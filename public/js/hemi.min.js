/*
 * Kuda includes a library and editor for authoring interactive 3D content for the web.
 * Copyright (C) 2011 SRI International.
 *
 * This program is free software; you can redistribute it and/or modify it under the terms
 * of the GNU General Public License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program;
 * if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 * Boston, MA 02110-1301 USA.
 */
Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.textAlign="center",a.style.background="#eee",a.style.color="#000",a.style.padding="1em",a.style.width="475px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"));return a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=a.parent!==undefined?a.parent:document.body,c=a.id!==undefined?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}};var Hashtable=function(){function w(a,c){var d=this,e=[],f={},i=typeof a==b?a:h,j=typeof c==b?c:null;this.put=function(a,b){l(a),m(b);var c=i(a),d,g,h=null,k=v(f,c);k?(g=k.getEntryForKey(a),g?(h=g[1],g[1]=b):k.addEntry(a,b)):(d=new t,d[0]=c,d[1]=new n(a,b,j),e[e.length]=d,f[c]=d);return h},this.get=function(a){l(a);var b=i(a),c=v(f,b);if(c){var d=c.getEntryForKey(a);if(d)return d[1]}return null},this.containsKey=function(a){l(a);var b=i(a),c=v(f,b);return c?c.containsKey(a):!1},this.containsValue=function(a){m(a);var b=e.length;while(b--)if(e[b][1].containsValue(a))return!0;return!1},this.clear=function(){e.length=0,f={}},this.isEmpty=function(){return!e.length};var k=function(a){return function(){var b=[],c=e.length;while(c--)e[c][1][a](b);return b}};this.keys=k("keys"),this.values=k("values"),this.entries=k("getEntries"),this.remove=function(a){l(a);var b=i(a),c,d=null,h=v(f,b);h&&(d=h.removeEntryForKey(a),d!==null&&(h.entries.length||(c=u(e,b),g(e,c),f[b]=null,delete f[b])));return d},this.size=function(){var a=0,b=e.length;while(b--)a+=e[b][1].entries.length;return a},this.each=function(a){var b=d.entries(),c=b.length,e;while(c--)e=b[c],a(e[0],e[1])},this.putAll=function(a,c){var e=a.entries(),f,g,h,i,j=e.length,k=typeof c==b;while(j--)f=e[j],g=f[0],h=f[1],k&&(i=d.get(g))&&(h=c(g,i,h)),d.put(g,h)},this.clone=function(){var b=new w(a,c);b.putAll(d);return b}}function v(a,b){var c=a[b];return c&&c instanceof t?c[1]:null}function u(a,b){var c=a.length,d;while(c--){d=a[c];if(b===d[0])return c}return null}function t(){}function s(a){return function(b){var c=b.length;for(var d=0,e=this.entries.length;d<e;++d)b[c+d]=this.entries[d][a]}}function r(a){return function(b){var c=this.entries.length,d,e=this.getEqualityFunction(b);while(c--){d=this.entries[c];if(e(b,d[0]))switch(a){case o:return!0;case p:return d;case q:return[c,d[1]]}}return!1}}function n(a,b,c){this.entries=[],this.addEntry(a,b),c!==null&&(this.getEqualityFunction=function(){return c})}function k(b){return function(c){if(c===null)throw new Error("null is not a valid "+b);if(typeof c==a)throw new Error(b+" must not be undefined")}}function j(a,c){return typeof c[d]==b?c.equals(a):a===c}function i(a,b){return a.equals(b)}function h(a){var d;if(typeof a==c)return a;if(typeof a[e]==b){d=a.hashCode();return typeof d==c?d:h(d)}return typeof a[f]==b?a.toString():String(a)}var a="undefined",b="function",c="string",d="equals",e="hashCode",f="toString",g=typeof Array.prototype.splice==b?function(a,b){a.splice(b,1)}:function(a,b){var c,d,e;if(b===a.length-1)a.length=b;else{c=a.slice(b+1),a.length=b;for(d=0,e=c.length;d<e;++d)a[b+d]=c[d]}},l=k("key"),m=k("value"),o=0,p=1,q=2;n.prototype={getEqualityFunction:function(a){return typeof a[d]==b?i:j},getEntryForKey:r(p),getEntryAndIndexForKey:r(q),removeEntryForKey:function(a){var b=this.getEntryAndIndexForKey(a);if(b){g(this.entries,b[0]);return b[1]}return null},addEntry:function(a,b){this.entries[this.entries.length]=[a,b]},keys:s(0),values:s(1),getEntries:function(a){var b=a.length;for(var c=0,d=this.entries.length;c<d;++c)a[b+c]=this.entries[c].slice(0)},containsKey:r(o),containsValue:function(a){var b=this.entries.length;while(b--)if(a===this.entries[b][1])return!0;return!1}},t.prototype=[];return w}(),hemi=function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;a.Class=function(){},a.Class.extend=function(a){function g(){!b&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;b=!0;var e=new this;b=!1;for(var f in a)e[f]=typeof a[f]=="function"&&typeof d[f]=="function"&&c.test(a[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);this._super=c;return e}}(f,a[f]):a[f];g.prototype=e,g.constructor=g,g.extend=arguments.callee;return g};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.Hashtable=Hashtable,a.utils.Hashtable.prototype.query=function(b){var c=this.values(),d=[],e=[],f=[],g,h,i,j,k,l,m,n;for(x in b)a.utils.isArray(b[x])?e.push(x):d.push(x);var o=d.length,p=e.length;for(var q=0,r=c.length;q<r;q++){g=c[q],n=!0;for(k=0;n&&k<o;k++)h=d[k],n=g[h]===b[h];for(k=0;n&&k<p;k++){n=!1,h=e[k],i=g[h],j=b[h],m=j.length;for(l=0;!n&&l<m;l++)n=i===j[l]}n&&f.push(g)}return f};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.clone=function(b,c){var d=a.utils.isArray(b)?[]:{},c=c==null?!0:c;a.utils.join(d,b,c);return d},a.utils.compareArrays=function(b,c){var d=b.length===c.length;for(var e=0;d&&e<b.length;e++)b[e]instanceof Array?d=a.utils.compareArrays(b[e],c[e]):d=Math.abs(b[e]-c[e])<=.001;return d},a.utils.get=function(b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){if(this.readyState===4){this.onreadystatechange=a.utils.noop;var b=null;if(this.status===200||window.location.href.indexOf("http")===-1){var d=this.getResponseHeader("content-type");d&&d.indexOf("xml")>=0?b=this.responseXML:b=this.responseText}c(b,this.statusText)}},d.open("GET",b,!0);try{d.send(null)}catch(e){c(null,e.name+": "+e.message)}},a.utils.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},a.utils.isFunction=function(a){return Object.prototype.toString.call(a)==="[object Function]"},a.utils.join=function(){var b=arguments[0],c=arguments.length,d=arguments[c-1],e=!0;typeof d=="boolean"&&(e=d,--c);for(var f=1;f<c;f++){var g=arguments[f];for(var h in g){var i=g[h];if(e&&i!=null&&typeof i=="object"){var j=b[h],k=a.utils.isArray(i);if(j==null||typeof j!="object"||a.utils.isArray(j)!==k)j=k?[]:{};b[h]=a.utils.join(j,i)}else b[h]=i}}return b},a.utils.noop=function(){};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.cartesianToSpherical=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d),f=Math.acos(c/e),g=Math.atan2(b,d);return[e,f,g]},a.utils.choose=function(b,c){return a.utils.factorial(b,b-c+1)/a.utils.factorial(c)},a.utils.clamp=function(a,b,c){return Math.min(c,Math.max(b,a))},a.utils.cubicHermite=function(a,b,c,d,e){var f=a*a,g=f*a,h=2*g-3*f+1,i=g-2*f+a,j=-2*g+3*f,k=g-f;return h*b+i*c+j*d+k*e},a.utils.factorial=function(a,b){var c=1,d=b?b:2;while(d<=a)c*=d++;return c},a.utils.intersect=function(b,c){var d=c,e=[b.near,b.far],f=a.core.math.inverse([[e[0][0]-e[1][0],d[1][0]-d[0][0],d[2][0]-d[0][0]],[e[0][1]-e[1][1],d[1][1]-d[0][1],d[2][1]-d[0][1]],[e[0][2]-e[1][2],d[1][2]-d[0][2],d[2][2]-d[0][2]]]),g=[e[0][0]-d[0][0],e[0][1]-d[0][1],e[0][2]-d[0][2]],h=f[0][0]*g[0]+f[0][1]*g[1]+f[0][2]*g[2],i=f[1][0]*g[0]+f[1][1]*g[1]+f[1][2]*g[2],j=f[2][0]*g[0]+f[2][1]*g[1]+f[2][2]*g[2];return[h,i,j]},a.utils.lerp=function(b,c,d){var e;if(a.utils.isArray(b)){e=[];for(var f=0;f<b.length;++f)e[f]=a.utils.lerp(b[f],c[f],d)}else e=b+(c-b)*d;return e},a.utils.linearToSine=function(a){return(Math.sin(Math.PI*a-Math.PI/2)+1)/2},a.utils.linearToParabolic=function(a){return a*a},a.utils.linearToParabolicInverse=function(a){return 1-(1-a)*(1-a)},a.utils.linearToExponential=function(a,b){return(Math.pow(b,a)-1)/(b-1)},a.utils.linearToExponentialInverse=function(b,c){return 1-a.utils.linearToExponential(1-b,c)},a.utils.penner={linearTween:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d){a/=d;return c*a*a+b},easeOutQuad:function(a,b,c,d){a/=d;return-c*a*(a-2)+b},easeInOutQuad:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a+b;a--;return-c/2*(a*(a-2)-1)+b},easeInCubic:function(a,b,c,d){a/=d;return c*a*a*a+b},easeOutCubic:function(a,b,c,d){a/=d,a--;return c*(a*a*a+1)+b},easeInOutCubic:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a+b;a-=2;return c/2*(a*a*a+2)+b},easeInQuart:function(a,b,c,d){a/=d;return c*a*a*a*a+b},easeOutQuart:function(a,b,c,d){a/=d,a--;return-c*(a*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a*a+b;a-=2;return-c/2*(a*a*a*a-2)+b},easeInQuint:function(a,b,c,d){a/=d;return c*a*a*a*a*a+b},easeOutQuint:function(a,b,c,d){a/=d,a--;return c*(a*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a*a*a+b;a-=2;return c/2*(a*a*a*a*a+2)+b},easeInSine:function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){a/=d/2;if(a<1)return c/2*Math.pow(2,10*(a-1))+b;a--;return c/2*(-Math.pow(2,-10*a)+2)+b},easeInCirc:function(a,b,c,d){a/=d;return-c*(Math.sqrt(1-a*a)-1)+b},easeOutCirc:function(a,b,c,d){a/=d,a--;return c*Math.sqrt(1-a*a)+b},easeInOutCirc:function(a,b,c,d){a/=d/2;if(a<1)return-c/2*(Math.sqrt(1-a*a)-1)+b;a-=2;return c/2*(Math.sqrt(1-a*a)+1)+b}},a.utils.sphericalToCartesian=function(a){var b=a[0],c=a[1],d=a[2];return[b*Math.sin(c)*Math.cos(d),b*Math.sin(c)*Math.sin(d),b*Math.cos(c)]},a.utils.uvToXYZ=function(b,c){var d=a.core.math,e=d.mulScalarVector(b[0],d.subVector(c[1],c[0])),f=d.mulScalarVector(b[1],d.subVector(c[2],c[0]));pos=d.addVector(c[0],d.addVector(e,f));return pos},a.utils.worldToScreen=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[Math.round(k),Math.round(l)]},a.utils.worldToScreenFloat=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[k,l,j[2]]};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.buildSrc=function(a){var b=(a.preHdr?a.preHdr:"")+(a.hdr?a.hdr:"")+(a.postHdr?a.postHdr:"")+(a.preSprt?a.preSprt:"")+(a.sprt?a.sprt:"")+(a.postSprt?a.postSprt:"")+a.main+(a.preBody?a.preBody:"")+(a.body?a.body:"")+(a.postBody?a.postBody:"")+(a.preGlob?a.preGlob:"")+(a.glob?a.glob:"")+(a.postGlob?a.postGlob:"")+a.end;return b},a.utils.combineFragSrc=function(a,b){return this.combineSrc(a,b,"gl_FragColor")},a.utils.combineSrc=function(b,c,d){var e=this.parseSrc(b,d);a.utils.join(e,c);return this.buildSrc(e)},a.utils.combineVertSrc=function(a,b){return this.combineSrc(a,b,"gl_Position")},a.utils.getShaders=function(a){var b=a.gl,c=a.effect.program_,d=b.getAttachedShaders(c),e=b.getShaderSource(d[0]),f=b.getShaderSource(d[1]),g;e.search("gl_FragColor")>0?g={fragShd:d[0],fragSrc:e,vertShd:d[1],vertSrc:f}:g={fragShd:d[1],fragSrc:f,vertShd:d[0],vertSrc:e};return g},a.utils.parseSrc=function(a,b){var c=a.lastIndexOf(";",a.indexOf("{"))+1,d=a.indexOf("void main",c),e=a.indexOf("{",d)+1,f=a.indexOf(b,e),g=a.lastIndexOf(";")+1;a.charAt(c)==="\n"&&++c,a.charAt(e)==="\n"&&++e,a.charAt(f)==="\n"&&++f,a.charAt(g)==="\n"&&++g;var h={hdr:a.slice(0,c),sprt:a.slice(c,d),main:a.slice(d,e),body:a.slice(e,f),glob:a.slice(f,g),end:a.slice(g)};return h};return a}(hemi||{}),hemi=function(a){function c(a,c,d){var e=c,f=0,g=a.length,h=c-Math.max(c-d,0),i=Math.min(c+d,g-1)-c,j,k;for(var l=parseInt(c-h);l<=c+i;l++){k=b.get(a.charAt(l));if(k===null)continue;j=k/Math.abs(c-l),j>f&&(e=l,f=j)}return Math.min(e+1,g-1)}a.utils=a.utils||{},String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},a.utils.isNumeric=function(a){return a!==null&&!isNaN(a)&&a.length!==0};var b=new Hashtable;b.put(" ",10),b.put(",",20),b.put(";",30),b.put(".",10),b.put("!",40),b.put("?",40),a.utils.wrapTextStrict=function(c,d,e){var f=[],c=a.utils.cleanseText(c),g=c.length,h=e.measureText(c),i=h.width/g,j=Math.floor(d/i),k=Math.ceil(j/10),l=0,m=j,n,o;while(m<g){n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o<d&&m<g)m+=k,m>g&&(m=g),n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o>d)m--,n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;var p=m-1,q=c.charAt(p);while(!b.containsKey(q)&&p>l)p--,q=c.charAt(p);p>l&&(m=p+1),n=c.substring(l,m).trim(),f.push(n),l=m,m+=j}if(l!=g||f.length===0)n=c.substring(l,g).trim(),f.push(n);return f},a.utils.wrapText=function(b,d,e){var f=[],b=a.utils.cleanseText(b),g=b.length,h=parseInt(d/e),i=Math.ceil(g/h),j=h,k=0,l;for(var m=0;m<i-1;m++)l=k,k=c(b,j,10),f.push(b.substring(l,k).trim()),j=k+h;f.push(b.substring(k,g));return f},a.utils.cleanseText=function(a){a=a.replace("\n"," ");return a};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.isAnimated=function(a){var b=a.getParam("o3d.localMatrix");return b.inputConnection!=null},a.utils.fosterTransform=function(b){var c=b.children,d=b.shapes,e=a.core.mainPack.createObject("Transform");while(c.length>0)c[0].parent=e;e.parent=b;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return e},a.utils.pointAsLocal=function(a,b){var c=THREE.Matrix4.makeInvert(a.matrixWorld);return c.multiplyVector3(b.clone())},a.utils.pointAsWorld=function(a,b){return a.matrixWorld.multiplyVector3(b.clone())},a.utils.pointYAt=function(a,b,c){var d=c[0]-b[0],e=c[1]-b[1],f=c[2]-b[2],g=Math.sqrt(d*d+f*f),h=Math.atan2(d,f),i=Math.atan2(g,e);a.rotateX(i),a.rotateY(h);return a},a.utils.pointZAt=function(a,b,c){var d=(new THREE.Vector3).sub(c,b),e=Math.atan2(d.x,d.z),f=-Math.asin(d.y/d.length());a.rotation.y+=e,a.rotation.x+=f,a.updateMatrix();return a},a.utils.unfosterTransform=function(b){var c=b.children,d=b.shapes,e=b.parent;while(c.length>0)c[0].parent=e;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}b.parent=null,a.core.mainPack.removeObject(b);return e},a.utils.worldRotate=function(b,c,d){var e=a.core.math.matrix4,f=e.inverse(d.getUpdatedWorldMatrix()),g=e.transformDirection(f,b);d.axisRotate(g,c)},a.utils.worldScale=function(b,c){var d=a.core.math.matrix4,e=d.mul(d.mul(d.mul(c.getUpdatedWorldMatrix(),d.scaling(b)),d.inverse(c.getUpdatedWorldMatrix())),c.localMatrix);c.localMatrix=e},a.utils.worldTranslate=function(b,c){var d=a.core.math.matrix4,e=d.inverse(c.getUpdatedWorldMatrix()),f=d.transformDirection(e,b);c.translate(f)},a.utils.identity=function(a){a.position=new THREE.Vector3(0,0,0),a.rotation=new THREE.Vector3(0,0,0),a.scale=new THREE.Vector3(1,1,1),a.updateMatrix()};return a}(hemi||{}),hemi=function(a){a.msg={animate:"hemi.animate",burst:"hemi.burst",cleanup:"hemi.cleanup",drag:"hemi.drag",enable:"hemi.enable",load:"hemi.load",pick:"hemi.pick",progress:"hemi.progress",ready:"hemi.ready",scale:"hemi.scale",start:"hemi.start",stop:"hemi.stop",unload:"hemi.unload",visible:"hemi.visible"};return a}(hemi||{}),hemi=function(a){a.console=a.console||{},a.console.ERR="ERR",a.console.WARN="WARN",a.console.LOG="LOG";var b=!1,c=!0,d=function(b,d){d=d||a.console.LOG;if(j(d)){var g=d+":\t"+b;if(c){var h=f();g=h+"\t"+g}e(g)}},e=function(a){try{console.log(a)}catch(b){}},f=function(){var a=new Date,b=a.getHours();b=b<10?"0"+b:""+b;var c=a.getMinutes();c=c<10?":0"+c:":"+c;var d=a.getSeconds();d=d<10?":0"+d:":"+d;return b+c+d},g=function(b){return b===a.console.LOG||b===a.console.WARN||b===a.console.ERR},h=function(b){return b===a.console.WARN||b===a.console.ERR},i=function(b){return b===a.console.ERR},j=g;a.console.log=a.utils.noop,a.console.setEnabled=function(c){c!=b&&(b=c,b?a.console.log=d:a.console.log=a.utils.noop)},a.console.setOutput=function(a){e=a},a.console.setPriority=function(b){switch(b){case a.console.LOG:j=g;break;case a.console.WARN:j=h;break;case a.console.ERR:j=i}},a.console.setShowTime=function(a){c=a};return a}(hemi||{});Array.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1}),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}());var hemi=function(a){var b=null,c=60,d=1/c,e=0,f=[],g=function(a){var b=null;Detector.webgl?b=new THREE.WebGLRenderer:(Detector.canvas&&(b=new THREE.CanvasRenderer),Detector.addGetWebGLMessage({id:"warn_"+a.id,parent:a}),function(a){setTimeout(function(){var b=document.getElementById("warn_"+a.id);a.removeChild(b)},5e3)}(a));return b},h=function(b){requestAnimationFrame(h);var c=(new Date).getTime()*.001,g={elapsedTime:d};while(c-e>d){b=!0,e+=d;for(var i=0;i<f.length;++i)f[i].onRender(g)}if(b)for(var i=0;i<a.clients.length;++i)a.clients[i].onRender(g)},i=function(){for(var b=0;b<a.clients.length;++b)a.clients[b].resize()};a.version="1.5.0",a.console.setEnabled(!0),a.clients=[],a.makeClients=function(){var b=document.getElementsByTagName("div"),c=a.clients.length;for(var d=0;d<b.length;++d){var e=b[d];if(e.id&&e.id.match(/^kuda/)){var f=g(e);if(f){var h=d<c?a.clients[d]:new a.Client;e.appendChild(f.domElement),h.setRenderer(f)}}}a.init();return a.clients},a.init=function(){window.addEventListener("resize",i,!1),e=(new Date).getTime()*.001,h(!0)},a.addRenderListener=function(a){var b=f.indexOf(a);b===-1&&f.push(a)},a.removeRenderListener=function(a){var b=f.indexOf(a),c=null;b!==-1&&(c=f.splice(b,1)[0]);return c},a.error=function(a){if(b)b(a);else{var c=new Error(a);c.name="HemiError";throw c}},a.getTimeOfFrame=function(a){return a*d},a.setErrorCallback=function(a){b=a},a.getFPS=function(){return c},a.setFPS=function(a){c=a,d=1/c};return a}(hemi||{}),hemi=function(a){var b=new THREE.ColladaLoader,c=null,d=1,e=function(){--d===0&&(d=1,a.send(a.msg.ready,{}),c&&(c(),c=null))},f=function(b){return b.substr(0,4)==="http"?b:a.loadPath+b};a.loadPath="",a.loadCollada=function(a,c){a=f(a),++d,b.load(a,function(a){c&&c(a),e()})},a.loadOctane=function(b,c){b=f(b),++d,a.utils.get(b,function(b,d){e();if(b==null)a.error(d);else{typeof b=="string"&&(b=JSON.parse(b));var f=a.fromOctane(b);b.type||(a.makeClients(),a.ready()),c&&c(f)}})},a.ready=e,a.resetLoadTasks=function(a){c=a,e()};return a}(hemi||{}),hemi=function(a){var b=function(a,b){var c=b.split("."),d=c.length-1,e=window;for(var f=0;f<d;++f){var g=c[f];e[g]||(e[g]={}),e=e[g]}e[c[d]]=a},c=function(){return this._worldId},d=function(b){var c=this._worldId;this._worldId=b,c!==null&&(a.world.citizens.remove(c),a.world.citizens.put(b,this))},e=function(b,c){a.dispatch.postMessage(this,b,c)},f=function(b,c,d,e){return a.dispatch.registerTarget(this._worldId,b,c,d,e)},g=function(b,c,d){return a.dispatch.registerTarget(this._worldId,a.dispatch.WILDCARD,b,c,d)},h=function(b,c){return a.dispatch.removeTarget(b,{src:this._worldId,msg:c})};a.makeCitizen=function(i,j,k){function n(){i.apply(this,arguments),this.name=this.name||"",this._worldId=null,a.world.addCitizen(this)}k=k||{};var l=k.cleanup,m=k.msgs||[];m.push(a.msg.cleanup),n.prototype=i.prototype,n.prototype._msgSent=m,n.prototype.cleanup=function(){this.send(a.msg.cleanup,{}),l&&l.apply(this,arguments),a.world.removeCitizen(this)},n.prototype._getId=c,n.prototype._setId=d,n.prototype.send=e,n.prototype.subscribe=f,n.prototype.subscribeAll=g,n.prototype.unsubscribe=h,n.constructor=n,a.makeOctanable(n,j,k.toOctane),b(n,j);return n},a.world=a.world||{},a.world.WORLD_ID=0;var i=1;a.world.citizens=new a.utils.Hashtable,a.world.setNextId=function(a){i=a},a.world.getNextId=function(){return i++},a.world.checkNextId=function(){return i},a.world._getId=function(){return a.world.WORLD_ID},a.world.addCitizen=function(b){var c=b._getId();c==null&&(c=this.getNextId(),b._setId(c));var d=this.citizens.get(c);d!==null&&(a.console.log("Citizen with id "+c+" already exists.",a.console.ERR),d.cleanup()),this.citizens.put(c,b)},a.world.cleanup=function(){a.resetLoadTasks(),a.send(a.msg.cleanup,{}),a.world.citizens.each(function(a,b){b.cleanup()}),a.world.citizens.size()>0&&a.console.log("World cleanup did not remove all citizens.",a.console.ERR),i=1},a.world.removeCitizen=function(b){var c=b._getId(),d=this.citizens.remove(c);d===null&&a.console.log("Unable to remove Citizen with id "+c,a.console.WARN);return d!==null},a.world.getCitizens=function(a,b){var c={};a!=undefined&&(a.worldId!==undefined&&(c.worldId=a.worldId),a.name!==undefined&&(c.name=a.name),a.citizenType!==undefined&&(c.citizenType=a.citizenType));var d=this.citizens.query(c);if(b)for(var e=0,f=d.length;e<f;e++)b(d[e])||(d.splice(e,1),e--,f--);return d},a.world.getCitizenById=function(b){var c=this.citizens.get(b);c===null&&a.console.log("Tried to get Citizen with id "+b+", returned null.",a.console.ERR);return c},a.world.getAudio=function(b,c){b=b||{},b.citizenType=a.audio.Audio.prototype.citizenType;return this.getCitizens(b,c)},a.world.getCamCurves=function(b,c){b=b||{},b.citizenType=a.view.CameraCurve.prototype.citizenType;return this.getCitizens(b,c)},a.world.getHudDisplays=function(b,c){b=b||{},b.citizenType=a.hud.HudDisplay.prototype.citizenType;return this.getCitizens(b,c)},a.world.getHudElements=function(b,c){b=b||{},b.citizenType=a.hud.HudElement.prototype.citizenType;return this.getCitizens(b,c)},a.world.getModels=function(b,c){b=b||{},b.citizenType=a.model.Model.prototype.citizenType;return this.getCitizens(b,c)},a.world.getAnimations=function(b,c){b=b||{},b.citizenType=a.animation.Animation.prototype.citizenType;return this.getCitizens(b,c)},a.world.getEffects=function(b,c){var d=[];b=b||{},b.citizenType=a.effect.Emitter.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Burst.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Trail.prototype.citizenType,d=d.concat(this.getCitizens(b,c));return d},a.world.getViewpoints=function(b,c){b=b||{},b.citizenType=a.view.Viewpoint.prototype.citizenType;return this.getCitizens(b,c)},a.world.getPressureEngines=function(a,b){a=a||{},a.citizenType=hext.engines.PressureEngine.prototype.citizenType;return this.getCitizens(a,b)},a.world.getDraggables=function(b,c){b=b||{},b.citizenType=a.manip.Draggable.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTurnables=function(b,c){b=b||{},b.citizenType=a.manip.Turnable.prototype.citizenType;return this.getCitizens(b,c)},a.world.getRotators=function(b,c){b=b||{},b.citizenType=a.motion.Rotator.prototype.citizenType;return this.getCitizens(b,c)},a.world.getScenes=function(b,c){b=b||{},b.citizenType=a.scene.Scene.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTimers=function(b,c){b=b||{},b.citizenType=a.time.Timer.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTranslators=function(b,c){b=b||{},b.citizenType=a.motion.Translator.prototype.citizenType;return this.getCitizens(b,c)},a.world.getShapes=function(b,c){b=b||{},b.citizenType=a.shape.Shape.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTranOwner=function(a){var b=a.getParam("ownerId"),c=null;b!==null&&(c=this.getCitizenById(b.value));return c},a.world.toOctane=function(b){var c={version:a.version,nextId:i,citizens:[]};this.citizens.each(function(d,e){var f=b?b(e):!0;if(f){var g=e._toOctane();g!==null?c.citizens.push(g):a.console.log("Null Octane returned by Citizen with id "+e.getId(),a.console.WARN)}}),c.dispatch=a.dispatch._toOctane();return c};return a}(hemi||{}),hemi=function(a){var b=function(b){if(!b.type){alert("Unable to process octane: missing type");return null}var c=e[b.type],d=null;c?(d=new c,b.id!==undefined&&d._setId(b.id)):a.console.log("Cannot find constructor for type: "+b.type,a.console.ERR);return d},c=function(b,c){var d=[];for(var e=0;e<c.length;++e){var f=c[e],g=b[f],h={name:f};a.utils.isFunction(g)?h.arg=[]:g._getId&&g._worldId?h.id=g._getId():g._toOctane?h.oct=g._toOctane():h.val=g,d.push(h)}return d},d=function(c,e){for(var f=0,g=e.props.length;f<g;f++){var h=e.props[f],i=h.name;if(h.oct!==undefined){if(h.oct instanceof Array){m=[];for(var j=0,k=h.oct.length;j<k;j++){var l=b(h.oct[j]);d(l,h.oct[j]),m.push(l)}}else m=b(h.oct),d(m,h.oct);c[i]=m}else if(h.val!==undefined)c[i]=h.val;else if(h.id!==undefined){var m;if(h.id instanceof Array){m=[];for(var j=0,k=h.id.length;j<k;j++)m.push(a.world.getCitizenById(h.id[j]))}else m=a.world.getCitizenById(h.id);c[i]=m}else if(h.arg!==undefined){var n=c[i];n.apply(c,h.arg)}else alert("Unable to process octane for "+e.id+": missing property value")}},e={};a.fromOctane=function(c){var e=null;if(c.type)e=b(c),d(e,c);else{a.world.cleanup();var f=c.citizens.length,g=f*-2;a.world.setNextId(g);for(var h=0;h<f;h++){var i=c.citizens[h];b(i)}a.world.setNextId(c.nextId);var j=c.dispatch.ents,k=[];for(var h=0,l=j.length;h<l;h++){var m=b(j[h]);d(m,j[h]),k.push(m)}a.dispatch.loadEntries(k),a.dispatch.setNextId(c.dispatch.nextId);for(var h=0;h<f;h++){var i=c.citizens[h];d(a.world.getCitizenById(i.id),i)}}return e},a.makeOctanable=function(b,d,f){f=f||[],e[d]=b,b.prototype._citizenType=d,b.prototype._toOctane=function(){var b={type:this._citizenType,props:a.utils.isFunction(f)?f.call(this):c(this,f)};this._worldId!=null&&(b.id=this._worldId),this.name&&this.name.length>0&&!b.props.name&&b.props.unslice({name:"name",val:this.name});return b}};return a}(hemi||{}),hemi=function(a){a.dispatch=a.dispatch||{};var b=0;a.dispatch.WILDCARD="*",a.dispatch.ID_ARG="id:",a.dispatch.MSG_ARG="msg:",a.dispatch.Message=function(){this.src=null,this.msg=null,this.data={}},a.dispatch.MessageSpec=function(){this.src=null,this.msg=null,this.targets=[]},a.dispatch.MessageSpec.prototype={cleanup:function(){for(var a=0,b=this.targets.length;a<b;a++)this.targets[a].cleanup();this.targets=[]},addTarget:function(b){this.targets.indexOf(b)!=-1&&a.console.log("MessageSpec already contains MessageTarget",a.console.WARN),this.targets.push(b)},removeTarget:function(b){var c=null,d=this.targets.indexOf(b);if(d!=-1){var e=this.targets.splice(d,1);e.length===1&&(c=e[0])}else a.console.log("MessageTarget not found in MessageSpec",a.console.WARN);return c},getHash:function(){return this.msg+this.src}},a.makeOctanable(a.dispatch.MessageSpec,"hemi.dispatch.MessageSpec",function(){var b=[];for(var c=0,d=this.targets.length;c<d;c++){var e=this.targets[c]._toOctane();e!==null?b.push(e):a.console.log("Null Octane returned by MessageTarget",a.console.ERR)}return[{name:"src",val:this.src},{name:"msg",val:this.msg},{name:"targets",oct:b}]}),a.dispatch.MessageTarget=function(){this._dispatchId=null,this.name="",this.handler=null,this.func=null,this.args=null},a.dispatch.MessageTarget.prototype={cleanup:function(){this.handler=null}},a.makeOctanable(a.dispatch.MessageTarget,"hemi.dispatch.MessageTarget",function(){if(!this.handler._getId){a.console.log("Handler object in MessageTarget can not be saved to Octane",a.console.WARN);return null}var b=["_dispatchId","name","func","args"],c=[{name:"handler",id:this.handler._getId()}];for(var d=0,e=b.length;d<e;d++){var f=b[d];c.push({name:f,val:this[f]})}return c}),a.dispatch.msgSpecs=new a.utils.Hashtable,a.dispatch.setNextId=function(a){b=a},a.dispatch.getNextId=function(){return b++},a.dispatch.checkNextId=function(){return b},a.dispatch.loadEntries=function(a){for(var b=0,c=a.length;b<c;b++){var d=a[b];this.msgSpecs.put(d.getHash(),d)}},a.dispatch.cleanup=function(){this.msgSpecs.each(function(a,b){b.cleanup()}),this.msgSpecs.clear()},a.dispatch._toOctane=function(){var c={nextId:b,ents:[]};this.msgSpecs.each(function(b,d){var e=d._toOctane();e!==null?c.ents.push(e):a.console.log("Null Octane returned by MessageSpec",a.console.ERR)});return c},a.dispatch.getSpecs=function(b,c){var d;if(b===undefined)d=this.msgSpecs.values();else{var e={};c?(b.src!==undefined&&(b.src===a.dispatch.WILDCARD?e.src=a.dispatch.WILDCARD:e.src=[b.src,a.dispatch.WILDCARD]),b.msg!==undefined&&(b.msg===a.dispatch.WILDCARD?e.msg=a.dispatch.WILDCARD:e.msg=[b.msg,a.dispatch.WILDCARD])):(b.src!==undefined&&(e.src=b.src),b.msg!==undefined&&(e.msg=b.msg)),d=this.msgSpecs.query(e)}return d},a.dispatch.getSpecsFast=function(b,c,d){var e=[],f=c+b,g=this.msgSpecs.get(f);g!==null&&e.push(g);if(d){var h=b===a.dispatch.WILDCARD;h||(f=c+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)),c!==a.dispatch.WILDCARD&&(f=a.dispatch.WILDCARD+b,g=this.msgSpecs.get(f),g!==null&&e.push(g),h||(f=a.dispatch.WILDCARD+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)))}return e},a.dispatch.getTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a.dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;h++){var j=c[h].targets;for(var k=0,l=j.length;k<l;k++){var m=j[k],n=!0;e!==undefined&&(n=m._dispatchId===e),n&&f!==undefined&&(n=m.name===f),n&&g!==undefined&&(n=m.handler===g),n&&d.push(m)}}return d},a.dispatch.getTargetSpec=function(a){var b=this.getSpecs(),c=a._dispatchId;for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f.targets;for(var h=0,i=g.length;h<i;h++)if(g[h]._dispatchId===c)return f}return null},a.dispatch.createSpec=function(b,c){var d=this.getSpecsFast(b,c,!1),e;d.length===0?(e=new a.dispatch.MessageSpec,e.src=b,e.msg=c,this.msgSpecs.put(e.getHash(),e)):(d.length>1&&a.console.log("Found "+d.length+" MessageSpecs with the same src and msg.",a.console.ERR),e=d[0]);return e},a.dispatch.registerTarget=function(b,c,d,e,f){var g=this.createSpec(b,c),h=new a.dispatch.MessageTarget;h._dispatchId=this.getNextId(),h.handler=d,e&&(h.func=e),f&&(h.args=f),g.addTarget(h);return h},a.dispatch.removeTarget=function(b,c){var d=this.getSpecs(c,!1),e=null;for(var f=0,g=d.length;f<g;f++){var h=d[f];e=h.removeTarget(b);if(e!==null)break}e===null&&a.console.log("MessageTarget was not found and therefore not removed",a.console.WARN);return e},a.dispatch.setTargetSpec=function(b,c,d){var e=this.getTargetSpec(b);e!==null?e.removeTarget(b):a.console.log("Previous MessageSpec for MessageTarget not found",a.console.WARN),e=this.createSpec(c,d),e.addTarget(b)},a.dispatch.postMessage=function(b,c,d){var e=new a.dispatch.Message,f=b._getId();e.src=b,e.msg=c,e.data=d;var g=this.getSpecsFast(f,c,!0);for(var h=0,i=g.length;h<i;h++){var j=g[h].targets.slice(0);for(var k=0,l=j.length;k<l;k++){var m=j[k],n,o;m.args!==null?n=this.getArguments(e,m.args):n=[e],m.func?o=m.handler[m.func]:o=m.handler,o.apply(m.handler,n)}}},a.dispatch.getArguments=function(b,c){var d=[];for(var e=0,f=c.length;e<f;e++){var g=c[e];if(typeof g!="string")d[e]=g;else if(g.substring(0,3)===a.dispatch.ID_ARG){var h=parseInt(g.substring(3));d.push(a.world.getCitizenById(h))}else if(g.substring(0,4)===a.dispatch.MSG_ARG){g=g.substring(4);var i=g.split("."),j=b;for(aNdx=0,aLen=i.length;j!=null&&aNdx<aLen;aNdx++)j=j[i[aNdx]];d.push(j)}else d[e]=g}return d};var c={_getId:function(){return a.dispatch.WILDCARD}};a.send=function(b,d){a.dispatch.postMessage(c,b,d)},a.subscribe=function(b,c,d,e){return a.dispatch.registerTarget(a.dispatch.WILDCARD,b,c,d,e)},a.unsubscribe=function(b,c){return a.dispatch.removeTarget(b,{src:a.dispatch.WILDCARD,msg:c})};return a}(hemi||{}),hemi=function(a){a.input=a.input||{},a.input.mouseDownListeners=[],a.input.mouseUpListeners=[],a.input.mouseMoveListeners=[],a.input.mouseWheelListeners=[],a.input.keyDownListeners=[],a.input.keyUpListeners=[],a.input.keyPressListeners=[],a.input.init=function(b){b.addEventListener("mousedown",function(b){a.input.mouseDown(b)},!0),b.addEventListener("mousemove",function(b){a.input.mouseMove(b)},!0),b.addEventListener("mouseup",function(b){a.input.mouseUp(b)},!0),b.addEventListener("mousewheel",function(b){a.input.scroll(b)},!1),b.addEventListener("DOMMouseScroll",function(b){a.input.scroll(b)},!1),document.addEventListener("keypress",function(b){a.input.keyPress(b)},!0),document.addEventListener("keydown",function(b){a.input.keyDown(b)},!0),document.addEventListener("keyup",function(b){a.input.keyUp(b)},!0)},a.input.addMouseDownListener=function(c){b(a.input.mouseDownListeners,c)},a.input.addMouseUpListener=function(c){b(a.input.mouseUpListeners,c)},a.input.addMouseMoveListener=function(c){b(a.input.mouseMoveListeners,c)},a.input.addMouseWheelListener=function(c){b(a.input.mouseWheelListeners,c)},a.input.addKeyDownListener=function(c){b(a.input.keyDownListeners,c)},a.input.addKeyUpListener=function(c){b(a.input.keyUpListeners,c)},a.input.addKeyPressListener=function(c){b(a.input.keyPressListeners,c)},a.input.removeMouseDownListener=function(b){return c(a.input.mouseDownListeners,b)},a.input.removeMouseUpListener=function(b){return c(a.input.mouseUpListeners,b)},a.input.removeMouseMoveListener=function(b){return c(a.input.mouseMoveListeners,b)},a.input.removeMouseWheelListener=function(b){return c(a.input.mouseWheelListeners,b)},a.input.removeKeyDownListener=function(b){return c(a.input.keyDownListeners,b)},a.input.removeKeyUpListener=function(b){return c(a.input.keyUpListeners,b)},a.input.removeKeyPressListener=function(b){return c(a.input.keyPressListeners,b)},a.input.mouseDown=function(b){var c=e(b);for(var d=0;d<a.input.mouseDownListeners.length;d++)a.input.mouseDownListeners[d].onMouseDown(c)},a.input.mouseUp=function(b){var c=e(b);for(var d=0;d<a.input.mouseUpListeners.length;d++)a.input.mouseUpListeners[d].onMouseUp(c)},a.input.mouseMove=function(b){var c=e(b);for(var d=0;d<a.input.mouseMoveListeners.length;d++)a.input.mouseMoveListeners[d].onMouseMove(c)},a.input.scroll=function(b){var c=e(b);c.deltaY=b.detail?-b.detail:b.wheelDelta,f(b);for(var d=0;d<a.input.mouseWheelListeners.length;d++)a.input.mouseWheelListeners[d].onScroll(c)},a.input.keyDown=function(b){for(var c=0;c<a.input.keyDownListeners.length;c++)a.input.keyDownListeners[c].onKeyDown(b)},a.input.keyUp=function(b){for(var c=0;c<a.input.keyUpListeners.length;c++)a.input.keyUpListeners[c].onKeyUp(b)},a.input.keyPress=function(b){for(var c=0;c<a.input.keyPressListeners.length;c++)a.input.keyPressListeners[c].onKeyPress(b)};var b=function(a,b){a.push(b)},c=function(a,b){var c=null,d=a.indexOf(b);if(d!=-1){var e=a.splice(d,1);e.length==1&&(c=e[0])}return c},d=function(a){var b=a.target?a.target:a.srcElement,c={x:0,y:0};for(var d=b;d;d=d.offsetParent)c.x+=d.offsetLeft,c.y+=d.offsetTop;c.x=a.pageX-c.x,c.y=a.pageY-c.y;return c},e=function(b){var c=a.utils.clone(b,!1),e=d(c);c.x=e.x,c.y=e.y;return c},f=function(a){a||(a=window.event),a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()};return a}(hemi||{}),hemi=function(a){a.viewDefaults={MOUSE_SPEED:.005,MOUSE_DELTA:.0015,TRUCK_SPEED:.02,FOV:.707107,NP:1,FP:1e4,MOVE_TIME:72,MIN_FOV:.05,MAX_FOV:Math.PI/3,MIN_TILT:-Math.PI/2.001,MAX_TILT:Math.PI/2.001},a.viewProjection={PERSPECTIVE:0,XY:1,XZ:2,YZ:3},a.CameraBase=function(){this.panTilt=new THREE.Object3D,this.panTilt.name="panTilt",this.panTilt.eulerOrder="ZYX",this.cam=new THREE.Object3D,this.cam.name="cam",this.panTilt.add(this.cam),this.cam.position.z=1,this.cam.updateMatrix(),this.updateWorldMatrices(),this.distance=1,this.vd={current:null,last:null},this.light=new THREE.PointLight(16777215,1.35),this.tiltMax=a.viewDefaults.MAX_TILT,this.tiltMin=a.viewDefaults.MIN_TILT,this.fov={current:a.viewDefaults.FOV,min:a.viewDefaults.MIN_FOV,max:a.viewDefaults.MAX_FOV},this.lookLimits={panMax:null,panMin:null,tiltMax:null,tiltMin:null},this.mode={scroll:!0,scan:!0,fixed:!1,control:!1,projection:a.viewProjection.PERSPECTIVE,fixedLight:!0},this.state={moving:!1,curve:null,time:{current:0,end:0},mouse:!1,xy:{current:[-1,-1],last:[-1,-1]},shift:!1,update:!1,vp:null},this.threeCamera=new THREE.PerspectiveCamera(this.fov.current*180/Math.PI,window.innerWidth/window.innerHeight,a.viewDefaults.NP,a.viewDefaults.FP);var b=a.utils.penner.linearTween;this.easeFunc=[b,b,b],this.update(),a.addRenderListener(this)},a.CameraBase.prototype={disableControl:function(){if(!this.mode.control)return!1;a.input.removeMouseDownListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseMoveListener(this),a.input.removeMouseWheelListener(this),a.input.removeKeyDownListener(this),a.input.removeKeyUpListener(this),this.mode.control=!1,this.state.mouse=!1;return!0},disableScan:function(){this.mode.scan=!1},disableZoom:function(){this.mode.scroll=!1},enableControl:function(b){if(this.mode.control)return!1;a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this),a.input.addMouseWheelListener(this),a.input.addKeyDownListener(this),a.input.addKeyUpListener(this),this.mode.control=!0;return!0},enableScan:function(){this.mode.scan=!0},enableZoom:function(){this.mode.scroll=!0},fixEye:function(){this.mode.fixed=!0,this.update();return this},lightOnCam:function(){this.mode.fixedLight=!0,this.update();return this},freeEye:function(){this.setEyeTarget(this.getEye(),this.getTarget()),this.mode.fixed=!1,this.update();return this},lightAtPosition:function(a){this.light.position=a,this.light.updateMatrix(),this.mode.fixedLight=!1,this.update();return this},getEye:function(){return this.cam.matrixWorld.getPosition().clone()},getTarget:function(){if(this.mode.fixed){var a=new THREE.Vector3(0,0,1);this.cam.matrixWorld.rotateAxis(a).multiplyScalar(-this.distance);return a.addSelf(this.cam.matrixWorld.getPosition())}return this.panTilt.matrixWorld.getPosition().clone()},moveOnCurve:function(b,c){this.vd.current!==null?this.vd.last=this.vd.current:this.vd.last=a.createViewData(this),this.vd.current=new a.ViewData({eye:b.eye.getEnd(),target:b.target.getEnd(),fov:this.fov.current,np:this.threeCamera.near,fp:this.threeCamera.far}),this.state.curve=b,this.state.moving=!0,this.state.vp=null,this.state.time.end=c==null?1:c>0?c:.001,this.state.time.current=0,this.send(a.msg.start,{viewdata:this.vd.current})},moveOrthographic:function(b,c){var d=b*2*this.distance/a.core.client.width,e=c*2*this.distance/a.core.client.width;switch(this.mode.projection){case a.viewProjection.XY:case a.viewProjection.YZ:this.panTilt.translateX(-d),this.panTilt.translateY(e),this.panTilt.updateMatrix();break;case a.viewProjection.XZ:this.panTilt.translateX(d),this.panTilt.translateZ(e),this.panTilt.updateMatrix()}},movePerspective:function(b,c){if(this.state.shift&&this.mode.scan){var d=a.viewDefaults.MOUSE_DELTA*this.distance*b,e=a.viewDefaults.MOUSE_DELTA*this.distance*c;this.panTilt.translateX(-d),this.panTilt.translateY(e),this.panTilt.updateMatrix(),this.update()}else this.mode.fixed?this.rotate(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED):this.orbit(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED)},moveToView:function(b,c){var d=c==null?1:c,e;b.getData!=null?(this.vd.current=b.getData(),this.state.vp=b,e={viewpoint:b}):(this.vd.current=b,this.state.vp=null,e={viewdata:b}),this.vd.last=a.createViewData(this),this.state.curve=null,this.state.time.end=d>0?d:.001,this.state.time.current=0,this.state.moving=!0,this.send(a.msg.start,e)},onKeyDown:function(a){this.state.shift=a.keyCode==16},onKeyUp:function(a){a.keyCode==16&&(this.state.shift=!1)},onMouseDown:function(a){this.state.mouse=!0,this.state.xy.current[0]=this.state.xy.last[0]=a.x,this.state.xy.current[1]=this.state.xy.last[1]=a.y},onMouseMove:function(a){if(this.state.mouse){this.state.xy.last[0]=this.state.xy.current[0],this.state.xy.last[1]=this.state.xy.current[1],this.state.xy.current[0]=a.x,this.state.xy.current[1]=a.y;var b=this.state.xy.current[0]-this.state.xy.last[0],c=this.state.xy.current[1]-this.state.xy.last[1];this.mode.projection?this.moveOrthographic(b,c):this.movePerspective(b,c)}},onMouseUp:function(a){this.state.mouse=!1},onRender:function(a){var b=this.state,c=b.xy;(b.mouse&&(c.current[0]!==c.last[0]||c.current[1]!==c.last[1])||b.moving||b.update)&&this.update(a.elapsedTime),b.update=!1},onScroll:function(b){if(!!this.mode.scroll)if(this.state.shift){var c=this.distance*a.viewDefaults.TRUCK_SPEED,d=b.deltaY>0?1:-1;this.truck(c*d)}else{if(this.mode.fixed){var e=(this.fov.max+this.fov.min)/2;b.deltaY>0?this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*11/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*13/12:this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*13/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*11/12,this.threeCamera.fov=this.fov.current*180/Math.PI,this.threeCamera.updateProjectionMatrix(),this.state.update=!0;return}var f=b.deltaY>0?11/12:13/12;this.distance=a.utils.lerp(0,this.distance,f),this.mode.projection||(this.cam.position.z=this.distance,this.cam.updateMatrix()),this.state.update=!0}},orbit:function(a,b){b==null&&(b=0);var c=this.panTilt.rotation.x+b;this.panTilt.rotation.y+=a,this.panTilt.rotation.x=c>=this.tiltMax?this.tiltMax:c<=this.tiltMin?this.tiltMin:c,this.panTilt.updateMatrix(),this.update()},rotate:function(a,b){b==null&&(b=0);var c=this.lookLimits,d=this.cam.rotation.y+a,e=this.cam.rotation.x+b;c.panMin!=null&&d<c.panMin?this.cam.rotation.y=c.panMin:c.panMax!=null&&d>c.panMax?this.cam.rotation.y=c.panMax:this.cam.rotation.y=d,c.tiltMin!=null&&e<c.tiltMin?this.cam.rotation.x=c.tiltMin:c.tiltMax!=null&&e>c.tiltMax?this.cam.rotation.x=c.tiltMax:this.cam.rotation.x=e,this.cam.updateMatrix(),this.update()},setLookAroundLimits:function(a,b,c,d){this.lookLimits.panMax=b,this.lookLimits.panMin=a,this.lookLimits.tiltMax=d,this.lookLimits.tiltMin=c;return this},setEasing:function(a){typeof a=="function"?this.easeFunc=[a,a,a]:this.easeFunc=[a.x||this.easeFunc[0],a.y||this.easeFunc[1],a.z||this.easeFunc[2]];return this},setEyeTarget:function(b,c){var d=[b.x-c.x,b.y-c.y,b.z-c.z],e=a.utils.cartesianToSpherical(d);this.distance=e[0],this.panTilt.position=c,this.panTilt.rotation.y=e[2],this.panTilt.rotation.x=e[1]-Math.PI/2,this.panTilt.updateMatrix(),this.cam.rotation.y=0,this.cam.rotation.x=0,this.cam.position.z=this.distance,this.cam.updateMatrix();var f=new THREE.Vector3(0,0,this.distance);a.utils.pointZAt(this.cam,f,a.utils.pointAsLocal(this.cam,c)),this.cam.rotation.y+=Math.PI,this.cam.updateMatrix(),this.updateWorldMatrices()},setLight:function(a){this.light.color.value=[a[0],a[1],a[2],1];return this},setOrthographic:function(a){this.mode.projection=a},setPerspective:function(){this.mode.projection=0},setZoomLimits:function(a,b){this.fov.min=a,this.fov.max=b,this.fov.current>this.fov.max&&(this.fov.current=this.fov.max),this.fov.current<this.fov.min&&(this.fov.current=this.fov.min)},truck:function(a){this.panTilt.translateZ(-a),this.panTilt.updateMatrix(),this.update()},interpolateView:function(a,b){var c=new THREE.Vector3,d=new THREE.Vector3,e=this.vd.last,f=this.vd.current,g=!1;if(this.state.curve){var h=this.easeFunc[0](a,0,1,b);c=this.state.curve.eye.interpolate(h),d=this.state.curve.target.interpolate(h)}else c.x=this.easeFunc[0](a,e.eye.x,f.eye.x-e.eye.x,b),c.y=this.easeFunc[1](a,e.eye.y,f.eye.y-e.eye.y,b),c.z=this.easeFunc[2](a,e.eye.z,f.eye.z-e.eye.z,b),d.x=this.easeFunc[0](a,e.target.x,f.target.x-e.target.x,b),d.y=this.easeFunc[1](a,e.target.y,f.target.y-e.target.y,b),d.z=this.easeFunc[2](a,e.target.z,f.target.z-e.target.z,b);f.fov!==e.fov&&(this.fov.current=this.easeFunc[0](a,e.fov,f.fov-e.fov,b),this.threeCamera.fov=this.fov.current*180/Math.PI,g=!0),f.np!==e.np&&(this.threeCamera.near=this.easeFunc[0](a,e.np,f.np-e.np,b),g=!0),f.fp!==e.fp&&(this.threeCamera.far=this.easeFunc[0](a,e.fp,f.fp-e.fp,b),g=!0),g&&this.threeCamera.updateProjectionMatrix(),this.setEyeTarget(c,d)},update:function(b){var c=this.state.time;this.state.moving&&(this.interpolateView(c.current,c.end),b!=undefined&&(c.current>=c.end&&(this.state.moving=!1,this.state.curve=null,this.state.vp!==null?(this.send(a.msg.stop,{viewpoint:this.state.vp}),this.state.vp=null):this.send(a.msg.stop,{viewdata:this.vd.current})),c.current+=b,c.current>=c.end&&(c.current=c.end))),this.updateWorldMatrices();var d=this.getEye(),e=this.getTarget();this.threeCamera.position=d,this.threeCamera.updateMatrix(),this.threeCamera.update(null,!0,null),this.threeCamera.lookAt(e),this.mode.fixedLight&&(this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale,this.light.updateMatrix())},updateWorldMatrices:function(){this.panTilt.update(null,!0,null)}},a.makeCitizen(a.CameraBase,"hemi.Camera",{cleanup:function(){a.removeRenderListener(this),this.disableControl(),this.threeCamera=null},msgs:[a.msg.start,a.msg.stop],toOctane:function(){var b=a.createViewData(this),c=[{name:this.mode.control?"enableControl":"disableControl",arg:[]},{name:"mode",val:this.mode},{name:"moveToView",arg:[b,0]}];return c}}),a.CameraCurve=function(a,b){this.eye=a,this.target=b},a.CameraCurve.prototype={constructor:a.CameraCurve,cleanup:function(){this._super(),this.eye=null,this.target=null},toOctane:function(){var a=this._super();a.props.push({name:"eye",oct:this.eye._toOctane()}),a.props.push({name:"target",oct:this.target._toOctane()});return a}},a.ViewData=function(b){var c=b||{};this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.ViewpointBase=function(b){var c=b||{};this.name=c.name||"",this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.ViewpointBase.prototype={getData:function(){return new a.ViewData(this)},setData:function(a){this.eye=a.eye,this.target=a.target,this.fov=a.fov,this.np=a.np,this.fp=a.fp}},a.makeCitizen(a.ViewpointBase,"hemi.Viewpoint",{toOctane:["eye","target","fov","np","fp"]}),a.createViewData=function(b){return new a.ViewData({eye:b.getEye(),target:b.getTarget(),fov:b.fov.current,np:b.threeCamera.near,fp:b.threeCamera.far})},a.createViewpoint=function(b,c){var d=new a.Viewpoint({name:b});d.setData(this.createViewData(c));return d},a.createCustomViewpoint=function(b,c,d,e,f,g){var h=new a.Viewpoint({name:b,eye:c,target:d,fov:e,np:f,fp:g});return h};return a}(hemi||{}),hemi=function(a){THREE.Object3D.prototype.pickable=!0;var b=function(a,c,d){for(var e=0;e<c.children.length;++e){var f=c.children[e];f.name===a&&d.push(f),b(a,f,d)}};a.ModelBase=function(a){this.client=a,this.fileName=null,this.root=null},a.ModelBase.prototype={getObject3Ds:function(a){var c=[];b(a,this.root,c);return c},load:function(){var b=this;a.loadCollada(this.fileName,function(c){b.root=c.scene,b.client.scene.add(b.root),b.send(a.msg.load,{})})},setFileName:function(a,b){this.fileName=a,this.load(b)}},a.makeCitizen(a.ModelBase,"hemi.Model",{cleanup:function(){this.client.scene.remove(this.root),this.client=null,this.root=null},msgs:[a.msg.load],toOctane:["client","fileName","load"]});return a}(hemi||{}),hemi=function(a){a.Picker=function(b,c){this.scene=b,this.camera=c,this.width=1,this.height=1,this.projector=new THREE.Projector,a.input.addMouseDownListener(this)},a.Picker.prototype={onMouseDown:function(b){var c=b.x/this.width*2-1,d=-(b.y/this.height)*2+1,e=new THREE.Vector3(c,d,.5);this.projector.unprojectVector(e,this.camera.threeCamera);var f=new THREE.Ray(this.camera.threeCamera.position,e.subSelf(this.camera.threeCamera.position).normalize()),g=f.intersectScene(this.scene);if(g.length>0)for(var h=0;h<g.length;++h)if(g[h].object.parent.pickable){a.send(a.msg.pick,{mouseEvent:b,pickedMesh:g[0].object.parent});break}},resize:function(a,b){this.width=a,this.height=b}};return a}(hemi||{}),hemi=function(a){a.ClientBase=function(){this.bgColor=0,this.bgAlpha=1,this.camera=new a.Camera,this.scene=new THREE.Scene,this.picker=new a.Picker(this.scene,this.camera),this.renderer=null,this.lights=[],this.useCameraLight(!0),a.clients.push(this)},a.ClientBase.prototype={addGrid:function(){var a=new THREE.LineBasicMaterial({color:13421772,opacity:.2}),b=new THREE.Geometry,c=-0.04,d=1,e=14;for(var f=0;f<=e/d*2;f++)b.vertices.push(new THREE.Vertex(new THREE.Vector3(-e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,e)));var g=new THREE.Line(b,a,THREE.LinePieces);this.scene.add(g)},addLight:function(a){var b=this.lights.indexOf(a);b===-1&&(this.lights.push(a),this.scene.add(a))},onRender:function(){this.renderer.render(this.scene,this.camera.threeCamera)},removeLight:function(a){var b=this.lights.indexOf(a);b>-1&&(this.lights.splice(b,1),this.scene.remove(a))},resize:function(){var a=this.renderer.domElement,b=Math.max(1,a.clientWidth),c=Math.max(1,a.clientHeight);this.renderer.setSize(b,c),this.camera.threeCamera.aspect=b/c,this.camera.threeCamera.updateProjectionMatrix(),this.picker.resize(b,c)},setBGColor:function(a,b){this.bgColor=a,this.bgAlpha=b==null?1:b,this.renderer.setClearColorHex(this.bgColor,this.bgAlpha)},setRenderer:function(b){var c=b.domElement;c.style.width="100%",c.style.height="100%",a.input.init(c),b.setClearColorHex(this.bgColor,this.bgAlpha),this.renderer=b,this.resize()},useCameraLight:function(a){a?this.addLight(this.camera.light):this.removeLight(this.camera.light)}},a.makeCitizen(a.ClientBase,"hemi.Client",{msgs:[],toOctane:function(){return[{name:"bgColor",val:this.bgColor},{name:"bgAlpha",val:this.bgAlpha},{name:"useCameraLight",arg:[!1]},{name:"camera",id:this.camera._getId()},{name:"useCameraLight",arg:[!0]}]}});return a}(hemi||{}),hemi=function(a){a.TranslatorBase=function(a,b){var c=b||{};this.pos=c.pos||new THREE.Vector3,this.vel=c.vel||new THREE.Vector3,this.accel=c.accel||new THREE.Vector3,this.time=0,this.stopTime=0,this.mustComplete=!1,this.steadyMove=!1,this.startPos=this.pos.clone(),this.stopPos=this.pos.clone(),this.toLoad={},this.transformObjs=[],a!=null&&this.addTransform(a),this.enable()},a.TranslatorBase.prototype={addTransform:function(a){this.transformObjs.push(a),applyTranslator.call(this,[a])},cleanup:function(){this.disable(),this.clearTransforms()},clear:function(){this.pos=new THREE.Vector3,this.vel=new THREE.Vector3,this.accel=new THREE.Vector3},clearTransforms:function(){while(this.transformObjs.length>0)this.removeTransform(this.transformObjs[0])},disable:function(){this.enabled&&(a.removeRenderListener(this),this.enabled=!1)},enable:function(){this.enabled=!0,shouldRender.call(this)},getTransforms:function(){var a=[];for(var b=0,c=this.transformObjs.length;b<c;b++)a.push(this.transformObjs[b]);return a},move:function(b,c,d){if(!this.enabled||this.mustComplete)return!1;this.time=0,this.stopTime=c||.001,this.steadyMove=!0,this.startPos=this.pos,this.mustComplete=d||!1,this.stopPos.add(this.pos,b),a.addRenderListener(this),this.send(a.msg.start,{});return!0},onRender:function(b){if(this.transformObjs.length>0){var c=b.elapsedTime;if(this.steadyMove){this.time+=c,this.time>=this.stopTime&&(this.time=this.stopTime,this.steadyMove=this.mustComplete=!1,a.removeRenderListener(this),this.send(a.msg.stop,{}));var d=this.time/this.stopTime,e=a.utils.lerp([this.startPos.x,this.startPos.y,this.startPos.z],[this.stopPos.x,this.stopPos.y,this.stopPos.z],d);this.pos.x=e[0],this.pos.y=e[1],this.pos.z=e[2]}else this.vel.addSelf(this.accel.clone().multiplyScalar(c)),this.pos.addSelf(this.vel.clone().multiplyScalar(c));applyTranslator.call(this)}},removeTransforms:function(a){var b=this.transformObjs.indexOf(a);b>-1&&this.transformObjs.splice(b,1)},setAccel:function(a){this.accel=a.clone(),shouldRender.call(this)},setPos:function(a){this.pos=a.clone(),applyTranslator.call(this)},setVel:function(a){this.vel=a.clone(),shouldRender.call(this)}},a.makeCitizen(a.TranslatorBase,"hemi.Translator",{msgs:["hemi.start","hemi.stop"],toOctane:[]}),shouldRender=function(){!this.enabled||this.accel.isZero()&&this.vel.isZero()?a.removeRenderListener(this):a.addRenderListener(this)},applyTranslator=function(b){var c=this.transformObjs;b&&(c=b);for(var d=0,e=c.length;d<e;d++){var f=c[d];a.utils.identity(f),f.position=this.pos.clone(),f.updateMatrix()}};return a}(hemi||{}),hemi=function(a){function g(){for(var a in c){var b=c[a]||[];for(var d=0;d<b.length;d++){var e=b[d];this.transform.remove(e)}delete c[a]}}function f(){var a=c[this.transform.clientId]||[];for(var d=0;d<this.boxes.length;d++){var e=this.boxes[d],f=e.max[0]-e.min[0],g=e.max[1]-e.min[1],h=e.max[2]-e.min[2],i=e.min[0]+f/2,j=e.min[1]+g/2,k=e.min[2]+h/2,l=new THREE.CubeGeometry(g,f,h),m=new THREE.Mesh(l,b);m.position.addSelf(new THREE.Vector3(i,j,k)),this.transform.add(m),a.push(m)}c[this.transform.clientId]=a}a.curve=a.curve||{};var b=new THREE.MeshPhongMaterial({color:136,wireframe:!0,wireframeLinewidth:1}),c={},d=null,e=[];a.curve.CurveType={Linear:0,Bezier:1,CubicHermite:2,LinearNorm:3,Cardinal:4,Custom:5},a.curve.ShapeType={CUBE:"cube",SPHERE:"sphere",ARROW:"arrow"},a.curve.Box=function(a,b){this.min=a||[],this.max=b||[]},a.curve.ColorKey=function(a,b){this.key=a,this.value=b},a.curve.ScaleKey=function(a,b){this.key=a,this.value=b},a.curve.drawCurve=function(a,b){},a.curve.drawLine=function(a,b,c,d){},a.curve.hideCurves=function(a){},a.curve.randomPoint=function(a,b){var c=Math.random(),d=Math.random(),e=Math.random(),f=c*a[0]+(1-c)*b[0],g=d*a[1]+(1-d)*b[1],h=e*a[2]+(1-e)*b[2];return[f,g,h]},a.curve.createSystem=function(b,c){var d;d=new a.curve.ParticleSystem(b,c);return d},a.curve.newMaterial=function(a,b){var c={color:0,opacity:1,transparent:b==null?!0:b},d;switch(a){case"lambert":d=new THREE.MeshLambertMaterial(c);break;case"phong":d=new THREE.MeshPhongMaterial(c);break;default:d=new THREE.MeshBasicMaterial(c)}return d},a.curve.Curve=function(a,b,c){this.count=0,this.tension=0,this.type=b,this.weights=[],this.xpts=[],this.xtans=[],this.ypts=[],this.ytans=[],this.zpts=[],this.ztans=[],a&&(c=c||{},c.points=a,this.loadConfig(c))},a.curve.Curve.prototype={toOctane:function(){var a=["count","tension","weights","xpts","xtans","ypts","ytans","zpts","ztans"],b={type:"hemi.curve.Curve",props:[]};for(var c=0,d=a.length;c<d;c++){var e=a[c];b.props.push({name:e,val:this[e]})}b.props.push({name:"setType",arg:[this.type]});return b},loadConfig:function(b){var c=b.points,d=b.type||this.type||a.curve.CurveType.Linear;this.setType(d);if(c){this.count=c.length;for(var e=0;e<this.count;e++)this.xpts[e]=c[e][0],this.ypts[e]=c[e][1],this.zpts[e]=c[e][2],this.xtans[e]=0,this.ytans[e]=0,this.ztans[e]=0,this.weights[e]=1}if(b.weights)for(var e=0;e<this.count;e++)this.weights[e]=b.weights[e]!=null?b.weights[e]:1;if(b.tangents)for(var e=0;e<this.count;e++)b.tangents[e]&&(this.xtans[e]=b.tangents[e][0]||0,this.ytans[e]=b.tangents[e][1]||0,this.ztans[e]=b.tangents[e][2]||0);b.tension&&(this.tension=b.tension),this.setTangents()},interpolate:function(a){return[a,a,a]},linear:function(a){var b=this.count-1,c=Math.floor(a*b);c>=b&&(c=b-1);var d=(a-c/b)/((c+1)/b-c/b),e=(1-d)*this.xpts[c]+d*this.xpts[c+1],f=(1-d)*this.ypts[c]+d*this.ypts[c+1],g=(1-d)*this.zpts[c]+d*this.zpts[c+1];return[e,f,g]},bezier:function(b){var c=0,d=0,e=0,f=0,g=this.count;for(var h=0;h<g;h++){var i=this.weights[h]*a.utils.choose(g-1,h)*Math.pow(b,h)*Math.pow(1-b,g-1-h);c+=i*this.xpts[h],d+=i*this.ypts[h],e+=i*this.zpts[h],f+=i}return[c/f,d/f,e/f]},cubicHermite:function(b){var c=this.count-1,d=Math.floor(b*c);d>=c&&(d=c-1);var e=(b-d/c)/((d+1)/c-d/c),f=a.utils.cubicHermite(e,this.xpts[d],this.xtans[d],this.xpts[d+1],this.xtans[d+1]),g=a.utils.cubicHermite(e,this.ypts[d],this.ytans[d],this.ypts[d+1],this.ytans[d+1]),h=a.utils.cubicHermite(e,this.zpts[d],this.ztans[d],this.zpts[d+1],this.ztans[d+1]);return[f,g,h]},linearNorm:function(b){var c=0,d=[];d[0]=0;for(var e=1;e<this.count;e++)c+=a.core.math.distance([this.xpts[e-1],this.ypts[e-1],this.zpts[e-1]],[this.xpts[e],this.ypts[e],this.zpts[e]]),d[e]=c;var f=b*c,g=0;for(var e=0;e<this.count;e++)d[e]<f&&(g=e);var h=(f-d[g])/(d[g+1]-d[g]),i=(1-h)*this.xpts[g]+h*this.xpts[g+1],j=(1-h)*this.ypts[g]+h*this.ypts[g+1],k=(1-h)*this.zpts[g]+h*this.zpts[g+1];return[i,j,k]},setTangents:function(){if(this.type==a.curve.CurveType.Cardinal){var b=a.utils.clone(this.xpts),c=a.utils.clone(this.ypts),d=a.utils.clone(this.zpts);b.unshift(b[0]),b.push(b[b.length-1]),c.unshift(c[0]),c.push(c[c.length-1]),d.unshift(d[0]),d.push(d[d.length-1]);for(var e=0;e<this.count;e++)this.xtans[e]=(1-this.tension)*(b[e+2]-b[e])/2,this.ytans[e]=(1-this.tension)*(c[e+2]-c[e])/2,this.ztans[e]=(1-this.tension)*(d[e+2]-d[e])/2}},setType:function(b){this.type=b;switch(b){case a.curve.CurveType.Linear:this.interpolate=this.linear;break;case a.curve.CurveType.Bezier:this.interpolate=this.bezier;break;case a.curve.CurveType.CubicHermite:case a.curve.CurveType.Cardinal:this.interpolate=this.cubicHermite;break;case a.curve.CurveType.LinearNorm:this.interpolate=this.linearNorm;break;case a.curve.CurveType.Custom:default:}},getEnd:function(){var a=this.count-1;return[this.xpts[a],this.ypts[a],this.zpts[a]]},getStart:function(){return[this.xpts[0],this.ypts[0],this.zpts[0]]},draw:function(b,c){var d=[];for(var e=0;e<b+2;e++)d[e]=this.interpolate(e/(b+1));a.curve.drawCurve(d,c)}},a.curve.Particle=function(b,c,d,e,f){this.transform=new THREE.Object3D,b.add(this.transform),this.transform.matrixAutoUpdate=!1,this.frame=1,this.lastFrame=c.length-2,this.destroyed=!1,this.material=new THREE.MeshPhongMaterial({color:0,transparent:!0}),this.lt=[],this.matrices=[],this.setColors(d);for(var g=this.frame;g<=this.lastFrame;g++){var h=new THREE.Matrix4,i=c[g];h.setTranslation(i[0],i[1],i[2]),f&&a.utils.pointYAt(h,c[g-1],c[g+1]),this.lt[g]=h}this.setScales(e),this.ready=!0,this.active=!1},a.curve.Particle.prototype={run:function(a){this.loops=a,this.ready=!1,this.active=!0},addShape:function(a){this.transform.add(new THREE.Mesh(a,this.material))},removeShapes:function(){for(var a=this.transform.children.length-1;a>=0;a--)this.transform.remove(this.transform.children[a])},setColors:function(a){this.colors=[];if(a){this.colorKeys=[];for(var b=0;b<a.length;b++){var c={},d=a[b];c.key=d.key;if(d.range){c.value=[];if(typeof d.range=="number"){var e=(Math.random()-.5)*2*d.range;for(var f=0;f<d.value.length;f++)c.value[f]=d.value[f]+e}else for(var f=0;f<d.value.length;f++)c.value[f]=d.value[f]+(Math.random()-.5)*2*d.range[f]}else c.value=d.value;this.colorKeys[b]=c}}else this.colorKeys=[{key:0,value:[0,0,0,1]},{key:1,value:[0,0,0,1]}];for(var b=1;b<=this.lastFrame;b++){var g=(b-1)/(this.lastFrame-2);this.colors[b]=this.lerpValue(g,this.colorKeys)}return this},setScales:function(a){this.scales=[];if(a){var b=[];for(var c=0;c<a.length;c++){var d={},e=a[c];d.key=e.key;if(e.range){d.value=[];if(typeof e.range=="number"){var f=(Math.random()-.5)*2*e.range;for(var g=0;g<e.value.length;g++)d.value[g]=e.value[g]+f}else for(var g=0;g<e.value.length;g++)d.value[g]=e.value[g]+(Math.random()-.5)*2*e.range[g]}else d.value=e.value;b[c]=d}}else b=[{key:0,value:[1,1,1]},{key:1,value:[1,1,1]}];for(var c=1;c<=this.lastFrame;c++){var h=(c-1)/(this.lastFrame-2),i=this.scales[c]=this.lerpValue(h,b);this.matrices[c]=(new THREE.Matrix4).copy(this.lt[c]).scale(new THREE.Vector3(i[0],i[1],i[2]))}return this},translate:function(a,b,c){this.transform.translateX(a),this.transform.translateY(b),this.transform.translateZ(c)},lerpValue:function(a,b){var c=b.length-2;while(b[c].key>a)c--;var d=b[c],e=b[c+1],f=(a-d.key)/(e.key-d.key),g=[],h=d.value.length;for(var i=0;i<h;++i)g[i]=(1-f)*d.value[i]+f*e.value[i];return g},update:function(){if(!!this.active){var a=this.frame,b=this.colors[a];this.material.color.setRGB(b[0],b[1],b[2]),this.material.opacity=b[3],this.transform.matrixWorldNeedsUpdate=!0,this.transform.matrix=this.matrices[a],this.frame++,this.transform.visible=!0;for(var c=0,d=this.transform.children.length;c<d;c++)this.transform.children[c].visible=!0;this.frame>=this.lastFrame&&(this.frame=1,this.loops--,this.loops===0&&this.reset())}},destroy:function(){if(!this.destroyed){var a=this.transform,b=a.parent;for(var c=a.children.length-1;c>=0;c--)a.remove(a.children[c]);b&&b.remove(a),this.transform=null,this.curve=null,this.destroyed=!0}},reset:function(){this.transform.visible=!1;for(var a=0,b=this.transform.children.length;a<b;a++)this.transform.children[a].visible=!1;this.loops=this.totalLoops,this.destroyed=!1,this.active=!1,this.ready=!0}},a.curve.ParticleSystem=function(b,c){this.transform=new THREE.Object3D,c.parent?c.parent.add(this.transform):b.scene.add(this.transform),this.active=!1,this.pLife=c.life||5,this.boxes=c.boxes,this.maxParticles=c.particleCount||25,this.maxRate=Math.ceil(this.maxParticles/this.pLife),this.particles=[],this.pRate=this.maxRate,this.pTimer=0,this.pTimerMax=1/this.pRate,this.pIndex=0,this.shapeMaterial=new THREE.MeshBasicMaterial({color:16711680,transparent:!0});var d=c.particleShape||a.curve.ShapeType.CUBE,e=c.particleSize||1;this.shapes=[],this.size=e;switch(d){case a.curve.ShapeType.ARROW:var f=e/2;case a.curve.ShapeType.CUBE:this.shapes.push(new THREE.CubeGeometry(e,e,e));break;case a.curve.ShapeType.SPHERE:this.shapes.push(new THREE.SphereGeometry(e,12,12))}a.addRenderListener(this),this.boxesOn=!1,this.points=[],this.frames=c.frames||this.pLife*b.camera.FPS;for(var g=0;g<this.maxParticles;g++){var h=this.newCurve(c.tension||0);this.points[g]=[];for(var i=0;i<this.frames;i++)this.points[g][i]=h.interpolate(i/this.frames)}console.log(this);var j=null,k=null;if(c.colorKeys)j=c.colorKeys;else if(c.colors){var l=c.colors.length,m=l===1?1:1/(l-1);j=[];for(var i=0;i<l;i++)j.push({key:i*m,value:c.colors[i]})}if(c.scaleKeys)k=c.scaleKeys;else if(c.scales){var l=c.scales.length,m=l===1?1:1/(l-1);k=[];for(var i=0;i<l;i++)k.push({key:i*m,value:c.scales[i]})}for(i=0;i<this.maxParticles;i++){this.particles[i]=new a.curve.Particle(this.transform,this.points[i],j,k,c.aim);for(var g=0;g<this.shapes.length;g++)this.particles[i].addShape(this.shapes[g])}},a.curve.ParticleSystem.prototype={start:function(){this.active=!0},stop:function(a){this.active=!1;if(a)for(var b=0;b<this.maxParticles;b++)this.particles[b]!=null&&this.particles[b].reset()},onRender:function(a){for(var b=0;b<this.maxParticles;b++)this.particles[b]!=null&&this.particles[b].update(a);if(!!this.active){this.pTimer+=a.elapsedTime;if(this.pTimer>=this.pTimerMax){this.pTimer=0;var c=this.particles[this.pIndex];c.ready&&c.run(1),this.pIndex++,this.pIndex>=this.maxParticles&&(this.pIndex=0)}}},newCurve:function(b){var c=[],d=this.boxes.length;for(var e=0;e<d;e++){var f=this.boxes[e].min,g=this.boxes[e].max;c[e+1]=a.curve.randomPoint(f,g)}c[0]=c[1].slice(0,3),c[d+1]=c[d].slice(0,3);var h=new a.curve.Curve(c,a.curve.CurveType.Cardinal,{tension:b});return h},removeShapes:function(){for(var a=0;a<this.maxParticles;a++)this.particles[a].removeShapes();this.shapes=[]},addShape:function(b){var c=a.curve.pack,d=this.shapes.length;if(typeof b=="string"){var e=this.size;switch(b){case a.curve.ShapeType.ARROW:var f=e/2;case a.curve.ShapeType.CUBE:this.shapes.push(new THREE.CubeGeometry(e,e,e));break;case a.curve.ShapeType.SPHERE:this.shapes.push(new THREE.SphereGeometry(e,24,12))}}else this.shapes.push(b);for(var g=0;g<this.maxParticles;g++)for(var h=d;h<this.shapes.length;h++)this.particles[g].addShape(this.shapes[h])},changeRate:function(a){return this.setRate(this.pRate+a)},setRate:function(b){var c=a.utils.clamp(b,0,this.maxRate);c===0?(this.pTimerMax=0,this.stop()):(this.pRate===0&&c>0&&this.start(),this.pTimerMax=1/c),this.pRate=c;return c},setColors:function(a){for(var b=0;b<this.maxParticles;b++)this.particles[b].setColors(a);return this},setScales:function(a){for(var b=0;b<this.maxParticles;b++)this.particles[b].setScales(a);return this},showBoxes:function(){f.call(this)},hideBoxes:function(){g.call(this)},translate:function(a,b,c){this.transform.position.addSelf(new THREE.Vector(a,b,c)),this.transform.updateMatrix()}};return a}(hemi||{}),hemi=function(a){function f(a){var b,c,e,f,g,h,i=a.object,j=a.buffer,k=a.opaque,l=a.transparent;l.count=0,k.count=0;for(e=0,f=i.materials.length;e<f;e++){h=i.materials[e];if(h instanceof THREE.MeshFaceMaterial)for(b=0,c=j.materials.length;b<c;b++)g=j.materials[b],g&&(g.transparent?d(l,g):d(k,g));else g=h,g&&(g.transparent?d(l,g):d(k,g))}}function e(a){var b,c,e,f,g,h=a.object,i=a.opaque,j=a.transparent;j.count=0,i.count=0;for(e=0,f=h.materials.length;e<f;e++)g=h.materials[e],g.transparent?d(j,g):d(i,g)}function d(a,b){a.list[a.count]=b,a.count+=1}function c(a){var c=null;for(var d=0,e=b.length;d<e&&c==null;d++)b[d].client===a&&(c=b[d]);return c}a.fx=a.fx||{};var b=[];a.fx.cleanup=function(){b=[]},a.fx.clearFog=function(a){var b=c(a);if(b&&b.fog){a.scene.fog=undefined,a.setBGColor(b.oldBGHex,b.oldBGAlpha);for(var d=0,e=b.materials.length;d<e;d++){var f=b.materials[d];a.renderer.initMaterial(f.mat,a.scene.lights,a.scene.fog,f.obj)}}},a.fx.setFog=function(a,d,e,f,g){var h=c(a),i=a.scene.__webglObjects.concat(a.scene.__webglObjectsImmediate),j=[],k=!1;h||(h={client:a},b.push(h)),h.fog||(h.fog=new THREE.Fog,h.oldBGHex=a.renderer.getClearColor().getHex(),h.oldBGAlpha=a.renderer.getClearAlpha(),k=!0),h.fog.color.setHex(d),h.fog.near=f,h.fog.far=g,a.scene.fog=h.fog,a.setBGColor(d,e);if(k){for(var l=0,m=i.length;l<m;l++){var n=i[l],o=n.object,p=n.opaque,q=n.transparent;for(var r=0,s=p.count;r<s;r++)j.push({mat:p.list[r],obj:o});for(var r=0,s=q.count;r<s;r++)j.push({mat:q.list[r],obj:o})}h.materials=j}for(var l=0,m=h.materials.length;l<m;l++){var t=h.materials[l],u=t.mat,o=t.obj,v=a.scene.fog;if(k)a.renderer.initMaterial(u,a.scene.lights,v,o);else{var w=u.uniforms;w.fogColor.value=v.color,w.fogNear.value=v.near,w.fogFar.value=v.far}}},a.fx.setOpacity=function(a,b,c,d){var g=a.scene.__webglObjects.concat(a.scene.__webglObjectsImmediate),h=null;for(var i=0,j=g.length;i<j&&h==null;i++){var k=g[i];if(k.object.parent===b||k.object===b)h=k}h&&(c.transparent=d<1,c.opacity=d,h.transparent.list=[],h.opaque.list=[],f(h),e(h))};return a}(hemi||{}),hemi=function(a){var b=function(b){b.reset(),b.send(a.msg.stop,{time:b.startTime})};a.TimerBase=function(){this._started=null,this._time=0,this._timeId=null,this.startTime=1e3},a.TimerBase.prototype={pause:function(){if(this._timeId!==null){clearTimeout(this._timeId),this._timeId=null;var a=(new Date).getTime();this._time+=a-this._started}},reset:function(){this._started=null,this._time=0,this._timeId=null},resume:function(){this._timeId===null&&this._started!==null&&(this._timeId=setTimeout(b,this.startTime-this._time,this),this._started=(new Date).getTime())},start:function(){this._timeId!==null&&clearTimeout(this._timeId),this._time=0,this.send(a.msg.start,{time:this.startTime}),this._timeId=setTimeout(b,this.startTime,this),this._started=(new Date).getTime()},stop:function(){if(this._timeId!==null){clearTimeout(this._timeId);var b=(new Date).getTime();this._time+=b-this._started}if(this._started!==null){var c=this._time;this.reset(),this.send(a.msg.stop,{time:c})}}},a.makeCitizen(a.TimerBase,"hemi.Timer",{cleanup:function(){this._timeId!==null&&(clearTimeout(this._timeId),this._timeId=null,this._started=null)},msgs:[a.msg.start,a.msg.stop],toOctane:["startTime"]});return a}(hemi||{})