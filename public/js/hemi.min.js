/**
 * @author alteredq / http://alteredqualia.com/
 * @author mr.doob / http://mrdoob.com/
 */
Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.textAlign="center",a.style.background="#eee",a.style.color="#000",a.style.padding="1em",a.style.width="475px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"));return a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=a.parent!==undefined?a.parent:document.body,c=a.id!==undefined?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}}/**
 * Copyright 2009 Tim Down.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Hashtable=(function(){var w="undefined",f="function",k="string",j="equals",t="hashCode",o="toString";var r=(typeof Array.prototype.splice==f)?function(y,x){y.splice(x,1)}:function(A,z){var y,B,x;if(z===A.length-1){A.length=z}else{y=A.slice(z+1);A.length=z;for(B=0,x=y.length;B<x;++B){A[z+B]=y[B]}}};function v(y){var x;if(typeof y==k){return y}else{if(typeof y[t]==f){x=y.hashCode();return(typeof x==k)?x:v(x)}else{if(typeof y[o]==f){return y.toString()}else{return String(y)}}}}function s(x,y){return x.equals(y)}function b(x,y){return(typeof y[j]==f)?y.equals(x):(x===y)}function d(x){return function(y){if(y===null){throw new Error("null is not a valid "+x)}else{if(typeof y==w){throw new Error(x+" must not be undefined")}}}}var g=d("key"),c=d("value");function i(y,z,x){this.entries=[];this.addEntry(y,z);if(x!==null){this.getEqualityFunction=function(){return x}}}var a=0,l=1,h=2;function p(x){return function(z){var y=this.entries.length,B,A=this.getEqualityFunction(z);while(y--){B=this.entries[y];if(A(z,B[0])){switch(x){case a:return true;case l:return B;case h:return[y,B[1]]}}}return false}}function u(x){return function(A){var B=A.length;for(var z=0,y=this.entries.length;z<y;++z){A[B+z]=this.entries[z][x]}}}i.prototype={getEqualityFunction:function(x){return(typeof x[j]==f)?s:b},getEntryForKey:p(l),getEntryAndIndexForKey:p(h),removeEntryForKey:function(y){var x=this.getEntryAndIndexForKey(y);if(x){r(this.entries,x[0]);return x[1]}return null},addEntry:function(x,y){this.entries[this.entries.length]=[x,y]},keys:u(0),values:u(1),getEntries:function(y){var A=y.length;for(var z=0,x=this.entries.length;z<x;++z){y[A+z]=this.entries[z].slice(0)}},containsKey:p(a),containsValue:function(y){var x=this.entries.length;while(x--){if(y===this.entries[x][1]){return true}}return false}};function q(){}q.prototype=[];function e(A,x){var y=A.length,z;while(y--){z=A[y];if(x===z[0]){return y}}return null}function n(y,x){var z=y[x];return(z&&(z instanceof q))?z[1]:null}function m(A,x){var B=this;var E=[];var y={};var C=(typeof A==f)?A:v;var z=(typeof x==f)?x:null;this.put=function(I,K){g(I);c(K);var F=C(I),J,H,G=null;var L=n(y,F);if(L){H=L.getEntryForKey(I);if(H){G=H[1];H[1]=K}else{L.addEntry(I,K)}}else{J=new q();J[0]=F;J[1]=new i(I,K,z);E[E.length]=J;y[F]=J}return G};this.get=function(H){g(H);var F=C(H);var I=n(y,F);if(I){var G=I.getEntryForKey(H);if(G){return G[1]}}return null};this.containsKey=function(G){g(G);var F=C(G);var H=n(y,F);return H?H.containsKey(G):false};this.containsValue=function(G){c(G);var F=E.length;while(F--){if(E[F][1].containsValue(G)){return true}}return false};this.clear=function(){E.length=0;y={}};this.isEmpty=function(){return !E.length};var D=function(F){return function(){var G=[],H=E.length;while(H--){E[H][1][F](G)}return G}};this.keys=D("keys");this.values=D("values");this.entries=D("getEntries");this.remove=function(I){g(I);var G=C(I),F,H=null;var J=n(y,G);if(J){H=J.removeEntryForKey(I);if(H!==null){if(!J.entries.length){F=e(E,G);r(E,F);y[G]=null;delete y[G]}}}return H};this.size=function(){var G=0,F=E.length;while(F--){G+=E[F][1].entries.length}return G};this.each=function(I){var F=B.entries(),G=F.length,H;while(G--){H=F[G];I(H[0],H[1])}};this.putAll=function(N,I){var H=N.entries();var K,L,J,F,G=H.length;var M=(typeof I==f);while(G--){K=H[G];L=K[0];J=K[1];if(M&&(F=B.get(L))){J=I(L,F,J)}B.put(L,J)}};this.clone=function(){var F=new m(A,x);F.putAll(B);return F}}return m})();var hemi=function(a){a.particles=a.particles||{};var b=function(a){var b=new Uint8Array(a.length),c;for(var d=0;d<a.length;++d)c=a[d]*256,b[d]=c>255?255:c<0?0:c;return b},c={particle3d:{attributes:{uvLifeTimeFrameStart:{type:"v4",value:[]},positionStartTime:{type:"v4",value:[]},velocityStartSize:{type:"v4",value:[]},accelerationEndSize:{type:"v4",value:[]},spinStartSpinSpeed:{type:"v4",value:[]},orientation:{type:"v4",value:[]},colorMult:{type:"v4",value:[]}},uniforms:{worldVelocity:{type:"v3",value:new THREE.Vector3},worldAcceleration:{type:"v3",value:new THREE.Vector3},timeRange:{type:"f",value:0},time:{type:"f",value:0},timeOffset:{type:"f",value:0},frameDuration:{type:"f",value:0},numFrames:{type:"f",value:0},rampSampler:{type:"t",value:0,texture:null},colorSampler:{type:"t",value:1,texture:null}},vertexShader:"uniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart; \nattribute vec4 positionStartTime; \nattribute vec4 velocityStartSize; \nattribute vec4 accelerationEndSize; \nattribute vec4 spinStartSpinSpeed; \nattribute vec4 orientation; \nattribute vec4 colorMult; \n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (objectMatrix * vec4(velocityStartSize.xyz, 0)).xyz\n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (objectMatrix *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime),\n      timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.0,\n                               (uv.x * s - uv.y * c) * size, 1.0);\n  vec3 center = velocity * localTime +\n                  acceleration * localTime * localTime + \n                  position;\n  \n      vec4 q2 = orientation + orientation;\n      vec4 qx = orientation.xxxw * q2.xyzx;\n      vec4 qy = orientation.xyyw * q2.xyzy;\n      vec4 qz = orientation.xxzw * q2.xxzz;\n  \n      mat4 localMatrix = mat4(\n        (1.0 - qy.y) - qz.z, \n        qx.y + qz.w, \n        qx.z - qy.w,\n        0,\n  \n        qx.y - qz.w, \n        (1.0 - qx.x) - qz.z, \n        qy.z + qx.w,\n        0,\n  \n        qx.z + qy.w, \n        qy.z - qx.w, \n        (1.0 - qx.x) - qy.y,\n        0,\n  \n        center.x, center.y, center.z, 1.0);\n  rotatedPoint = localMatrix * rotatedPoint;\n  gl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n  v_percentLife = percentLife;\n}\n",fragmentShader:"varying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n"},particle2d:{attributes:{uvLifeTimeFrameStart:{type:"v4",value:[]},positionStartTime:{type:"v4",value:[]},velocityStartSize:{type:"v4",value:[]},accelerationEndSize:{type:"v4",value:[]},spinStartSpinSpeed:{type:"v4",value:[]},colorMult:{type:"v4",value:[]}},uniforms:{viewInverse:{type:"m4",value:null},worldVelocity:{type:"v3",value:new THREE.Vector3},worldAcceleration:{type:"v3",value:new THREE.Vector3},timeRange:{type:"f",value:0},time:{type:"f",value:0},timeOffset:{type:"f",value:0},frameDuration:{type:"f",value:0},numFrames:{type:"f",value:0},rampSampler:{type:"t",value:0,texture:null},colorSampler:{type:"t",value:1,texture:null}},vertexShader:"uniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart; \nattribute vec4 positionStartTime; \nattribute vec4 velocityStartSize; \nattribute vec4 accelerationEndSize; \nattribute vec4 spinStartSpinSpeed; \nattribute vec4 colorMult; \n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = (objectMatrix * vec4(positionStartTime.xyz, 1.0)).xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (objectMatrix * vec4(velocityStartSize.xyz, 0)).xyz \n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (objectMatrix *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime),\n      timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  vec3 basisX = viewInverse[0].xyz;\n  vec3 basisZ = viewInverse[1].xyz;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n                               -uv.x * s + uv.y * c);\n  vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                                basisZ * rotatedPoint.y) * size +\n                         velocity * localTime +\n                         acceleration * localTime * localTime + \n                         position;\n\n  gl_Position = (projectionMatrix * viewMatrix * vec4(localPosition, 1.0));\n  v_percentLife = percentLife;\n}\n",fragmentShader:"varying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n"}},d=[[-0.5,-0.5],[.5,-0.5],[.5,.5],[-0.5,.5]];a.particles.System=function(a){var c=[0,.2,.7,1,.7,.2,0,0],d=[];for(var e=0;e<8;++e)for(var f=0;f<8;++f){var g=c[f]*c[e];d.push(g,g,g,g)}var h=b(d),i=new THREE.DataTexture(h,8,8,THREE.RGBAFormat),j=b([1,1,1,1,1,1,1,.5,1,1,1,0]),k=new THREE.DataTexture(j,3,1,THREE.RGBAFormat);i.needsUpdate=k.needsUpdate=!0,this._randomFunction=a||function(){return Math.random()},this.defaultColorTexture=i,this.defaultRampTexture=k,this.emitters=[]},a.particles.System.prototype.createEmitter=function(b,c){return new a.particles.Emitter(this,b,c)},a.particles.System.prototype.createTrail=function(b,c,d,e,f){return new a.particles.Trail(this,b,c,d,e,f)},a.particles.System.prototype.update=function(a){for(var b=0,c=this.emitters.length;b<c;++b)this.emitters[b]._timeParam.value+=a},a.particles.Spec=function(){this.numParticles=1,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.lifeTimeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.position=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.worldAcceleration=[0,0,0],this.billboard=!0,this.orientation=[0,0,0,1]},a.particles.Emitter=function(a,b,c){this._camera=b,this._colorTexture=c||null,this._particleSystem=null,this._rampTexture=null,this._timeParam=null,this.material=new THREE.ShaderMaterial({blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0}),this.material.name="particles",this.shape=new THREE.Geometry,a&&(this._colorTexture=c||a.defaultColorTexture,this._rampTexture=a.defaultRampTexture,this._particleSystem=a,a.emitters.push(this))},a.particles.Emitter.prototype.setBlending=function(a){this.material.blending=a},a.particles.Emitter.prototype.setColorRamp=function(c){var d=c.length/4;d%1!==0&&a.error("colorRamp must have multiple of 4 entries");var e=b(c);this._rampTexture===this._particleSystem.defaultRampTexture||this._rampTexture.image.width!==d?(this._rampTexture=new THREE.DataTexture(e,d,1,THREE.RGBAFormat),this._rampTexture.needsUpdate=!0,this.uniforms&&(this.uniforms.rampSampler.texture=this._rampTexture)):this._rampTexture.image.data=e},a.particles.Emitter.prototype.validateParameters=function(b){var c=new a.particles.Spec;for(var d in b)typeof c[d]=="undefined"&&a.error('unknown particle parameter "'+d+'"');for(d in c)typeof b[d]=="undefined"&&(b[d]=c[d])},a.particles.Emitter.prototype.setParameters=function(a,b){g.call(this,a);var c=a.numParticles;e.call(this,c),f.call(this,0,c,a,b)},a.particles.Emitter.prototype.createOneShot=function(b){return new a.particles.OneShot(this,b)},a.particles.OneShot=function(a,b){this._emitter=a,this._timeOffsetParam=a.material.uniforms.timeOffset,this.transform=new THREE.Mesh(a.shape,a.material),this.transform.doubleSided=!0,this.transform.visible=!1,b&&b.add(this.transform)},a.particles.OneShot.prototype.trigger=function(a,b){b&&b.add(this._transform),a&&this._transform.position.copy(a),this._transform.visible=!0,this._timeOffsetParam.value=this._emitter._timeParam.value},a.particles.Trail=function(b,c,d,f,h,i){a.particles.Emitter.call(this,b,c,h),this._birthIndex=0,this._maxParticles=d,this._parameters=f,this._paramSetter=i,e.call(this,d),g.call(this,f)},a.particles.Trail.prototype=new a.particles.Emitter,a.particles.Trail.constructor=a.particles.Trail,a.particles.Trail.prototype.birthParticles=function(a){var b=this._parameters.numParticles;this._parameters.startTime=this._timeParam.value,this._parameters.position=a;while(this._birthIndex+b>=this._maxParticles){var c=this._maxParticles-this._birthIndex;f.call(this,this._birthIndex,c,this._parameters,this._paramSetter),b-=c,this._birthIndex=0}f.call(this,this._birthIndex,b,this._parameters,this._paramSetter),this._birthIndex+=b};var e=function(a){for(var b=0;b<a;++b){for(var c=0;c<4;++c)this.shape.vertices.push(new THREE.Vertex);var d=b*4;this.shape.faces.push(new THREE.Face3(d,d+1,d+2)),this.shape.faces.push(new THREE.Face3(d,d+2,d+3))}},f=function(a,b,c,e){var f=this.material.attributes,g=this.material.uniforms,h=f.uvLifeTimeFrameStart;positionStartTime=f.positionStartTime,velocityStartSize=f.velocityStartSize,accelerationEndSize=f.accelerationEndSize,spinStartSpinSpeed=f.spinStartSpinSpeed,orientation=f.orientation,colorMult=f.colorMult,wv=c.worldVelocity,wa=c.worldAcceleration,random=this._particleSystem._randomFunction,plusMinus=function(a){return(random()-.5)*a*2},plusMinusVector=function(a,b){var c=[];for(var d=0,e=a.length;d<e;++d)c[d]=a[d]+plusMinus(b[d]);return c},g.colorSampler.texture=this._colorTexture,g.rampSampler.texture=this._rampTexture,g.timeRange.value=c.timeRange,g.numFrames.value=c.numFrames,g.frameDuration.value=c.frameDuration,g.worldVelocity.value.set(wv[0],wv[1],wv[2]),g.worldAcceleration.value.set(wa[0],wa[1],wa[2]),c.billboard&&(g.viewInverse.value=this._camera.matrixWorld);for(var i=0;i<b;++i){e&&e(i,c);var j=c.lifeTime,k=c.startTime===null?i*j/b:c.startTime,l=c.frameStart+plusMinus(c.frameStartRange),m=plusMinusVector(c.position,c.positionRange),n=plusMinusVector(c.velocity,c.velocityRange),o=plusMinusVector(c.acceleration,c.accelerationRange),p=plusMinusVector(c.colorMult,c.colorMultRange),q=c.spinStart+plusMinus(c.spinStartRange),r=c.spinSpeed+plusMinus(c.spinSpeedRange),s=c.startSize+plusMinus(c.startSizeRange),t=c.endSize+plusMinus(c.endSizeRange),u=c.orientation;for(var v=0;v<4;++v){var w=i*4+v+a;h.value[w]=new THREE.Vector4(d[v][0],d[v][1],j,l),positionStartTime.value[w]=new THREE.Vector4(m[0],m[1],m[2],k),velocityStartSize.value[w]=new THREE.Vector4(n[0],n[1],n[2],s),accelerationEndSize.value[w]=new THREE.Vector4(o[0],o[1],o[2],t),spinStartSpinSpeed.value[w]=new THREE.Vector4(q,r,0,0),colorMult.value[w]=new THREE.Vector4(p[0],p[1],p[2],p[3]),orientation&&(orientation.value[w]=new THREE.Vector4(u[0],u[1],u[2],u[3]))}}h.needsUpdate=!0,positionStartTime.needsUpdate=!0,velocityStartSize.needsUpdate=!0,accelerationEndSize.needsUpdate=!0,spinStartSpinSpeed.needsUpdate=!0,colorMult.needsUpdate=!0,orientation&&(orientation.needsUpdate=!0)},g=function(a){this.validateParameters(a);var b=c[a.billboard?"particle2d":"particle3d"];this.material.attributes=THREE.UniformsUtils.clone(b.attributes),this.material.uniforms=THREE.UniformsUtils.clone(b.uniforms),this.material.vertexShader=b.vertexShader,this.material.fragmentShader=b.fragmentShader,this._timeParam=this.material.uniforms.time};return a}(hemi||{})/*
 * Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 * The MIT License (MIT)
 * 
 * Copyright (c) 2011 SRI International
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated  documentation files (the "Software"), to deal in the Software without restriction,
 * including without limitation the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or
 * substantial portions of the  Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT
 * NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
var hemi=function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;a.Class=function(){},a.Class.extend=function(a){function g(){!b&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;b=!0;var e=new this;b=!1;for(var f in a)e[f]=typeof a[f]=="function"&&typeof d[f]=="function"&&c.test(a[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);this._super=c;return e}}(f,a[f]):a[f];g.prototype=e,g.constructor=g,g.extend=arguments.callee;return g};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.Hashtable=Hashtable,a.utils.Hashtable.prototype.query=function(b){var c=this.values(),d=[],e=[],f=[],g,h,i,j,k,l,m,n;for(x in b)a.utils.isArray(b[x])?e.push(x):d.push(x);var o=d.length,p=e.length;for(var q=0,r=c.length;q<r;q++){g=c[q],n=!0;for(k=0;n&&k<o;k++)h=d[k],n=g[h]===b[h];for(k=0;n&&k<p;k++){n=!1,h=e[k],i=g[h],j=b[h],m=j.length;for(l=0;!n&&l<m;l++)n=i===j[l]}n&&f.push(g)}return f};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.clone=function(b,c){var d=a.utils.isArray(b)?[]:{},c=c==null?!0:c;a.utils.join(d,b,c);return d},a.utils.compareArrays=function(b,c){var d=b.length===c.length;for(var e=0;d&&e<b.length;e++)b[e]instanceof Array?d=a.utils.compareArrays(b[e],c[e]):d=Math.abs(b[e]-c[e])<=.001;return d},a.utils.get=function(b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){if(this.readyState===4){this.onreadystatechange=a.utils.noop;var b=null;if(this.status===200||window.location.href.indexOf("http")===-1){var d=this.getResponseHeader("content-type");d&&d.indexOf("xml")>=0?b=this.responseXML:b=this.responseText}c(b,this.statusText)}},d.open("GET",b,!0);try{d.send(null)}catch(e){c(null,e.name+": "+e.message)}},a.utils.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},a.utils.isFunction=function(a){return Object.prototype.toString.call(a)==="[object Function]"},a.utils.join=function(){var b=arguments[0],c=arguments.length,d=arguments[c-1],e=!0;typeof d=="boolean"&&(e=d,--c);for(var f=1;f<c;f++){var g=arguments[f];for(var h in g){var i=g[h];if(e&&i!=null&&typeof i=="object"){var j=b[h],k=a.utils.isArray(i);if(j==null||typeof j!="object"||a.utils.isArray(j)!==k)j=k?[]:{};b[h]=a.utils.join(j,i)}else b[h]=i}}return b},a.utils.noop=function(){};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.cartesianToSpherical=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d),f=Math.acos(c/e),g=Math.atan2(b,d);return[e,f,g]},a.utils.choose=function(b,c){return a.utils.factorial(b,b-c+1)/a.utils.factorial(c)},a.utils.clamp=function(a,b,c){return Math.min(c,Math.max(b,a))},a.utils.cubicHermite=function(a,b,c,d,e){var f=a*a,g=f*a,h=2*g-3*f+1,i=g-2*f+a,j=-2*g+3*f,k=g-f;return h*b+i*c+j*d+k*e},a.utils.factorial=function(a,b){var c=1,d=b?b:2;while(d<=a)c*=d++;return c},a.utils.intersect=function(b,c){var d=a.utils.inverse([[b.direction.x,c[1].x-c[0].x,c[2].x-c[0].x],[b.direction.y,c[1].y-c[0].y,c[2].y-c[0].y],[b.direction.z,c[1].z-c[0].z,c[2].z-c[0].z]]),e=[b.origin.x-c[0].x,b.origin.y-c[0].y,b.origin.z-c[0].z],f=d[0][0]*e[0]+d[0][1]*e[1]+d[0][2]*e[2],g=d[1][0]*e[0]+d[1][1]*e[1]+d[1][2]*e[2],h=d[2][0]*e[0]+d[2][1]*e[1]+d[2][2]*e[2];return[f,g,h]},a.utils.lerp=function(b,c,d){var e;if(a.utils.isArray(b)){e=[];for(var f=0;f<b.length;++f)e[f]=a.utils.lerp(b[f],c[f],d)}else e=b+(c-b)*d;return e},a.utils.linearToSine=function(b){return(Math.sin(Math.PI*b-a.HALF_PI)+1)/2},a.utils.linearToParabolic=function(a){return a*a},a.utils.linearToParabolicInverse=function(a){return 1-(1-a)*(1-a)},a.utils.linearToExponential=function(a,b){return(Math.pow(b,a)-1)/(b-1)},a.utils.linearToExponentialInverse=function(b,c){return 1-a.utils.linearToExponential(1-b,c)},a.utils.penner={linearTween:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d){a/=d;return c*a*a+b},easeOutQuad:function(a,b,c,d){a/=d;return-c*a*(a-2)+b},easeInOutQuad:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a+b;a--;return-c/2*(a*(a-2)-1)+b},easeInCubic:function(a,b,c,d){a/=d;return c*a*a*a+b},easeOutCubic:function(a,b,c,d){a/=d,a--;return c*(a*a*a+1)+b},easeInOutCubic:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a+b;a-=2;return c/2*(a*a*a+2)+b},easeInQuart:function(a,b,c,d){a/=d;return c*a*a*a*a+b},easeOutQuart:function(a,b,c,d){a/=d,a--;return-c*(a*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a*a+b;a-=2;return-c/2*(a*a*a*a-2)+b},easeInQuint:function(a,b,c,d){a/=d;return c*a*a*a*a*a+b},easeOutQuint:function(a,b,c,d){a/=d,a--;return c*(a*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a*a*a+b;a-=2;return c/2*(a*a*a*a*a+2)+b},easeInSine:function(b,c,d,e){return-d*Math.cos(b/e*a.HALF_PI)+d+c},easeOutSine:function(b,c,d,e){return d*Math.sin(b/e*a.HALF_PI)+c},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){a/=d/2;if(a<1)return c/2*Math.pow(2,10*(a-1))+b;a--;return c/2*(-Math.pow(2,-10*a)+2)+b},easeInCirc:function(a,b,c,d){a/=d;return-c*(Math.sqrt(1-a*a)-1)+b},easeOutCirc:function(a,b,c,d){a/=d,a--;return c*Math.sqrt(1-a*a)+b},easeInOutCirc:function(a,b,c,d){a/=d/2;if(a<1)return-c/2*(Math.sqrt(1-a*a)-1)+b;a-=2;return c/2*(Math.sqrt(1-a*a)+1)+b}},a.utils.sphericalToCartesian=function(a){var b=a[0],c=a[1],d=a[2];return[b*Math.sin(c)*Math.cos(d),b*Math.sin(c)*Math.sin(d),b*Math.cos(c)]},a.utils.uvToXYZ=function(a,b){var c=(new THREE.Vector3).sub(b[1],b[0]).multiplyScalar(a[0]),d=(new THREE.Vector3).sub(b[2],b[0]).multiplyScalar(a[1]),e=c.addSelf(d).addSelf(b[0]);return e},a.utils.worldToScreen=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[Math.round(k),Math.round(l)]},a.utils.worldToScreenFloat=function(a,b){var c=a.camera.threeCamera.matrixWorldInverse.multiplyVector3(b.clone()),d=a.camera.threeCamera.projectionMatrix.multiplyVector3(c.clone());c.z>0&&(d.x=-d.x,d.y=-d.y);var e=(d.x+1)*.5*a.getWidth(),f=(-d.y+1)*.5*a.getHeight();return new THREE.Vector3(e,f,d.z)},a.utils.computeNormal=function(a,b,c){var d=new THREE.Vector3,e=new THREE.Vector3;d.sub(c.position,b.position),e.sub(a.position,b.position),d.crossSelf(e),d.isZero()||d.normalize();return d},a.utils.inverse=function(a){var b=a[1][1]*a[2][2]-a[1][2]*a[2][1],c=a[0][1]*a[2][2]-a[0][2]*a[2][1],d=a[0][1]*a[1][2]-a[0][2]*a[1][1],e=1/(a[0][0]*b-a[1][0]*c+a[2][0]*d);return[[e*b,-e*c,e*d],[-e*(a[1][0]*a[2][2]-a[1][2]*a[2][0]),e*(a[0][0]*a[2][2]-a[0][2]*a[2][0]),-e*(a[0][0]*a[1][2]-a[0][2]*a[1][0])],[e*(a[1][0]*a[2][1]-a[1][1]*a[2][0]),-e*(a[0][0]*a[2][1]-a[0][1]*a[2][0]),e*(a[0][0]*a[1][1]-a[0][1]*a[1][0])]]};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.buildSrc=function(a){var b=(a.preHdr?a.preHdr:"")+(a.hdr?a.hdr:"")+(a.postHdr?a.postHdr:"")+(a.preSprt?a.preSprt:"")+(a.sprt?a.sprt:"")+(a.postSprt?a.postSprt:"")+a.main+(a.preBody?a.preBody:"")+(a.body?a.body:"")+(a.postBody?a.postBody:"")+(a.preGlob?a.preGlob:"")+(a.glob?a.glob:"")+(a.postGlob?a.postGlob:"")+a.end;return b},a.utils.combineFragSrc=function(a,b){return this.combineSrc(a,b,"gl_FragColor")},a.utils.combineSrc=function(b,c,d){var e=this.parseSrc(b,d);a.utils.join(e,c);return this.buildSrc(e)},a.utils.combineVertSrc=function(a,b){return this.combineSrc(a,b,"gl_Position")},a.utils.getShaders=function(a,b){var c=a.renderer.context,d=b.program,e=c.getAttachedShaders(d),f=c.getShaderSource(e[0]),g=c.getShaderSource(e[1]),h;f.search("gl_FragColor")>0?h={fragShd:e[0],fragSrc:f,vertShd:e[1],vertSrc:g}:h={fragShd:e[1],fragSrc:g,vertShd:e[0],vertSrc:f};return h},a.utils.parseSrc=function(a,b){var c=a.lastIndexOf(";",a.indexOf("{"))+1,d=a.indexOf("void main",c),e=a.indexOf("{",d)+1,f=a.lastIndexOf(b),g=a.lastIndexOf("}");a.charAt(c)==="\n"&&++c,a.charAt(e)==="\n"&&++e,a.charAt(f)==="\n"&&++f,a.charAt(g)==="\n"&&++g;var h={hdr:a.slice(0,c),sprt:a.slice(c,d),main:a.slice(d,e),body:a.slice(e,f),glob:a.slice(f,g),end:a.slice(g)};return h};return a}(hemi||{}),hemi=function(a){function c(a,c,d){var e=c,f=0,g=a.length,h=c-Math.max(c-d,0),i=Math.min(c+d,g-1)-c,j,k;for(var l=parseInt(c-h);l<=c+i;l++){k=b.get(a.charAt(l));if(k===null)continue;j=k/Math.abs(c-l),j>f&&(e=l,f=j)}return Math.min(e+1,g-1)}a.utils=a.utils||{},String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},a.utils.isNumeric=function(a){return a!==null&&!isNaN(a)&&a.length!==0};var b=new Hashtable;b.put(" ",10),b.put(",",20),b.put(";",30),b.put(".",10),b.put("!",40),b.put("?",40),a.utils.wrapTextStrict=function(c,d,e){var f=[],c=a.utils.cleanseText(c),g=c.length,h=e.measureText(c),i=h.width/g,j=Math.floor(d/i),k=Math.ceil(j/10),l=0,m=j,n,o;while(m<g){n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o<d&&m<g)m+=k,m>g&&(m=g),n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o>d)m--,n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;var p=m-1,q=c.charAt(p);while(!b.containsKey(q)&&p>l)p--,q=c.charAt(p);p>l&&(m=p+1),n=c.substring(l,m).trim(),f.push(n),l=m,m+=j}if(l!=g||f.length===0)n=c.substring(l,g).trim(),f.push(n);return f},a.utils.wrapText=function(b,d,e){var f=[],b=a.utils.cleanseText(b),g=b.length,h=parseInt(d/e),i=Math.ceil(g/h),j=h,k=0,l;for(var m=0;m<i-1;m++)l=k,k=c(b,j,10),f.push(b.substring(l,k).trim()),j=k+h;f.push(b.substring(k,g));return f},a.utils.cleanseText=function(a){a=a.replace("\n"," ");return a};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.isAnimated=function(a){var b=a.getParam("o3d.localMatrix");return b.inputConnection!=null},a.utils.fosterTransform=function(b){var c=b.children,d=b.shapes,e=a.core.mainPack.createObject("Transform");while(c.length>0)c[0].parent=e;e.parent=b;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return e},a.utils.pointAsLocal=function(a,b){var c=(new THREE.Matrix4).getInverse(a.matrixWorld);return c.multiplyVector3(b.clone())},a.utils.pointAsWorld=function(a,b){return a.matrixWorld.multiplyVector3(b.clone())},a.utils.pointYAt=function(a,b,c){var d=c.x-b.x,e=c.y-b.y,f=c.z-b.z,g=Math.sqrt(d*d+f*f),h=Math.atan2(d,f),i=Math.atan2(g,e);a.rotateY(h),a.rotateX(i);return a},a.utils.pointZAt=function(a,b,c){var d=(new THREE.Vector3).sub(c,b),e=Math.atan2(d.x,d.z),f=-Math.asin(d.y/d.length());a.rotation.y+=e,a.rotation.x+=f,a.updateMatrix();return a},a.utils.rotateUVs=function(a,b){var c=a.faceVertexUvs[0],d=Math.cos(b),e=Math.sin(b);for(var f=0,g=c.length;f<g;++f){var h=c[f];for(var i=0,j=h.length;i<j;++i){var k=h[i],l=k.u,m=k.v;k.u=l*d-m*e,k.v=l*e+m*d}}for(var f=0,g=a.geometryGroupsList.length;f<g;++f){var n=a.geometryGroupsList[f],o=n.faces3.length*3+n.faces4.length*4;n.__uvArray=new Float32Array(o*2),n.__inittedArrays=!0}a.__dirtyUvs=!0},a.utils.scaleUVs=function(a,b,c){var d=a.faceVertexUvs[0];for(var e=0,f=d.length;e<f;++e){var g=d[e];for(var h=0,i=g.length;h<i;++h)g[h].u*=b,g[h].v*=c}for(var e=0,f=a.geometryGroupsList.length;e<f;++e){var j=a.geometryGroupsList[e],k=j.faces3.length*3+j.faces4.length*4;j.__uvArray=new Float32Array(k*2),j.__inittedArrays=!0}a.__dirtyUvs=!0},a.utils.shiftGeometry=function(b,c,d){var e=b.geometry,f=b.children;e&&(e.applyMatrix(c),e.computeBoundingBox(),b.__webglInit&&(e.dynamic=!0,b.__webglInit=!1,delete e.geometryGroupsList[0].__webglVertexBuffer,d.__objectsAdded.push(b)));for(var g=0,h=f.length;g<h;++g){var i=f[g];a.utils.shiftGeometry(i,c,d)}},a.utils.translateUVs=function(a,b,c){var d=a.faceVertexUvs[0];for(var e=0,f=d.length;e<f;++e){var g=d[e];for(var h=0,i=g.length;h<i;++h)g[h].u+=b,g[h].v+=c}for(var e=0,f=a.geometryGroupsList.length;e<f;++e){var j=a.geometryGroupsList[e],k=j.faces3.length*3+j.faces4.length*4;j.__uvArray=new Float32Array(k*2),j.__inittedArrays=!0}a.__dirtyUvs=!0},a.utils.unfosterTransform=function(b){var c=b.children,d=b.shapes,e=b.parent;while(c.length>0)c[0].parent=e;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}b.parent=null,a.core.mainPack.removeObject(b);return e},a.utils.worldRotate=function(b,c,d){var e=(new THREE.Matrix4).getInverse(d.matrixWorld),f=a.utils.transformDirection(e,b);a.utils.axisRotate(f,c,d)},a.utils.worldScale=function(b,c){var d=THREE.Matrix4.makeInvert3x3(c.parent.matrixWorld);c.scale.multiplySelf(a.utils.multiplyVector3(d,b.clone())),c.updateMatrix()},a.utils.worldTranslate=function(b,c){var d=(new THREE.Matrix4).getInverse(c.matrixWorld),e=a.utils.transformDirection(d,b);c.translateX(e.x),c.translateY(e.y),c.translateZ(e.z),c.updateMatrix()},a.utils.axisRotate=function(b,c,d){d.useQuaternion||(d.useQuaternion=!0,d.quaternion.setFromEuler(THREE.Vector3(a.utils.radToDeg(d.rotation.x),a.utils.radToDeg(d.rotation.y),a.utils.radToDeg(d.rotation.z)))),d.quaternion=(new THREE.Quaternion).setFromAxisAngle(b,c).multiplySelf(d.quaternion),d.updateMatrix()},a.utils.identity=function(a){a.position=new THREE.Vector3(0,0,0),a.rotation=new THREE.Vector3(0,0,0),a.scale=new THREE.Vector3(1,1,1),a.updateMatrix()},a.utils.getChildren=function(b,c){for(var d=0;d<b.children.length;++d){var e=b.children[d];c.push(e),a.utls.getChildren(e,c)}},a.utils.transformDirection=function(a,b){return new THREE.Vector3(b.x*a.n11+b.y*a.n21+b.z*a.n31,b.x*a.n12+b.y*a.n22+b.z*a.n32,b.x*a.n13+b.y*a.n23+b.z*a.n33)},a.utils.multiplyVector3=function(a,b){var c=b.x,d=b.y,e=b.z;b.x=a.m[0]*c+a.m[3]*d+a.m[6]*e,b.y=a.m[1]*c+a.m[4]*d+a.m[7]*e,b.z=a.m[2]*c+a.m[5]*d+a.m[8]*e;return b};return a}(hemi||{}),hemi=function(a){a.msg={animate:"hemi.animate",burst:"hemi.burst",cleanup:"hemi.cleanup",drag:"hemi.drag",enable:"hemi.enable",load:"hemi.load",pick:"hemi.pick",progress:"hemi.progress",ready:"hemi.ready",scale:"hemi.scale",start:"hemi.start",stop:"hemi.stop",unload:"hemi.unload",visible:"hemi.visible"};return a}(hemi||{}),hemi=function(a){a.console=a.console||{};var b=function(){var a=new Date,b=a.getHours(),c=a.getMinutes(),d=a.getSeconds();b=b<10?"0"+b:""+b,c=c<10?":0"+c:":"+c,d=d<10?":0"+d:":"+d;return b+c+d},c=function(c,e){e=e||a.console.LOG;if(h(e)){var f=e+":\t"+c;j&&(f=b()+"\t"+f),d(f)}},d=function(a){try{console.log(a)}catch(b){}},e=function(b){return b===a.console.LOG||b===a.console.WARN||b===a.console.ERR},f=function(b){return b===a.console.WARN||b===a.console.ERR},g=function(b){return b===a.console.ERR},h=e,i=!1,j=!0;a.console.ERR="ERR",a.console.WARN="WARN",a.console.LOG="LOG",a.console.log=a.utils.noop,a.console.setEnabled=function(b){i=b,a.console.log=i?c:a.utils.noop},a.console.setOutput=function(a){d=a},a.console.setPriority=function(b){switch(b){case a.console.LOG:h=e;break;case a.console.WARN:h=f;break;case a.console.ERR:h=g}},a.console.setShowTime=function(a){j=a};return a}(hemi||{});window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}());var hemi=function(a){var b=function(a){var b=null;Detector.webgl?b=new THREE.WebGLRenderer:(Detector.canvas&&(b=new THREE.CanvasRenderer),Detector.addGetWebGLMessage({id:"warn_"+a.id,parent:a}),function(a){setTimeout(function(){var b=document.getElementById("warn_"+a.id);a.removeChild(b)},5e3)}(a));return b},c=function(b){requestAnimationFrame(c);var d=(new Date).getTime(),e={elapsedTime:g};while(d-i>h){b=!0,i+=h;for(k=0;k<j.length;++k)j[k].onRender(e)}k=-1;if(b)for(var f=0,l=a.clients.length;f<l;++f)a.clients[f].onRender(e)},d=function(){for(var b=0;b<a.clients.length;++b)a.clients[b]._resize()},e=null,f=60,g=1/f,h=g*1e3,i=0,j=[],k=-1;a.DEG_TO_RAD=Math.PI/180,a.HALF_PI=Math.PI/2,a.RAD_TO_DEG=180/Math.PI,a.version="2.0.0-beta",a.console.setEnabled(!0),a.clients=[],a.addRenderListener=function(a){j.indexOf(a)===-1&&j.push(a)},a.error=function(a){if(e)e(a);else{var b=new Error(a);b.name="HemiError";throw b}},a.getFPS=function(){return f},a.getTimeOfFrame=function(a){return a*g},a.init=function(){window.addEventListener("resize",d,!1),i=(new Date).getTime(),c(!0)},a.makeClients=function(){var c=document.getElementsByTagName("div"),d=a.clients.length;for(var e=0,f=c.length;e<f;++e){var g=c[e];if(g.id&&g.id.match(/^kuda/)){var h=b(g);if(h){var i=e<d?a.clients[e]:new a.Client(!0);g.appendChild(h.domElement),i.setRenderer(h),a.hudManager.addClient(i)}}}a.init();return a.clients},a.removeRenderListener=function(a){var b=j.indexOf(a),c=null;b!==-1&&(c=j.splice(b,1)[0],b<=k&&k--);return c},a.setErrorCallback=function(a){e=a},a.setFPS=function(a){f=a,g=1/f,h=g*1e3};return a}(hemi||{}),hemi=function(a){function e(){--d===0&&(d=1,a.send(a.msg.ready,{}),c&&(c(),c=null))}var b=new THREE.ColladaLoader,c=null,d=1;a.loadPath="",a.getLoadPath=function(b){return b.substr(0,4)==="http"?b:a.loadPath+b},a.loadHtml=function(b,c){b=a.getLoadPath(b),a.utils.get(b,function(b,d){b===null?a.error(d):c(b)})},a.loadCollada=function(c,f){c=a.getLoadPath(c),++d,b.load(c,function(a){f&&f(a),e()})},a.loadImage=function(b,c){var f=new Image;++d,f.onabort=function(){a.error("Aborted loading: "+b),e()},f.onerror=function(){a.error("Error loading: "+b),e()},f.onload=function(){c(f),e()},f.src=a.getLoadPath(b)},a.loadOctane=function(b,c){b=a.getLoadPath(b),++d,a.utils.get(b,function(b,d){e();if(b===null)a.error(d);else{typeof b=="string"&&(b=JSON.parse(b));var f=a.fromOctane(b);b.type||(a.makeClients(),a.ready()),c&&c(f)}})},a.loadTexture=function(b,c){a.loadImage(b,function(a){var b=new THREE.Texture(a);b.needsUpdate=!0,c(b)})},a.ready=e,a.resetLoadTasks=function(a){c=a,e()};return a}(hemi||{}),hemi=function(a){var b=function(a,b){var c=b.split("."),d=c.length-1,e=window;for(var f=0;f<d;++f){var g=c[f];e[g]||(e[g]={}),e=e[g]}e[c[d]]=a},c=function(){return this._worldId},d=function(b){var c=this._worldId;this._worldId=b,c!==null&&(a.world.citizens.remove(c),a.world.citizens.put(b,this))},e=function(b,c){a.dispatch.postMessage(this,b,c)},f=function(b,c,d,e){return a.dispatch.registerTarget(this._worldId,b,c,d,e)},g=function(b,c,d){return a.dispatch.registerTarget(this._worldId,a.dispatch.WILDCARD,b,c,d)},h=function(b,c){return a.dispatch.removeTarget(b,{src:this._worldId,msg:c})},i={};a.getBaseClass=function(a){return i[a]},a.makeCitizen=function(j,k,l){function o(){j.apply(this,arguments),this.name=this.name||"",this._worldId=null,a.world.addCitizen(this)}l=l||{};var m=l.cleanup,n=l.msgs||[];i[k]=j,n.push(a.msg.cleanup),o.prototype=j.prototype,o.prototype._msgSent=n,o.prototype.cleanup=function(){this.send(a.msg.cleanup,{}),m&&m.apply(this,arguments),a.dispatch.removeSpecs({src:this._worldId},!0),a.dispatch.removeTargets({handler:this},!0),a.world.removeCitizen(this)},o.prototype._getId=c,o.prototype._setId=d,o.prototype.send=e,o.prototype.subscribe=f,o.prototype.subscribeAll=g,o.prototype.unsubscribe=h,o.constructor=o,a.makeOctanable(o,k,l.toOctane),b(o,k);return o},a.world=a.world||{},a.world.WORLD_ID=0;var j=1;a.world.citizens=new a.utils.Hashtable,a.world.setNextId=function(a){j=a},a.world.getNextId=function(){return j++},a.world.checkNextId=function(){return j},a.world._getId=function(){return a.world.WORLD_ID},a.world.addCitizen=function(b){var c=b._getId();c==null&&(c=this.getNextId(),b._setId(c));var d=this.citizens.get(c);d!==null&&(a.console.log("Citizen with id "+c+" already exists.",a.console.ERR),d.cleanup()),this.citizens.put(c,b)},a.world.cleanup=function(){a.resetLoadTasks(),a.send(a.msg.cleanup,{}),a.world.citizens.each(function(a,b){b.cleanup()}),a.world.citizens.size()>0&&a.console.log("World cleanup did not remove all citizens.",a.console.ERR),j=1},a.world.removeCitizen=function(b){var c=b._getId(),d=this.citizens.remove(c);d===null&&a.console.log("Unable to remove Citizen with id "+c,a.console.WARN);return d!==null},a.world.getCitizens=function(a,b){var c={};a!=undefined&&(a.worldId!==undefined&&(c.worldId=a.worldId),a.name!==undefined&&(c.name=a.name),a.citizenType!==undefined&&(c.citizenType=a.citizenType));var d=this.citizens.query(c);if(b)for(var e=0,f=d.length;e<f;e++)b(d[e])||(d.splice(e,1),e--,f--);return d},a.world.getCitizenById=function(b){var c=this.citizens.get(b);c===null&&a.console.log("Tried to get Citizen with id "+b+", returned null.",a.console.ERR);return c},a.world.getAudio=function(b,c){b=b||{},b.citizenType=a.audio.Audio.prototype.citizenType;return this.getCitizens(b,c)},a.world.getCamCurves=function(b,c){b=b||{},b.citizenType=a.view.CameraCurve.prototype.citizenType;return this.getCitizens(b,c)},a.world.getHudDisplays=function(b,c){b=b||{},b.citizenType=a.hud.HudDisplay.prototype.citizenType;return this.getCitizens(b,c)},a.world.getHudElements=function(b,c){b=b||{},b.citizenType=a.hud.HudElement.prototype.citizenType;return this.getCitizens(b,c)},a.world.getModels=function(b,c){b=b||{},b.citizenType=a.model.Model.prototype.citizenType;return this.getCitizens(b,c)},a.world.getAnimations=function(b,c){b=b||{},b.citizenType=a.animation.Animation.prototype.citizenType;return this.getCitizens(b,c)},a.world.getEffects=function(b,c){var d=[];b=b||{},b.citizenType=a.effect.Emitter.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Burst.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Trail.prototype.citizenType,d=d.concat(this.getCitizens(b,c));return d},a.world.getViewpoints=function(b,c){b=b||{},b.citizenType=a.view.Viewpoint.prototype.citizenType;return this.getCitizens(b,c)},a.world.getPressureEngines=function(a,b){a=a||{},a.citizenType=hext.engines.PressureEngine.prototype.citizenType;return this.getCitizens(a,b)},a.world.getDraggables=function(b,c){b=b||{},b.citizenType=a.manip.Draggable.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTurnables=function(b,c){b=b||{},b.citizenType=a.manip.Turnable.prototype.citizenType;return this.getCitizens(b,c)},a.world.getRotators=function(b,c){b=b||{},b.citizenType=a.motion.Rotator.prototype.citizenType;return this.getCitizens(b,c)},a.world.getScenes=function(b,c){b=b||{},b.citizenType=a.scene.Scene.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTimers=function(b,c){b=b||{},b.citizenType=a.time.Timer.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTranslators=function(b,c){b=b||{},b.citizenType=a.motion.Translator.prototype.citizenType;return this.getCitizens(b,c)},a.world.getShapes=function(b,c){b=b||{},b.citizenType=a.shape.Shape.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTranOwner=function(a){var b=a.getParam("ownerId"),c=null;b!==null&&(c=this.getCitizenById(b.value));return c},a.world.toOctane=function(b){var c={version:a.version,nextId:j,citizens:[]};this.citizens.each(function(d,e){var f=b?b(e):!0;if(f){var g=e._toOctane();g!==null?c.citizens.push(g):a.console.log("Null Octane returned by Citizen with id "+e._getId(),a.console.WARN)}}),c.dispatch=a.dispatch._toOctane();return c};return a}(hemi||{}),hemi=function(a){function e(b,d){for(var f=0,g=d.props.length;f<g;++f){var h=d.props[f],i=h.name;if(h.oct!==undefined){if(h.oct instanceof Array){m=[];for(var j=0,k=h.oct.length;j<j;++j){var l=c(h.oct[j]);e(l,h.oct[j]),m.push(l)}}else m=c(h.oct),e(m,h.oct);b[i]=m}else if(h.val!==undefined)b[i]=h.val;else if(h.id!==undefined){var m;if(h.id instanceof Array){m=[];for(var j=0,k=h.id.length;j<k;++j)m.push(a.world.getCitizenById(h.id[j]))}else m=a.world.getCitizenById(h.id);b[i]=m}else if(h.arg!==undefined){var n=b[i],o=a.dispatch.getArguments(null,h.arg);n.apply(b,o)}else alert("Unable to process octane for "+d.id+": missing property value")}}function d(b,c){var d=[];for(var e=0,f=c.length;e<f;++e){var g=c[e],h=b[g],i={name:g};if(a.utils.isFunction(h))i.arg=[];else if(a.utils.isArray(h))if(h.length>0){var j=h[0];if(j._getId&&j._worldId){i.id=[];for(var k=0;k<h.length;++k)i.id[k]=h[k]._getId()}else if(j._toOctane){i.oct=[];for(var k=0;k<h.length;++k)i.oct[k]=h[k]._toOctane()}else i.val=h}else i.val=h;else h._getId&&h._worldId?i.id=h._getId():h._toOctane?i.oct=h._toOctane():i.val=h;d.push(i)}return d}function c(c){if(!c.type){alert("Unable to process octane: missing type");return null}var d=b[c.type],e=null;d?(e=new d,c.id!==undefined&&e._setId(c.id)):a.console.log("Cannot find constructor for type: "+c.type,a.console.ERR);return e}var b={};a.fromOctane=function(b){var d=null;if(b.type)d=c(b),e(d,b);else{a.world.cleanup();var f=b.citizens.length;a.world.setNextId(f*-2);for(var g=0;g<f;++g)c(b.citizens[g]);a.world.setNextId(b.nextId);var h=b.dispatch.ents,i=[];for(var g=0,j=h.length;g<j;++g){var k=c(h[g]);e(k,h[g]),i.push(k)}a.dispatch.loadEntries(i),a.dispatch.setNextId(b.dispatch.nextId);for(var g=0;g<f;++g){var l=b.citizens[g];e(a.world.getCitizenById(l.id),l)}}return d},a.makeOctanable=function(c,e,f){f=f||[],b[e]=c,c.prototype._citizenType=e,c.prototype._toOctane=function(){var b=a.utils.isFunction(f)?f.call(this):d(this,f),c=null;b!==null&&(c={type:this._citizenType,props:b},this._worldId!==undefined&&(c.id=this._worldId),this.name&&this.name.length>0&&!c.props.name&&c.props.unshift({name:"name",val:this.name}));return c}};return a}(hemi||{}),hemi=function(a){var b=function(){this._seeking=!1,this._startPlay=!1,this._urls=[],this.audio=document.createElement("audio"),this.looping=!1;var b=this;this.audio.addEventListener("emptied",function(c){b.send(a.msg.unload,{})},!0),this.audio.addEventListener("loadeddata",function(c){b.send(a.msg.load,{src:b.audio.currentSrc})},!0),this.audio.addEventListener("playing",function(c){b.send(a.msg.start,{})},!0),this.audio.addEventListener("ended",function(c){b.looping&&b.play(),b.send(a.msg.stop,{})},!0)};b.prototype._clean=function(){this.audio=null,this._urls=[]},b.prototype._msgSent=[a.msg.load,a.msg.start,a.msg.stop,a.msg.unload],b.prototype._octane=function(){var a=[{name:"looping",val:this.looping}];for(var b=0,c=this._urls.length;b<c;++b){var d=this._urls[b];a.push({name:"addUrl",arg:[d.url,d.type]})}return a},b.prototype.addUrl=function(b,c){var d=document.createElement("source"),e=a.getLoadPath(b);d.setAttribute("src",e),d.setAttribute("type","audio/"+c),this.audio.appendChild(d),this._urls.push({url:b,type:c,node:d})},b.prototype.getDuration=function(){return this.audio?this.audio.duration:null},b.prototype.getVolume=function(){return this.audio?this.audio.volume:null},b.prototype.pause=function(){this.audio&&!this.audio.paused&&(this.audio.pause(),this._startPlay=!1)},b.prototype.play=function(){this.audio&&(this._seeking?this._startPlay=!0:(this.audio.paused||this.audio.ended)&&this.audio.play())},b.prototype.removeUrl=function(a){for(var b=0,c=this._urls.length;b<c;++b){var d=this._urls[b];if(d.url===a){this.audio.removeChild(d.node),this._urls.splice(b,1),d.node.src===this.audio.currentSrc&&this.audio.load();break}}},b.prototype.seek=function(a){if(this.audio&&a>=0&&a<this.audio.duration){var b=this,c=function(){b.audio.removeEventListener("seeked",c,!0),b._seeking=!1,b._startPlay&&(b._startPlay=!1,b.play())};this.audio.addEventListener("seeked",c,!0),this._seeking=!0,this._startPlay=!this.audio.paused,this.audio.currentTime=a}},b.prototype.setLoop=function(a){this.looping!==a&&(this.looping=a,!this.audio)},b.prototype.setVolume=function(a){this.audio&&(this.audio.volume=a)};var c=function(){this.looping?this.audio.setAttribute("loop","loop"):this.audio.removeAttribute("loop")};a.makeCitizen(b,"hemi.Audio",{cleanup:b.prototype._clean,toOctane:b.prototype._octane});return a}(hemi||{}),hemi=function(a){function h(c,d){var e=a.dispatch.getSpecsFast(c,d,!1),f;e.length===0?(f=new a.dispatch.MessageSpec,f.src=c,f.msg=d,b.put(f.getHash(),f)):(e.length>1&&a.console.log("Found "+e.length+" MessageSpecs with the same src and msg.",a.console.ERR),f=e[0]);return f}a.dispatch=a.dispatch||{};var b=new a.utils.Hashtable,c=0;a.dispatch.WILDCARD="*",a.dispatch.ID_ARG="id:",a.dispatch.MSG_ARG="msg:";var d=function(){this.src=null,this.msg=null,this.data={}};a.dispatch.Message=d;var e=function(){this.src=null,this.msg=null,this.targets=[]};e.prototype._octane=function(){var b=[];for(var c=0,d=this.targets.length;c<d;++c){var e=this.targets[c]._toOctane();e!==null?b.push(e):a.console.log("Null Octane returned by MessageTarget",a.console.WARN)}return[{name:"src",val:this.src},{name:"msg",val:this.msg},{name:"targets",oct:b}]},e.prototype.addTarget=function(b){this.targets.indexOf(b)!==-1&&a.console.log("MessageSpec already contains MessageTarget",a.console.WARN),this.targets.push(b)},e.prototype.cleanup=function(){for(var a=0,b=this.targets.length;a<b;++a)this.targets[a].cleanup();this.targets=[]},e.prototype.removeTarget=function(b){var c=null,d=this.targets.indexOf(b);d!==-1?c=this.targets.splice(d,1)[0]:a.console.log("MessageTarget not found in MessageSpec",a.console.WARN);return c},e.prototype.getHash=function(){return this.msg+this.src},a.dispatch.MessageSpec=e,a.makeOctanable(a.dispatch.MessageSpec,"hemi.dispatch.MessageSpec",a.dispatch.MessageSpec.prototype._octane);var f=function(){this._dispatchId=null,this.name="",this.handler=null,this.func=null,this.args=null};f.prototype._octane=function(){if(!this.handler._getId){a.console.log("Handler object in MessageTarget can not be saved to Octane",a.console.WARN);return null}var b=["_dispatchId","name","func","args"],c=[{name:"handler",id:this.handler._getId()}];for(var d=0,e=b.length;d<e;++d){var f=b[d];c.push({name:f,val:this[f]})}return c},f.prototype.cleanup=function(){this.handler=null},a.dispatch.MessageTarget=f,a.makeOctanable(a.dispatch.MessageTarget,"hemi.dispatch.MessageTarget",a.dispatch.MessageTarget.prototype._octane),a.dispatch._toOctane=function(){var d={nextId:c,ents:[]};b.each(function(b,c){var e=c._toOctane();e!==null?d.ents.push(e):a.console.log("Null Octane returned by MessageSpec",a.console.ERR)});return d},a.dispatch.checkNextId=function(){return c},a.dispatch.cleanup=function(){b.each(function(a,b){b.cleanup()}),b.clear()},a.dispatch.getNextId=function(){return c++},a.dispatch.getSpecs=function(c,d){var e;if(c===undefined)e=b.values();else{var f={};d?(c.src!==undefined&&(c.src===a.dispatch.WILDCARD?f.src=a.dispatch.WILDCARD:f.src=[c.src,a.dispatch.WILDCARD]),c.msg!==undefined&&(c.msg===a.dispatch.WILDCARD?f.msg=a.dispatch.WILDCARD:f.msg=[c.msg,a.dispatch.WILDCARD])):(c.src!==undefined&&(f.src=c.src),c.msg!==undefined&&(f.msg=c.msg)),e=b.query(f)}return e},a.dispatch.getSpecsFast=function(c,d,e){var f=[],g=d+c,h=b.get(g);h!==null&&f.push(h);if(e){var i=c===a.dispatch.WILDCARD;i||(g=d+a.dispatch.WILDCARD,h=b.get(g),h!==null&&f.push(h)),d!==a.dispatch.WILDCARD&&(g=a.dispatch.WILDCARD+c,h=b.get(g),h!==null&&f.push(h),i||(g=a.dispatch.WILDCARD+a.dispatch.WILDCARD,h=b.get(g),h!==null&&f.push(h)))}return f},a.dispatch.getTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a.dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;++h){var j=c[h].targets;for(var k=0,l=j.length;k<l;++k){var m=j[k],n=!0;e!==undefined&&(n=m._dispatchId===e),n&&f!==undefined&&(n=m.name===f),n&&g!==undefined&&(n=m.handler===g),n&&d.push(m)}}return d},a.dispatch.getTargetSpec=function(a){var b=this.getSpecs(),c=a._dispatchId;for(var d=0,e=b.length;d<e;++d){var f=b[d],g=f.targets;for(var h=0,i=g.length;h<i;++h)if(g[h]._dispatchId===c)return f}return null},a.dispatch.loadEntries=function(a){for(var c=0,d=a.length;c<d;++c){var e=a[c];b.put(e.getHash(),e)}},a.dispatch.postMessage=function(b,c,d){var e=new a.dispatch.Message,f=b._getId();e.src=b,e.msg=c,e.data=d;var g=this.getSpecsFast(f,c,!0);for(var h=0,i=g.length;h<i;++h){var j=g[h].targets.slice(0);for(var k=0,l=j.length;k<l;++k){var m=j[k],n,o;m.args!==null?n=this.getArguments(e,m.args):n=[e],m.func?o=m.handler[m.func]:o=m.handler,o.apply(m.handler,n)}}},a.dispatch.registerTarget=function(b,c,d,e,f){var g=h(b,c),i=new a.dispatch.MessageTarget;i._dispatchId=this.getNextId(),i.handler=d,e&&(i.func=e),f&&(i.args=f),g.addTarget(i);return i},a.dispatch.removeSpecs=function(c,d){var e=a.dispatch.getSpecs(c,d),f=[],g;for(var h=0,i=e.length;h<i;++h)g=b.remove(e[h].getHash()),g&&f.push(g);return f},a.dispatch.removeTarget=function(b,c){var d=this.getSpecs(c,!1),e=null;for(var f=0,g=d.length;f<g;++f){var h=d[f];e=h.removeTarget(b);if(e!==null)break}e===null&&a.console.log("MessageTarget was not found and therefore not removed",a.console.WARN);return e},a.dispatch.removeTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a.dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;++h){var j=c[h],k=j.targets;for(var l=0,m=k.length;l<m;++l){var n=k[l],o=!0;e!==undefined&&(o=n._dispatchId===e),o&&f!==undefined&&(o=n.name===f),o&&g!==undefined&&(o=n.handler===g),o&&(j.removeTarget(n),d.push(n))}}return d},a.dispatch.setNextId=function(a){c=a},a.dispatch.setTargetSpec=function(b,c,d){var e=this.getTargetSpec(b);e!==null?e.removeTarget(b):a.console.log("Previous MessageSpec for MessageTarget not found",a.console.WARN),e=h(c,d),e.addTarget(b)},a.dispatch.getArguments=function(b,c){var d=[];for(var e=0,f=c.length;e<f;++e){var g=c[e];if(typeof g!="string")d[e]=g;else if(g.substring(0,3)===a.dispatch.ID_ARG){var h=parseInt(g.substring(3),10);d[e]=a.world.getCitizenById(h)}else if(g.substring(0,4)===a.dispatch.MSG_ARG){var i=g.substring(4).split("."),j=b;for(var k=0,l=i.length;j!=null&&k<l;++k)j=j[i[k]];d[e]=j}else d[e]=g}return d};var g={_getId:function(){return a.dispatch.WILDCARD}};a.send=function(b,c){a.dispatch.postMessage(g,b,c)},a.subscribe=function(b,c,d,e){return a.dispatch.registerTarget(a.dispatch.WILDCARD,b,c,d,e)},a.unsubscribe=function(b,c){return a.dispatch.removeTarget(b,{src:a.dispatch.WILDCARD,msg:c})};return a}(hemi||{}),hemi=function(a){function m(a){a||(a=window.event),a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}function l(b){var c=a.utils.clone(b,!1),d=k(c);c.x=d.x,c.y=d.y;return c}function k(a){var b=a.target?a.target:a.srcElement,c={x:0,y:0};for(var d=b;d;d=d.offsetParent)c.x+=d.offsetLeft,c.y+=d.offsetTop;c.x=a.pageX-c.x,c.y=a.pageY-c.y;return c}function j(a,b){var c=a.indexOf(b),d=null;c!==-1&&(d=a.splice(c,1)[0]);return d}function i(a,b){a.push(b)}a.input=a.input||{};var b=[],c=[],d=[],e=[],f=[],g=[],h=[];a.input.init=function(b){b.addEventListener("mousedown",function(b){a.input.mouseDown(b)},!0),b.addEventListener("mousemove",function(b){a.input.mouseMove(b)},!0),b.addEventListener("mouseup",function(b){a.input.mouseUp(b)},!0),b.addEventListener("mousewheel",function(b){a.input.scroll(b)},!1),b.addEventListener("DOMMouseScroll",function(b){a.input.scroll(b)},!1),document.addEventListener("keypress",function(b){a.input.keyPress(b)},!0),document.addEventListener("keydown",function(b){a.input.keyDown(b)},!0),document.addEventListener("keyup",function(b){a.input.keyUp(b)},!0)},a.input.addMouseDownListener=function(a){i(b,a)},a.input.addMouseUpListener=function(a){i(c,a)},a.input.addMouseMoveListener=function(a){i(d,a)},a.input.addMouseWheelListener=function(a){i(e,a)},a.input.addKeyDownListener=function(a){i(f,a)},a.input.addKeyUpListener=function(a){i(g,a)},a.input.addKeyPressListener=function(a){i(h,a)},a.input.removeMouseDownListener=function(a){return j(b,a)},a.input.removeMouseUpListener=function(a){return j(c,a)},a.input.removeMouseMoveListener=function(a){return j(d,a)},a.input.removeMouseWheelListener=function(a){return j(e,a)},a.input.removeKeyDownListener=function(a){return j(f,a)},a.input.removeKeyUpListener=function(a){return j(g,a)},a.input.removeKeyPressListener=function(a){return j(h,a)},a.input.mouseDown=function(a){var c=l(a);for(var d=0;d<b.length;d++)b[d].onMouseDown(c)},a.input.mouseUp=function(a){var b=l(a);for(var d=0;d<c.length;d++)c[d].onMouseUp(b)},a.input.mouseMove=function(a){var b=l(a);for(var c=0;c<d.length;c++)d[c].onMouseMove(b)},a.input.scroll=function(a){var b=l(a);b.deltaY=a.detail?-a.detail:a.wheelDelta,m(a);for(var c=0;c<e.length;c++)e[c].onScroll(b)},a.input.keyDown=function(a){for(var b=0;b<f.length;b++)f[b].onKeyDown(a)},a.input.keyUp=function(a){for(var b=0;b<g.length;b++)g[b].onKeyUp(a)},a.input.keyPress=function(a){for(var b=0;b<h.length;b++)h[b].onKeyPress(a)};return a}(hemi||{}),hemi=function(a){var b=function(){this.parent.remove(this);for(var a=0,b=this.children.length;a<b;++a)this.children[a].cleanup()},c=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.rotation.set(0,0,0),this.scale.set(1,1,1),this.matrix.identity(),this.updateMatrixWorld()},d=function(a,b){var c=this.children;this.matrix=a.matrix,this.matrixWorld=a.matrixWorld,this.updateMatrix(),this.updateMatrixWorld(),this.children=[],b[a.id]!==undefined&&(b[a.id]=this);for(var d=0,e=c.length;d<e;++d){var f=c[d],g=a.getChildByName(f.name,!1);this.add(f),f._init(g,b)}},e=["name","children","pickable","visible","position","rotation","quaternion","scale","useQuaternion"],f=function(){THREE.Object3D.call(this),this.pickable=!0};f.prototype=new THREE.Object3D,f.constructor=f,f.prototype._clean=b,f.prototype._init=d,f.prototype._octane=e,f.prototype.identity=c,a.makeCitizen(f,"hemi.Transform",{cleanup:f.prototype._clean,toOctane:f.prototype._octane});var g=function(){THREE.Mesh.call(this),this.pickable=!0};g.prototype=new THREE.Mesh,g.constructor=g,g.prototype._clean=b,g.prototype._init=function(a,b){this.geometry=a.geometry,this.material=a.material,this.boundRadius=a.boundRadius,this.geometry.morphTargets.length&&(this.morphTargetBase=a.morphTargetBase,this.morphTargetForcedOrder=a.morphTargetForcedOrder,this.morphTargetInfluences=a.morphTargetInfluences,this.morphTargetDictionary=a.morphTargetDictionary),d.call(this,a,b)},g.prototype._octane=e,g.prototype.identity=c,a.makeCitizen(g,"hemi.Mesh",{cleanup:g.prototype._clean,toOctane:g.prototype._octane}),a.makeCitizen(THREE.Scene,"hemi.Scene"),a.makeOctanable(THREE.Vector3,"THREE.Vector3",["x","y","z"]),a.makeOctanable(THREE.Quaternion,"THREE.Quaternion",["x","y","z","w"]);return a}(hemi||{}),hemi=function(a){a.viewDefaults={MOUSE_SPEED:.005,MOUSE_DELTA:.0015,TRUCK_SPEED:.02,FOV:.707107,NP:1,FP:1e4,MOVE_TIME:72,MIN_FOV:.05,MAX_FOV:Math.PI/3,MIN_TILT:-Math.PI/2.001,MAX_TILT:Math.PI/2.001},a.viewProjection={PERSPECTIVE:0,XY:1,XZ:2,YZ:3},a.CameraBase=function(){this.panTilt=new THREE.Object3D,this.panTilt.name="panTilt",this.panTilt.eulerOrder="ZYX",this.cam=new THREE.Object3D,this.cam.name="cam",this.cam.eulerOrder="ZYX",this.panTilt.add(this.cam),this.cam.position.z=1,this.cam.updateMatrix(),this.updateWorldMatrices(),this.distance=1,this.vd={current:null,last:null},this.light=new THREE.PointLight(16777215,1.35),this.tiltMax=a.viewDefaults.MAX_TILT,this.tiltMin=a.viewDefaults.MIN_TILT,this.fov={current:a.viewDefaults.FOV,min:a.viewDefaults.MIN_FOV,max:a.viewDefaults.MAX_FOV},this.lookLimits={panMax:null,panMin:null,tiltMax:null,tiltMin:null},this.mode={scroll:!0,scan:!0,fixed:!1,control:!1,projection:a.viewProjection.PERSPECTIVE,fixedLight:!0},this.state={moving:!1,curve:null,time:{current:0,end:0},mouse:!1,xy:{current:[-1,-1],last:[-1,-1]},shift:!1,update:!1,vp:null},this.threeCamera=new THREE.PerspectiveCamera(this.fov.current*a.RAD_TO_DEG,window.innerWidth/window.innerHeight,a.viewDefaults.NP,a.viewDefaults.FP);var b=a.utils.penner.linearTween;this.easeFunc=[b,b,b],this.update(),a.addRenderListener(this)},a.CameraBase.prototype={disableControl:function(){if(!this.mode.control)return!1;a.input.removeMouseDownListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseMoveListener(this),a.input.removeMouseWheelListener(this),a.input.removeKeyDownListener(this),a.input.removeKeyUpListener(this),this.mode.control=!1,this.state.mouse=!1;return!0},disableScan:function(){this.mode.scan=!1},disableZoom:function(){this.mode.scroll=!1},enableControl:function(b){if(this.mode.control)return!1;a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this),a.input.addMouseWheelListener(this),a.input.addKeyDownListener(this),a.input.addKeyUpListener(this),this.mode.control=!0;return!0},enableScan:function(){this.mode.scan=!0},enableZoom:function(){this.mode.scroll=!0},fixEye:function(){this.mode.fixed=!0,this.update();return this},lightOnCam:function(){this.mode.fixedLight=!0,this.update();return this},freeEye:function(){this.setEyeTarget(this.getEye(),this.getTarget()),this.mode.fixed=!1,this.update();return this},lightAtPosition:function(a){this.light.position=a,this.light.updateMatrix(),this.mode.fixedLight=!1,this.update();return this},getEye:function(){return this.cam.matrixWorld.getPosition().clone()},getTarget:function(){if(this.mode.fixed){var a=new THREE.Vector3(0,0,1);this.cam.matrixWorld.rotateAxis(a).multiplyScalar(-this.distance);return a.addSelf(this.cam.matrixWorld.getPosition())}return this.panTilt.matrixWorld.getPosition().clone()},moveOnCurve:function(b,c){this.vd.current!==null?this.vd.last=this.vd.current:this.vd.last=a.createViewData(this),this.vd.current=new a.ViewData({eye:b.eye.getEnd(),target:b.target.getEnd(),fov:this.fov.current,np:this.threeCamera.near,fp:this.threeCamera.far}),this.state.curve=b,this.state.moving=!0,this.state.vp=null,this.state.time.end=c==null?1:c>0?c:.001,this.state.time.current=0,this.send(a.msg.start,{viewdata:this.vd.current})},moveOrthographic:function(b,c){var d=b*2*this.distance/a.core.client.width,e=c*2*this.distance/a.core.client.width;switch(this.mode.projection){case a.viewProjection.XY:case a.viewProjection.YZ:this.panTilt.translateX(-d),this.panTilt.translateY(e),this.panTilt.updateMatrix();break;case a.viewProjection.XZ:this.panTilt.translateX(d),this.panTilt.translateZ(e),this.panTilt.updateMatrix()}},movePerspective:function(b,c){if(this.state.shift&&this.mode.scan){var d=a.viewDefaults.MOUSE_DELTA*this.distance*b,e=a.viewDefaults.MOUSE_DELTA*this.distance*c;this.panTilt.translateX(-d),this.panTilt.translateY(e),this.panTilt.updateMatrix(),this.update()}else this.mode.fixed?this.rotate(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED):this.orbit(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED)},moveToView:function(b,c){var d=c==null?1:c,e;b.getData!=null?(this.vd.current=b.getData(),this.state.vp=b,e={viewpoint:b}):(this.vd.current=b,this.state.vp=null,e={viewdata:b}),this.vd.last=a.createViewData(this),this.state.curve=null,this.state.time.end=d>0?d:.001,this.state.time.current=0,this.state.moving=!0,this.send(a.msg.start,e)},onKeyDown:function(a){this.state.shift=a.keyCode==16},onKeyUp:function(a){a.keyCode==16&&(this.state.shift=!1)},onMouseDown:function(a){this.state.mouse=!0,this.state.xy.current[0]=this.state.xy.last[0]=a.x,this.state.xy.current[1]=this.state.xy.last[1]=a.y},onMouseMove:function(a){if(this.state.mouse){this.state.xy.last[0]=this.state.xy.current[0],this.state.xy.last[1]=this.state.xy.current[1],this.state.xy.current[0]=a.x,this.state.xy.current[1]=a.y;var b=this.state.xy.current[0]-this.state.xy.last[0],c=this.state.xy.current[1]-this.state.xy.last[1];this.mode.projection?this.moveOrthographic(b,c):this.movePerspective(b,c)}},onMouseUp:function(a){this.state.mouse=!1},onRender:function(a){var b=this.state,c=b.xy;(b.mouse&&(c.current[0]!==c.last[0]||c.current[1]!==c.last[1])||b.moving||b.update)&&this.update(a.elapsedTime),b.update=!1},onScroll:function(b){if(!!this.mode.scroll)if(this.state.shift){var c=this.distance*a.viewDefaults.TRUCK_SPEED,d=b.deltaY>0?1:-1;this.truck(c*d)}else{if(this.mode.fixed){var e=(this.fov.max+this.fov.min)/2;b.deltaY>0?this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*11/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*13/12:this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*13/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*11/12,this.threeCamera.fov=this.fov.current*a.RAD_TO_DEG,this.threeCamera.updateProjectionMatrix(),this.state.update=!0;return}var f=b.deltaY>0?11/12:13/12;this.distance=a.utils.lerp(0,this.distance,f),this.mode.projection||(this.cam.position.z=this.distance,this.cam.updateMatrix()),this.state.update=!0}},orbit:function(a,b){b==null&&(b=0);var c=this.panTilt.rotation.x+b;this.panTilt.rotation.y+=a,this.panTilt.rotation.x=c>=this.tiltMax?this.tiltMax:c<=this.tiltMin?this.tiltMin:c,this.panTilt.updateMatrix(),this.update()},rotate:function(a,b){b==null&&(b=0);var c=this.lookLimits,d=this.cam.rotation.y+a,e=this.cam.rotation.x+b;c.panMin!=null&&d<c.panMin?this.cam.rotation.y=c.panMin:c.panMax!=null&&d>c.panMax?this.cam.rotation.y=c.panMax:this.cam.rotation.y=d,c.tiltMin!=null&&e<c.tiltMin?this.cam.rotation.x=c.tiltMin:c.tiltMax!=null&&e>c.tiltMax?this.cam.rotation.x=c.tiltMax:this.cam.rotation.x=e,this.cam.updateMatrix(),this.update()},setLookAroundLimits:function(a,b,c,d){this.lookLimits.panMax=b,this.lookLimits.panMin=a,this.lookLimits.tiltMax=d,this.lookLimits.tiltMin=c;return this},setEasing:function(a){typeof a=="function"?this.easeFunc=[a,a,a]:this.easeFunc=[a.x||this.easeFunc[0],a.y||this.easeFunc[1],a.z||this.easeFunc[2]];return this},setEyeTarget:function(b,c){var d=[b.x-c.x,b.y-c.y,b.z-c.z],e=a.utils.cartesianToSpherical(d);this.distance=e[0],this.panTilt.position=c,this.panTilt.rotation.y=e[2],this.panTilt.rotation.x=e[1]-a.HALF_PI,this.panTilt.updateMatrix(),this.cam.rotation.y=0,this.cam.rotation.x=0,this.cam.position.z=this.distance,this.cam.updateMatrix();var f=new THREE.Vector3(0,0,this.distance);a.utils.pointZAt(this.cam,f,a.utils.pointAsLocal(this.cam,c)),this.cam.rotation.y+=Math.PI,this.cam.updateMatrix(),this.updateWorldMatrices()},setLight:function(a){this.light.color.value=[a[0],a[1],a[2],1];return this},setOrthographic:function(a){this.mode.projection=a},setPerspective:function(){this.mode.projection=0},setZoomLimits:function(a,b){this.fov.min=a,this.fov.max=b,this.fov.current>this.fov.max&&(this.fov.current=this.fov.max),this.fov.current<this.fov.min&&(this.fov.current=this.fov.min)},truck:function(a){this.panTilt.translateZ(-a),this.panTilt.updateMatrix(),this.update()},interpolateView:function(b,c){var d=new THREE.Vector3,e=new THREE.Vector3,f=this.vd.last,g=this.vd.current,h=!1;if(this.state.curve){var i=this.easeFunc[0](b,0,1,c);d=this.state.curve.eye.interpolate(i),e=this.state.curve.target.interpolate(i)}else d.x=this.easeFunc[0](b,f.eye.x,g.eye.x-f.eye.x,c),d.y=this.easeFunc[1](b,f.eye.y,g.eye.y-f.eye.y,c),d.z=this.easeFunc[2](b,f.eye.z,g.eye.z-f.eye.z,c),e.x=this.easeFunc[0](b,f.target.x,g.target.x-f.target.x,c),e.y=this.easeFunc[1](b,f.target.y,g.target.y-f.target.y,c),e.z=this.easeFunc[2](b,f.target.z,g.target.z-f.target.z,c);g.fov!==f.fov&&(this.fov.current=this.easeFunc[0](b,f.fov,g.fov-f.fov,c),this.threeCamera.fov=this.fov.current*a.RAD_TO_DEG,h=!0),g.np!==f.np&&(this.threeCamera.near=this.easeFunc[0](b,f.np,g.np-f.np,c),h=!0),g.fp!==f.fp&&(this.threeCamera.far=this.easeFunc[0](b,f.fp,g.fp-f.fp,c),h=!0),h&&this.threeCamera.updateProjectionMatrix(),this.setEyeTarget(d,e)},update:function(b){var c=this.state.time;this.state.moving&&(this.interpolateView(c.current,c.end),b!=undefined&&(c.current>=c.end&&(this.state.moving=!1,this.state.curve=null,this.state.vp!==null?(this.send(a.msg.stop,{viewpoint:this.state.vp}),this.state.vp=null):this.send(a.msg.stop,{viewdata:this.vd.current})),c.current+=b,c.current>=c.end&&(c.current=c.end))),this.updateWorldMatrices();var d=this.getEye(),e=this.getTarget();this.threeCamera.position=d,this.threeCamera.updateMatrix(),this.threeCamera.updateMatrixWorld(!0),this.threeCamera.lookAt(e),this.mode.fixedLight&&(this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale,this.light.updateMatrix())},updateWorldMatrices:function(){this.panTilt.updateMatrixWorld(!0)}},a.makeCitizen(a.CameraBase,"hemi.Camera",{cleanup:function(){a.removeRenderListener(this),this.disableControl(),this.threeCamera=null},msgs:[a.msg.start,a.msg.stop],toOctane:function(){var b=a.createViewData(this),c=[{name:this.mode.control?"enableControl":"disableControl",arg:[]},{name:"mode",val:this.mode},{name:"moveToView",arg:[b,0]}];return c}}),a.CameraCurve=function(a,b){this.eye=a,this.target=b},a.CameraCurve.prototype={constructor:a.CameraCurve,cleanup:function(){this._super(),this.eye=null,this.target=null},toOctane:function(){var a=this._super();a.props.push({name:"eye",oct:this.eye._toOctane()}),a.props.push({name:"target",oct:this.target._toOctane()});return a}},a.ViewData=function(b){var c=b||{};this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.ViewpointBase=function(b){var c=b||{};this.name=c.name||"",this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.ViewpointBase.prototype={getData:function(){return new a.ViewData(this)},setData:function(a){this.eye=a.eye,this.target=a.target,this.fov=a.fov,this.np=a.np,this.fp=a.fp}},a.makeCitizen(a.ViewpointBase,"hemi.Viewpoint",{toOctane:["eye","target","fov","np","fp"]}),a.createViewData=function(b){return new a.ViewData({eye:b.getEye(),target:b.getTarget(),fov:b.fov.current,np:b.threeCamera.near,fp:b.threeCamera.far})},a.createViewpoint=function(b,c){var d=new a.Viewpoint({name:b});d.setData(this.createViewData(c));return d},a.createCustomViewpoint=function(b,c,d,e,f,g){var h=new a.Viewpoint({name:b,eye:c,target:d,fov:e,np:f,fp:g});return h};return a}(hemi||{}),hemi=function(a){function d(a,b,c){for(var e=0;e<b.children.length;++e){var f=b.children[e];f.name===a&&c.push(f),d(a,f,c)}}function c(b,d){var e=b.children,f;b.geometry?(f=new a.Mesh,f.geometry=b.geometry,f.material=b.material,f.boundRadius=b.boundRadius,f.geometry.morphTargets.length&&(f.morphTargetBase=b.morphTargetBase,f.morphTargetForcedOrder=b.morphTargetForcedOrder,f.morphTargetInfluences=b.morphTargetInfluences,f.morphTargetDictionary=b.morphTargetDictionary),this.materials.indexOf(b.material)===-1&&this.materials.push(b.material),this.geometries.indexOf(b.geometry)===-1&&this.geometries.push(b.geometry)):f=new a.Transform,f.name=b.name,f.visible=b.visible,f.position=b.position,f.rotation=b.rotation,f.quaternion=b.quaternion,f.scale=b.scale,f.useQuaternion=b.useQuaternion,f.matrix=b.matrix,f.matrixWorld=b.matrixWorld,d[b.id]!==undefined&&(d[b.id]=f);for(var g=0;g<e.length;++g){var h=c.call(this,e[g],d);f.add(h)}return f}var b=function(a){this._fileName=null,this._loaded=!1,this.animations=[],this.autoLoad=!0,this.client=a,this.geometries=[],this.materials=[],this.root=null};b.prototype._clean=function(){this.unload(),this.client=null},b.prototype._msgSent=[a.msg.load,a.msg.unload],b.prototype._octane=function(){var a=["autoLoad","client","root"],b=[];for(var c=0,d=a.length;c<d;++c){var e=a[c];b.push({name:e,val:this[e]})}b.push({name:"setFileName",arg:[this._fileName]});return b},b.prototype.getTransforms=function(a){var b=[];d(a,this.root,b);return b},b.prototype.load=function(){var b=this;this._loaded&&this.unload(),a.loadCollada(this._fileName,function(d){var e=THREE.AnimationHandler,f=d.animations,g={};b._loaded=!0;for(var h=0,i=f.length;h<i;++h){var j=f[h].node;g[j.id]=j}b.root===null?b.root=c.call(b,d.scene,g):b.root._init(d.scene,g),b.client.scene.add(b.root);for(var h=0,i=d.animations.length;h<i;h++){var k=f[h];e.add(k);var l=new THREE.KeyFrameAnimation(g[k.node.id],k.name);l.timeScale=1,b.animations.push(l)}b.send(a.msg.load,{root:d.scene})})},b.prototype.setFileName=function(a){this._fileName=a,this.autoLoad&&this.load()},b.prototype.unload=function(){this.send(a.msg.unload,{root:this.root}),this.root&&(this.root.cleanup(),this.root=null),this._loaded=!1,this.animations=[],this.geometries=[],this.materials=[]},a.makeCitizen(b,"hemi.Model",{cleanup:b.prototype._clean,toOctane:b.prototype._octane});return a}(hemi||{}),hemi=function(a){var b=new THREE.Projector,c=new THREE.Ray,d=new THREE.Vector3;a.Picker=function(b,c){this.camera=c,this.scene=b,this.height=1,this.width=1,a.input.addMouseDownListener(this)},a.Picker.prototype.onMouseDown=function(e){var f=e.x/this.width*2-1,g=-(e.y/this.height)*2+1,h=this.camera.threeCamera.position;d.set(f,g,.5),b.unprojectVector(d,this.camera.threeCamera),c.origin.copy(h),c.direction.copy(d.subSelf(h).normalize());var i=c.intersectScene(this.scene);if(i.length>0)for(var j=0;j<i.length;++j){var k=i[j];if(k.object.parent.pickable){a.send(a.msg.pick,{mouseEvent:e,pickedMesh:k.object});break}}};return a}(hemi||{}),hemi=function(a){var b=new THREE.Projector,c=function(b){this._bgColor=0,this._bgAlpha=1,this.camera=b?new a.Camera:null,this.scene=b?new a.Scene:null,this.picker=new a.Picker(this.scene,this.camera),this.renderer=null,b&&(this.useCameraLight(!0),this.scene.add(this.camera.threeCamera)),a.clients.push(this)};c.prototype._octane=function(){return[{name:"_bgColor",val:this._bgColor},{name:"_bgAlpha",val:this._bgAlpha},{name:"setScene",arg:[a.dispatch.ID_ARG+this.scene._getId()]},{name:"setCamera",arg:[a.dispatch.ID_ARG+this.camera._getId()]}]},c.prototype._resize=function(){var a=this.renderer.domElement,b=a.clientWidth>1?a.clientWidth:1,c=a.clientHeight>1?a.clientHeight:1;this.renderer.setSize(b,c),this.camera.threeCamera.aspect=b/c,this.camera.threeCamera.updateProjectionMatrix(),this.picker.width=b,this.picker.height=c},c.prototype.addGrid=function(){var a=new THREE.LineBasicMaterial({color:13421772,opacity:.2}),b=new THREE.Geometry,c=-0.04,d=1,e=14;for(var f=0,g=e/d*2;f<=g;++f)b.vertices.push(new THREE.Vertex(new THREE.Vector3(-e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,e)));var h=new THREE.Line(b,a,THREE.LinePieces);this.scene.add(h)},c.prototype.castRay=function(a,c){var d=this.renderer.domElement,e=a/d.clientWidth*2-1,f=-(c/d.clientHeight)*2+1,g=new THREE.Vector3(e,f,.5),h=this.camera.threeCamera;b.unprojectVector(g,h),g.subSelf(h.position).normalize();return new THREE.Ray(h.position,g)},c.prototype.getWidth=function(){return this.renderer.domElement.clientWidth},c.prototype.getHeight=function(){return this.renderer.domElement.clientHeight},c.prototype.onRender=function(){this.renderer.render(this.scene,this.camera.threeCamera)},c.prototype.setBGColor=function(a,b){this._bgColor=a,this._bgAlpha=b===undefined?1:b,this.renderer.setClearColorHex(this._bgColor,this._bgAlpha)},c.prototype.setCamera=function(a){this.scene&&(this.camera&&(this.scene.remove(this.camera.threeCamera),this.scene.remove(this.camera.light)),this.scene.add(a.threeCamera),this.scene.add(a.light)),this.camera&&this.camera.cleanup(),this.picker.camera=a,this.camera=a},c.prototype.setRenderer=function(b){var c=b.domElement;c.style.width="100%",c.style.height="100%",a.input.init(c),b.setClearColorHex(this._bgColor,this._bgAlpha),this.renderer=b,this._resize()},c.prototype.setScene=function(a){this.scene&&(this.camera&&(this.scene.remove(this.camera.threeCamera),this.scene.remove(this.camera.light)),this.scene.cleanup()),this.camera&&(a.add(this.camera.threeCamera),a.add(this.camera.light)),this.picker.scene=a,this.scene=a},c.prototype.useCameraLight=function(a){a?this.scene.add(this.camera.light):this.scene.remove(this.camera.light)},a.makeCitizen(c,"hemi.Client",{toOctane:c.prototype._octane});return a}(hemi||{}),hemi=function(a){var b=function(){this._current=0,this.iterations=-1,this.name="",this.startTime=0,this.stopTime=0};b.prototype._octane=["iteration","name","startTime","stopTime"],a.Loop=b,a.makeOctanable(a.Loop,"hemi.Loop",a.Loop.prototype._octane);var c=function(a,b,c){this._currentTime=a?a:0,this._isAnimating=!1,this.animations=c?c.animations:[],this.beginTime=a?a:0,this.endTime=b?b:0,this.loops=[]};c.prototype._clean=function(){this._isAnimating&&this.stop(),this.animations=[],this.loops=[]},c.prototype._msgSent=[a.msg.animate,a.msg.start,a.msg.stop],c.prototype._octane=["beginTime","endTime","loops","reset"],c.prototype.addLoop=function(a){this.loops.indexOf(a)===-1&&this.loops.push(a)},c.prototype.onRender=function(b){var c=this.currentTime,e=b.elapsedTime;this.currentTime+=e,d.call(this),this.send(a.msg.animate,{previous:c,time:this.currentTime}),this.currentTime>=this.endTime&&(e=this.endTime-c,this.stop(),this.reset());for(var f=0,g=this.animations.length;f<g;++f)this.animations[f].update(e)},c.prototype.removeLoop=function(a){var b=this.loops.indexOf(a),c=null;b!==-1&&(c=this.loops.splice(b,1)[0]);return c},c.prototype.reset=function(){this._currentTime=this.beginTime;for(var a=0,b=this.loops.length;a<b;++a)this.loops[a]._current=0},c.prototype.start=function(){if(!this._isAnimating){for(var b=0,c=this.animations.length;b<c;++b)this.animations[b].play(!1,this._currentTime);this._isAnimating=!0,a.addRenderListener(this),this.send(a.msg.start,{})}},c.prototype.stop=function(){if(this._isAnimating){for(var b=0,c=this.animations.length;b<c;++b)this.animations[b].stop();a.removeRenderListener(this),this._isAnimating=!1,this.send(a.msg.stop,{})}};var d=function(){for(var a=0,b=this.loops.length;a<b;++a){var c=this.loops[a];c._current!==c.iterations&&this.currentTime>=c.stopTime&&(this.currentTime=c.startTime,c._current++)}};a.makeCitizen(c,"hemi.AnimationGroup",{cleanup:c.prototype._clean,toOctane:c.prototype._octane});return a}(hemi||{}),hemi=function(a){a=a||{},a.RotatorBase=function(a,b){var c=b||{};this.accel=c.accel||new THREE.Vector3,this.angle=c.angle||new THREE.Vector3,this.vel=c.vel||new THREE.Vector3,this.time=0,this.stopTime=0,this.steadyRotate=!1,this.mustComplete=!1,this.startAngle=this.angle.clone(),this.stopAngle=this.angle.clone(),this.toLoad={},this.transformObjs=[],a!=null&&this.addTransform(a),this.enable()},a.RotatorBase.prototype={addTransform:function(a){this.transformObjs.push(a),applyRotator.call(this,[a])},clear:function(){this.accel=new THREE.Vector3(0,0,0),this.angle=new THREE.Vector3(0,0,0),this.vel=new THREE.Vector3(0,0,0)},clearTransforms:function(){while(this.transformObjs.length>0)removeRotateTransforms.call(this,this.transformObjs[0])},disable:function(){this.enabled&&(a.removeRenderListener(this),this.enabled=!1)},enable:function(){this.enabled=!0,shouldRender.call(this)},getTransforms:function(){return this.transformObjs.slice()},rotate:function(b,c,d){if(!this.enabled||this.mustComplete)return!1;this.time=0,this.stopTime=c||.001,this.steadyRotate=!0,this.startAngle=this.angle.clone(),this.mustComplete=d||!1,this.stopAngle.add(this.angle,b),a.addRenderListener(this),this.send(a.msg.start,{});return!0},onRender:function(b){if(this.transformObjs.length>0){var c=b.elapsedTime;if(this.steadyRotate){this.time+=c,this.time>=this.stopTime&&(this.time=this.stopTime,this.steadyRotate=this.mustComplete=!1,a.removeRenderListener(this),this.send(a.msg.stop,{}));var d=this.time/this.stopTime,e=a.utils.lerp([this.startAngle.x,this.startAngle.y,this.startAngle.z],[this.stopAngle.x,this.stopAngle.y,this.stopAngle.z],d);this.angle.x=e[0],this.angle.y=e[1],this.angle.z=e[2]}else this.vel.addSelf(this.accel.clone().multiplyScalar(c)),this.angle.addSelf(this.vel.clone().multiplyScalar(c));applyRotator.call(this)}},removeTransforms:function(a){var b=this.transformObjs.indexOf(a);b>-1&&this.transformObjs.splice(b,1)},setAccel:function(a){this.accel=a.clone(),shouldRender.call(this)},setAngle:function(a){this.angle=a.clone(),applyRotator.call(this)},setOrigin:function(b){var c=(new THREE.Vector3).set(-b[0],-b[1],-b[2]),d=(new THREE.Matrix4).setTranslation(-b[0],-b[1],-b[2]);for(var e=0,f=this.transformObjs.length;e<f;++e){var g=this.transformObjs[e],h=g.geometry,i=g.parent,j=g.matrixWorld,k=(new THREE.Vector3).multiply(c,g.scale),l=k.x,m=k.y,n=k.z;while(i.parent!=null)i=i.parent;a.utils.shiftGeometry(g,d,i),k.x=l*j.n11+m*j.n12+n*j.n13,k.y=l*j.n21+m*j.n22+n*j.n23,k.z=l*j.n31+m*j.n32+n*j.n33,g.position.subSelf(k),g.updateMatrix(),g.updateMatrixWorld()}},setVel:function(a){this.vel=a.clone(),shouldRender.call(this)},toOctane:function(){var a=this._super(),b=["accel","angle","vel"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}a.props.push({name:"setOrigin",arg:[this.origin]});var f={};for(var g=0,h=this.transformObjs.length;g<h;g++){var i=this.transformObjs[g],j=i.offTran,k=i.rotTran;f[j.name]=[i.parent.localMatrix,k.localMatrix,j.localMatrix]}a.props.push({name:"toLoad",val:f});return a}},a.makeCitizen(a.RotatorBase,"hemi.Rotator",{msgs:["hemi.start","hemi.stop"],toOctane:[]}),a.TranslatorBase=function(a,b){var c=b||{};this.pos=c.pos||new THREE.Vector3,this.vel=c.vel||new THREE.Vector3,this.accel=c.accel||new THREE.Vector3,this.time=0,this.stopTime=0,this.mustComplete=!1,this.steadyMove=!1,this.startPos=this.pos.clone(),this.stopPos=this.pos.clone(),this.toLoad={},this.transformObjs=[],a!=null&&this.addTransform(a),this.enable()},a.TranslatorBase.prototype={addTransform:function(a){this.transformObjs.push(a),applyTranslator.call(this,[a])},cleanup:function(){this.disable(),this.clearTransforms()},clear:function(){this.pos=new THREE.Vector3,this.vel=new THREE.Vector3,this.accel=new THREE.Vector3},clearTransforms:function(){while(this.transformObjs.length>0)this.removeTransform(this.transformObjs[0])},disable:function(){this.enabled&&(a.removeRenderListener(this),this.enabled=!1)},enable:function(){this.enabled=!0,shouldRender.call(this)},getTransforms:function(){return this.transformObjs.slice()},move:function(b,c,d){if(!this.enabled||this.mustComplete)return!1;this.time=0,this.stopTime=c||.001,this.steadyMove=!0,this.startPos=this.pos.clone(),this.mustComplete=d||!1,this.stopPos.add(this.pos,b),a.addRenderListener(this),this.send(a.msg.start,{});return!0},onRender:function(b){if(this.transformObjs.length>0){var c=b.elapsedTime;if(this.steadyMove){this.time+=c,this.time>=this.stopTime&&(this.time=this.stopTime,this.steadyMove=this.mustComplete=!1,a.removeRenderListener(this),this.send(a.msg.stop,{}));var d=this.time/this.stopTime,e=a.utils.lerp([this.startPos.x,this.startPos.y,this.startPos.z],[this.stopPos.x,this.stopPos.y,this.stopPos.z],d);this.pos.x=e[0],this.pos.y=e[1],this.pos.z=e[2]}else this.vel.addSelf(this.accel.clone().multiplyScalar(c)),this.pos.addSelf(this.vel.clone().multiplyScalar(c));applyTranslator.call(this)}},removeTransforms:function(a){var b=this.transformObjs.indexOf(a);b>-1&&this.transformObjs.splice(b,1)},setAccel:function(a){this.accel=a.clone(),shouldRender.call(this)},setPos:function(a){this.pos=a.clone(),applyTranslator.call(this)},setVel:function(a){this.vel=a.clone(),shouldRender.call(this)}},a.makeCitizen(a.TranslatorBase,"hemi.Translator",{msgs:["hemi.start","hemi.stop"],toOctane:[]}),shouldRender=function(){!this.enabled||this.accel.isZero()&&this.vel.isZero()?a.removeRenderListener(this):a.addRenderListener(this)},applyTranslator=function(a){var b=this.transformObjs;a&&(b=a);for(var c=0,d=b.length;c<d;c++){var e=b[c];e.position=this.pos.clone(),e.updateMatrix(),e.updateMatrixWorld()}},applyRotator=function(b){var c=this.transformObjs;b&&(c=b);for(var d=0,e=c.length;d<e;d++){var f=c[d];if(f.useQuaternion){var g=(new THREE.Quaternion).setFromEuler(new THREE.Vector3(this.angle.x*a.RAD_TO_DEG,this.angle.y*a.RAD_TO_DEG,this.angle.z*a.RAD_TO_DEG));f.quaternion.multiply(f.quaternion,g)}else f.rotation.addSelf(this.angle);f.updateMatrix(),f.updateMatrixWorld()}};return a}(hemi||{}),hemi=function(a){function h(b){var c=function(b,d){var e=Math.random()*2*Math.PI,f=.8*c.size,g=-0.003*c.size;d.velocity=a.core.math.matrix4.transformPoint(a.core.math.matrix4.rotationY(7*e),[f,f,f]),d.velocity=a.core.math.matrix4.transformPoint(a.core.math.matrix4.rotationX(e),d.velocity),d.acceleration=a.core.math.mulVectorVector(d.velocity,[g,g,g]),d.acceleration=a.core.math.addVector(d.acceleration,c.wind)};c.wind=b.wind===undefined?[0,0,0]:b.wind,c.size=b.size===undefined?1:b.size;return c}function g(a){var b=function(a,c){c.acceleration=[b.factor[0]*c.velocity[0],b.factor[1]*c.velocity[1],b.factor[2]*c.velocity[2]]};b.factor=a.factor===undefined?[0,0,0]:a.factor;return b}var b=new a.particles.System;a.addRenderListener({onRender:function(a){b.update(a.elapsedTime)}}),a.ParticleFunctionIds={Acceleration:"Acceleration",Puff:"Puff"};var c=function(){this.name=null,this.options={}};a.ParticleFunction=c,a.makeOctanable(a.ParticleFunction,"hemi.ParticleFunction",["name","options"]);var d=function(a){this._newSystem=!1,this._system=null,this.blending=THREE.AdditiveBlending,this.client=a,this.colorRamp=[],this.params={},this.particleFunction=null,this.particles=null,this.transform=null};d.prototype._clean=function(){var a=this._system.emitters,b=a.indexOf(this.particles);a.splice(b,1),this.transform.parent.remove(this.transform),this.transform=null,this.particles=null},d.prototype._msgSent=[a.msg.visible],d.prototype._octane=["_newSystem","blending","client","colorRamp","params","particleFunction","setup"],d.prototype.hide=function(){this.particles===null&&this.setup(),this.transform.visible&&(this.transform.visible=!1,this.send(a.msg.visible,{visible:!1}))},d.prototype.setup=function(){var c=a.utils.clone(this.params),d=null;this.particleFunction!==null&&(d=a.getParticleFunction(this.particleFunction)),this._system=this._newSystem?new a.particles.System:b,this.particles=this._system.createEmitter(this.client.camera.threeCamera),this.particles.setBlending(this.blending),this.particles.setColorRamp(this.colorRamp),this.particles.setParameters(c,d),this.transform=new THREE.Mesh(this.particles.shape,this.particles.material),this.transform.doubleSided=!0,this.client.scene.add(this.transform)},d.prototype.show=function(){this.particles===null&&this.setup(),this.transform.visible||(this.transform.visible=!0,this.send(a.msg.visible,{visible:!0}))},a.makeCitizen(d,"hemi.ParticleEmitter",{cleanup:d.prototype._clean,toOctane:d.prototype._octane});var e=function(a){d.call(this,a),this.oneShot=null};e.prototype=new d,e.constructor=e,e.prototype._clean=function(){d.prototype._clean.call(this),this.oneShot=null},e.prototype._msgSent=d.prototype._msgSent.concat([a.msg.burst]),e.prototype.setup=function(){var c=a.utils.clone(this.params),d=null;this.particleFunction!==null&&(d=a.getParticleFunction(this.particleFunction)),this._system=this._newSystem?new a.particles.System:b,this.particles=this._newSystem.createEmitter(this.client.camera.threeCamera),this.particles.setBlending(this.blending),this.particles.setColorRamp(this.colorRamp),this.particles.setParameters(c,d),this.transform=new THREE.Object3D,this.client.scene.add(this.transform),this.oneShot=this.particles.createOneShot(this.transform)},e.prototype.trigger=function(){this.oneShot===null&&this.setup(),this.oneShot.trigger(this.params.position),this.send(a.msg.burst,{position:this.params.position})},a.makeCitizen(e,"hemi.ParticleBurst",{cleanup:e.prototype._clean,toOctane:e.prototype._octane});var f=function(a){d.call(this,a),this.isAnimating=!1,this.fireInterval=1,this.count=0};f.prototype=new d,f.constructor=f,f.prototype._msgSent=d.prototype._msgSent.concat([a.msg.start,a.msg.stop]),f.prototype._octane=d.prototype._octane.unshift("fireInterval"),f.prototype.onRender=function(a){this.count+=a.elapsedTime,this.count>=this.fireInterval&&(this.count=0,this.particles.birthParticles(this.params.position))},f.prototype.setup=function(){var c=a.utils.clone(this.params),d=null,e=this.params.numParticles||1,f=this.params.lifeTime||1+this.params.lifeTimeRange||0,g=f/this.fireInterval+1,h=parseInt(g*e,10);this.particleFunction!==null&&(d=a.getParticleFunction(this.particleFunction)),this._system=this._newSystem?new a.particles.System:b,this.particles=this._newSystem.createTrail(this.client.camera.threeCamera,h,c,null,d),this.particles.setBlending(this.blending),this.particles.setColorRamp(this.colorRamp)},f.prototype.start=function(){this.particles===null&&this.setup(),this.isAnimating||(this.isAnimating=!0,a.view.addRenderListener(this),this.send(a.msg.start,{}))},f.prototype.stop=function(){this.particles===null&&this.setup(),this.isAnimating&&(a.view.removeRenderListener(this),this.isAnimating=!1,this.count=0,this.send(a.msg.stop,{}))},a.makeCitizen(f,"hemi.ParticleTrail",{cleanup:f.prototype._clean,toOctane:f.prototype._octane}),a.createParticleEmitter=function(b,c,d,e,f){var g=new a.ParticleEmitter(b);g.colorRamp=c,g.params=d,e!=null&&(g.blending=blending),f&&(g.particleFunction=f),g.setup();return g},a.createParticleBurst=function(b,c,d,e,f){var g=new a.ParticleBurst(b);g.colorRamp=c,g.params=d,e!=null&&(g.blending=blending),f&&(g.particleFunction=f),g.setup();return g},a.createParticleTrail=function(b,c,d,e,f,g){var h=new a.ParticleTrail(b);h.colorRamp=c,h.params=d,h.fireInterval=e,f!=null&&(h.blending=blending),g&&(h.particleFunction=g),h.setup();return h},a.getParticleFunction=function(b){var c;switch(b.name){case a.ParticleFunctionIds.Acceleration:c=g(b.options);break;case a.ParticleFunctionIds.Puff:c=h(b.options);break;default:c=null}return c};return a}(hemi||{}),hemi=function(a){function m(a,b){var c=b.textStyle==null?"":b.textStyle+" ";b.textSize!=null?c+=b.textSize+"px ":c+="12px ",b.textTypeface!=null?c+='"'+b.textTypeface+'"':c+="helvetica",a.font=c,b.textAlign!=null&&(a.textAlign=b.textAlign),b.color!=null&&(a.fillStyle=l(b.color));if(b.outline!=null)a.strokeStyle=l(b.outline),a.shadowColor="rgba(0,0,0,0)";else if(b.shadow!=null){var d=b.shadow;a.shadowBlur=d.radius,a.shadowColor=l(d.color),a.shadowOffsetX=d.offsetX,a.shadowOffsetY=d.offsetY}else a.shadowColor="rgba(0,0,0,0)"}function l(a){return"rgba("+Math.round(a[0]*255)+","+Math.round(a[1]*255)+","+Math.round(a[2]*255)+","+a[3]+")"}var b=function(){this.image={shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,1]}},this.page={color:[0,0,0,.45],curve:0,shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,0]},outline:null},this.text={textSize:12,textTypeface:"helvetica",textAlign:"center",textStyle:"bold",strictWrapping:!0,lineMargin:5,color:[1,1,.6,1],shadow:{radius:.5,offsetY:1,offsetX:1,color:[0,0,0,1]},outline:null},this.video={shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,1]}}};b.prototype._octane=["image","page","text","load"],b.prototype.load=function(){a.setHudTheme(this)},a.HudTheme=b,a.makeOctanable(a.HudTheme,"hemi.HudTheme",a.HudTheme.prototype._octane);var c=function(){this._bottom=0,this._left=0,this._right=0,this._top=0,this.config={},this.mouseDown=null,this.mouseUp=null,this.mouseMove=null,this.visible=!0};c.prototype._checkEvent=function(a){return a.x<=this._right&&a.x>=this._left&&a.y<=this._bottom&&a.y>=this._top},c.prototype._octane=["_bottom","_left","_right","_top","config"],c.prototype.cleanup=function(){this.mouseDown=null,this.mouseUp=null,this.mouseMove=null,this.config={}},c.prototype.onMouseDown=function(a){var b=this._checkEvent(a);b&&this.mouseDown&&this.mouseDown(a);return b},c.prototype.onMouseMove=function(a){if(this.mouseMove){var b=this._checkEvent(a);this.mouseMove(a,b)}},c.prototype.onMouseUp=function(a){var b=this._checkEvent(a);b&&this.mouseUp&&this.mouseUp(a);return b};var d=function(){c.call(this),this._text=[],this._width=0,this._wrappedHeight=0,this._wrappedText=[],this._wrappedWidth=0,this.x=0,this.y=0};d.prototype=new c,d.constructor=d,d.prototype._octane=c.prototype._octane.concat(["_text","_width","x","y","wrapText"]),d.prototype.calculateBounds=function(){var a;this.config.textAlign!=null?a=this.config.textAlign.toLowerCase():a=k.text.textAlign.toLowerCase(),this._top=this.y,this._bottom=this._top+this._wrappedHeight;switch(a){case"left":this._left=this.x,this._right=this._left+this._wrappedWidth;break;case"right":this._right=this.x,this._left=this._right-this._wrappedWidth;break;default:var b=this._wrappedWidth/2;this._left=this.x-b,this._right=this.x+b}},d.prototype.draw=function(){a.hudManager.createTextOverlay(this,this.config)},d.prototype.setConfig=function(a){this.config=a,this.wrapText()},d.prototype.setText=function(b){this._text=a.utils.isArray(b)?b:[b],this.wrapText()},d.prototype.setWidth=function(a){this._width=a,this.wrapText()},d.prototype.wrapText=function(){if(!(this._width<=0||this._text.length===0)){var b=0,c=0,d=[];for(var e=0,f=this._text.length;e<f;++e){var g=a.hudManager.doTextWrapping(this._text[e],this._width,this.config);g.width>b&&(b=g.width),c+=g.height,d=d.concat(g.text)}this._wrappedWidth=b,this._wrappedHeight=c,this._wrappedText=d}},a.HudText=d,a.makeOctanable(a.HudText,"hemi.HudText",a.HudText.prototype._octane);var e=function(){c.call(this),this._height=0,this._image=null,this._width=0,this.srcX=0,this.srcY=0,this.url=null,this.x=0,this.y=0};e.prototype=new c,e.constructor=e,e.prototype._octane=c.prototype._octane.concat(["srcX","srcY","url","x","y","loadImage"]),e.prototype.calculateBounds=function(){this._top=this.y,this._bottom=this._top+this._height,this._left=this.x,this._right=this._left+this._width},e.prototype.cleanup=function(){c.prototype.cleanup.call(this),this._image=null},e.prototype.draw=function(){a.hudManager.createImageOverlay(this,this.config)},e.prototype.loadImage=function(){var b=this;a.loadImage(this.url,function(a){b._image=a,b._height=a.height,b._width=a.width})},e.prototype.setUrl=function(a){this.url=a,this.loadImage()},a.HudImage=e,a.makeOctanable(a.HudImage,"hemi.HudImage",a.HudImage.prototype._octane);var f=function(){c.call(this),this.disabledImg=null,this.enabled=!0,this.enabledImg=null,this.hovering=!1,this.hoverImg=null,this.selected=!1,this.selectedImg=null,this.x=0,this.y=0;var a=this;this.mouseMove=function(b,c){!!a.enabled&&!a.selected&&(c?a.hovering||(a.hovering=!0,a.draw()):a.hovering&&(a.hovering=!1,a.draw()))}};f.prototype=new c,f.constructor=f,f.prototype._octane=c.prototype._octane.concat(["disabledImg","enabledImg","hoverImg","selectedImg","x","y"]),f.prototype.calculateBounds=function(){var a=this.getImage();this._top=this.y,this._bottom=this._top+a._height,this._left=this.x,this._right=this._left+a._width},f.prototype.cleanup=function(){c.prototype.cleanup.call(this),this.mouseMove=null,this.enabledImg&&(this.enabledImg.cleanup(),this.enabledImg=null),this.disabledImg&&(this.disabledImg.cleanup(),this.disabledImg=null),this.selectedImg&&(this.selectedImg.cleanup(),this.selectedImg=null),this.hoverImg&&(this.hoverImg.cleanup(),this.hoverImg=null)},f.prototype.draw=function(){var a=this.getImage();a.x=this.x,a.y=this.y,a.draw()},f.prototype.getImage=function(){var a=this.enabledImg;this.enabled?this.selected?this.selectedImg&&(a=this.selectedImg):this.hovering&&this.hoverImg&&(a=this.hoverImg):this.disabledImg&&(a=this.disabledImg);return a},f.prototype.select=function(a){this.selected=a,this.draw()},f.prototype.setSrcCoords=function(b){var c=b.disabled,d=b.enabled,e=b.hover,f=b.selected;d!=null&&(this.enabledImg===null&&(this.enabledImg=new a.HudImage),this.enabledImg.srcX=d[0],this.enabledImg.srcY=d[1]),c!=null&&(this.disabledImg===null&&(this.disabledImg=new a.HudImage),this.disabledImg.srcX=c[0],this.disabledImg.srcY=c[1]),e!=null&&(this.hoverImg===null&&(this.hoverImg=new a.HudImage),this.hoverImg.srcX=e[0],this.hoverImg.srcY=e[1]),f!=null&&(this.selectedImg===null&&(this.selectedImg=new a.HudImage),this.selectedImg.srcX=f[0],this.selectedImg.srcY=f[1])},f.prototype.setUrls=function(b){var c=b.disabled,d=b.enabled,e=b.hover,f=b.selected;c!=null&&(this.disabledImg=new a.HudImage,this.disabledImg.setUrl(c)),d!=null&&(this.enabledImg=new a.HudImage,this.enabledImg.setUrl(d)),e!=null&&(this.hoverImg=new a.HudImage,this.hoverImg.setUrl(e)),f!=null&&(this.selectedImg=new a.HudImage,this.selectedImg.setUrl(f))},a.HudButton=f,a.makeOctanable(a.HudButton,"hemi.HudButton",a.HudButton.prototype._octane);var g=function(){c.call(this),this._height=0,this._urls=[],this._video=document.createElement("video"),this._width=0,this.x=0,this.y=0;var a=this._video,b=this;this._video.onloadeddata=function(){b._height===0?b._height=a.videoHeight:a.setAttribute("height",""+b._height),b._width===0?b._width=a.videoWidth:a.setAttribute("width",""+b._width)}};g.prototype=new c,g.constructor=g,g.prototype._octane=function(){var a=c.protothype._octane.concat(["x","y"]);for(var b=0,d=this._urls.length;b<d;++b){var e=this._urls[b];a.push({name:"addUrl",arg:[e.url,e.type]})}return a},g.prototype.addUrl=function(b,c){var d=document.createElement("source"),e=a.getLoadPath(b);d.setAttribute("src",e),d.setAttribute("type","video/"+c),this._video.appendChild(d),this._urls.push({url:b,type:c,node:d})},g.prototype.calculateBounds=function(){this._top=this.y,this._bottom=this._top+this._height,this._left=this.x,this._right=this._left+this._width},g.prototype.cleanup=function(){c.prototype.cleanup.call(this),this._video=null,this._urls=[]},g.prototype.draw=function(){a.hudManager.createVideoOverlay(this,this.config)},g.prototype.removeUrl=function(a){for(var b=0,c=this._urls.length;b<c;++b){var d=this._urls[b];if(d.url===a){this._video.removeChild(d.node),this._urls.splice(b,1);break}}},g.prototype.setHeight=function(a){this._height=a,this._video!==null&&this._video.setAttribute("height",""+a)},g.prototype.setWidth=function(a){this._width=a,this._video!==null&&this._video.setAttribute("width",""+a)},a.HudVideo=g,a.makeOctanable(a.HudVideo,"hemi.HudVideo",a.HudVideo.prototype._octane);var h=function(){c.call(this),this.auto=!0,this.drawBackground=!0,this.margin=5,this.elements=[]};h.prototype=new c,h.constructor=h,h.prototype._octane=c.prototype._octane.concat(["auto","drawBackground","elements","margin"]),h.prototype.add=function(a){this.elements.indexOf(a)===-1&&this.elements.push(a)},h.prototype.calculateBounds=function(){var a,b=this.elements.length;if(b===0)this._top=0,this._bottom=0,this._left=0,this._right=0;else{for(a=0;a<b;a++)this.elements[a].calculateBounds();if(this.auto){var c=this.elements[0];this._top=c._top,this._bottom=c._bottom,this._left=c._left,this._right=c._right;for(a=1;a<b;a++)c=this.elements[a],c._top<this._top&&(this._top=c._top),c._bottom>this._bottom&&(this._bottom=c._bottom),c._left<this._left&&(this._left=c._left),c._right>this._right&&(this._right=c._right);this._top-=this.margin,this._bottom+=this.margin,this._left-=this.margin,this._right+=this.margin}}},h.prototype.cleanup=function(){c.prototype.cleanup.call(this);for(var a=0,b=this.elements.length;a<b;++a)this.elements[a].cleanup();this.elements=[]},h.prototype.clear=function(){this.elements=[]},h.prototype.draw=function(){this.calculateBounds(),this.drawBackground&&a.hudManager.createRectangleOverlay(this,this.config);for(var b=0,c=this.elements.length;b<c;++b)this.elements[b].visible&&this.elements[b].draw()},h.prototype.onMouseDown=function(a){if(!this.visible)return!1;var b=this._checkEvent(a);if(b||!this.auto){var c=!1;for(var d=0,e=this.elements.length;d<e&&!c;++d)this.elements[d].visible&&(c=this.elements[d].onMouseDown(a));b&&!c&&this.mouseDown&&this.mouseDown(a)}return b},h.prototype.onMouseMove=function(a){if(!!this.visible){for(var b=0,c=this.elements.length;b<c;++b)this.elements[b].visible&&this.elements[b].onMouseMove(a);if(this.mouseMove){var d=this._checkEvent(a);this.mouseMove(a,d)}}},h.prototype.onMouseUp=function(a){var b=this._checkEvent(a);if(b||!this.auto){var c=!1,d=this.elements.length;for(var e=0,f=this.elements.length;e<f&&!c;++e)c=this.elements[e].onMouseUp(a);b&&!c&&this.mouseUp&&this.mouseUp(a)}return b},h.prototype.remove=function(a){var b=this.elements.indexOf(a),c=null;b!==-1&&(c=this.elements.splice(b,1)[0]);return c},h.prototype.setSize=function(a,b,c,d){this._top=a,this._bottom=b,this._left=c,this._right=d,this.auto=!1},a.HudPage=h,a.makeOctanable(a.HudPage,"hemi.HudPage",a.HudPage.prototype._octane);var i=function(a){this._visible=!1,this.client=a,this.currentPage=0,this.pages=[]};i.prototype._clean=function(){for(var a=0,b=this.pages.length;a<b;++a)this.pages[a].cleanup();this.pages=[]},i.prototype._msgSent=[a.msg.visible],i.prototype._octane=["client","pages"],i.prototype.add=function(a){this.pages.indexOf(a)===-1&&this.pages.push(a)},i.prototype.clear=function(){this._visible&&this.hide(),this.pages=[]},i.prototype.getCurrentPage=function(){return this.currentPage<this.pages.length?this.pages[this.currentPage]:null},i.prototype.getNumberOfPages=function(){return this.pages.length},i.prototype.hide=function(){this._visible&&(a.input.removeMouseMoveListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseDownListener(this),a.hudManager.clearDisplay(),this._visible=!1,this.currentPage=0,this.send(a.msg.visible,{page:0}))},i.prototype.onMouseDown=function(a){var b=this.getCurrentPage(),c=!1;b&&(c=b.onMouseDown(a));return c},i.prototype.onMouseMove=function(a){var b=this.getCurrentPage();b&&b.onMouseMove(a)},i.prototype.onMouseUp=function(a){var b=this.getCurrentPage(),c=!1;b&&(c=b.onMouseUp(a));return c},i.prototype.nextPage=function(){var a=this.pages.length;this.currentPage++,this.currentPage>=a?this.currentPage=a-1:this.showPage()},i.prototype.previousPage=function(){this.currentPage--,this.currentPage<0?this.currentPage=0:this.showPage()},i.prototype.remove=function(a){var b=this.pages.indexOf(a),c=null;b!==-1&&(this._visible&&b===this.currentPage&&(b!==0?this.previousPage():this.pages.length>1?this.nextPage():this.hide()),c=this.pages.splice(b,1)[0]);return c},i.prototype.show=function(){this._visible||(this._visible=!0,this.showPage(),a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this))},i.prototype.showPage=function(){if(!!this.client){a.hudManager.setClient(this.client),a.hudManager.clearDisplay();var b=this.getCurrentPage();b.draw(),this.send(a.msg.visible,{page:this.currentPage+1})}},a.makeCitizen(i,"hemi.HudDisplay",{cleanup:i.prototype._clean,toOctane:i.prototype._octane});var j=function(b){this._contexts={},this._videos=[],this.currentContext=null,a.addRenderListener(this)};j.prototype.addClient=function(b){var c=b.renderer.domElement,d=c.parentNode,e=document.createElement("canvas"),f=e.style;f.left=c.offsetLeft+"px",f.position="absolute",f.top=c.offsetTop+"px",f.zIndex="10",e.height=c.height,e.width=c.width,e.addEventListener("DOMMouseScroll",a.input.scroll,!0),e.addEventListener("mousewheel",a.input.scroll,!0),e.addEventListener("mousedown",a.input.mouseDown,!0),e.addEventListener("mousemove",a.input.mouseMove,!0),e.addEventListener("mouseup",a.input.mouseUp,!0),d.appendChild(e);var g=e.getContext("2d");g.textBaseline="top",this._contexts[b._getId()]=g,this.currentContext=g},j.prototype.clearDisplay=function(){var a=this.currentContext,b=a.canvas,c=this._videos;this._videos=[];for(var d=0,e=c.length;d<e;++d)c[d].video.pause();a.clearRect(0,0,b.width,b.height),a.beginPath()},j.prototype.createRectangleOverlay=function(b,c){var d=a.utils.join({},k.page,c),e=this.currentContext;e.save(),m(e,d);if(d.curve>0){var f=d.curve<=1?d.curve/2:.5;this.drawRoundRect(b,f,!0),d.outline!=null&&this.drawRoundRect(b,f,!1)}else{var g=b._left,h=b._top,i=b._right-g,j=b._bottom-h;e.fillRect(g,h,i,j),d.outline!=null&&e.strokeRect(g,h,i,j)}e.restore()},j.prototype.createTextOverlay=function(b,c){var d=a.utils.join({},k.text,c),e=d.textSize+d.lineMargin,f=this.currentContext,g=b._wrappedText,h=b.x,i=b.y;f.save(),m(f,d);for(var j=0,l=g.length;j<l;++j){var n=g[j];f.fillText(n,h,i),d.outline!=null&&f.strokeText(n,h,i),i+=e}f.restore()},j.prototype.createImageOverlay=function(b,c){var d=a.utils.join({},k.image,c),e=this.currentContext,f=b._image;e.save(),m(e,d),b._width!==f.width||b._height!==f.height||b.srcX!==0||b.srcY!==0?e.drawImage(f,b.srcX,b.srcY,b._width,b._height,b.x,b.y,b._width,b._height):e.drawImage(f,b.x,b.y),e.restore()},j.prototype.createVideoOverlay=function(b,c){var d=a.utils.join({},k.video,c),e=b._video;this._videos.push({video:e,config:d,context:this.currentContext,x:b.x,y:b.y,width:b._width||e.videoWidth,height:b._height||e.videoHeight}),e.play()},j.prototype.doTextWrapping=function(b,c,d){var e=a.utils.join({},k.text,d),f=this.currentContext,g;f.save(),m(f,e);if(e.strictWrapping)g=a.utils.wrapTextStrict(b,c,f);else{var h=f.measureText(b),i=h.width/b.length;g=a.utils.wrapText(b,c,i)}var j=g.length*(e.textSize+e.lineMargin),l=0;for(var n=0,o=g.length;n<o;++n){var h=f.measureText(g[n]);l<h.width&&(l=h.width)}f.restore();return{text:g,height:j,width:l}},j.prototype.drawRoundRect=function(b,c,d){var e=this.currentContext,f=b._left,g=b._right,h=b._top,i=b._bottom,j=g-f,k=i-h,l=k>j?j*c:k*c,m=270*a.DEG_TO_RAD,n=0,o=90*a.DEG_TO_RAD,p=180*a.DEG_TO_RAD;e.beginPath(),e.moveTo(f,h+l),e.lineTo(f,i-l),e.arc(f+l,i-l,l,p,o,!0),e.lineTo(g-l,i),e.arc(g-l,i-l,l,o,n,!0),e.lineTo(g,h+l),e.arc(g-l,h+l,l,n,m,!0),e.lineTo(f+l,h),e.arc(f+l,h+l,l,m,p,!0),e.closePath(),d?e.fill():e.stroke()},j.prototype.onRender=function(a){var b=this._videos;for(var c=0,d=b.length;c<d;++c){var e=b[c],f=e.context;f.save(),m(f,e.config),f.drawImage(e.video,e.x,e.y,e.width,e.height),f.restore()}},j.prototype.setClient=function(a){this.currentContext=this._contexts[a._getId()]},a.setHudTheme=function(a){k=a};var k=new a.HudTheme;k.name="Default",a.hudManager=new j;return a}(hemi||{}),hemi=function(a){a=a||{},a.Plane={XY:"xy",XZ:"xz",YZ:"yz"},a.Axis={X:"x",Y:"y",Z:"z"};var b=function(a){this.client=a,this.transformObjs=[],this.local=!1,this.enabled=!1,this.msgHandler=null,this.activeTransform=null};b.prototype._clean=function(){this.disable(),this.clearTransforms(),this.msgHandler=null},b.prototype.addTransform=function(a){this.transformObjs.push(a)},b.prototype.clearTransforms=function(){this.transformObjs.length=0},b.prototype.containsTransform=function(b){for(var c=0;c<this.transformObjs.length;c++){var d=[];a.utils.getChildren(this.transformObjs[c],d);for(var e=0;e<d.length;e++)if(b.id===d[e].id)return!0}return!1},b.prototype.disable=function(){this.enabled&&(a.unsubscribe(this.msgHandler,a.msg.pick),a.input.removeMouseMoveListener(this),a.input.removeMouseUpListener(this),this.enabled=!1)},b.prototype.enable=function(){this.enabled||(this.msgHandler=a.subscribe(a.msg.pick,this,"onPick",[a.dispatch.MSG_ARG+"data.pickedMesh",a.dispatch.MSG_ARG+"data.mouseEvent"]),a.input.addMouseMoveListener(this),a.input.addMouseUpListener(this),this.enabled=!0)},b.prototype.getTransforms=function(){return this.transformObjs.slice(0)},b.prototype.removeTransforms=function(a){var b=this.transformObjs.indexOf(a);b>-1&&this.transformObjs.splice(b,1)},b.prototype.setToLocal=function(){this.local=!0},b.prototype.setToWorld=function(){this.local=!1};var c=function(a,c,d,e){b.call(this,a),this.dragUV=null,this.plane=null,this.umin=null,this.umax=null,this.uv=e==null?[0,0]:e,this.vmin=null,this.vmax=null,c!=null&&this.setPlane(c),d!=null&&this.setLimits(d),this.enable()};c.prototype=new b,c.constructor=c,c.prototype._msgSent=[a.msg.drag],c.prototype._octane=["local","plane","umin","umax","vmin","vmax"],c.prototype.clamp=function(a){var b=this.uv[0]+a[0],c=this.uv[1]+a[1];this.umin!==null&&b<this.umin&&(b=this.umin),this.umax!==null&&b>this.umax&&(b=this.umax),this.vmin!==null&&c<this.vmin&&(c=this.vmin),this.vmax!==null&&c>this.vmax&&(c=this.vmax),a=[b-this.uv[0],c-this.uv[1]],this.uv=[b,c];return a},c.prototype.clearLimits=function(){this.umin=null,this.umax=null,this.vmin=null,this.vmax=null},c.prototype.getPlane=function(){if(this.activeTransform===null)return null;var b;if(this.local){var c=a.utils;b=[c.pointAsWorld(this.activeTransform,this.plane[0]),c.pointAsWorld(this.activeTransform,this.plane[1]),c.pointAsWorld(this.activeTransform,this.plane[2])]}else{var d=this.activeTransform.matrixWorld.getPosition();b=[(new THREE.Vector3).add(this.plane[0],d),(new THREE.Vector3).add(this.plane[1],d),(new THREE.Vector3).add(this.plane[2],d)]}return b},c.prototype.getUV=function(b,c){var d=this.client.castRay(b,c),e=this.getPlane(),f=a.utils.intersect(d,e);return[f[1],f[2]]},c.prototype.onMouseMove=function(b){if(this.dragUV!==null){var c=this.getUV(b.x,b.y),d=[c[0]-this.dragUV[0],c[1]-this.dragUV[1]],e=this.getPlane();d=this.clamp(d);var f=a.utils.uvToXYZ(d,e),g=a.utils.uvToXYZ([0,0],e),h=(new THREE.Vector3).sub(f,g);for(var i=0,j=this.transformObjs.length;i<j;i++){var k=this.transformObjs[i];a.utils.worldTranslate(h,k)}this.send(a.msg.drag,{drag:h})}},c.prototype.onMouseUp=function(a){this.activeTransform=null,this.dragUV=null},c.prototype.onPick=function(a,b){for(var c=0,d=this.transformObjs.length;c<d;c++)if(this.transformObjs[c].id==a.id){this.activeTransform=a,this.dragUV=this.getUV(b.x,b.y);break}},c.prototype.setLimits=function(a){this.umin=a[0][0],this.umax=a[1][0],this.vmin=a[0][1],this.vmax=a[1][1]},c.prototype.setPlane=function(b){switch(b){case a.Plane.XY:this.plane=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0)];break;case a.Plane.XZ:this.plane=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)];break;case a.Plane.YZ:this.plane=[new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)];break;default:this.plane=b}},a.makeCitizen(c,"hemi.Draggable",{cleanup:b.prototype._clean,toOctane:c.prototype._octane});var d=function(a,c,d,e){b.call(this,a),this.angle=e==null?0:e,this.axis=null,this.dragAngle=null,this.min=null,this.max=null,this.msgHandler=null,this.plane=null,c!=null&&this.setAxis(c),d!=null&&this.setLimits(d),this.enable()};d.prototype=new b,d.constructor=d,d.prototype._octane=function(){var a=["min","max"],b=[];for(var c=0,d=a.length;c<d;c++){var e=a[c];b.push({name:e,val:this[e]})}b.push({name:"setAxis",arg:[this.axis]});return b},d.prototype.clearLimits=function(){this.min=null,this.max=null},d.prototype.getAngle=function(b,c){var d;if(this.local){var e=a.utils;d=[e.pointAsWorld(this.activeTransform,this.plane[0]),e.pointAsWorld(this.activeTransform,this.plane[1]),e.pointAsWorld(this.activeTransform,this.plane[2])]}else{var f=this.activeTransform.matrixWorld.getPosition();d=[(new THREE.Vector3).add(this.plane[0],f),(new THREE.Vector3).add(this.plane[1],f),(new THREE.Vector3).add(this.plane[2],f)]}var g=this.client.castRay(b,c),h=a.utils.intersect(g,d);return Math.atan2(h[2],h[1])},d.prototype.onMouseMove=function(b){if(this.dragAngle!==null){var c=this.getAngle(b.x,b.y)-this.dragAngle,d;this.max!==null&&this.angle+c>=this.max&&(c=this.max-this.angle),this.min!==null&&this.angle+c<=this.min&&(c=this.min-this.angle),this.angle+=c,this.local||(this.dragAngle+=c);switch(this.axis){case a.Axis.X:d=new THREE.Vector3(-1,0,0);break;case a.Axis.Y:d=new THREE.Vector3(0,-1,0);break;case a.Axis.Z:d=new THREE.Vector3(0,0,1)}for(var e=0;e<this.transformObjs.length;e++){var f=this.transformObjs[e];this.local?a.utils.axisRotate(d,c,f):a.utils.worldRotate(d,c,f)}}},d.prototype.onMouseUp=function(a){this.dragAngle=null},d.prototype.onPick=function(a,b){for(var c=0,d=this.transformObjs.length;c<d;c++)if(this.transformObjs[c].id==a.id){this.activeTransform=a,this.dragAngle=this.getAngle(b.x,b.y);break}},d.prototype.setAxis=function(b){this.axis=b;switch(b){case a.Axis.X:this.plane=[new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)];break;case a.Axis.Y:this.plane=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)];break;case a.Axis.Z:this.plane=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0)]}},d.prototype.setLimits=function(a){a[0]!=null?this.min=a[0]:this.min=null,a[1]!=null?this.max=a[1]:this.max=null},a.makeCitizen(d,"hemi.Turnable",{cleanup:b.prototype._clean,toOctane:d.prototype._octane});var e=function(a,c){b.call(this,a),this.axis=null,this.dragAxis=null,this.dragOrigin=null,this.scale=null,this.setAxis(c),this.enable()};e.prototype=new b,e.constructor=e,e.prototype._msgSent=[a.msg.scale],e.prototype.getScale=function(a,b){var c=new THREE.Vector2(a-this.dragOrigin.x,b-this.dragOrigin.y),d=Math.abs(this.dragAxis.dot(c));return d},e.prototype.onMouseMove=function(b){if(this.dragAxis!==null){var c=this.getScale(b.x,b.y),d=c/this.scale,e=new THREE.Vector3(this.axis.x?d:1,this.axis.y?d:1,this.axis.z?d:1);for(var f=0;f<this.transformObjs.length;f++){var g=this.transformObjs[f];this.local?(g.scale.multiplySelf(e),g.updateMatrix()):a.utils.worldScale(e,g)}this.scale=c,this.send(a.msg.scale,{scale:c})}},e.prototype.onMouseUp=function(){this.dragAxis=null,this.dragOrigin=null,this.scale=null},e.prototype.onPick=function(a,b){for(var c=0,d=this.transformObjs.length;c<d;c++)if(this.transformObjs[c].id==a.id){this.activeTransform=a;var e=this.xyPoint(this.axis);this.dragOrigin=this.xyPoint(new THREE.Vector3(0,0,0)),this.dragAxis=(new THREE.Vector2(e.x-this.dragOrigin.x,e.y-this.dragOrigin.y)).normalize(),this.scale=this.getScale(b.x,b.y);break}},e.prototype.setAxis=function(b){switch(b){case a.Axis.X:this.axis=new THREE.Vector3(1,0,0);break;case a.Axis.Y:this.axis=new THREE.Vector3(0,1,0);break;case a.Axis.Z:this.axis=new THREE.Vector3(0,0,1);break;default:this.axis=new THREE.Vector3(0,0,0)}},e.prototype.xyPoint=function(b){if(this.activeTransform===null)return null;var c;this.local?c=a.utils.pointAsWorld(this.activeTransform,b):c=(new THREE.Vector3).add(b,this.activeTransform.position);return a.utils.worldToScreenFloat(this.client,c)},a.makeCitizen(e,"hemi.Scalable",{cleanup:b.prototype._clean,toOctane:[]});return a}(hemi||{}),hemi=function(a){function x(a,b){var c=a.uniforms.ptcScales,d=a.uniforms.ptcScaleKeys;c._array=new Float32Array(3*b.length);for(var e=0,f=b.length;e<f;++e){var g=b[e];c.value[e]=g.value,d.value[e]=g.key}}function w(a,b){var c=a.uniforms.ptcColors,d=a.uniforms.ptcColorKeys;c._array=new Float32Array(4*b.length);for(var e=0,f=b.length;e<f;++e){var g=b[e],h=e*4;c.value[e]=new THREE.Vector4(g.value[0],g.value[1],g.value[2],g.value[3]),d.value[e]=g.key}}function v(a,b){var c={color:16711680,opacity:1,transparent:b===undefined?!0:b},d;a==="lambert"?d=new THREE.MeshLambertMaterial(c):d=new THREE.MeshPhongMaterial(c);return d}function u(a,b){var c=a.vertices,d=a.faces,e=a.faceVertexUvs,f=c.length,g=d.length,h=[],i=[],j=[];for(var k=0;k<f;k++)h.push(0),i.push(0),j.push(new THREE.Vector2);for(var k=1;k<b;k++){var l=k*f,m=k/b,n=[],o=[];for(var p=0;p<f;p++){h.push(k),i.push(m),j.push(new THREE.Vector2(k,m));var q=c[p].position,r=new THREE.Vector3(q.x,q.y,q.z);n.push(new THREE.Vertex(r))}for(var p=0;p<g;p++){var s=d[p],t=null;s instanceof THREE.Face3?t=new THREE.Face3(s.a+l,s.b+l,s.c+l,null,null,s.material):t=new THREE.Face4(s.a+l,s.b+l,s.c+l,s.d+l,null,null,s.material),o.push(t)}a.vertices=a.vertices.concat(n),a.faces=a.faces.concat(o),a.faceVertexUvs=a.faceVertexUvs.concat(e)}a.computeCentroids(),a.computeFaceNormals();return{ids:h,offsets:i,idOffsets:j}}function t(a){}function s(a,b,c,d){}function r(a,b){}function p(){if(this._mesh){var a=this._mesh.material,b=this._boxes,c=a.uniforms.minXYZ,d=a.uniforms.maxXYZ;c._array=new Float32Array(3*b.length),d._array=new Float32Array(3*b.length);for(var e=0,f=b.length;e<f;++e){var g=b[e];c.value[e]=g.min,d.value[e]=g.max}}}function o(){if(!(!this._mesh||!this._materialSrc||this._boxes.length<2)){var b=this.client.renderer.context,c=g.vert,d=g.frag,e=this._mesh.material,f=e.program,h=e.program=f.isCurveGen?f:b.createProgram(),i=this._materialSrc.frag,j=this._materialSrc.vert,k=this._boxes.length,l=this._colors.length,m=this._scales.length,n=l>1,o=m>1,q=a.utils.getShaders(this.client,e),r=q.fragShd,s=q.vertShd,t=1,u=3,v=1.1,y=["sysTime","ptcMaxTime","ptcDec","numPtcs","tension","ptcScales","ptcScaleKeys","minXYZ","maxXYZ","ptcColors","ptcColorKeys","viewIT"];for(var z=0,A=y.length;z<A;++z){var B=y[z],C=e.uniforms[B];C&&(B==="ptcDec"?t=C.value:B==="ptcMaxTime"?u=C.value:B==="sysTime"&&(v=C.value),delete e.uniforms[B],delete h.uniforms[B])}if(j.search("ptcInterp")<0){var D=c.header.replace(/NUM_BOXES/g,k),E=c.support,F=c.bodySetup.replace(/NUM_BOXES/g,k);n?(D+=c.headerColors.replace(/NUM_COLORS/g,l),E+=c.supportColors.replace(/NUM_COLORS/g,l)):E+=c.supportNoColors,this._aim?(E+=c.supportAim,F+=c.bodyAim):F+=c.bodyNoAim,o?(D+=c.headerScales.replace(/NUM_SCALES/g,m),E+=c.supportScale.replace(/NUM_SCALES/g,m),F+=c.bodyScale):F+=c.bodyNoScale,F+=c.bodyEnd;var G=a.utils.parseSrc(j),H=G.body.replace(/modelViewMatrix/g,"ptcWorldView").replace(/objectMatrix/g,"ptcWorld").replace(/normalMatrix/g,"ptcNorm");G.postSprt=D+E,G.preBody=F,G.body=H,j=e.vertexShader=a.utils.buildSrc(G);var I=b.createShader(b.VERTEX_SHADER);b.shaderSource(I,j),b.compileShader(I),b.detachShader(h,s),b.attachShader(h,I)}if(i.search("ptcColor")<0){var J=a.utils.parseSrc(i,"gl_FragColor"),K=J.glob;J.postSprt=d.header,J.preBody=d.bodySetup,n&&(J.body.indexOf("diffuse")!==-1?J.body=J.body.replace(/diffuse/g,"ptcColor.rgb"):J.body=J.body.replace(/emissive/g,"ptcColor.rgb")),J.body=J.body.replace(/opacity/g,"(opacity * ptcColor.a)"),i=e.fragmentShader=a.utils.buildSrc(J);var L=b.createShader(b.FRAGMENT_SHADER);b.shaderSource(L,i),b.compileShader(L),b.detachShader(h,r),b.attachShader(h,L)}var M={idOffset:{type:"v2",value:this.idOffsets,needsUpdate:!0}},N={sysTime:{type:"f",value:v},ptcMaxTime:{type:"f",value:u},ptcDec:{type:"f",value:t},numPtcs:{type:"f",value:this._particles},tension:{type:"f",value:(1-this._tension)/2},minXYZ:{type:"v3v",value:[]},maxXYZ:{type:"v3v",value:[]},viewIT:{type:"m4",value:new THREE.Matrix4}};n&&(N.ptcColors={type:"v4v",value:[]},N.ptcColorKeys={type:"fv1",value:[]}),o&&(N.ptcScales={type:"v3v",value:[]},N.ptcScaleKeys={type:"fv1",value:[]}),e.uniforms=THREE.UniformsUtils.merge([e.uniforms,N]),e.attributes=THREE.UniformsUtils.merge([e.attributes,M]),e.uniformsList=[],b.linkProgram(h),b.getProgramParameter(h,b.LINK_STATUS)||a.error("Could not initialise shader. VALIDATE_STATUS: "+b.getProgramParameter(h,b.VALIDATE_STATUS)+", gl error ["+b.getError()+"]"),h.uniforms={},h.attributes={},h.isCurveGen=!0;for(var O in e.uniforms)e.uniformsList.push([e.uniforms[O],O]);for(var O in f.uniforms)var P=h.uniforms[O]=b.getUniformLocation(h,O);for(var O in N)h.uniforms[O]=b.getUniformLocation(h,O);for(var Q in f.attributes){var P=h.attributes[Q]=b.getAttribLocation(h,Q);b.enableVertexAttribArray(P)}for(var Q in M){var P=h.attributes[Q]=b.getAttribLocation(h,Q);b.enableVertexAttribArray(P)}this._decparam=e.uniforms.ptcDec,this._maxTimeParam=e.uniforms.ptcMaxTime,this._timeParam=e.uniforms.sysTime,this._viewITParam=e.uniforms.viewIT,p.call(this);var R=!1;for(var z=0;z<l&&!R;z++)R=this._colors[z].value[3]<1;e.transparent=R,n&&w(e,this._colors),o&&x(e,this._scales),this._mesh.dynamic=!0,this._mesh.__webglInit=this._mesh.__webglActive=!1,delete this._mesh.geometry.geometryGroups,delete this._mesh.geometry.geometryGroupsList,this.client.scene.__objectsAdded.push(this._mesh)}}var b=new THREE.MeshPhongMaterial({color:136,wireframe:!0,wireframeLinewidth:1}),c={},e=null,f=[],g={vert:{header:"uniform float sysTime; \nuniform float ptcMaxTime; \nuniform float ptcDec; \nuniform float numPtcs; \nuniform float tension; \nuniform mat4 viewIT; \nuniform vec3 minXYZ[NUM_BOXES]; \nuniform vec3 maxXYZ[NUM_BOXES]; \nattribute vec4 idOffset; \nvarying vec4 ptcColor; \n",headerColors:"uniform vec4 ptcColors[NUM_COLORS]; \nuniform float ptcColorKeys[NUM_COLORS]; \n",headerScales:"uniform vec3 ptcScales[NUM_SCALES]; \nuniform float ptcScaleKeys[NUM_SCALES]; \n",support:"float rand(vec2 co) { \n  return fract(sin(dot(co.xy, vec2(12.9898,78.233))) * 43758.5453); \n} \nvec3 randXYZ(vec2 co, vec3 min, vec3 max) { \n  float rX = rand(vec2(co.x, co.x)); \n  float rY = rand(vec2(co.y, co.y)); \n  float rZ = rand(co); \n  return vec3(mix(max.x, min.x, rX), \n              mix(max.y, min.y, rY), \n              mix(max.z, min.z, rZ)); \n} \nvec3 ptcInterp(float t, vec3 p0, vec3 p1, vec3 m0, vec3 m1) { \n  float t2 = pow(t, 2.0); \n  float t3 = pow(t, 3.0); \n  return (2.0*t3 - 3.0*t2 + 1.0)*p0 + (t3 -2.0*t2 + t)*m0 + \n   (-2.0*t3 + 3.0*t2)*p1 + (t3-t2)*m1; \n} \n",supportColors:"void setPtcClr(float ptcTime) { \n  if (ptcTime > 1.0) { \n    ptcColor = vec4(0.0); \n  } else { \n    int ndx; \n    float key; \n    for (int i = 0; i < NUM_COLORS-1; i++) { \n      if (ptcColorKeys[i] < ptcTime) { \n        ndx = i; \n        key = ptcColorKeys[i]; \n      } \n    } \n    float t = (ptcTime - key)/(ptcColorKeys[ndx+1] - key); \n    ptcColor = mix(ptcColors[ndx], ptcColors[ndx+1], t); \n  } \n} \n",supportNoColors:"void setPtcClr(float ptcTime) { \n  if (ptcTime > 1.0) { \n    ptcColor = vec4(0.0); \n  } else { \n    ptcColor = vec4(1.0); \n  } \n} \n",supportAim:"mat4 getRotMat(float t, vec3 p0, vec3 p1, vec3 m0, vec3 m1) { \n  float tM = max(0.0,t-0.02); \n  float tP = min(1.0,t+0.02); \n  vec3 posM = ptcInterp(tM, p0, p1, m0, m1); \n  vec3 posP = ptcInterp(tP, p0, p1, m0, m1); \n  vec3 dPos = posP-posM; \n  float dxz = sqrt(pow(dPos.x,2.0)+pow(dPos.z,2.0)); \n  float dxyz = length(dPos); \n  float cx = dPos.y/dxyz; \n  float cy = dPos.z/dxz; \n  float sx = dxz/dxyz; \n  float sy = dPos.x/dxz; \n  return mat4(cy,0.0,-1.0*sy,0.0, \n   sx*sy,cx,sx*cy,0.0, \n   cx*sy,-1.0*sx,cx*cy,0.0, \n   0.0,0.0,0.0,1.0); \n} \n",supportScale:"vec3 getScale(float ptcTime) { \n  if (ptcTime > 1.0) { \n    return vec3(1.0); \n  } else { \n    int ndx; \n    float key; \n    for (int i = 0; i < NUM_SCALES-1; i++) { \n      if (ptcScaleKeys[i] < ptcTime) { \n        ndx = i; \n        key = ptcScaleKeys[i]; \n      } \n    } \n    float t = (ptcTime - key)/(ptcScaleKeys[ndx+1] - key); \n    return mix(ptcScales[ndx], ptcScales[ndx+1], t); \n  } \n} \n",bodySetup:"  float id = idOffset[0]; \n  float offset = idOffset[1]; \n  vec2 seed = vec2(id, numPtcs-id); \n  float ptcTime = sysTime + offset; \n  if (ptcTime > ptcMaxTime) { \n    ptcTime -= ptcDec; \n  } \n  setPtcClr(ptcTime); \n  if (ptcTime > 1.0) { \n    ptcTime = 0.0; \n  } \n  float boxT = float(NUM_BOXES-1)*ptcTime; \n  int ndx = int(floor(boxT)); \n  float t = fract(boxT); \n  vec3 p0 = randXYZ(seed,minXYZ[ndx],maxXYZ[ndx]); \n  vec3 p1 = randXYZ(seed,minXYZ[ndx+1],maxXYZ[ndx+1]); \n  vec3 m0; \n  vec3 m1; \n  if (ndx == 0) { \n    m0 = vec3(0,0,0); \n  } else { \n    vec3 pm1 = randXYZ(seed,minXYZ[ndx-1],maxXYZ[ndx-1]); \n    m0 = (p1-pm1)*tension; \n  } \n  if (ndx == NUM_BOXES-2) { \n    m1 = vec3(0,0,0); \n  } else { \n    vec3 p2 = randXYZ(seed,minXYZ[ndx+2],maxXYZ[ndx+2]); \n    m1 = (p2-p0)*tension; \n  } \n  vec3 pos = ptcInterp(t, p0, p1, m0, m1); \n  mat4 tMat = mat4(1.0,0.0,0.0,0.0, \n   0.0,1.0,0.0,0.0, \n   0.0,0.0,1.0,0.0, \n   pos.x,pos.y,pos.z,1.0); \n  mat4 tMatIT = mat4(1.0,0.0,0.0,-1.0*pos.x, \n   0.0,1.0,0.0,-1.0*pos.y, \n   0.0,0.0,1.0,-1.0*pos.z, \n   0.0,0.0,0.0,1.0); \n",bodyAim:"  mat4 rMat = getRotMat(t, p0, p1, m0, m1); \n",bodyNoAim:"  mat4 rMat = mat4(1.0); \n",bodyScale:"  vec3 scale = getScale(ptcTime); \n  mat4 sMat = mat4(scale.x,0.0,0.0,0.0, \n   0.0,scale.y,0.0,0.0, \n   0.0,0.0,scale.z,0.0, \n   0.0,0.0,0.0,1.0); \n",bodyNoScale:"  mat4 sMat = mat4(1.0); \n",bodyEnd:"  mat4 ptcWorld = tMat*rMat*sMat; \n  mat4 ptcWorldViewIT = viewIT*tMatIT*rMat*sMat; \n  mat3 ptcNorm = mat3(ptcWorldViewIT[0].xyz, ptcWorldViewIT[1].xyz, ptcWorldViewIT[2].xyz); \n  mat4 ptcWorldView = viewMatrix * ptcWorld; \n"},frag:{header:"varying vec4 ptcColor; \n",bodySetup:"  if (ptcColor.a == 0.0) {\n    discard;\n  }\n",globNoColors:"gl_FragColor.a *= ptcColor.a; \n"}};a.CurveType={Linear:0,Bezier:1,CubicHermite:2,LinearNorm:3,Cardinal:4,Custom:5},a.BoundingBox=function(a,b){this.min=a||new THREE.Vector3,this.max=b||new THREE.Vector3};var h=function(a,b,c){this.count=0,this.tension=0,this.type=b,this.weights=[],this.xpts=[],this.xtans=[],this.ypts=[],this.ytans=[],this.zpts=[],this.ztans=[],a&&(c=c||{},c.points=a,this.loadConfig(c))};h.prototype._octane=function(){var a=["count","tension","weights","xpts","xtans","ypts","ytans","zpts","ztans"],b=[];for(var c=0,d=a.length;c<d;++c){var e=a[c];b.push({name:e,val:this[e]})}b.push({name:"setType",arg:[this.type]});return b},h.prototype.draw=function(a,b){var c=[];for(var d=0,e=a+2;d<e;++d)c[d]=this.interpolate(d/(a+1));r(c,b)},h.prototype.getEnd=function(){var a=this.count-1;return new THREE.Vector3(this.xpts[a],this.ypts[a],this.zpts[a])},h.prototype.getStart=function(){return new THREE.Vector3(this.xpts[0],this.ypts[0],this.zpts[0])},h.prototype.interpolate=function(a){return new THREE.Vector3(a,a,a)},h.prototype.loadConfig=function(b){var c=b.points,d=b.type||this.type||a.CurveType.Linear;this.setType(d);if(c){this.count=c.length;for(var e=0;e<this.count;e++)this.xpts[e]=c[e].x,this.ypts[e]=c[e].y,this.zpts[e]=c[e].z,this.xtans[e]=0,this.ytans[e]=0,this.ztans[e]=0,this.weights[e]=1}if(b.weights)for(var e=0;e<this.count;e++)this.weights[e]=b.weights[e]!==undefined?b.weights[e]:1;if(b.tangents)for(var e=0;e<this.count;e++)b.tangents[e]&&(this.xtans[e]=b.tangents[e][0]||0,this.ytans[e]=b.tangents[e][1]||0,this.ztans[e]=b.tangents[e][2]||0);b.tension&&(this.tension=b.tension),this.type===a.CurveType.Cardinal&&m.call(this)},h.prototype.setType=function(b){this.type=b;switch(b){case a.CurveType.Bezier:this.interpolate=i;break;case a.CurveType.CubicHermite:case a.CurveType.Cardinal:this.interpolate=j;break;case a.CurveType.Linear:this.interpolate=k;break;case a.CurveType.LinearNorm:this.interpolate=l;break;default:}};var i=function(b){var c=this.count,d=0,e=0,f=0,g=0;for(var h=0;h<c;++h){var i=this.weights[h]*a.utils.choose(c-1,h)*Math.pow(b,h)*Math.pow(1-b,c-1-h);d+=i*this.xpts[h],e+=i*this.ypts[h],f+=i*this.zpts[h],g+=i}return new THREE.Vector3(d/g,e/g,f/g)},j=function(b){var c=this.count-1,d=Math.floor(b*c);d>=c&&(d=c-1);var e=d/c,f=(b-e)/((d+1)/c-e),g=a.utils.cubicHermite(f,this.xpts[d],this.xtans[d],this.xpts[d+1],this.xtans[d+1]);y=a.utils.cubicHermite(f,this.ypts[d],this.ytans[d],this.ypts[d+1],this.ytans[d+1]),z=a.utils.cubicHermite(f,this.zpts[d],this.ztans[d],this.zpts[d+1],this.ztans[d+1]);return new THREE.Vector3(g,y,z)},k=function(a){var b=this.count-1,c=Math.floor(a*points);c>=b&&(c=b-1);var d=c/b,e=(a-d)/((c+1)/b-d),f=(1-e)*this.xpts[c]+e*this.xpts[c+1];y=(1-e)*this.ypts[c]+e*this.ypts[c+1],z=(1-e)*this.zpts[c]+e*this.zpts[c+1];return new THREE.Vector3(f,y,z)},l=function(a){var b=0,c=[0];for(var e=1,f=this.count;e<f;++e){var g=this.xpts[e-1]-this.xpts[e],h=this.ypts[e-1]-this.ypts[e],i=this.zpts[e-1]-this.zpts[e];b+=Math.sqrt(g*g+h*h+i*i),c[e]=d}var j=a*b,k=0;for(var e=1,f=this.count;e<f;++e)c[e]<j&&(k=e);var l=(j-c[k])/(c[k+1]-c[k]),m=(1-l)*this.xpts[k]+l*this.xpts[k+1],n=(1-l)*this.ypts[k]+l*this.ypts[k+1],o=(1-l)*this.zpts[k]+l*this.zpts[k+1];return new THREE.Vector3(m,n,o)},m=function(){var b=a.utils.clone(this.xpts),c=a.utils.clone(this.ypts),d=a.utils.clone(this.zpts);b.unshift(b[0]),b.push(b[b.length-1]),c.unshift(c[0]),c.push(c[c.length-1]),d.unshift(d[0]),d.push(d[d.length-1]);for(var e=0;e<this.count;e++)this.xtans[e]=(1-this.tension)*(b[e+2]-b[e])/2,this.ytans[e]=(1-this.tension)*(c[e+2]-c[e])/2,this.ztans[e]=(1-this.tension)*(d[e+2]-d[e])/2};a.Curve=h,a.makeOctanable(a.Curve,"hemi.Curve",a.Curve.prototype._octane);var n=function(a,b){this._aim=!1,this._boxes=[],this._colors=[],this._decparam=null,this._materialSrc=null,this._maxTimeParam=null,this._mesh=null,this._particles=0,this._scales=[],this._tension=0,this._timeParam=null,this._viewITParam=null,this.active=!1,this.client=a,this.life=0,b&&this.loadConfig(b)};n.prototype._msgSent=[a.msg.start,a.msg.stop],n.prototype._octane=function(){return[{name:"mesh",id:this._mesh._getId()},{name:"loadConfig",arg:[{aim:this._aim,boxes:this._boxes,colorKeys:this._colors,life:this.life,particleCount:this._particles,scaleKeys:this._scales,tension:this._tension}]}]},n.prototype.hideBoxes=function(){if(this._mesh){var a=c[this._mesh.id]||[];for(var b=0,d=a.length;b<d;++b)this._mesh.remove(a[b]);delete c[this._mesh.id]}},n.prototype.loadConfig=function(b){this._aim=b.aim===undefined?!1:b.aim,this._boxes=b.boxes?a.utils.clone(b.boxes):[],this.life=b.life||5,this._particles=b.particleCount||0,this._tension=b.tension||0,b.colorKeys?this.setColorKeys(b.colorKeys):b.colors?this.setColors(b.colors):this._colors=[],b.scaleKeys?this.setScaleKeys(b.scaleKeys):b.scales?this.setScales(b.scales):this._scales=[],b.particleShape?this.setParticleShape(b.particleShape):this._mesh=null},n.prototype.onRender=function(a){var b=a.elapsedTime/this.life,c=this._timeParam.value+b;while(c>1)--c;this._timeParam.value=c,this._viewITParam.value.copy(this.client.camera.threeCamera.matrixWorld).transpose()},n.prototype.pause=function(){this.active&&(a.removeRenderListener(this),this.active=!1)},n.prototype.play=function(){this.active||(this._maxTimeParam.value===1?(a.addRenderListener(this),this.active=!0):this.start())},n.prototype.setAim=function(a){this._aim!==a&&(this._aim=a,o.call(this))},n.prototype.setBoxes=function(b){var c=this._boxes.length;this._boxes=a.utils.clone(b),this._boxes.length===c?p.call(this):o.call(this)},n.prototype.setColors=function(a){var b=a.length,c=b===1?1:1/(b-1),d=[];for(var e=0;e<b;++e)d.push({key:e*c,value:a[e]});this.setColorKeys(d)},n.prototype.setColorKeys=function(a){var b=a.length;if(b===1){var c=a[0].value;this._colors=[{key:0,value:c},{key:1,value:c}]}else b>1?(a[0].key=0,a[a.length-1].key=1,this._colors=a):this._colors=[];o.call(this)},n.prototype.setMaterial=function(b){if(this._mesh){this._mesh.material=b;if(!b.program){var c=this.client.scene;this.client.renderer.initMaterial(b,c.lights,c.fog,this._mesh)}var d=a.utils.getShaders(this.client,b);this._materialSrc={frag:d.fragSrc,vert:d.vertSrc},o.call(this)}},n.prototype.setParticleCount=function(a){this._particles=a,this._mesh&&this.setParticleShape(this._mesh)},n.prototype.setParticleShape=function(a){this._mesh&&(this._mesh.parent&&this.client.scene.remove(this._mesh),this._mesh=null),a.parent||this.client.scene.add(a),this._mesh=a,this._particles=this._particles||1;var b=u(this._mesh.geometry,this._particles);this.idArray=b.ids,this.offsetArray=b.offsets,this.idOffsets=b.idOffsets,this.setMaterial(a.material||v())},n.prototype.setScales=function(a){var b=a.length,c=b===1?1:1/(b-1),d=[];for(var e=0;e<b;e++)d.push({key:e*c,value:a[e]});this.setScaleKeys(d)},n.prototype.setScaleKeys=function(a){var b=a.length;if(b===1){var c=a[0].value;this._scales=[{key:0,value:c},{key:1,value:c}]}else b>1?(a[0].key=0,a[b-1].key=1,this._scales=a):this._scales=[];o.call(this)},n.prototype.setTension=function(a){this._tension=a,this._mesh&&(this._mesh.material.getParam("tension").value=(1-this._tension)/2)},n.prototype.showBoxes=function(){if(this._mesh){var a=c[this._mesh.id]||[];for(var d=0;d<this._boxes.length;d++){var e=this._boxes[d],f=e.max.x-e.min.x,g=e.max.y-e.min.y,h=e.max.z-e.min.z,i=e.min.x+f/2,j=e.min.y+g/2,k=e.min.z+h/2,l=new THREE.CubeGeometry(f,g,h),m=new THREE.Mesh(l,b);m.position.addSelf(new THREE.Vector3(i,j,k)),this._mesh.add(m),a.push(m)}c[this._mesh.id]=a}},n.prototype.start=function(){this.active||(this.active=!0,this._timeParam.value=1,this._maxTimeParam.value=1,a.addRenderListener(this))},n.prototype.stop=function(){this.active&&(this.active=!1,this._timeParam.value=1.1,this._maxTimeParam.value=3,a.removeRenderListener(this))},n.prototype.translate=function(a,b,c){for(var d=0,e=this._boxes.length;d<e;d++){var f=this._boxes[d],g=f.min,h=f.max;g[0]+=a,h[0]+=a,g[1]+=b,h[1]+=b,g[2]+=c,h[2]+=c}p.call(this)},a.makeCitizen(n,"hemi.ParticleCurve",{toOctane:n.prototype._octane});var q=function(a,b){n.call(this,a,b),this.endTime=1,this.starting=!1,this.stopping=!1};q.prototype=new n,q.prototype.constructor=q,q.prototype.onRender=function(b){var c=b.elapsedTime/this.life,d=this._timeParam.value+c;if(d>this.endTime)if(this.stopping)this.active=!1,this.stopping=!1,this._maxTimeParam.value=3,a.removeRenderListener(this),d=1.1;else{this.starting&&(this.starting=!1,this.endTime=1,this._decparam.value=1,this._maxTimeParam.value=1);while(--d>this.endTime);}this.stopping&&(this._maxTimeParam.value+=c),this._timeParam.value=d,this._viewITParam.value.copy(this.client.camera.threeCamera.matrixWorld).transpose()},q.prototype.play=function(){this.active||(this.starting||this.stopping||this._maxTimeParam.value===1?(a.addRenderListener(this),this.active=!0):this.start())},q.prototype.start=function(){this.stopping&&(a.removeRenderListener(this),this.active=!1,this.stopping=!1),this.active||(this.active=!0,this.starting=!0,this.stopping=!1,this.endTime=2,this._decparam.value=2,this._maxTimeParam.value=2,this._timeParam.value=1,a.addRenderListener(this))},q.prototype.stop=function(a){this.active&&(a?this.endTime=-1:this.stopping||(this.endTime=this._timeParam.value+1),this.starting=!1,this.stopping=!0)},a.makeCitizen(q,"hemi.ParticleCurveTrail",{toOctane:q.prototype._octane});return a}(hemi||{});(function(){var a=function(a,b){var c=b.maps,d,e,f,g=0;this.maps=[];for(d=0,e=c.length;d<e;d++)f=c[d],this.maps.push(b.map instanceof THREE.Texture?f:THREE.ImageUtils.loadTexture(hemi.loadPath+f,null,function(){g++,g>=e&&b.callback&&b.callback()}));b.map=this.maps[0],THREE.Sprite.call(this,b),this.cycle=0,this.maxCycles=0,this.clock=0,this.period=1,this.running=!1,this.client=a,a.scene.add(this)};a.prototype=new THREE.Sprite({map:new THREE.Texture(new Image)}),a.prototype.constructor=a,a.prototype.supr=THREE.Sprite.prototype,a.prototype.addFrame=function(a,b){this.maps.push(THREE.ImageUtils.loadTexture(hemi.loadPath+a,null,b))},a.prototype.onRender=function(a){!this.running||(this.clock+=a.elapsedTime,this.clock>=this.period&&(this.cycle++,this.cycle==this.maxCycles?this.stop():(this.setFrame(this.cycle),this.clock%=this.period)))},a.prototype.run=function(a){this.cycle=0,this.maxCycles=a||this.samplers.length,this.clock=0,this.setFrame(0),this.running=!0,hemi.addRenderListener(this)},a.prototype.setFrame=function(a){if(this.maps.length>0){var b=a%this.maps.length;this.map=this.maps[b]}},a.prototype.setPeriod=function(a){this.period=a},a.prototype.stop=function(){this.running=!1},hemi.makeCitizen(a,"hemi.Sprite",{msgs:["hemi.start","hemi.stop"],toOctane:[]})})(),function(a){function f(a){var b=a/2,c=[new THREE.Vertex(new THREE.Vector3(b,b,b)),new THREE.Vertex(new THREE.Vector3(-b,-b,b)),new THREE.Vertex(new THREE.Vector3(-b,b,-b)),new THREE.Vertex(new THREE.Vector3(b,-b,-b))],e=[new THREE.Face3(0,2,1),new THREE.Face3(0,1,3),new THREE.Face3(0,3,2),new THREE.Face3(1,2,3)],f=[[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)]];return d(c,e,f)}function e(a,b,c){var e=a/2,f=b/2,g=c/2,h=[new THREE.Vertex(new THREE.Vector3(f,-e,g)),new THREE.Vertex(new THREE.Vector3(-f,-e,g)),new THREE.Vertex(new THREE.Vector3(-f,-e,-g)),new THREE.Vertex(new THREE.Vector3(f,-e,-g)),new THREE.Vertex(new THREE.Vector3(0,e,0))],i=[new THREE.Face3(0,1,2),new THREE.Face3(0,2,3),new THREE.Face3(1,0,4),new THREE.Face3(2,1,4),new THREE.Face3(3,2,4),new THREE.Face3(0,3,4)],j=[[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)]];return d(h,i,j)}function d(b,c,d){var e=new THREE.Geometry;e.vertices=b,e.faces=c,e.faceVertexUvs[0]=d;for(var f=0,g=c.length;f<g;++f){var h=c[f],i=a.utils.computeNormal(b[h.a],b[h.b],b[h.c]);h.normal.copy(i),h.vertexNormals.push(i.clone(),i.clone(),i.clone())}e.computeCentroids(),e.mergeVertices();return e}function c(a,b,c){var d=a+b,e=a/2,f=d/2,g=e/2,h=0,i=f,j=[new THREE.Vector2(h,i),new THREE.Vector2(h+=e,i-=a),new THREE.Vector2(h-=g,i),new THREE.Vector2(h,i-=b),new THREE.Vector2(h-=e,i),new THREE.Vector2(h,i+=b),new THREE.Vector2(h-=g,i),new THREE.Vector2(h+=e,i+=a)],k=new THREE.Shape(j);return k.extrude({amount:c,bevelEnabled:!1})}a.ShapeType={ARROW:"arrow",BOX:"box",CONE:"cone",CUBE:"cube",CUSTOM:"custom",CYLINDER:"cylinder",OCTA:"octa",PLANE:"plane",PYRAMID:"pyramid",SPHERE:"sphere",TETRA:"tetra"};var b=function(a,b){this.client=a,this.config=b||{},this.mesh=null,this.config.shape&&this.create()};b.prototype._clean=function(){this.mesh!==null&&(this.mesh.cleanup(),this.mesh=null),this.client=null,this.config={}},b.prototype._octane=["client","config","mesh","create"],b.prototype.create=function(){this.mesh===null&&(this.mesh=new a.Mesh),a.createShape(this.config,this.mesh),this.setName(this.name),this.mesh.parent===undefined&&this.client.scene.add(this.mesh)},b.prototype.setColor=function(a){this.config.material?this.config.material.color=a:(this.config.color=a,this.mesh.material.color=a)},b.prototype.setName=function(a){this.name=a,this.mesh.name=this.name+" Mesh",this.mesh.geometry.name=this.name+" Geometry"},b.prototype.setOpacity=function(a){this.config.opacity=a,this.mesh.material.opacity=a,this.mesh.material.transparent=a<1},b.prototype.setType=function(a){this.config.shape=a,this.create()},a.makeCitizen(b,"hemi.Shape",{cleanup:b.prototype._clean,toOctane:b.prototype._octane}),a.createShape=function(b,g){var h=g||new a.Mesh,i=b.shape||a.ShapeType.Box;if(!h.material)if(b.material!==undefined)h.material=b.material;else{var j=b.color||0,k=b.opacity===undefined?1:b.opacity;h.material=new THREE.MeshPhongMaterial({color:j,opacity:k,transparent:k<1})}switch(i.toLowerCase()){case a.ShapeType.BOX:var l=b.width!==undefined?b.width:b.w!==undefined?b.w:1,m=b.height!==undefined?b.height:b.h!==undefined?b.h:1,n=b.depth!==undefined?b.depth:b.d!==undefined?b.d:1;h.geometry=new THREE.CubeGeometry(l,m,n);break;case a.ShapeType.CUBE:var o=b.size!==undefined?b.size:1;h.geometry=new THREE.CubeGeometry(o,o,o);break;case a.ShapeType.SPHERE:var p=b.radius!==undefined?b.radius:b.r!==undefined?b.r:1;h.geometry=new THREE.SphereGeometry(p,24,12);break;case a.ShapeType.CYLINDER:var q=b.radiusB!==undefined?b.radiusB:b.r1!==undefined?b.r1:1,r=b.radiusT!==undefined?b.radiusT:b.r2!==undefined?b.r2:1,m=b.height!==undefined?b.height:b.h!==undefined?b.h:1;h.geometry=new THREE.CylinderGeometry(q,r,m,24);break;case a.ShapeType.CONE:var p=b.radius!==undefined?b.radius:b.r!==undefined?b.r:1,m=b.height!==undefined?b.height:b.h!==undefined?b.h:1;h.geometry=new THREE.CylinderGeometry(0,p,m,24);break;case a.ShapeType.PLANE:var l=b.width!==undefined?b.width:b.w!==undefined?b.w:1,m=b.height!==undefined?b.height:b.h!==undefined?b.h:1;h.geometry=new THREE.PlaneGeometry(l,m);break;case a.ShapeType.ARROW:h.geometry=c(b.size!==undefined?b.size:1,b.tail!==undefined?b.tail:1,b.depth!==undefined?b.depth:1);break;case a.ShapeType.TETRA:h.geometry=f(b.size!==undefined?b.size:1);break;case a.ShapeType.OCTA:var o=b.size!==undefined?b.size:1;h.geometry=new THREE.OctahedronGeometry(o/2,0);break;case a.ShapeType.PYRAMID:h.geometry=e(b.height!==undefined?b.height:b.h!==undefined?b.h:1,b.width!==undefined?b.width:b.w!==undefined?b.w:1,b.depth!==undefined?b.depth:b.d!==undefined?b.d:1);break;case a.ShapeType.CUSTOM:h.geometry=d(b.vertices!==undefined?b.vertices:b.v!==undefined?b.v:[],b.faces!==undefined?b.faces:b.f!==undefined?b.f:[],b.faceVertexUvs!==undefined?b.faceVertexUvs:b.uvs!==undefined?b.uvs:[])}h.geometry.computeBoundingSphere(),h.boundRadius=h.geometry.boundingSphere.radius;return h}}(hemi);var hemi=function(a){function f(a){var b=a.object,c=a.buffer,d,e,f;f=b.material,f instanceof THREE.MeshFaceMaterial?(e=c.materialIndex,e>=0&&(d=b.geometry.materials[e],d.transparent?(a.transparent=d,a.opaque=null):(a.opaque=d,a.transparent=null))):(d=f,d&&(d.transparent?(a.transparent=d,a.opaque=null):(a.opaque=d,a.transparent=null)))}function e(a){var b=a.object,c=b.material;c.transparent?(a.transparent=c,a.opaque=null):(a.opaque=c,a.transparent=null)}function d(a,b){a.list[a.count]=b,a.count+=1}function c(a){var c=null;for(var d=0,e=b.length;d<e&&c===null;d++)b[d].client===a&&(c=b[d]);return c}a.fx=a.fx||{};var b=[];a.fx.cleanup=function(){b=[]},a.fx.clearFog=function(a){var b=c(a);if(b&&b.fog){a.scene.fog=undefined,a.setBGColor(b.oldBGHex,b.oldBGAlpha);for(var d=0,e=b.materials.length;d<e;d++){var f=b.materials[d];a.renderer.initMaterial(f.mat,a.scene.lights,a.scene.fog,f.obj)}}},a.fx.setFog=function(a,d,e,f,g){var h=c(a),i=a.scene.__webglObjects.concat(a.scene.__webglObjectsImmediate),j=[],k=!1;h||(h={client:a},b.push(h)),h.fog||(h.fog=new THREE.Fog,h.oldBGHex=a.renderer.getClearColor().getHex(),h.oldBGAlpha=a.renderer.getClearAlpha(),k=!0),h.fog.color.setHex(d),h.fog.near=f,h.fog.far=g,a.scene.fog=h.fog,a.setBGColor(d,e);if(k){for(var l=0,m=i.length;l<m;l++){var n=i[l],o=n.object,p=n.opaque,q=n.transparent;for(var r=0,s=p.count;r<s;r++)j.push({mat:p.list[r],obj:o});for(var r=0,s=q.count;r<s;r++)j.push({mat:q.list[r],obj:o})}h.materials=j}for(var l=0,m=h.materials.length;l<m;l++){var t=h.materials[l],u=t.mat,o=t.obj,v=a.scene.fog;if(k)a.renderer.initMaterial(u,a.scene.lights,v,o);else{var w=u.uniforms;w.fogColor.value=v.color,w.fogNear.value=v.near,w.fogFar.value=v.far}}},a.fx.setOpacity=function(a,b,c,d){var g=a.scene.__webglObjects.concat(a.scene.__webglObjectsImmediate),h=null;for(var i=0,j=g.length;i<j&&h===null;i++){var k=g[i];if(k.object.parent===b||k.object===b)h=k}h&&(c.transparent=d<1,c.opacity=d,h.transparent&&(h.transparent.list=[]),h.opaque&&(h.opaque.list=[]),f(h),e(h))};return a}(hemi||{}),hemi=function(a){var b=function(a,b){this._callback=b||null,this.count=0,this.loaded=0,this.textures={};if(a)for(var c in a)this.addTexture(c,a[c])};b.prototype.addLoadedTexture=function(a,b){this.count++,this.loaded++,this.textures[a]=b},b.prototype.addTexture=function(b,c){var d=this;this.count++,a.loadTexture(c,function(a){d.textures[b]=a,d.loaded++,d.loaded===d.count&&d._callback&&d._callback(d.textures)})},b.prototype.getTexture=function(a){return this.textures[a]},a.TextureSet=b;return a}(hemi||{}),hemi=function(a){var b=function(b){b.reset(),b.send(a.msg.stop,{time:b.startTime})};a.TimerBase=function(){this._started=null,this._time=0,this._timeId=null,this.startTime=1e3},a.TimerBase.prototype={pause:function(){if(this._timeId!==null){clearTimeout(this._timeId),this._timeId=null;var a=(new Date).getTime();this._time+=a-this._started}},reset:function(){this._started=null,this._time=0,this._timeId=null},resume:function(){this._timeId===null&&this._started!==null&&(this._timeId=setTimeout(b,this.startTime-this._time,this),this._started=(new Date).getTime())},start:function(){this._timeId!==null&&clearTimeout(this._timeId),this._time=0,this.send(a.msg.start,{time:this.startTime}),this._timeId=setTimeout(b,this.startTime,this),this._started=(new Date).getTime()},stop:function(){if(this._timeId!==null){clearTimeout(this._timeId);var b=(new Date).getTime();this._time+=b-this._started}if(this._started!==null){var c=this._time;this.reset(),this.send(a.msg.stop,{time:c})}}},a.makeCitizen(a.TimerBase,"hemi.Timer",{cleanup:function(){this._timeId!==null&&(clearTimeout(this._timeId),this._timeId=null,this._started=null)},msgs:[a.msg.start,a.msg.stop],toOctane:["startTime"]});return a}(hemi||{})