/*
 * Kuda includes a library and editor for authoring interactive 3D content for the web.
 * Copyright (C) 2011 SRI International.
 *
 * This program is free software; you can redistribute it and/or modify it under the terms
 * of the GNU General Public License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program;
 * if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 * Boston, MA 02110-1301 USA.
 */
<<<<<<< local
Array.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1}),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}());var hemi=function(a){var b=null,c=0,d=[],e=function(){requestAnimationFrame(e);var b=(new Date).getTime()*.001,f=c===0?0:b-c,g={elapsedTime:f};c=b;for(var h=0;h<a.clients.length;++h)a.clients[h].onRender(g);for(var h=0;h<d.length;++h)d[h].onRender(g)};a.version="1.5.0",a.clients=[],a.makeClients=function(){var b=document.getElementsByTagName("div"),c=[];Detector.webgl||Detector.addGetWebGLMessage();for(var d=0;d<b.length;++d){var f=b[d];if(f.id&&f.id.match(/^kuda/)){var g=new THREE.WebGLRenderer,h=new a.Client(g);g.setSize(window.innerWidth,window.innerHeight),f.appendChild(g.domElement),a.clients.push(h),c.push(h)}}e();return c},a.addRenderListener=function(a){var b=d.indexOf(a);b===-1&&d.push(a)},a.removeRenderListener=function(a){var b=d.indexOf(a),c=null;b!==-1&&(c=d.splice(b,1)[0]);return c},a.error=function(a){if(b)b(a);else{var c=new Error(a);c.name="HemiError";throw c}},a.setErrorCallback=function(a){b=a},a.init=function(){a.picking.init(),a.input.init(),a.view.init(),a.curve.init(),a.model.init(),a.effect.init(),a.hud.init(),a.shape.init(),a.sprite.init(),a.world.init()};return a}(hemi||{}),hemi=function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;a.Class=function(){},a.Class.extend=function(a){function g(){!b&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;b=!0;var e=new this;b=!1;for(var f in a)e[f]=typeof a[f]=="function"&&typeof d[f]=="function"&&c.test(a[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);this._super=c;return e}}(f,a[f]):a[f];g.prototype=e,g.constructor=g,g.extend=arguments.callee;return g};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.Hashtable=Hashtable,a.utils.Hashtable.prototype.query=function(b){var c=this.values(),d=[],e=[],f=[],g,h,i,j,k,l,m,n;for(x in b)a.utils.isArray(b[x])?e.push(x):d.push(x);var o=d.length,p=e.length;for(var q=0,r=c.length;q<r;q++){g=c[q],n=!0;for(k=0;n&&k<o;k++)h=d[k],n=g[h]===b[h];for(k=0;n&&k<p;k++){n=!1,h=e[k],i=g[h],j=b[h],m=j.length;for(l=0;!n&&l<m;l++)n=i===j[l]}n&&f.push(g)}return f};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.clone=function(b,c){var d=a.utils.isArray(b)?[]:{},c=c==null?!0:c;a.utils.join(d,b,c);return d},a.utils.compareArrays=function(b,c){var d=b.length===c.length;for(var e=0;d&&e<b.length;e++)b[e]instanceof Array?d=a.utils.compareArrays(b[e],c[e]):d=Math.abs(b[e]-c[e])<=.001;return d},a.utils.get=function(b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){if(this.readyState===4){this.onreadystatechange=a.utils.noop;var b=null;if(this.status===200||window.location.href.indexOf("http")===-1){var d=this.getResponseHeader("content-type");d&&d.indexOf("xml")>=0?b=this.responseXML:b=this.responseText}c(b,this.statusText)}},d.open("GET",b,!0);try{d.send(null)}catch(e){c(null,e.name+": "+e.message)}},a.utils.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},a.utils.join=function(){var b=arguments[0],c=arguments.length,d=arguments[c-1],e=!0;typeof d=="boolean"&&(e=d,--c);for(var f=1;f<c;f++){var g=arguments[f];for(var h in g){var i=g[h];if(e&&i!=null&&typeof i=="object"){var j=b[h],k=a.utils.isArray(i);if(j==null||typeof j!="object"||a.utils.isArray(j)!==k)j=k?[]:{};b[h]=a.utils.join(j,i)}else b[h]=i}}return b},a.utils.noop=function(){};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.cartesianToSpherical=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d),f=Math.acos(c/e),g=Math.atan2(b,d);return[e,f,g]},a.utils.choose=function(b,c){return a.utils.factorial(b,b-c+1)/a.utils.factorial(c)},a.utils.clamp=function(a,b,c){return Math.min(c,Math.max(b,a))},a.utils.cubicHermite=function(a,b,c,d,e){var f=a*a,g=f*a,h=2*g-3*f+1,i=g-2*f+a,j=-2*g+3*f,k=g-f;return h*b+i*c+j*d+k*e},a.utils.factorial=function(a,b){var c=1,d=b?b:2;while(d<=a)c*=d++;return c},a.utils.intersect=function(b,c){var d=c,e=[b.near,b.far],f=a.core.math.inverse([[e[0][0]-e[1][0],d[1][0]-d[0][0],d[2][0]-d[0][0]],[e[0][1]-e[1][1],d[1][1]-d[0][1],d[2][1]-d[0][1]],[e[0][2]-e[1][2],d[1][2]-d[0][2],d[2][2]-d[0][2]]]),g=[e[0][0]-d[0][0],e[0][1]-d[0][1],e[0][2]-d[0][2]],h=f[0][0]*g[0]+f[0][1]*g[1]+f[0][2]*g[2],i=f[1][0]*g[0]+f[1][1]*g[1]+f[1][2]*g[2],j=f[2][0]*g[0]+f[2][1]*g[1]+f[2][2]*g[2];return[h,i,j]},a.utils.linearToSine=function(a){return(Math.sin(Math.PI*a-Math.PI/2)+1)/2},a.utils.linearToParabolic=function(a){return a*a},a.utils.linearToParabolicInverse=function(a){return 1-(1-a)*(1-a)},a.utils.linearToExponential=function(a,b){return(Math.pow(b,a)-1)/(b-1)},a.utils.linearToExponentialInverse=function(b,c){return 1-a.utils.linearToExponential(1-b,c)},a.utils.penner={linearTween:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d){a/=d;return c*a*a+b},easeOutQuad:function(a,b,c,d){a/=d;return-c*a*(a-2)+b},easeInOutQuad:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a+b;a--;return-c/2*(a*(a-2)-1)+b},easeInCubic:function(a,b,c,d){a/=d;return c*a*a*a+b},easeOutCubic:function(a,b,c,d){a/=d,a--;return c*(a*a*a+1)+b},easeInOutCubic:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a+b;a-=2;return c/2*(a*a*a+2)+b},easeInQuart:function(a,b,c,d){a/=d;return c*a*a*a*a+b},easeOutQuart:function(a,b,c,d){a/=d,a--;return-c*(a*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a*a+b;a-=2;return-c/2*(a*a*a*a-2)+b},easeInQuint:function(a,b,c,d){a/=d;return c*a*a*a*a*a+b},easeOutQuint:function(a,b,c,d){a/=d,a--;return c*(a*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){a/=d/2;if(a<1)return c/2*a*a*a*a*a+b;a-=2;return c/2*(a*a*a*a*a+2)+b},easeInSine:function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){a/=d/2;if(a<1)return c/2*Math.pow(2,10*(a-1))+b;a--;return c/2*(-Math.pow(2,-10*a)+2)+b},easeInCirc:function(a,b,c,d){a/=d;return-c*(Math.sqrt(1-a*a)-1)+b},easeOutCirc:function(a,b,c,d){a/=d,a--;return c*Math.sqrt(1-a*a)+b},easeInOutCirc:function(a,b,c,d){a/=d/2;if(a<1)return-c/2*(Math.sqrt(1-a*a)-1)+b;a-=2;return c/2*(Math.sqrt(1-a*a)+1)+b}},a.utils.sphericalToCartesian=function(a){var b=a[0],c=a[1],d=a[2];return[b*Math.sin(c)*Math.cos(d),b*Math.sin(c)*Math.sin(d),b*Math.cos(c)]},a.utils.uvToXYZ=function(b,c){var d=a.core.math,e=d.mulScalarVector(b[0],d.subVector(c[1],c[0])),f=d.mulScalarVector(b[1],d.subVector(c[2],c[0]));pos=d.addVector(c[0],d.addVector(e,f));return pos},a.utils.worldToScreen=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[Math.round(k),Math.round(l)]},a.utils.worldToScreenFloat=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[k,l,j[2]]};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.buildSrc=function(a){var b=(a.preHdr?a.preHdr:"")+(a.hdr?a.hdr:"")+(a.postHdr?a.postHdr:"")+(a.preSprt?a.preSprt:"")+(a.sprt?a.sprt:"")+(a.postSprt?a.postSprt:"")+a.main+(a.preBody?a.preBody:"")+(a.body?a.body:"")+(a.postBody?a.postBody:"")+(a.preGlob?a.preGlob:"")+(a.glob?a.glob:"")+(a.postGlob?a.postGlob:"")+a.end;return b},a.utils.combineFragSrc=function(a,b){return this.combineSrc(a,b,"gl_FragColor")},a.utils.combineSrc=function(b,c,d){var e=this.parseSrc(b,d);a.utils.join(e,c);return this.buildSrc(e)},a.utils.combineVertSrc=function(a,b){return this.combineSrc(a,b,"gl_Position")},a.utils.getShaders=function(a){var b=a.gl,c=a.effect.program_,d=b.getAttachedShaders(c),e=b.getShaderSource(d[0]),f=b.getShaderSource(d[1]),g;e.search("gl_FragColor")>0?g={fragShd:d[0],fragSrc:e,vertShd:d[1],vertSrc:f}:g={fragShd:d[1],fragSrc:f,vertShd:d[0],vertSrc:e};return g},a.utils.parseSrc=function(a,b){var c=a.lastIndexOf(";",a.indexOf("{"))+1,d=a.indexOf("void main",c),e=a.indexOf("{",d)+1,f=a.indexOf(b,e),g=a.lastIndexOf(";")+1;a.charAt(c)==="\n"&&++c,a.charAt(e)==="\n"&&++e,a.charAt(f)==="\n"&&++f,a.charAt(g)==="\n"&&++g;var h={hdr:a.slice(0,c),sprt:a.slice(c,d),main:a.slice(d,e),body:a.slice(e,f),glob:a.slice(f,g),end:a.slice(g)};return h};return a}(hemi||{}),hemi=function(a){function c(a,c,d){var e=c,f=0,g=a.length,h=c-Math.max(c-d,0),i=Math.min(c+d,g-1)-c,j,k;for(var l=parseInt(c-h);l<=c+i;l++){k=b.get(a.charAt(l));if(k===null)continue;j=k/Math.abs(c-l),j>f&&(e=l,f=j)}return Math.min(e+1,g-1)}a.utils=a.utils||{},String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},a.utils.isNumeric=function(a){return a!==null&&!isNaN(a)&&a.length!==0};var b=new Hashtable;b.put(" ",10),b.put(",",20),b.put(";",30),b.put(".",10),b.put("!",40),b.put("?",40),a.utils.wrapTextStrict=function(c,d,e){var f=[],c=a.utils.cleanseText(c),g=c.length,h=e.measureText(c),i=h.width/g,j=Math.floor(d/i),k=Math.ceil(j/10),l=0,m=j,n,o;while(m<g){n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o<d&&m<g)m+=k,m>g&&(m=g),n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o>d)m--,n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;var p=m-1,q=c.charAt(p);while(!b.containsKey(q)&&p>l)p--,q=c.charAt(p);p>l&&(m=p+1),n=c.substring(l,m).trim(),f.push(n),l=m,m+=j}if(l!=g||f.length===0)n=c.substring(l,g).trim(),f.push(n);return f},a.utils.wrapText=function(b,d,e){var f=[],b=a.utils.cleanseText(b),g=b.length,h=parseInt(d/e),i=Math.ceil(g/h),j=h,k=0,l;for(var m=0;m<i-1;m++)l=k,k=c(b,j,10),f.push(b.substring(l,k).trim()),j=k+h;f.push(b.substring(k,g));return f},a.utils.cleanseText=function(a){a=a.replace("\n"," ");return a};return a}(hemi||{}),hemi=function(a){a.utils=a.utils||{},a.utils.isAnimated=function(a){var b=a.getParam("o3d.localMatrix");return b.inputConnection!=null},a.utils.fosterTransform=function(b){var c=b.children,d=b.shapes,e=a.core.mainPack.createObject("Transform");while(c.length>0)c[0].parent=e;e.parent=b;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return e},a.utils.pointAsLocal=function(a,b){var c=THREE.Matrix4.makeInvert(a.matrixWorld);return c.multiplyVector3(b.clone())},a.utils.pointAsWorld=function(a,b){return a.matrixWorld.multiplyVector3(b.clone())},a.utils.pointYAt=function(a,b,c){var d=c.x-b.x,e=c.y-b.y,f=c.z-b.z,g=Math.sqrt(d*d+f*f),h=Math.atan2(d,f),i=Math.atan2(g,e);a.rotation.y+=h,a.rotation.x+=i,a.updateMatrix();return a},a.utils.pointZAt=function(a,b,c){var d=(new THREE.Vector3).sub(c,b),e=Math.atan2(d.x,d.z),f=-Math.asin(d.y/d.length());a.rotation.y+=e,a.rotation.x+=f,a.updateMatrix();return a},a.utils.unfosterTransform=function(b){var c=b.children,d=b.shapes,e=b.parent;while(c.length>0)c[0].parent=e;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}b.parent=null,a.core.mainPack.removeObject(b);return e},a.utils.worldRotate=function(b,c,d){var e=a.core.math.matrix4,f=e.inverse(d.getUpdatedWorldMatrix()),g=e.transformDirection(f,b);d.axisRotate(g,c)},a.utils.worldScale=function(b,c){var d=a.core.math.matrix4,e=d.mul(d.mul(d.mul(c.getUpdatedWorldMatrix(),d.scaling(b)),d.inverse(c.getUpdatedWorldMatrix())),c.localMatrix);c.localMatrix=e},a.utils.worldTranslate=function(b,c){var d=a.core.math.matrix4,e=d.inverse(c.getUpdatedWorldMatrix()),f=d.transformDirection(e,b);c.translate(f)};return a}(hemi||{}),hemi=function(a){a.msg={animate:"hemi.animate",burst:"hemi.burst",cleanup:"hemi.cleanup",drag:"hemi.drag",enable:"hemi.enable",load:"hemi.load",pick:"hemi.pick",progress:"hemi.progress",ready:"hemi.ready",scale:"hemi.scale",start:"hemi.start",stop:"hemi.stop",unload:"hemi.unload",visible:"hemi.visible"};return a}(hemi||{}),hemi=function(a){var b=new THREE.ColladaLoader,c=1,d=function(){--c===0&&(c=1,a.send(a.msg.ready,{}))},e=function(b){return b.substr(0,4)==="http"?b:a.loadPath+b};a.loadPath="",a.loadCollada=function(a,f){a=e(a),++c,b.load(a,function(a){f&&f(a),d()})},a.ready=d;return a}(hemi||{}),hemi=function(a){var b=function(a,b){var c=b.split("."),d=c.length-1,e=window;for(var f=0;f<d;++f){var g=c[f];e[g]||(e[g]={}),e=e[g]}e[c[d]]=a},c=function(b,c){a.dispatch.postMessage(this,b,c)},d=function(b,c,d,e){return a.dispatch.registerTarget(this.worldId,b,c,d,e)},e=function(b,c,d){return a.dispatch.registerTarget(this.worldId,a.dispatch.WILDCARD,b,c,d)},f=function(b,c){return a.dispatch.removeTarget(b,{src:this.worldId,msg:c})};a.makeCitizen=function(g,h,i){function l(){g.apply(this,arguments),this.name=this.name||"",this._worldId=null,a.world.addCitizen(this)}i=i||{};var j=i.cleanup,k=i.msgs||[a.msg.cleanup];l.prototype=g.prototype,l.prototype._msgSent=k,l.prototype._getId=function(){return this._worldId},l.prototype._setId=function(b){var c=this._worldId;this._worldId=b,c!==null&&(a.world.citizens.remove(c),a.world.citizens.put(b,this))},l.prototype.cleanup=function(){this.send(a.msg.cleanup,{}),j&&j.apply(this,arguments),a.world.removeCitizen(this)},l.prototype.send=c,l.prototype.subscribe=d,l.prototype.subscribeAll=e,l.prototype.unsubscribe=f,l.constructor=l,a.makeOctanable(l,h,i.toOctane),b(l,h);return l},a.world=a.world||{},a.world.WORLD_ID=0;var g=1;a.world.citizens=new a.utils.Hashtable,a.world.setNextId=function(a){g=a},a.world.getNextId=function(){return g++},a.world.checkNextId=function(){return g},a.world._getId=function(){return a.world.WORLD_ID},a.world.addCitizen=function(b){var c=b._getId();c==null&&(c=this.getNextId(),b._setId(c));var d=this.citizens.get(c);d!==null&&(a.console.log("Citizen with id "+c+" already exists.",a.console.ERR),d.cleanup()),this.citizens.put(c,b)},a.world.removeCitizen=function(b){var c=b._getId(),d=this.citizens.remove(c);d===null&&a.console.log("Unable to remove Citizen with id "+c,a.console.WARN);return d!==null},a.world.getCitizens=function(a,b){var c={};a!=undefined&&(a.worldId!==undefined&&(c.worldId=a.worldId),a.name!==undefined&&(c.name=a.name),a.citizenType!==undefined&&(c.citizenType=a.citizenType));var d=this.citizens.query(c);if(b)for(var e=0,f=d.length;e<f;e++)b(d[e])||(d.splice(e,1),e--,f--);return d},a.world.getCitizenById=function(b){var c=this.citizens.get(b);c===null&&a.console.log("Tried to get Citizen with id "+b+", returned null.",a.console.ERR);return c},a.world.getAudio=function(b,c){b=b||{},b.citizenType=a.audio.Audio.prototype.citizenType;return this.getCitizens(b,c)},a.world.getCamCurves=function(b,c){b=b||{},b.citizenType=a.view.CameraCurve.prototype.citizenType;return this.getCitizens(b,c)},a.world.getHudDisplays=function(b,c){b=b||{},b.citizenType=a.hud.HudDisplay.prototype.citizenType;return this.getCitizens(b,c)},a.world.getHudElements=function(b,c){b=b||{},b.citizenType=a.hud.HudElement.prototype.citizenType;return this.getCitizens(b,c)},a.world.getModels=function(b,c){b=b||{},b.citizenType=a.model.Model.prototype.citizenType;return this.getCitizens(b,c)},a.world.getAnimations=function(b,c){b=b||{},b.citizenType=a.animation.Animation.prototype.citizenType;return this.getCitizens(b,c)},a.world.getEffects=function(b,c){var d=[];b=b||{},b.citizenType=a.effect.Emitter.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Burst.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Trail.prototype.citizenType,d=d.concat(this.getCitizens(b,c));return d},a.world.getViewpoints=function(b,c){b=b||{},b.citizenType=a.view.Viewpoint.prototype.citizenType;return this.getCitizens(b,c)},a.world.getPressureEngines=function(a,b){a=a||{},a.citizenType=hext.engines.PressureEngine.prototype.citizenType;return this.getCitizens(a,b)},a.world.getDraggables=function(b,c){b=b||{},b.citizenType=a.manip.Draggable.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTurnables=function(b,c){b=b||{},b.citizenType=a.manip.Turnable.prototype.citizenType;return this.getCitizens(b,c)},a.world.getRotators=function(b,c){b=b||{},b.citizenType=a.motion.Rotator.prototype.citizenType;return this.getCitizens(b,c)},a.world.getScenes=function(b,c){b=b||{},b.citizenType=a.scene.Scene.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTimers=function(b,c){b=b||{},b.citizenType=a.time.Timer.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTranslators=function(b,c){b=b||{},b.citizenType=a.motion.Translator.prototype.citizenType;return this.getCitizens(b,c)},a.world.getShapes=function(b,c){b=b||{},b.citizenType=a.shape.Shape.prototype.citizenType;return this.getCitizens(b,c)},a.world.getTranOwner=function(a){var b=a.getParam("ownerId"),c=null;b!==null&&(c=this.getCitizenById(b.value));return c};return a}(hemi||{}),hemi=function(a){var b=function(a){return Object.prototype.toString.call(a)==="[object Function]"},c=function(a,c){var d=[];for(var e=0;e<c.length;++e){var f=c[e],g=a[f],h={name:f};b(g)?h.arg=[]:g._getId&&g._worldId?h.id=g._getId():g._toOctane?h.oct=g._toOctane():h.val=g,d.push(h)}return d};a.makeOctanable=function(a,d,e){e=e||[],a.prototype._citizenType=d,a.prototype._toOctane=function(){var a={type:this._citizenType,props:b(e)?e.call(this):c(this,e)};this._worldId!=null&&(a.id=this._worldId),this.name.length>0&&!a.props.name&&a.props.unslice({name:"name",val:this.name});return a}};return a}(hemi||{}),hemi=function(a){a.dispatch=a.dispatch||{};var b=0;a.dispatch.WILDCARD="*",a.dispatch.ID_ARG="id:",a.dispatch.MSG_ARG="msg:",a.dispatch.Message=function(){this.src=null,this.msg=null,this.data={}},a.dispatch.MessageSpec=function(){this.src=null,this.msg=null,this.targets=[]},a.dispatch.MessageSpec.prototype={cleanup:function(){for(var a=0,b=this.targets.length;a<b;a++)this.targets[a].cleanup();this.targets=[]},toOctane:function(){var b=[];for(var c=0,d=this.targets.length;c<d;c++){var e=this.targets[c].toOctane();e!==null?b.push(e):a.console.log("Null Octane returned by MessageTarget",a.console.ERR)}var f=[{name:"src",val:this.src},{name:"msg",val:this.msg},{name:"targets",oct:b}],g={type:"hemi.dispatch.MessageSpec",props:f};return g},addTarget:function(b){this.targets.indexOf(b)!=-1&&a.console.log("MessageSpec already contains MessageTarget",a.console.WARN),this.targets.push(b)},removeTarget:function(b){var c=null,d=this.targets.indexOf(b);if(d!=-1){var e=this.targets.splice(d,1);e.length===1&&(c=e[0])}else a.console.log("MessageTarget not found in MessageSpec",a.console.WARN);return c},getHash:function(){return this.msg+this.src}},a.dispatch.MessageTarget=function(){this.dispatchId=null,this.name="",this.handler=null,this.func=null,this.args=null},a.dispatch.MessageTarget.prototype={cleanup:function(){this.handler=null},toOctane:function(){if(!this.handler.getId){a.console.log("Handler object in MessageTarget can not be saved to Octane",a.console.WARN);return null}var b=["dispatchId","name","func","args"],c=[{name:"handler",id:this.handler.getId()}];for(var d=0,e=b.length;d<e;d++){var f=b[d];c.push({name:f,val:this[f]})}var g={type:"hemi.dispatch.MessageTarget",props:c};return g}},a.dispatch.msgSpecs=new a.utils.Hashtable,a.dispatch.setNextId=function(a){b=a},a.dispatch.getNextId=function(){return b++},a.dispatch.checkNextId=function(){return b},a.dispatch.loadEntries=function(a){for(var b=0,c=a.length;b<c;b++){var d=a[b];this.msgSpecs.put(d.getHash(),d)}},a.dispatch.cleanup=function(){this.msgSpecs.each(function(a,b){b.cleanup()}),this.msgSpecs.clear()},a.dispatch.toOctane=function(){var c={nextId:b,ents:[]};this.msgSpecs.each(function(b,d){var e=d.toOctane();e!==null?c.ents.push(e):a.console.log("Null Octane returned by MessageSpec",a.console.ERR)});return c},a.dispatch.getSpecs=function(b,c){var d;if(b===undefined)d=this.msgSpecs.values();else{var e={};c?(b.src!==undefined&&(b.src===a.dispatch.WILDCARD?e.src=a.dispatch.WILDCARD:e.src=[b.src,a.dispatch.WILDCARD]),b.msg!==undefined&&(b.msg===a.dispatch.WILDCARD?e.msg=a.dispatch.WILDCARD:e.msg=[b.msg,a.dispatch.WILDCARD])):(b.src!==undefined&&(e.src=b.src),b.msg!==undefined&&(e.msg=b.msg)),d=this.msgSpecs.query(e)}return d},a.dispatch.getSpecsFast=function(b,c,d){var e=[],f=c+b,g=this.msgSpecs.get(f);g!==null&&e.push(g);if(d){var h=b===a.dispatch.WILDCARD;h||(f=c+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)),c!==a.dispatch.WILDCARD&&(f=a.dispatch.WILDCARD+b,g=this.msgSpecs.get(f),g!==null&&e.push(g),h||(f=a.dispatch.WILDCARD+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)))}return e},a.dispatch.getTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a.dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;h++){var j=c[h].targets;for(var k=0,l=j.length;k<l;k++){var m=j[k],n=!0;e!==undefined&&(n=m.dispatchId===e),n&&f!==undefined&&(n=m.name===f),n&&g!==undefined&&(n=m.handler===g),n&&d.push(m)}}return d},a.dispatch.getTargetSpec=function(a){var b=this.getSpecs(),c=a.dispatchId;for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f.targets;for(var h=0,i=g.length;h<i;h++)if(g[h].dispatchId===c)return f}return null},a.dispatch.createSpec=function(b,c){var d=this.getSpecsFast(b,c,!1),e;d.length===0?(e=new a.dispatch.MessageSpec,e.src=b,e.msg=c,this.msgSpecs.put(e.getHash(),e)):(d.length>1&&a.console.log("Found "+d.length+" MessageSpecs with the same src and msg.",a.console.ERR),e=d[0]);return e},a.dispatch.registerTarget=function(b,c,d,e,f){var g=this.createSpec(b,c),h=new a.dispatch.MessageTarget;h.dispatchId=this.getNextId(),h.handler=d,e&&(h.func=e),f&&(h.args=f),g.addTarget(h);return h},a.dispatch.removeTarget=function(b,c){var d=this.getSpecs(c,!1),e=null;for(var f=0,g=d.length;f<g;f++){var h=d[f];e=h.removeTarget(b);if(e!==null)break}e===null&&a.console.log("MessageTarget was not found and therefore not removed",a.console.WARN);return e},a.dispatch.setTargetSpec=function(b,c,d){var e=this.getTargetSpec(b);e!==null?e.removeTarget(b):a.console.log("Previous MessageSpec for MessageTarget not found",a.console.WARN),e=this.createSpec(c,d),e.addTarget(b)},a.dispatch.postMessage=function(b,c,d){var e=new a.dispatch.Message,f=b.getId();e.src=b,e.msg=c,e.data=d;var g=this.getSpecsFast(f,c,!0);for(var h=0,i=g.length;h<i;h++){var j=g[h].targets.slice(0);for(var k=0,l=j.length;k<l;k++){var m=j[k],n,o;m.args!==null?n=this.getArguments(e,m.args):n=[e],m.func?o=m.handler[m.func]:o=m.handler,o.apply(m.handler,n)}}},a.dispatch.getArguments=function(b,c){var d=[];for(var e=0,f=c.length;e<f;e++){var g=c[e];if(typeof g!="string")d[e]=g;else if(g.substring(0,3)===a.dispatch.ID_ARG){var h=parseInt(g.substring(3));d.push(a.world.getCitizenById(h))}else if(g.substring(0,4)===a.dispatch.MSG_ARG){g=g.substring(4);var i=g.split("."),j=b;for(aNdx=0,aLen=i.length;j!=null&&aNdx<aLen;aNdx++)j=j[i[aNdx]];d.push(j)}else d[e]=g}return d};var c={getId:function(){return a.dispatch.WILDCARD}};a.send=function(b,d){a.dispatch.postMessage(c,b,d)},a.subscribe=function(b,c,d,e){return a.dispatch.registerTarget(a.dispatch.WILDCARD,b,c,d,e)},a.unsubscribe=function(b,c){return a.dispatch.removeTarget(b,{src:a.dispatch.WILDCARD,msg:c})};return a}(hemi||{}),hemi=function(a){a.input=a.input||{},a.input.init=function(b){a.input.mouseDownListeners=[],a.input.mouseUpListeners=[],a.input.mouseMoveListeners=[],a.input.mouseWheelListeners=[],a.input.keyDownListeners=[],a.input.keyUpListeners=[],a.input.keyPressListeners=[],this.canvas=b,b.addEventListener("mousedown",function(b){a.input.mouseDown(b)},!0),b.addEventListener("mousemove",function(b){a.input.mouseMove(b)},!0),b.addEventListener("mouseup",function(b){a.input.mouseUp(b)},!0),b.addEventListener("mousewheel",function(b){a.input.scroll(b)},!1),b.addEventListener("DOMMouseScroll",function(b){a.input.scroll(b)},!1),document.addEventListener("keypress",function(b){a.input.keyPress(b)},!0),document.addEventListener("keydown",function(b){a.input.keyDown(b)},!0),document.addEventListener("keyup",function(b){a.input.keyUp(b)},!0)},a.input.addMouseDownListener=function(c){b(a.input.mouseDownListeners,c)},a.input.addMouseUpListener=function(c){b(a.input.mouseUpListeners,c)},a.input.addMouseMoveListener=function(c){b(a.input.mouseMoveListeners,c)},a.input.addMouseWheelListener=function(c){b(a.input.mouseWheelListeners,c)},a.input.addKeyDownListener=function(c){b(a.input.keyDownListeners,c)},a.input.addKeyUpListener=function(c){b(a.input.keyUpListeners,c)},a.input.addKeyPressListener=function(c){b(a.input.keyPressListeners,c)},a.input.removeMouseDownListener=function(b){return c(a.input.mouseDownListeners,b)},a.input.removeMouseUpListener=function(b){return c(a.input.mouseUpListeners,b)},a.input.removeMouseMoveListener=function(b){return c(a.input.mouseMoveListeners,b)},a.input.removeMouseWheelListener=function(b){return c(a.input.mouseWheelListeners,b)},a.input.removeKeyDownListener=function(b){return c(a.input.keyDownListeners,b)},a.input.removeKeyUpListener=function(b){return c(a.input.keyUpListeners,b)},a.input.removeKeyPressListener=function(b){return c(a.input.keyPressListeners,b)},a.input.mouseDown=function(b){var c=e(b);for(var d=0;d<a.input.mouseDownListeners.length;d++)a.input.mouseDownListeners[d].onMouseDown(c)},a.input.mouseUp=function(b){var c=e(b);for(var d=0;d<a.input.mouseUpListeners.length;d++)a.input.mouseUpListeners[d].onMouseUp(c)},a.input.mouseMove=function(b){var c=e(b);for(var d=0;d<a.input.mouseMoveListeners.length;d++)a.input.mouseMoveListeners[d].onMouseMove(c)},a.input.scroll=function(b){var c=e(b);c.deltaY=b.detail?-b.detail:b.wheelDelta,f(b);for(var d=0;d<a.input.mouseWheelListeners.length;d++)a.input.mouseWheelListeners[d].onScroll(c)},a.input.keyDown=function(b){for(var c=0;c<a.input.keyDownListeners.length;c++)a.input.keyDownListeners[c].onKeyDown(b)},a.input.keyUp=function(b){for(var c=0;c<a.input.keyUpListeners.length;c++)a.input.keyUpListeners[c].onKeyUp(b)},a.input.keyPress=function(b){for(var c=0;c<a.input.keyPressListeners.length;c++)a.input.keyPressListeners[c].onKeyPress(b)};var b=function(a,b){a.push(b)},c=function(a,b){var c=null,d=a.indexOf(b);if(d!=-1){var e=a.splice(d,1);e.length==1&&(c=e[0])}return c},d=function(a){var b=a.target?a.target:a.srcElement,c={x:0,y:0};for(var d=b;d;d=d.offsetParent)c.x+=d.offsetLeft,c.y+=d.offsetTop;c.x=a.pageX-c.x,c.y=a.pageY-c.y;return c},e=function(b){var c=a.utils.clone(b,!1),e=d(c);c.x=e.x,c.y=e.y;return c},f=function(a){a||(a=window.event),a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()};return a}(hemi||{}),hemi=function(a){a.viewDefaults={MOUSE_SPEED:.005,MOUSE_DELTA:.0015,TRUCK_SPEED:.02,FOV:.707107,NP:1,FP:1e4,MOVE_TIME:72,MIN_FOV:.05,MAX_FOV:Math.PI/3,MIN_TILT:-Math.PI/2.001,MAX_TILT:Math.PI/2.001},a.viewProjection={PERSPECTIVE:0,XY:1,XZ:2,YZ:3},a.CameraBase=function(){this.pan=new THREE.Object3D,this.pan.name="pan",this.tilt=new THREE.Object3D,this.tilt.name="tilt",this.cam=new THREE.Object3D,this.cam.name="cam",this.target=new THREE.Object3D,this.target.name="target",this.pan.add(this.tilt),this.tilt.add(this.cam),this.cam.add(this.target),this.target.position.z=-1,this.target.updateMatrix(),this.cam.position.z=1,this.cam.updateMatrix(),this.updateWorldMatrices(),this.vd={current:null,last:null},this.light=new THREE.PointLight(16777215,1.35),this.maxPan=null,this.minPan=null,this.maxTilt=null,this.minTilt=null,this.fov={current:a.viewDefaults.FOV,min:a.viewDefaults.MIN_FOV,max:a.viewDefaults.MAX_FOV},this.camPan={current:0,min:null,max:null},this.camTilt={current:0,min:null,max:null},this.distance=1,this.up=[0,1,0],this.mode={scroll:!0,scan:!0,fixed:!1,frames:!0,control:!1,projection:a.viewProjection.PERSPECTIVE,fixedLight:!0},this.state={moving:!1,curve:null,time:{current:0,end:0},mouse:!1,xy:{current:[-1,-1],last:[-1,-1]},shift:!1,update:!1,vp:null},this.clip={near:a.viewDefaults.NP,far:a.viewDefaults.FP},this.FPS=24,this.threeCamera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3);var b=a.utils.penner.linearTween;this.easeFunc=[b,b,b],this.update(),this.updateProjection(),a.addRenderListener(this)},a.CameraBase.prototype={clampPanTilt:function(){var a=this.camPan,b=this.camTilt;a.current=a.min!=null&&a.current<=a.min?a.min:a.max!=null&&a.current>=a.max?a.max:a.current,b.current=b.min!=null&&b.current<=b.min?b.min:b.max!=null&&b.current>=b.max?b.max:b.current},cleanup:function(){a.removeRenderListener(this),this.disableControl()},disableControl:function(){if(!this.mode.control)return!1;a.input.removeMouseDownListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseMoveListener(this),a.input.removeMouseWheelListener(this),a.input.removeKeyDownListener(this),a.input.removeKeyUpListener(this),this.mode.control=!1,this.state.mouse=!1;return!0},disableScan:function(){this.mode.scan=!1},disableZoom:function(){this.mode.scroll=!1},enableControl:function(b){if(this.mode.control)return!1;a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this),a.input.addMouseWheelListener(this),a.input.addKeyDownListener(this),a.input.addKeyUpListener(this),this.mode.control=!0;return!0},enableScan:function(){this.mode.scan=!0},enableZoom:function(){this.mode.scroll=!0},fixEye:function(){this.mode.fixed=!0,this.update();return this},lightOnCam:function(){this.mode.fixedLight=!0,this.update();return this},freeEye:function(){this.mode.fixed=!1,this.mode.projection||(identity(this.cam),cam.translateZ(this.distance),cam.updateMatrix()),this.update();return this},lightAtPosition:function(a){this.light.position=a,this.light.updateMatrix(),this.mode.fixedLight=!1,this.update();return this},getEye:function(){return this.cam.matrixWorld.getPosition().clone()},getTarget:function(){return this.mode.fixed?this.target.matrixWorld.getPosition().clone():this.pan.matrixWorld.getPosition().clone()},moveInFrames:function(){this.mode.frames=!0},moveInSeconds:function(){this.mode.frames=!1},moveOnCurve:function(b,c){this.vd.current!==null?this.vd.last=this.vd.current:this.vd.last=a.createViewData(this),this.vd.current=new a.ViewData({eye:b.eye.getEnd(),target:b.target.getEnd(),up:this.up,fov:this.fov.current,np:this.clip.near,fp:this.clip.far}),this.state.curve=b,this.state.moving=!0,this.state.vp=null,this.state.time.end=c==null?1:c>0?c:.001,this.state.time.current=0},moveOrthographic:function(b,c){var d=b*2*this.distance/a.core.client.width,e=c*2*this.distance/a.core.client.width;switch(this.mode.projection){case a.viewProjection.XY:case a.viewProjection.YZ:this.pan.translateX(-d),this.pan.translateY(e),this.pan.updateMatrix();break;case a.viewProjection.XZ:this.pan.translateX(d),this.pan.translateZ(e),this.pan.updateMatrix()}},movePerspective:function(b,c){if(this.state.shift&&this.mode.scan){var d=a.viewDefaults.MOUSE_DELTA*this.distance*b,e=a.viewDefaults.MOUSE_DELTA*this.distance*c;this.pan.translateX(-d),this.pan.translateY(e*Math.cos(this.tilt.current)),this.pan.translateZ(e*Math.sin(this.tilt.current)),this.pan.updateMatrix(),this.update()}else this.mode.fixed?this.rotate(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED):this.orbit(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED)},moveToView:function(b,c){var d=c==null?1:c,e;b.getData!=null?(this.vd.current=b.getData(),this.state.vp=b,e={viewpoint:b}):(this.vd.current=b,this.state.vp=null,e={viewdata:b}),this.vd.last=a.createViewData(this),this.state.curve=null,this.state.time.end=d>0?d:.001,this.state.time.current=0,this.state.moving=!0},onKeyDown:function(a){this.state.shift=a.keyCode==16},onKeyUp:function(a){a.keyCode==16&&(this.state.shift=!1)},onMouseDown:function(a){this.state.mouse=!0,this.state.xy.current[0]=this.state.xy.last[0]=a.x,this.state.xy.current[1]=this.state.xy.last[1]=a.y},onMouseMove:function(a){if(this.state.mouse){this.state.xy.last[0]=this.state.xy.current[0],this.state.xy.last[1]=this.state.xy.current[1],this.state.xy.current[0]=a.x,this.state.xy.current[1]=a.y;var b=this.state.xy.current[0]-this.state.xy.last[0],c=this.state.xy.current[1]-this.state.xy.last[1];this.mode.projection?this.moveOrthographic(b,c):this.movePerspective(b,c)}},onMouseUp:function(a){this.state.mouse=!1},onRender:function(a){var b=this.state,c=b.xy;(b.mouse&&(c.current[0]!==c.last[0]||c.current[1]!==c.last[1])||b.moving||b.update)&&this.update(a.elapsedTime),b.update=!1},onScroll:function(b){if(!!this.mode.scroll)if(this.state.shift){var c=this.distance*a.viewDefaults.TRUCK_SPEED,d=b.deltaY>0?1:-1;this.truck(c*d)}else{if(this.mode.fixed){var e=(this.fov.max+this.fov.min)/2;b.deltaY>0?this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*11/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*13/12:this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*13/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*11/12,this.updateProjection(),this.state.update=!0;return}var f=b.deltaY>0?11/12:13/12;this.distance=this.lerpScalar(0,this.distance,f),this.mode.projection||(this.identity(this.cam),this.cam.translateZ(this.distance),this.cam.updateMatrix()),this.updateProjection(),this.state.update=!0}},lerpScalar:function(a,b,c){return(1-c)*a+c*b},orbit:function(a,b){b==null&&(b=0);var c=this.tilt.rotation.x,d=this.pan.rotation.y+=a,e=c+b;e=e>=this.tiltMax?this.tiltMax:e<=this.tiltMin?this.tiltMin:e,this.pan.rotation.setY(d),this.tilt.rotation.setX(e),this.pan.updateMatrix(),this.tilt.updateMatrix(),this.update()},rotate:function(a,b){b==null&&(b=0),this.camPan.current+=a,this.camTilt.current+=b,this.clampPanTilt(),this.identity(this.cam),this.cam.translateZ(this.distance),this.cam.rotation.y=this.camPan.current,this.cam.rotation.x=this.camTilt.current,this.cam.updateMatrix(),this.update()},setLookAroundLimits:function(a,b,c,d){this.camPan.min=a,this.camPan.max=b,this.camTilt.min=c,this.camTilt.max=d;return this},setEasing:function(a){typeof a=="function"?this.easeFunc=[a,a,a]:this.easeFunc=[a.x||this.easeFunc[0],a.y||this.easeFunc[1],a.z||this.easeFunc[2]];return this},setEyeTarget:function(b,c){var d=[b.x-c.x,b.y-c.y,b.z-c.z],e=a.utils.cartesianToSpherical(d);this.distance=e[0],this.identity(this.pan),this.pan.position=c,this.pan.rotation.y=e[2],this.pan.updateMatrix(),this.identity(this.tilt),this.tilt.rotation.x=e[1]-Math.PI/2,this.tilt.updateMatrix();var f=new THREE.Vector3(0,0,this.distance);this.identity(this.cam),this.cam.position.z=this.distance,this.cam.updateMatrix(),this.updateWorldMatrices(),a.utils.pointZAt(this.cam,f,a.utils.pointAsLocal(this.cam,c)),this.cam.rotation.y=this.cam.rotation.y+Math.PI,this.cam.updateMatrix(),this.camPan.current=0,this.camTilt.current=0},setLight:function(a){this.light.color.value=[a[0],a[1],a[2],1];return this},setOrthographic:function(a){this.mode.projection=a,this.updateProjection()},setPerspective:function(){this.mode.projection=0,this.updateProjection()},setZoomLimits:function(a,b){this.fov.min=a,this.fov.max=b,this.fov.current>this.fov.max&&(this.fov.current=this.fov.max),this.fov.current<this.fov.min&&(this.fov.current=this.fov.min)},toOctane:function(){var b=this._super(),c=a.createViewData(this);b.props.push({name:this.mode.control?"enableControl":"disableControl",arg:[]}),b.props.push({name:"mode",val:this.mode}),b.props.push({name:"moveToView",arg:[c,0]});return b},truck:function(a){this.pan.rotation.x+=this.tilt.rotation.x,this.pan.updateMatrix(),this.pan.translateZ(-a),this.pan.updateMatrix(),this.pan.rotation.x-=this.tilt.rotation.x,this.pan.updateMatrix(),this.update()},interpolateView:function(a,b){var c=new THREE.Vector3,d=new THREE.Vector3,e=this.vd.last,f=this.vd.current,g=!1;if(this.state.curve){var h=this.easeFunc[0](a,0,1,b);c=this.state.curve.eye.interpolate(h),d=this.state.curve.target.interpolate(h)}else c.x=this.easeFunc[0](a,e.eye.x,f.eye.x-e.eye.x,b),c.y=this.easeFunc[1](a,e.eye.y,f.eye.y-e.eye.y,b),c.z=this.easeFunc[2](a,e.eye.z,f.eye.z-e.eye.z,b),d.x=this.easeFunc[0](a,e.target.x,f.target.x-e.target.x,b),d.y=this.easeFunc[1](a,e.target.y,f.target.y-e.target.y,b),d.z=this.easeFunc[2](a,e.target.z,f.target.z-e.target.z,b);f.fov!==e.fov&&(this.fov.current=this.easeFunc[0](a,e.fov,f.fov-e.fov,b),g=!0),f.np!==e.np&&(this.clip.near=this.easeFunc[0](a,e.np,f.np-e.np,b),g=!0),f.fp!==e.fp&&(this.clip.far=this.easeFunc[0](a,e.fp,f.fp-e.fp,b),g=!0),g&&this.updateProjection(),this.setEyeTarget(c,d)},update:function(a){var b=this.state.time;if(this.state.moving){this.interpolateView(b.current,b.end);if(a!=undefined){var c=this.mode.frames?1/this.FPS:a;b.current>=b.end&&(this.state.moving=!1,this.state.curve=null,this.state.vp!==null&&(this.state.vp=null)),b.current+=c,b.current>=b.end&&(b.current=b.end)}}this.target.position.z=-this.distance,this.target.updateMatrix(),this.updateWorldMatrices();var d=this.getEye(),e=this.getTarget();this.threeCamera.position=d,this.threeCamera.updateMatrix(),this.threeCamera.update(null,!0,null),this.threeCamera.lookAt(e),this.mode.fixedLight&&(this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale,this.light.updateMatrix())},updateProjection:function(){},identity:function(a){a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),a.updateMatrix()},updateWorldMatrices:function(){this.pan.update(null,!0,null)}},a.makeCitizen(a.CameraBase,"hemi.Camera",{msgs:["hemi.start","hemi.stop"],toOctane:[]}),a.CameraCurve=function(a,b){this.eye=a,this.target=b},a.CameraCurve.prototype={constructor:a.CameraCurve,cleanup:function(){this._super(),this.eye=null,this.target=null},toOctane:function(){var a=this._super();a.props.push({name:"eye",oct:this.eye.toOctane()}),a.props.push({name:"target",oct:this.target.toOctane()});return a}},a.ViewData=function(b){var c=b||{};this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.up=c.up||new THREE.Vector3(0,1,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.Viewpoint=function(b){var c=b||{};this.name=c.name||"",this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.up=c.up||new THREE.Vector3(0,1,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.Viewpoint.prototype={getData:function(){return new a.ViewData(this)},setData:function(a){this.eye=a.eye,this.target=a.target,this.up=a.up,this.fov=a.fov,this.np=a.np,this.fp=a.fp},toOctane:function(){var a=this._super(),b=["eye","target","up","fov","np","fp"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a}},a.getTimeOfFrame=function(a){return a/this.FPS},a.createViewData=function(b){return new a.ViewData({eye:b.getEye(),target:b.getTarget(),up:b.up,fov:b.fov.current,np:b.clip.near,fp:b.clip.far})},a.createViewpoint=function(b,c){var d=new a.Viewpoint({name:b});d.setData(this.createViewData(c));return d},a.createCustomViewpoint=function(b,c,d,e,f,g,h){var i=new a.Viewpoint({name:b,eye:c,target:d,up:e,fov:f,np:g,fp:h});return i};return a}(hemi||{}),hemi=function(a){a.ModelBase=function(a){this.client=a,this.fileName=null},a.ModelBase.prototype={load:function(b){var c=this;a.loadCollada(this.fileName,function(a){var d=a.scene;c.client.scene.add(d),b&&b(d)})},setFileName:function(a,b){this.fileName=a,this.load(b)}},a.makeCitizen(a.ModelBase,"hemi.Model",{msgs:["hemi.load"],toOctane:["fileName","load"]});return a}(hemi||{}),hemi=function(a){a.Client=function(b){this.camera=new a.Camera,this.renderer=b,this.scene=new THREE.Scene,this.scene.add(this.camera.light),a.input.init(b.domElement)},a.Client.prototype={addGrid:function(){var a=new THREE.LineBasicMaterial({color:13421772,opacity:.2}),b=new THREE.Geometry,c=-0.04,d=1,e=14;for(var f=0;f<=e/d*2;f++)b.vertices.push(new THREE.Vertex(new THREE.Vector3(-e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,e)));var g=new THREE.Line(b,a,THREE.LinePieces);this.scene.add(g)},onRender:function(){this.renderer.render(this.scene,this.camera.threeCamera)},setBGColor:function(a,b){this.renderer.setClearColorHex(a,b==null?1:b)}};return a}(hemi||{}),hemi=function(a){function c(a){var c=null;for(var d=0,e=b.length;d<e&&c==null;d++)b[d].client===a&&(c=b[d]);return c}a.fx=a.fx||{};var b=[];a.fx.setFog=function(a,d,e,f,g){var h=c(a),i=a.scene.__webglObjects.concat(a.scene.__webglObjectsImmediate),j=[],k=!1;h||(h={client:a},b.push(h)),h.fog||(h.fog=new THREE.Fog,h.oldBGHex=a.renderer.getClearColor().getHex(),h.oldBGAlpha=a.renderer.getClearAlpha(),k=!0),h.fog.color.setHex(d),h.fog.near=f,h.fog.far=g,a.scene.fog=h.fog,a.setBGColor(d,e);if(k){for(var l=0,m=i.length;l<m;l++){var n=i[l],o=n.object,p=n.opaque,q=n.transparent;for(var r=0,s=p.count;r<s;r++)j.push({mat:p.list[r],obj:o});for(var r=0,s=q.count;r<s;r++)j.push({mat:q.list[r],obj:o})}h.materials=j}for(var l=0,m=h.materials.length;l<m;l++){var t=h.materials[l],u=t.mat,o=t.obj,v=a.scene.fog;if(k)a.renderer.initMaterial(u,a.scene.lights,v,o);else{var w=u.uniforms;w.fogColor.value=v.color,w.fogNear.value=v.near,w.fogFar.value=v.far}}},a.fx.clearFog=function(a){var b=c(a);if(b&&b.fog){b.fog=a.scene.fog=undefined,a.setBGColor(b.oldBGHex,b.oldBGAlpha);for(var d=0,e=b.materials.length;d<e;d++){var f=b.materials[d];a.renderer.initMaterial(f.mat,a.scene.lights,a.scene.fog,f.obj)}}};return a}(hemi||{})=======
Array.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1}),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}());var hemi=function(a){var b=null,c=0,d=[],e=function(){requestAnimationFrame(e);var b=(new Date).getTime()*.001,f=c===0?0:b-c,g={elapsedTime:f};c=b;for(var h=0;h<a.clients.length;++h)a.clients[h].onRender(g);for(var h=0;h<d.length;++h)d[h].onRender(g)};return a.version="1.5.0",a.clients=[],a.makeClients=function(){var b=document.getElementsByTagName("div"),c=[];Detector.webgl||Detector.addGetWebGLMessage();for(var d=0;d<b.length;++d){var f=b[d];if(f.id&&f.id.match(/^kuda/)){var g=new THREE.WebGLRenderer,h=new a.Client(g);g.setSize(window.innerWidth,window.innerHeight),f.appendChild(g.domElement),a.clients.push(h),c.push(h)}}return e(),c},a.addRenderListener=function(a){var b=d.indexOf(a);b===-1&&d.push(a)},a.removeRenderListener=function(a){var b=d.indexOf(a),c=null;return b!==-1&&(c=d.splice(b,1)[0]),c},a.error=function(a){if(b)b(a);else{var c=new Error(a);throw c.name="HemiError",c}},a.setErrorCallback=function(a){b=a},a.init=function(){a.picking.init(),a.input.init(),a.view.init(),a.curve.init(),a.model.init(),a.effect.init(),a.hud.init(),a.shape.init(),a.sprite.init(),a.world.init()},a}(hemi||{}),hemi=function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;return a.Class=function(){},a.Class.extend=function(a){function g(){!b&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;b=!0;var e=new this;b=!1;for(var f in a)e[f]=typeof a[f]=="function"&&typeof d[f]=="function"&&c.test(a[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}}(f,a[f]):a[f];return g.prototype=e,g.constructor=g,g.extend=arguments.callee,g},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.Hashtable=Hashtable,a.utils.Hashtable.prototype.query=function(b){var c=this.values(),d=[],e=[],f=[],g,h,i,j,k,l,m,n;for(x in b)a.utils.isArray(b[x])?e.push(x):d.push(x);var o=d.length,p=e.length;for(var q=0,r=c.length;q<r;q++){g=c[q],n=!0;for(k=0;n&&k<o;k++)h=d[k],n=g[h]===b[h];for(k=0;n&&k<p;k++){n=!1,h=e[k],i=g[h],j=b[h],m=j.length;for(l=0;!n&&l<m;l++)n=i===j[l]}n&&f.push(g)}return f},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.clone=function(b,c){var d=a.utils.isArray(b)?[]:{},c=c==null?!0:c;return a.utils.join(d,b,c),d},a.utils.compareArrays=function(b,c){var d=b.length===c.length;for(var e=0;d&&e<b.length;e++)b[e]instanceof Array?d=a.utils.compareArrays(b[e],c[e]):d=Math.abs(b[e]-c[e])<=.001;return d},a.utils.get=function(b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){if(this.readyState===4){this.onreadystatechange=a.utils.noop;var b=null;if(this.status===200||window.location.href.indexOf("http")===-1){var d=this.getResponseHeader("content-type");d&&d.indexOf("xml")>=0?b=this.responseXML:b=this.responseText}c(b,this.statusText)}},d.open("GET",b,!0);try{d.send(null)}catch(e){c(null,e.name+": "+e.message)}},a.utils.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},a.utils.join=function(){var b=arguments[0],c=arguments.length,d=arguments[c-1],e=!0;typeof d=="boolean"&&(e=d,--c);for(var f=1;f<c;f++){var g=arguments[f];for(var h in g){var i=g[h];if(e&&i!=null&&typeof i=="object"){var j=b[h],k=a.utils.isArray(i);if(j==null||typeof j!="object"||a.utils.isArray(j)!==k)j=k?[]:{};b[h]=a.utils.join(j,i)}else b[h]=i}}return b},a.utils.noop=function(){},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.cartesianToSpherical=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d),f=Math.acos(c/e),g=Math.atan2(b,d);return[e,f,g]},a.utils.choose=function(b,c){return a.utils.factorial(b,b-c+1)/a.utils.factorial(c)},a.utils.clamp=function(a,b,c){return Math.min(c,Math.max(b,a))},a.utils.cubicHermite=function(a,b,c,d,e){var f=a*a,g=f*a,h=2*g-3*f+1,i=g-2*f+a,j=-2*g+3*f,k=g-f;return h*b+i*c+j*d+k*e},a.utils.factorial=function(a,b){var c=1,d=b?b:2;while(d<=a)c*=d++;return c},a.utils.intersect=function(b,c){var d=c,e=[b.near,b.far],f=a.core.math.inverse([[e[0][0]-e[1][0],d[1][0]-d[0][0],d[2][0]-d[0][0]],[e[0][1]-e[1][1],d[1][1]-d[0][1],d[2][1]-d[0][1]],[e[0][2]-e[1][2],d[1][2]-d[0][2],d[2][2]-d[0][2]]]),g=[e[0][0]-d[0][0],e[0][1]-d[0][1],e[0][2]-d[0][2]],h=f[0][0]*g[0]+f[0][1]*g[1]+f[0][2]*g[2],i=f[1][0]*g[0]+f[1][1]*g[1]+f[1][2]*g[2],j=f[2][0]*g[0]+f[2][1]*g[1]+f[2][2]*g[2];return[h,i,j]},a.utils.linearToSine=function(a){return(Math.sin(Math.PI*a-Math.PI/2)+1)/2},a.utils.linearToParabolic=function(a){return a*a},a.utils.linearToParabolicInverse=function(a){return 1-(1-a)*(1-a)},a.utils.linearToExponential=function(a,b){return(Math.pow(b,a)-1)/(b-1)},a.utils.linearToExponentialInverse=function(b,c){return 1-a.utils.linearToExponential(1-b,c)},a.utils.penner={linearTween:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d){return a/=d,c*a*a+b},easeOutQuad:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},easeInOutQuad:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)},easeInCubic:function(a,b,c,d){return a/=d,c*a*a*a+b},easeOutCubic:function(a,b,c,d){return a/=d,a--,c*(a*a*a+1)+b},easeInOutCubic:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a+b:(a-=2,c/2*(a*a*a+2)+b)},easeInQuart:function(a,b,c,d){return a/=d,c*a*a*a*a+b},easeOutQuart:function(a,b,c,d){return a/=d,a--,-c*(a*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a*a+b:(a-=2,-c/2*(a*a*a*a-2)+b)},easeInQuint:function(a,b,c,d){return a/=d,c*a*a*a*a*a+b},easeOutQuint:function(a,b,c,d){return a/=d,a--,c*(a*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a*a*a+b:(a-=2,c/2*(a*a*a*a*a+2)+b)},easeInSine:function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){return a/=d/2,a<1?c/2*Math.pow(2,10*(a-1))+b:(a--,c/2*(-Math.pow(2,-10*a)+2)+b)},easeInCirc:function(a,b,c,d){return a/=d,-c*(Math.sqrt(1-a*a)-1)+b},easeOutCirc:function(a,b,c,d){return a/=d,a--,c*Math.sqrt(1-a*a)+b},easeInOutCirc:function(a,b,c,d){return a/=d/2,a<1?-c/2*(Math.sqrt(1-a*a)-1)+b:(a-=2,c/2*(Math.sqrt(1-a*a)+1)+b)}},a.utils.sphericalToCartesian=function(a){var b=a[0],c=a[1],d=a[2];return[b*Math.sin(c)*Math.cos(d),b*Math.sin(c)*Math.sin(d),b*Math.cos(c)]},a.utils.uvToXYZ=function(b,c){var d=a.core.math,e=d.mulScalarVector(b[0],d.subVector(c[1],c[0])),f=d.mulScalarVector(b[1],d.subVector(c[2],c[0]));return pos=d.addVector(c[0],d.addVector(e,f)),pos},a.utils.worldToScreen=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[Math.round(k),Math.round(l)]},a.utils.worldToScreenFloat=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[k,l,j[2]]},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.buildSrc=function(a){var b=(a.preHdr?a.preHdr:"")+(a.hdr?a.hdr:"")+(a.postHdr?a.postHdr:"")+(a.preSprt?a.preSprt:"")+(a.sprt?a.sprt:"")+(a.postSprt?a.postSprt:"")+a.main+(a.preBody?a.preBody:"")+(a.body?a.body:"")+(a.postBody?a.postBody:"")+(a.preGlob?a.preGlob:"")+(a.glob?a.glob:"")+(a.postGlob?a.postGlob:"")+a.end;return b},a.utils.combineFragSrc=function(a,b){return this.combineSrc(a,b,"gl_FragColor")},a.utils.combineSrc=function(b,c,d){var e=this.parseSrc(b,d);return a.utils.join(e,c),this.buildSrc(e)},a.utils.combineVertSrc=function(a,b){return this.combineSrc(a,b,"gl_Position")},a.utils.getShaders=function(a){var b=a.gl,c=a.effect.program_,d=b.getAttachedShaders(c),e=b.getShaderSource(d[0]),f=b.getShaderSource(d[1]),g;return e.search("gl_FragColor")>0?g={fragShd:d[0],fragSrc:e,vertShd:d[1],vertSrc:f}:g={fragShd:d[1],fragSrc:f,vertShd:d[0],vertSrc:e},g},a.utils.parseSrc=function(a,b){var c=a.lastIndexOf(";",a.indexOf("{"))+1,d=a.indexOf("void main",c),e=a.indexOf("{",d)+1,f=a.indexOf(b,e),g=a.lastIndexOf(";")+1;a.charAt(c)==="\n"&&++c,a.charAt(e)==="\n"&&++e,a.charAt(f)==="\n"&&++f,a.charAt(g)==="\n"&&++g;var h={hdr:a.slice(0,c),sprt:a.slice(c,d),main:a.slice(d,e),body:a.slice(e,f),glob:a.slice(f,g),end:a.slice(g)};return h},a}(hemi||{}),hemi=function(a){function c(a,c,d){var e=c,f=0,g=a.length,h=c-Math.max(c-d,0),i=Math.min(c+d,g-1)-c,j,k;for(var l=parseInt(c-h);l<=c+i;l++){k=b.get(a.charAt(l));if(k===null)continue;j=k/Math.abs(c-l),j>f&&(e=l,f=j)}return Math.min(e+1,g-1)}a.utils=a.utils||{},String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},a.utils.isNumeric=function(a){return a!==null&&!isNaN(a)&&a.length!==0};var b=new Hashtable;return b.put(" ",10),b.put(",",20),b.put(";",30),b.put(".",10),b.put("!",40),b.put("?",40),a.utils.wrapTextStrict=function(c,d,e){var f=[],c=a.utils.cleanseText(c),g=c.length,h=e.measureText(c),i=h.width/g,j=Math.floor(d/i),k=Math.ceil(j/10),l=0,m=j,n,o;while(m<g){n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o<d&&m<g)m+=k,m>g&&(m=g),n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o>d)m--,n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;var p=m-1,q=c.charAt(p);while(!b.containsKey(q)&&p>l)p--,q=c.charAt(p);p>l&&(m=p+1),n=c.substring(l,m).trim(),f.push(n),l=m,m+=j}if(l!=g||f.length===0)n=c.substring(l,g).trim(),f.push(n);return f},a.utils.wrapText=function(b,d,e){var f=[],b=a.utils.cleanseText(b),g=b.length,h=parseInt(d/e),i=Math.ceil(g/h),j=h,k=0,l;for(var m=0;m<i-1;m++)l=k,k=c(b,j,10),f.push(b.substring(l,k).trim()),j=k+h;return f.push(b.substring(k,g)),f},a.utils.cleanseText=function(a){return a=a.replace("\n"," "),a},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.isAnimated=function(a){var b=a.getParam("o3d.localMatrix");return b.inputConnection!=null},a.utils.fosterTransform=function(b){var c=b.children,d=b.shapes,e=a.core.mainPack.createObject("Transform");while(c.length>0)c[0].parent=e;e.parent=b;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return e},a.utils.pointAsLocal=function(b,c){var d=a.core.math.matrix4,e=d.inverse(b.getUpdatedWorldMatrix());return d.transformPoint(e,c)},a.utils.pointAsWorld=function(b,c){var d=a.core.math.matrix4;return d.transformPoint(b.getUpdatedWorldMatrix(),c)},a.utils.pointYAt=function(b,c,d){var e=d[0]-c[0],f=d[1]-c[1],g=d[2]-c[2],h=Math.sqrt(e*e+g*g),i=Math.atan2(e,g),j=Math.atan2(h,f);return b.rotateY?(b.rotateY(i),b.rotateX(j)):(a.core.math.matrix4.rotateY(b,i),a.core.math.matrix4.rotateX(b,j)),b},a.utils.pointZAt=function(b,c,d){var e=a.core.math.subVector(d,c),f=Math.atan2(e[0],e[2]),g=-Math.asin(e[1]/a.core.math.length(e));return b.rotateY?(b.rotateY(f),b.rotateX(g)):(a.core.math.matrix4.rotateY(b,f),a.core.math.matrix4.rotateX(b,g)),b},a.utils.unfosterTransform=function(b){var c=b.children,d=b.shapes,e=b.parent;while(c.length>0)c[0].parent=e;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return b.parent=null,a.core.mainPack.removeObject(b),e},a.utils.worldRotate=function(b,c,d){var e=a.core.math.matrix4,f=e.inverse(d.getUpdatedWorldMatrix()),g=e.transformDirection(f,b);d.axisRotate(g,c)},a.utils.worldScale=function(b,c){var d=a.core.math.matrix4,e=d.mul(d.mul(d.mul(c.getUpdatedWorldMatrix(),d.scaling(b)),d.inverse(c.getUpdatedWorldMatrix())),c.localMatrix);c.localMatrix=e},a.utils.worldTranslate=function(b,c){var d=a.core.math.matrix4,e=d.inverse(c.getUpdatedWorldMatrix()),f=d.transformDirection(e,b);c.translate(f)},a}(hemi||{}),hemi=function(a){return a.msg={animate:"hemi.animate",burst:"hemi.burst",cleanup:"hemi.cleanup",drag:"hemi.drag",enable:"hemi.enable",load:"hemi.load",pick:"hemi.pick",progress:"hemi.progress",ready:"hemi.ready",scale:"hemi.scale",start:"hemi.start",stop:"hemi.stop",unload:"hemi.unload",visible:"hemi.visible"},a}(hemi||{}),hemi=function(a){var b=new THREE.ColladaLoader,c=1,d=function(){--c===0&&(c=1,a.send(a.msg.ready,{}))},e=function(b){return b.substr(0,4)==="http"?b:a.loadPath+b};return a.loadPath="",a.loadCollada=function(a,f){a=e(a),++c,b.load(a,function(a){f&&f(a),d()})},a.ready=d,a}(hemi||{}),hemi=function(a){var b=function(a,b){var c=b.split("."),d=c.length-1,e=window;for(var f=0;f<d;++f){var g=c[f];e[g]||(e[g]={}),e=e[g]}e[c[d]]=a},c=function(b,c){a.dispatch.postMessage(this,b,c)},d=function(b,c,d,e){return a.dispatch.registerTarget(this.worldId,b,c,d,e)},e=function(b,c,d){return a.dispatch.registerTarget(this.worldId,a.dispatch.WILDCARD,b,c,d)},f=function(b,c){return a.dispatch.removeTarget(b,{src:this.worldId,msg:c})};a.makeCitizen=function(g,h,i){function l(){g.apply(this,arguments),this.name=this.name||"",this._worldId=null,a.world.addCitizen(this)}i=i||{};var j=i.cleanup,k=i.msgs||[a.msg.cleanup];return l.prototype=g.prototype,l.prototype._msgSent=k,l.prototype._getId=function(){return this._worldId},l.prototype._setId=function(b){var c=this._worldId;this._worldId=b,c!==null&&(a.world.citizens.remove(c),a.world.citizens.put(b,this))},l.prototype.cleanup=function(){this.send(a.msg.cleanup,{}),j&&j.apply(this,arguments),a.world.removeCitizen(this)},l.prototype.send=c,l.prototype.subscribe=d,l.prototype.subscribeAll=e,l.prototype.unsubscribe=f,l.constructor=l,a.makeOctanable(l,h,i.toOctane),b(l,h),l},a.world=a.world||{},a.world.WORLD_ID=0;var g=1;return a.world.citizens=new a.utils.Hashtable,a.world.setNextId=function(a){g=a},a.world.getNextId=function(){return g++},a.world.checkNextId=function(){return g},a.world._getId=function(){return a.world.WORLD_ID},a.world.addCitizen=function(b){var c=b._getId();c==null&&(c=this.getNextId(),b._setId(c));var d=this.citizens.get(c);d!==null&&(a.console.log("Citizen with id "+c+" already exists.",a.console.ERR),d.cleanup()),this.citizens.put(c,b)},a.world.removeCitizen=function(b){var c=b._getId(),d=this.citizens.remove(c);return d===null&&a.console.log("Unable to remove Citizen with id "+c,a.console.WARN),d!==null},a.world.getCitizens=function(a,b){var c={};a!=undefined&&(a.worldId!==undefined&&(c.worldId=a.worldId),a.name!==undefined&&(c.name=a.name),a.citizenType!==undefined&&(c.citizenType=a.citizenType));var d=this.citizens.query(c);if(b)for(var e=0,f=d.length;e<f;e++)b(d[e])||(d.splice(e,1),e--,f--);return d},a.world.getCitizenById=function(b){var c=this.citizens.get(b);return c===null&&a.console.log("Tried to get Citizen with id "+b+", returned null.",a.console.ERR),c},a.world.getAudio=function(b,c){return b=b||{},b.citizenType=a.audio.Audio.prototype.citizenType,this.getCitizens(b,c)},a.world.getCamCurves=function(b,c){return b=b||{},b.citizenType=a.view.CameraCurve.prototype.citizenType,this.getCitizens(b,c)},a.world.getHudDisplays=function(b,c){return b=b||{},b.citizenType=a.hud.HudDisplay.prototype.citizenType,this.getCitizens(b,c)},a.world.getHudElements=function(b,c){return b=b||{},b.citizenType=a.hud.HudElement.prototype.citizenType,this.getCitizens(b,c)},a.world.getModels=function(b,c){return b=b||{},b.citizenType=a.model.Model.prototype.citizenType,this.getCitizens(b,c)},a.world.getAnimations=function(b,c){return b=b||{},b.citizenType=a.animation.Animation.prototype.citizenType,this.getCitizens(b,c)},a.world.getEffects=function(b,c){var d=[];return b=b||{},b.citizenType=a.effect.Emitter.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Burst.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Trail.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),d},a.world.getViewpoints=function(b,c){return b=b||{},b.citizenType=a.view.Viewpoint.prototype.citizenType,this.getCitizens(b,c)},a.world.getPressureEngines=function(a,b){return a=a||{},a.citizenType=hext.engines.PressureEngine.prototype.citizenType,this.getCitizens(a,b)},a.world.getDraggables=function(b,c){return b=b||{},b.citizenType=a.manip.Draggable.prototype.citizenType,this.getCitizens(b,c)},a.world.getTurnables=function(b,c){return b=b||{},b.citizenType=a.manip.Turnable.prototype.citizenType,this.getCitizens(b,c)},a.world.getRotators=function(b,c){return b=b||{},b.citizenType=a.motion.Rotator.prototype.citizenType,this.getCitizens(b,c)},a.world.getScenes=function(b,c){return b=b||{},b.citizenType=a.scene.Scene.prototype.citizenType,this.getCitizens(b,c)},a.world.getTimers=function(b,c){return b=b||{},b.citizenType=a.time.Timer.prototype.citizenType,this.getCitizens(b,c)},a.world.getTranslators=function(b,c){return b=b||{},b.citizenType=a.motion.Translator.prototype.citizenType,this.getCitizens(b,c)},a.world.getShapes=function(b,c){return b=b||{},b.citizenType=a.shape.Shape.prototype.citizenType,this.getCitizens(b,c)},a.world.getTranOwner=function(a){var b=a.getParam("ownerId"),c=null;return b!==null&&(c=this.getCitizenById(b.value)),c},a}(hemi||{}),hemi=function(a){var b=function(a){return Object.prototype.toString.call(a)==="[object Function]"},c=function(a,c){var d=[];for(var e=0;e<c.length;++e){var f=c[e],g=a[f],h={name:f};b(g)?h.arg=[]:g._getId&&g._worldId?h.id=g._getId():g._toOctane?h.oct=g._toOctane():h.val=g,d.push(h)}return d};return a.makeOctanable=function(a,d,e){e=e||[],a.prototype._citizenType=d,a.prototype._toOctane=function(){var a={type:this._citizenType,props:b(e)?e.call(this):c(this,e)};return this._worldId!=null&&(a.id=this._worldId),this.name.length>0&&!a.props.name&&a.props.unslice({name:"name",val:this.name}),a}},a}(hemi||{}),hemi=function(a){a.dispatch=a.dispatch||{};var b=0;a.dispatch.WILDCARD="*",a.dispatch.ID_ARG="id:",a.dispatch.MSG_ARG="msg:",a.dispatch.Message=function(){this.src=null,this.msg=null,this.data={}},a.dispatch.MessageSpec=function(){this.src=null,this.msg=null,this.targets=[]},a.dispatch.MessageSpec.prototype={cleanup:function(){for(var a=0,b=this.targets.length;a<b;a++)this.targets[a].cleanup();this.targets=[]},toOctane:function(){var b=[];for(var c=0,d=this.targets.length;c<d;c++){var e=this.targets[c].toOctane();e!==null?b.push(e):a.console.log("Null Octane returned by MessageTarget",a.console.ERR)}var f=[{name:"src",val:this.src},{name:"msg",val:this.msg},{name:"targets",oct:b}],g={type:"hemi.dispatch.MessageSpec",props:f};return g},addTarget:function(b){this.targets.indexOf(b)!=-1&&a.console.log("MessageSpec already contains MessageTarget",a.console.WARN),this.targets.push(b)},removeTarget:function(b){var c=null,d=this.targets.indexOf(b);if(d!=-1){var e=this.targets.splice(d,1);e.length===1&&(c=e[0])}else a.console.log("MessageTarget not found in MessageSpec",a.console.WARN);return c},getHash:function(){return this.msg+this.src}},a.dispatch.MessageTarget=function(){this.dispatchId=null,this.name="",this.handler=null,this.func=null,this.args=null},a.dispatch.MessageTarget.prototype={cleanup:function(){this.handler=null},toOctane:function(){if(!this.handler.getId)return a.console.log("Handler object in MessageTarget can not be saved to Octane",a.console.WARN),null;var b=["dispatchId","name","func","args"],c=[{name:"handler",id:this.handler.getId()}];for(var d=0,e=b.length;d<e;d++){var f=b[d];c.push({name:f,val:this[f]})}var g={type:"hemi.dispatch.MessageTarget",props:c};return g}},a.dispatch.msgSpecs=new a.utils.Hashtable,a.dispatch.setNextId=function(a){b=a},a.dispatch.getNextId=function(){return b++},a.dispatch.checkNextId=function(){return b},a.dispatch.loadEntries=function(a){for(var b=0,c=a.length;b<c;b++){var d=a[b];this.msgSpecs.put(d.getHash(),d)}},a.dispatch.cleanup=function(){this.msgSpecs.each(function(a,b){b.cleanup()}),this.msgSpecs.clear()},a.dispatch.toOctane=function(){var c={nextId:b,ents:[]};return this.msgSpecs.each(function(b,d){var e=d.toOctane();e!==null?c.ents.push(e):a.console.log("Null Octane returned by MessageSpec",a.console.ERR)}),c},a.dispatch.getSpecs=function(b,c){var d;if(b===undefined)d=this.msgSpecs.values();else{var e={};c?(b.src!==undefined&&(b.src===a.dispatch.WILDCARD?e.src=a.dispatch.WILDCARD:e.src=[b.src,a.dispatch.WILDCARD]),b.msg!==undefined&&(b.msg===a.dispatch.WILDCARD?e.msg=a.dispatch.WILDCARD:e.msg=[b.msg,a.dispatch.WILDCARD])):(b.src!==undefined&&(e.src=b.src),b.msg!==undefined&&(e.msg=b.msg)),d=this.msgSpecs.query(e)}return d},a.dispatch.getSpecsFast=function(b,c,d){var e=[],f=c+b,g=this.msgSpecs.get(f);g!==null&&e.push(g);if(d){var h=b===a.dispatch.WILDCARD;h||(f=c+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)),c!==a.dispatch.WILDCARD&&(f=a.dispatch.WILDCARD+b,g=this.msgSpecs.get(f),g!==null&&e.push(g),h||(f=a.dispatch.WILDCARD+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)))}return e},a.dispatch.getTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a.dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;h++){var j=c[h].targets;for(var k=0,l=j.length;k<l;k++){var m=j[k],n=!0;e!==undefined&&(n=m.dispatchId===e),n&&f!==undefined&&(n=m.name===f),n&&g!==undefined&&(n=m.handler===g),n&&d.push(m)}}return d},a.dispatch.getTargetSpec=function(a){var b=this.getSpecs(),c=a.dispatchId;for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f.targets;for(var h=0,i=g.length;h<i;h++)if(g[h].dispatchId===c)return f}return null},a.dispatch.createSpec=function(b,c){var d=this.getSpecsFast(b,c,!1),e;return d.length===0?(e=new a.dispatch.MessageSpec,e.src=b,e.msg=c,this.msgSpecs.put(e.getHash(),e)):(d.length>1&&a.console.log("Found "+d.length+" MessageSpecs with the same src and msg.",a.console.ERR),e=d[0]),e},a.dispatch.registerTarget=function(b,c,d,e,f){var g=this.createSpec(b,c),h=new a.dispatch.MessageTarget;return h.dispatchId=this.getNextId(),h.handler=d,e&&(h.func=e),f&&(h.args=f),g.addTarget(h),h},a.dispatch.removeTarget=function(b,c){var d=this.getSpecs(c,!1),e=null;for(var f=0,g=d.length;f<g;f++){var h=d[f];e=h.removeTarget(b);if(e!==null)break}return e===null&&a.console.log("MessageTarget was not found and therefore not removed",a.console.WARN),e},a.dispatch.setTargetSpec=function(b,c,d){var e=this.getTargetSpec(b);e!==null?e.removeTarget(b):a.console.log("Previous MessageSpec for MessageTarget not found",a.console.WARN),e=this.createSpec(c,d),e.addTarget(b)},a.dispatch.postMessage=function(b,c,d){var e=new a.dispatch.Message,f=b.getId();e.src=b,e.msg=c,e.data=d;var g=this.getSpecsFast(f,c,!0);for(var h=0,i=g.length;h<i;h++){var j=g[h].targets.slice(0);for(var k=0,l=j.length;k<l;k++){var m=j[k],n,o;m.args!==null?n=this.getArguments(e,m.args):n=[e],m.func?o=m.handler[m.func]:o=m.handler,o.apply(m.handler,n)}}},a.dispatch.getArguments=function(b,c){var d=[];for(var e=0,f=c.length;e<f;e++){var g=c[e];if(typeof g!="string")d[e]=g;else if(g.substring(0,3)===a.dispatch.ID_ARG){var h=parseInt(g.substring(3));d.push(a.world.getCitizenById(h))}else if(g.substring(0,4)===a.dispatch.MSG_ARG){g=g.substring(4);var i=g.split("."),j=b;for(aNdx=0,aLen=i.length;j!=null&&aNdx<aLen;aNdx++)j=j[i[aNdx]];d.push(j)}else d[e]=g}return d};var c={getId:function(){return a.dispatch.WILDCARD}};return a.send=function(b,d){a.dispatch.postMessage(c,b,d)},a.subscribe=function(b,c,d,e){return a.dispatch.registerTarget(a.dispatch.WILDCARD,b,c,d,e)},a.unsubscribe=function(b,c){return a.dispatch.removeTarget(b,{src:a.dispatch.WILDCARD,msg:c})},a}(hemi||{}),hemi=function(a){a.input=a.input||{},a.input.init=function(b){a.input.mouseDownListeners=[],a.input.mouseUpListeners=[],a.input.mouseMoveListeners=[],a.input.mouseWheelListeners=[],a.input.keyDownListeners=[],a.input.keyUpListeners=[],a.input.keyPressListeners=[],this.canvas=b,b.addEventListener("mousedown",function(b){a.input.mouseDown(b)},!0),b.addEventListener("mousemove",function(b){a.input.mouseMove(b)},!0),b.addEventListener("mouseup",function(b){a.input.mouseUp(b)},!0),b.addEventListener("mousewheel",function(b){a.input.scroll(b)},!1),b.addEventListener("DOMMouseScroll",function(b){a.input.scroll(b)},!1),document.addEventListener("keypress",function(b){a.input.keyPress(b)},!0),document.addEventListener("keydown",function(b){a.input.keyDown(b)},!0),document.addEventListener("keyup",function(b){a.input.keyUp(b)},!0)},a.input.addMouseDownListener=function(c){b(a.input.mouseDownListeners,c)},a.input.addMouseUpListener=function(c){b(a.input.mouseUpListeners,c)},a.input.addMouseMoveListener=function(c){b(a.input.mouseMoveListeners,c)},a.input.addMouseWheelListener=function(c){b(a.input.mouseWheelListeners,c)},a.input.addKeyDownListener=function(c){b(a.input.keyDownListeners,c)},a.input.addKeyUpListener=function(c){b(a.input.keyUpListeners,c)},a.input.addKeyPressListener=function(c){b(a.input.keyPressListeners,c)},a.input.removeMouseDownListener=function(b){return c(a.input.mouseDownListeners,b)},a.input.removeMouseUpListener=function(b){return c(a.input.mouseUpListeners,b)},a.input.removeMouseMoveListener=function(b){return c(a.input.mouseMoveListeners,b)},a.input.removeMouseWheelListener=function(b){return c(a.input.mouseWheelListeners,b)},a.input.removeKeyDownListener=function(b){return c(a.input.keyDownListeners,b)},a.input.removeKeyUpListener=function(b){return c(a.input.keyUpListeners,b)},a.input.removeKeyPressListener=function(b){return c(a.input.keyPressListeners,b)},a.input.mouseDown=function(b){var c=e(b);for(var d=0;d<a.input.mouseDownListeners.length;d++)a.input.mouseDownListeners[d].onMouseDown(c)},a.input.mouseUp=function(b){var c=e(b);for(var d=0;d<a.input.mouseUpListeners.length;d++)a.input.mouseUpListeners[d].onMouseUp(c)},a.input.mouseMove=function(b){var c=e(b);for(var d=0;d<a.input.mouseMoveListeners.length;d++)a.input.mouseMoveListeners[d].onMouseMove(c)},a.input.scroll=function(b){var c=e(b);c.deltaY=b.detail?-b.detail:b.wheelDelta,f(b);for(var d=0;d<a.input.mouseWheelListeners.length;d++)a.input.mouseWheelListeners[d].onScroll(c)},a.input.keyDown=function(b){for(var c=0;c<a.input.keyDownListeners.length;c++)a.input.keyDownListeners[c].onKeyDown(b)},a.input.keyUp=function(b){for(var c=0;c<a.input.keyUpListeners.length;c++)a.input.keyUpListeners[c].onKeyUp(b)},a.input.keyPress=function(b){for(var c=0;c<a.input.keyPressListeners.length;c++)a.input.keyPressListeners[c].onKeyPress(b)};var b=function(a,b){a.push(b)},c=function(a,b){var c=null,d=a.indexOf(b);if(d!=-1){var e=a.splice(d,1);e.length==1&&(c=e[0])}return c},d=function(a){var b=a.target?a.target:a.srcElement,c={x:0,y:0};for(var d=b;d;d=d.offsetParent)c.x+=d.offsetLeft,c.y+=d.offsetTop;return c.x=a.pageX-c.x,c.y=a.pageY-c.y,c},e=function(b){var c=a.utils.clone(b,!1),e=d(c);return c.x=e.x,c.y=e.y,c},f=function(a){a||(a=window.event),a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()};return a}(hemi||{}),hemi=function(a){return a.viewDefaults={MOUSE_SPEED:.005,MOUSE_DELTA:.0015,TRUCK_SPEED:.02,FOV:.707107,NP:1,FP:1e4,MOVE_TIME:72,MIN_FOV:.05,MAX_FOV:Math.PI/3,MIN_TILT:-Math.PI/2.001,MAX_TILT:Math.PI/2.001},a.viewProjection={PERSPECTIVE:0,XY:1,XZ:2,YZ:3},a.CameraBase=function(){var b=function(a,b,c,d){return c*a/d+b};this.pan=new THREE.Object3D,this.pan.name="pan",this.tilt=new THREE.Object3D,this.tilt.name="tilt",this.cam=new THREE.Object3D,this.cam.name="cam",this.target=new THREE.Object3D,this.target.name="target",this.pan.add(this.tilt),this.tilt.add(this.cam),this.cam.add(this.target),this.target.position.z=-1,this.target.updateMatrix(),this.cam.position.z=1,this.cam.updateMatrix(),this.updateWorldMatrices(),this.vd={current:null,last:null},this.light=new THREE.PointLight(16777215,1.35),this.maxPan=null,this.minPan=null,this.maxTilt=null,this.minTilt=null,this.fov={current:a.viewDefaults.FOV,min:a.viewDefaults.MIN_FOV,max:a.viewDefaults.MAX_FOV},this.camPan={current:0,min:null,max:null},this.camTilt={current:0,min:null,max:null},this.distance=1,this.up=[0,1,0],this.mode={scroll:!0,scan:!0,fixed:!1,frames:!0,control:!1,projection:a.viewProjection.PERSPECTIVE,fixedLight:!0},this.state={moving:!1,curve:null,time:{current:0,end:0},mouse:!1,xy:{current:[-1,-1],last:[-1,-1]},shift:!1,update:!1,vp:null},this.clip={near:a.viewDefaults.NP,far:a.viewDefaults.FP},this.FPS=24,this.threeCamera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3),this.easeFunc=[b,b,b],this.update(),this.updateProjection(),a.addRenderListener(this)},a.CameraBase.prototype={clampPanTilt:function(){var a=this.camPan,b=this.camTilt;a.current=a.min!=null&&a.current<=a.min?a.min:a.max!=null&&a.current>=a.max?a.max:a.current,b.current=b.min!=null&&b.current<=b.min?b.min:b.max!=null&&b.current>=b.max?b.max:b.current},cleanup:function(){a.removeRenderListener(this),this.disableControl()},disableControl:function(){return this.mode.control?(a.input.removeMouseDownListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseMoveListener(this),a.input.removeMouseWheelListener(this),a.input.removeKeyDownListener(this),a.input.removeKeyUpListener(this),this.mode.control=!1,this.state.mouse=!1,!0):!1},disableScan:function(){this.mode.scan=!1},disableZoom:function(){this.mode.scroll=!1},enableControl:function(b){return this.mode.control?!1:(a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this),a.input.addMouseWheelListener(this),a.input.addKeyDownListener(this),a.input.addKeyUpListener(this),this.mode.control=!0,!0)},enableScan:function(){this.mode.scan=!0},enableZoom:function(){this.mode.scroll=!0},fixEye:function(){return this.mode.fixed=!0,this.update(),this},lightOnCam:function(){return this.mode.fixedLight=!0,this.update(),this},freeEye:function(){return this.mode.fixed=!1,this.mode.projection||(identity(this.cam),cam.translateZ(this.distance),cam.updateMatrix()),this.update(),this},lightAtPosition:function(a){return this.light.position=a,this.light.updateMatrix(),this.mode.fixedLight=!1,this.update(),this},getEye:function(){return this.cam.matrixWorld.getPosition().clone()},getTarget:function(){return this.mode.fixed?this.target.matrixWorld.getPosition().clone():this.pan.matrixWorld.getPosition().clone()},moveInFrames:function(){this.mode.frames=!0},moveInSeconds:function(){this.mode.frames=!1},moveOnCurve:function(b,c){this.vd.current!==null?this.vd.last=this.vd.current:this.vd.last=a.createViewData(this),this.vd.current=new a.ViewData({eye:b.eye.getEnd(),target:b.target.getEnd(),up:this.up,fov:this.fov.current,np:this.clip.near,fp:this.clip.far}),this.state.curve=b,this.state.moving=!0,this.state.vp=null,this.state.time.end=c==null?1:c>0?c:.001,this.state.time.current=0},moveOrthographic:function(b,c){var d=b*2*this.distance/a.core.client.width,e=c*2*this.distance/a.core.client.width;switch(this.mode.projection){case a.viewProjection.XY:case a.viewProjection.YZ:this.pan.translateX(-d),this.pan.translateY(e),this.pan.updateMatrix();break;case a.viewProjection.XZ:this.pan.translateX(d),this.pan.translateZ(e),this.pan.updateMatrix()}},movePerspective:function(b,c){if(this.state.shift&&this.mode.scan){var d=a.viewDefaults.MOUSE_DELTA*this.distance*b,e=a.viewDefaults.MOUSE_DELTA*this.distance*c;this.pan.translateX(-d),this.pan.translateY(e*Math.cos(this.tilt.current)),this.pan.translateZ(e*Math.sin(this.tilt.current)),this.pan.updateMatrix(),this.update()}else this.mode.fixed?this.rotate(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED):this.orbit(-b*a.viewDefaults.MOUSE_SPEED,-c*a.viewDefaults.MOUSE_SPEED)},moveToView:function(b,c){var d=c==null?1:c,e;b.getData!=null?(this.vd.current=b.getData(),this.state.vp=b,e={viewpoint:b}):(this.vd.current=b,this.state.vp=null,e={viewdata:b}),this.vd.last=a.createViewData(this),this.state.curve=null,this.state.time.end=d>0?d:.001,this.state.time.current=0,this.state.moving=!0},onKeyDown:function(a){this.state.shift=a.keyCode==16},onKeyUp:function(a){a.keyCode==16&&(this.state.shift=!1)},onMouseDown:function(a){this.state.mouse=!0,this.state.xy.current[0]=this.state.xy.last[0]=a.x,this.state.xy.current[1]=this.state.xy.last[1]=a.y},onMouseMove:function(a){if(this.state.mouse){this.state.xy.last[0]=this.state.xy.current[0],this.state.xy.last[1]=this.state.xy.current[1],this.state.xy.current[0]=a.x,this.state.xy.current[1]=a.y;var b=this.state.xy.current[0]-this.state.xy.last[0],c=this.state.xy.current[1]-this.state.xy.last[1];this.mode.projection?this.moveOrthographic(b,c):this.movePerspective(b,c)}},onMouseUp:function(a){this.state.mouse=!1},onRender:function(a){var b=this.state,c=b.xy;(b.mouse&&(c.current[0]!==c.last[0]||c.current[1]!==c.last[1])||b.moving||b.update)&&this.update(a.elapsedTime),b.update=!1},onScroll:function(b){if(!this.mode.scroll)return;if(this.state.shift){var c=this.distance*a.viewDefaults.TRUCK_SPEED,d=b.deltaY>0?1:-1;this.truck(c*d)}else{if(this.mode.fixed){var e=(this.fov.max+this.fov.min)/2;b.deltaY>0?this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*11/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*13/12:this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*13/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*11/12,this.updateProjection(),this.state.update=!0;return}var f=b.deltaY>0?11/12:13/12;this.distance=this.lerpScalar(0,this.distance,f),this.mode.projection||(this.identity(this.cam),this.cam.translateZ(this.distance),this.cam.updateMatrix()),this.updateProjection(),this.state.update=!0}},lerpScalar:function(a,b,c){return(1-c)*a+c*b},orbit:function(a,b){b==null&&(b=0);var c=this.tilt.rotation.x,d=this.pan.rotation.y+=a,e=c+b;e=e>=this.tiltMax?this.tiltMax:e<=this.tiltMin?this.tiltMin:e,this.pan.rotation.setY(d),this.tilt.rotation.setX(e),this.pan.updateMatrix(),this.tilt.updateMatrix(),this.update()},rotate:function(a,b){b==null&&(b=0),this.camPan.current+=a,this.camTilt.current+=b,this.clampPanTilt(),this.identity(this.cam),this.cam.translateZ(this.distance),this.cam.rotation.y=this.camPan.current,this.cam.rotation.x=this.camTilt.current,this.cam.updateMatrix(),this.update()},setLookAroundLimits:function(a,b,c,d){return this.camPan.min=a,this.camPan.max=b,this.camTilt.min=c,this.camTilt.max=d,this},setEasing:function(a){return typeof a=="function"?this.easeFunc=[a,a,a]:this.easeFunc=[a.x||this.easeFunc[0],a.y||this.easeFunc[1],a.z||this.easeFunc[2]],this},setEyeTarget:function(a,b){var c=new THREE.Vector3(a.x-b.x,a.y-b.y,a.z-b.z),d=this.cartesianToSpherical(c);this.distance=d.x,this.identity(this.pan),this.pan.position=b,this.pan.rotation.y=d.z,this.pan.updateMatrix(),this.identity(this.tilt),this.tilt.rotation.x=d.y-Math.PI/2,this.tilt.updateMatrix();var e=new THREE.Vector3(0,0,this.distance);this.identity(this.cam),this.cam.position.z=this.distance,this.cam.updateMatrix(),this.updateWorldMatrices(),this.pointZAt(this.cam,e,this.pointAsLocal(this.cam,b)),this.cam.rotation.y=this.cam.rotation.y+Math.PI,this.cam.updateMatrix(),this.camPan.current=0,this.camTilt.current=0},cartesianToSpherical:function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),c=Math.acos(a.y/b),d=Math.atan2(a.x,a.z);return new THREE.Vector3(b,c,d)},pointZAt:function(a,b,c){var d=(new THREE.Vector3).sub(c,b),e=Math.atan2(d.x,d.z),f=-Math.asin(d.y/d.length());return a.rotation.y=a.rotation.y+e,a.rotation.x=a.rotation.x+f,a.updateMatrix(),a},pointAsLocal:function(a,b){var c=THREE.Matrix4.makeInvert(a.matrixWorld);return c.multiplyVector3(b.clone())},setLight:function(a){return this.light.color.value=[a[0],a[1],a[2],1],this},setOrthographic:function(a){this.mode.projection=a,this.updateProjection()},setPerspective:function(){this.mode.projection=0,this.updateProjection()},setZoomLimits:function(a,b){this.fov.min=a,this.fov.max=b,this.fov.current>this.fov.max&&(this.fov.current=this.fov.max),this.fov.current<this.fov.min&&(this.fov.current=this.fov.min)},toOctane:function(){var b=this._super(),c=a.createViewData(this);return b.props.push({name:this.mode.control?"enableControl":"disableControl",arg:[]}),b.props.push({name:"mode",val:this.mode}),b.props.push({name:"moveToView",arg:[c,0]}),b},truck:function(a){this.pan.rotation.x+=this.tilt.rotation.x,this.pan.updateMatrix(),this.pan.translateZ(-a),this.pan.updateMatrix(),this.pan.rotation.x-=this.tilt.rotation.x,this.pan.updateMatrix(),this.update()},interpolateView:function(a,b){var c=new THREE.Vector3,d=new THREE.Vector3,e=this.vd.last,f=this.vd.current,g=!1;if(this.state.curve){var h=this.easeFunc[0](a,0,1,b);c=this.state.curve.eye.interpolate(h),d=this.state.curve.target.interpolate(h)}else c.x=this.easeFunc[0](a,e.eye.x,f.eye.x-e.eye.x,b),c.y=this.easeFunc[1](a,e.eye.y,f.eye.y-e.eye.y,b),c.z=this.easeFunc[2](a,e.eye.z,f.eye.z-e.eye.z,b),d.x=this.easeFunc[0](a,e.target.x,f.target.x-e.target.x,b),d.y=this.easeFunc[1](a,e.target.y,f.target.y-e.target.y,b),d.z=this.easeFunc[2](a,e.target.z,f.target.z-e.target.z,b);f.fov!==e.fov&&(this.fov.current=this.easeFunc[0](a,e.fov,f.fov-e.fov,b),g=!0),f.np!==e.np&&(this.clip.near=this.easeFunc[0](a,e.np,f.np-e.np,b),g=!0),f.fp!==e.fp&&(this.clip.far=this.easeFunc[0](a,e.fp,f.fp-e.fp,b),g=!0),g&&this.updateProjection(),this.setEyeTarget(c,d)},update:function(a){var b=this.state.time;if(this.state.moving){this.interpolateView(b.current,b.end);if(a!=undefined){var c=this.mode.frames?1/this.FPS:a;b.current>=b.end&&(this.state.moving=!1,this.state.curve=null,this.state.vp!==null&&(this.state.vp=null)),b.current+=c,b.current>=b.end&&(b.current=b.end)}}this.target.position.z=-this.distance,this.target.updateMatrix(),this.updateWorldMatrices();var d=this.getEye(),e=this.getTarget();this.threeCamera.position=d,this.threeCamera.updateMatrix(),this.threeCamera.update(null,!0,null),this.threeCamera.lookAt(e),this.mode.fixedLight&&(this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale,this.light.updateMatrix())},updateProjection:function(){},identity:function(a){a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),a.updateMatrix()},updateWorldMatrices:function(){this.pan.update(null,!0,null)}},a.makeCitizen(a.CameraBase,"hemi.Camera",{msgs:["hemi.start","hemi.stop"],toOctane:[]}),a.CameraCurve=function(a,b){this.eye=a,this.target=b},a.CameraCurve.prototype={constructor:a.CameraCurve,cleanup:function(){this._super(),this.eye=null,this.target=null},toOctane:function(){var a=this._super();return a.props.push({name:"eye",oct:this.eye.toOctane()}),a.props.push({name:"target",oct:this.target.toOctane()}),a}},a.ViewData=function(b){var c=b||{};this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.up=c.up||new THREE.Vector3(0,1,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.Viewpoint=function(b){var c=b||{};this.name=c.name||"",this.eye=c.eye||new THREE.Vector3(0,0,-1),this.target=c.target||new THREE.Vector3(0,0,0),this.up=c.up||new THREE.Vector3(0,1,0),this.fov=c.fov||a.viewDefaults.FOV,this.np=c.np||a.viewDefaults.NP,this.fp=c.fp||a.viewDefaults.FP},a.Viewpoint.prototype={getData:function(){return new a.ViewData(this)},setData:function(a){this.eye=a.eye,this.target=a.target,this.up=a.up,this.fov=a.fov,this.np=a.np,this.fp=a.fp},toOctane:function(){var a=this._super(),b=["eye","target","up","fov","np","fp"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a}},a.getTimeOfFrame=function(a){return a/this.FPS},a.createViewData=function(b){return new a.ViewData({eye:b.getEye(),target:b.getTarget(),up:b.up,fov:b.fov.current,np:b.clip.near,fp:b.clip.far})},a.createViewpoint=function(b,c){var d=new a.Viewpoint({name:b});return d.setData(this.createViewData(c)),d},a.createCustomViewpoint=function(b,c,d,e,f,g,h){var i=new a.Viewpoint({name:b,eye:c,target:d,up:e,fov:f,np:g,fp:h});return i},a}(hemi||{}),hemi=function(a){return a.ModelBase=function(a){this.client=a,this.fileName=null},a.ModelBase.prototype={load:function(b){var c=this;a.loadCollada(this.fileName,function(a){var d=a.scene;c.client.scene.add(d),b&&b(d)})},setFileName:function(a,b){this.fileName=a,this.load(b)}},a.makeCitizen(a.ModelBase,"hemi.Model",{msgs:["hemi.load"],toOctane:["fileName","load"]}),a}(hemi||{}),hemi=function(a){return a.Client=function(b){this.camera=new a.Camera,this.renderer=b,this.scene=new THREE.Scene,this.scene.add(this.camera.light),a.input.init(b.domElement)},a.Client.prototype={addGrid:function(){var a=new THREE.LineBasicMaterial({color:13421772,opacity:.2}),b=new THREE.Geometry,c=-0.04,d=1,e=14;for(var f=0;f<=e/d*2;f++)b.vertices.push(new THREE.Vertex(new THREE.Vector3(-e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(e,c,f*d-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,-e))),b.vertices.push(new THREE.Vertex(new THREE.Vector3(f*d-e,c,e)));var g=new THREE.Line(b,a,THREE.LinePieces);this.scene.add(g)},onRender:function(){this.renderer.render(this.scene,this.camera.threeCamera)},setBGColor:function(a,b){this.renderer.setClearColorHex(a,b==null?1:b)}},a}(hemi||{}),hemi=function(a){function c(a){var c=null;for(var d=0,e=b.length;d<e&&c==null;d++)b[d].client===a&&(c=b[d]);return c}a.fx=a.fx||{};var b=[];return a.fx.setFog=function(a,d,e,f,g){var h=c(a),i=a.scene.__webglObjects.concat(a.scene.__webglObjectsImmediate),j=[],k=!1;h||(h={client:a},b.push(h)),h.fog||(h.fog=new THREE.Fog,h.oldBGHex=a.renderer.getClearColor().getHex(),h.oldBGAlpha=a.renderer.getClearAlpha(),k=!0),h.fog.color.setHex(d),h.fog.near=f,h.fog.far=g,a.scene.fog=h.fog,a.setBGColor(d,e);if(k){for(var l=0,m=i.length;l<m;l++){var n=i[l],o=n.object,p=n.opaque,q=n.transparent;for(var r=0,s=p.count;r<s;r++)j.push({mat:p.list[r],obj:o});for(var r=0,s=q.count;r<s;r++)j.push({mat:q.list[r],obj:o})}h.materials=j}for(var l=0,m=h.materials.length;l<m;l++){var t=h.materials[l],u=t.mat,o=t.obj,v=a.scene.fog;if(k)a.renderer.initMaterial(u,a.scene.lights,v,o);else{var w=u.uniforms;w.fogColor.value=v.color,w.fogNear.value=v.near,w.fogFar.value=v.far}}},a.fx.clearFog=function(a){var b=c(a);if(b&&b.fog){b.fog=a.scene.fog=undefined,a.setBGColor(b.oldBGHex,b.oldBGAlpha);for(var d=0,e=b.materials.length;d<e;d++){var f=b.materials[d];a.renderer.initMaterial(f.mat,a.scene.lights,a.scene.fog,f.obj)}}},a}(hemi||{})>>>>>>> other
