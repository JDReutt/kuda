function o3djs_isV8Supported(){return o3djs_navHas("Chrome")?!0:o3djs_navHas("Safari")?!o3djs_navHas("Intel Mac OS X 10_6"):!0}function o3djs_navHas(a){return navigator.userAgent.indexOf(a)!=-1}var o3d=o3d||{},goog=goog||{};goog.typedef=!0,o3d.global=this,o3d.basePath="",Object.prototype.__defineSetter__||(Object.prototype.__defineSetter__=function(){},Object.prototype.__defineGetter__=function(){}),o3d.findBasePath_=function(){var a=o3d.global.document;if(typeof a!="undefined"){if(o3d.global.BASE_PATH){o3d.basePath=o3d.global.BASE_PATH;return}o3d.global.BASE_PATH=null;var b=a.getElementsByTagName("script");for(var c,d=0;c=b[d];d++){var e=c.src,f=e.length,g="o3d-webgl/base.js",h=g.length;if(e.substr(f-h)==g){o3d.basePath=e.substr(0,f-h)+"o3d-webgl/";return}}}},o3d.writeScriptTag_=function(a){var b=o3d.global.document;typeof b!="undefined"&&b.write('<script type="text/javascript" src="'+a+'"></'+"script>")},o3d.filterTypeName_=function(a){a.length>=4&&a.substr(0,4)=="o3d."&&(a=a.substr(4));return a},o3d.include=function(a){var b=a.split("."),c=b[b.length-1]+".js";o3d.writeScriptTag_(o3d.basePath+c)},o3d.inherit=function(a,b){var c=o3d.global.o3d[b],d=o3d.global.o3d[a];if(!c)throw"Invalid superclass: "+b;if(!d)throw"Invalid subclass: "+a;d.prototype=new c,d.prototype.superClassName=b,d.prototype.superClass=c,d.prototype.className=a},o3d.removeFromArray=function(a,b){var c=a.indexOf(b);c>=0&&a.splice(c,1)},o3d.isArray_=function(a){var b=a;return typeof a=="object"&&a!==null&&"length"in b&&"splice"in b},o3d.clone=function(a){var b=o3d.isArray_(a)?[]:{};for(var c in a){var d=a[c];typeof d=="Object"?b[c]=o3d.clone(d):b[c]=d}return b},o3d.notImplemented=function(){debugger;throw"Not implemented."},o3d.findBasePath_(),o3d.ObjectBase=function(){},o3d.ObjectBase.prototype.className="o3d.ObjectBase",o3d.ObjectBase.prototype.superClass=null,o3d.ObjectBase.prototype.isAClassName=function(a){a=o3d.filterTypeName_(a);var b=this;while(b!=undefined){if(b.className==a)return!0;b=b.superClass&&b.superClass.prototype}return!1},o3d.NamedObjectBase=function(){o3d.ObjectBase.call(this)},o3d.inherit("NamedObjectBase","ObjectBase"),o3d.NamedObjectBase.prototype.name="",o3d.NamedObject=function(){o3d.NamedObjectBase.call(this)},o3d.inherit("NamedObject","NamedObjectBase"),o3d.NamedObject.prototype.name="",o3d.ParamObject=function(){o3d.NamedObject.call(this),this.params_={}},o3d.inherit("ParamObject","NamedObject"),o3d.ParamObject.prototype.__defineGetter__("params",function(){var a=[];for(name in this.params_)a.push(this.params_[name]);return a}),o3d.ParamObject.prototype.__defineSetter__("params",function(){}),o3d.ParamObject.O3D_PREFIX_="o3d.",o3d.ParamObject.prototype.createParam=function(a,b){if(this.params_[a])return null;b=o3d.filterTypeName_(b);if(!o3d.global.o3d[b])throw"Invalid param type name: "+b;var c=new o3d.global.o3d[b];c.gl=this.gl,c.owner_=this,c.name=a,this.params_[a]=c;return this.filterResult_(this.params_[a])},o3d.ParamObject.prototype.getParam=function(a){var b=this.params_[a],c;b||(c=o3d.ParamObject.O3D_PREFIX_+a,b=this.params_[c]);if(!b){var d=this.lazyParamMap_;if(d){var e=a,f=this.lazyParamMap_[e];f||(e=c,f=this.lazyParamMap_[e]),f&&(b=this.createParam(e,f))}}return this.filterResult_(b)},o3d.ParamObject.prototype.removeParam=function(a){for(var b in this.params_)this.params_[b]==a&&delete this.params_[b]},o3d.ParamObject.prototype.params_={},o3d.ParamObject.prototype.copyParams=function(a){for(name in a.params_){var b=a.params_[name];this.createParam(name,b.className),this.getParam(name).value=b.value}},o3d.ParamObject.prototype.filterResult_=function(a){return a?a:null},o3d.ParamObject.setUpO3DParam_=function(a,b,c){var d=o3d.ParamObject.O3D_PREFIX_+b,e=a.prototype.lazyParamMap_;e||(e={},a.prototype.lazyParamMap_=e),e[d]=c,a.prototype.__defineGetter__(b,function(){var a=this.getParam(d);return a.value}),a.prototype.__defineSetter__(b,function(a){var b=this.getParam(d);b.value=a})},o3d.ParamArray=function(){o3d.NamedObject.call(this),this.params_=[]},o3d.inherit("ParamArray","NamedObject"),o3d.ParamArray.prototype.createParam=function(a,b){b=o3d.filterTypeName_(b);if(!o3d.global.o3d[b])throw"Invalid param type name: "+b;if(a>=this.params_.length)this.resize(a+1,b);else{var c=new o3d.global.o3d[b];c.gl=this.gl,c.owner_=this,this.params_[a]=c}return this.filterResult_(this.params_[a])},o3d.ParamArray.prototype.getParam=function(a){var b=this.params_[a];return this.filterResult_(b)},o3d.ParamArray.prototype.removeParams=function(a,b){var c=[],d=0;for(var e=0;e<this.params_.length;e++)e>=a&&e<a+b||(c[d]=this.params_[e],d++);this.params_=c},o3d.ParamArray.prototype.resize=function(a,b){b=o3d.filterTypeName_(b);if(!o3d.global.o3d[b])throw"Invalid param type name: "+b;for(var c=this.params_.length;c<a;c++){var d=new o3d.global.o3d[b];d.gl=this.gl,d.owner_=this,this.params_[c]=d}},o3d.ParamArray.prototype.params_=[],o3d.ParamArray.prototype.__defineGetter__("params",function(){var a=[];for(var b=0;b<this.length;b++)a[b]=this.params_[b];return a}),o3d.ParamArray.prototype.__defineGetter__("length",function(){return this.params_.length}),o3d.ParamArray.prototype.filterResult_=function(a){return a?a:null},o3d.Param=function(a){o3d.Param.prototype.output_connections=[],this.outputConnections=[]},o3d.inherit("Param","NamedObject"),o3d.Param.prototype.update_input=!0,o3d.Param.prototype.inputConnection=null,o3d.Param.prototype.outputConnections=[],o3d.Param.prototype.owner_=null,o3d.Param.prototype.value_=null,o3d.Param.prototype.__defineSetter__("value",function(a){if(this.inputConnection)throw"Tried to set bound parameter.";this.value_!=undefined&&(typeof this.value_!=typeof a||this.value_.length_!==undefined&&this.value_.length_!=a.length)&&this.gl.client.error_callback("Param type error."),this.value_=a}),o3d.Param.prototype.__defineGetter__("value",function(){return this.inputConnection?this.inputConnection.value:this.value_}),o3d.Param.prototype.bind=function(a){a.outputConnections.push(this),this.inputConnection=a},o3d.Param.prototype.unbindInput=function(){o3d.notImplemented()},o3d.Param.prototype.unbindOutput=function(a){o3d.notImplemented()},o3d.Param.prototype.unbindOutputs=function(){o3d.notImplemented()},o3d.Param.prototype.read_only_=!1,o3d.ParamBoolean=function(){o3d.Param.call(this),this.value=!1},o3d.inherit("ParamBoolean","Param"),o3d.ParamBoundingBox=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamBoundingBox","Param"),o3d.ParamBoundingBox.prototype.__defineSetter__("value",function(a){if(this.inputConnection)throw"Tried to set bound parameter.";if(!a)a=new o3d.BoundingBox;else if(a.length!==undefined)if(a.length==0)a=new o3d.BoundingBox;else{if(a.length!=2)throw"Expected array of length 2";for(var b=0;b<2;++b)if(a[b].length!=3)throw"Expected sub-array of length 3 at index "+b+", got "+a[b].length;a=new o3d.BoundingBox(a[0],a[1])}this.value_=a}),o3d.ParamBoundingBox.prototype.__defineGetter__("value",function(){return this.inputConnection?this.inputConnection.value:this.value_}),o3d.ParamDrawContext=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamDrawContext","Param"),o3d.ParamDrawList=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamDrawList","Param"),o3d.ParamEffect=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamEffect","Param"),o3d.ParamFloat=function(){o3d.Param.call(this),this.value=0},o3d.inherit("ParamFloat","Param"),o3d.ParamFloat2=function(){o3d.Param.call(this),this.value=[0,0]},o3d.inherit("ParamFloat2","Param"),o3d.ParamFloat3=function(){o3d.Param.call(this),this.value=[0,0,0]},o3d.inherit("ParamFloat3","Param"),o3d.ParamFloat4=function(){o3d.Param.call(this),this.value=[0,0,0,0]},o3d.inherit("ParamFloat4","Param"),o3d.ParamFunction=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamFunction","Param"),o3d.ParamInteger=function(){o3d.Param.call(this),this.value=0},o3d.inherit("ParamInteger","Param"),o3d.ParamMaterial=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamMaterial","Param"),o3d.ParamMatrix4=function(){o3d.Param.call(this),this.value=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("ParamMatrix4","Param"),o3d.ParamParamArray=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamParamArray","Param"),o3d.ParamParamArrayOutput=function(){o3d.ParamParamArray.call(this)},o3d.inherit("ParamParamArrayOutput","ParamParamArray"),o3d.ParamParamArrayOutput.prototype.__defineGetter__("value",function(){this.owner_.updateOutputs(this);return this.value_}),o3d.ParamParamArrayOutput.prototype.__defineSetter__("value",function(a){this.value_=a}),o3d.ParamRenderSurface=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamRenderSurface","Param"),o3d.ParamRenderDepthStencilSurface=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamRenderDepthStencilSurface","Param"),o3d.ParamSampler=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamSampler","Param"),o3d.ParamSkin=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamSkin","Param"),o3d.ParamSteamBank=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamSteamBank","Param"),o3d.ParamState=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamState","Param"),o3d.ParamStreamBank=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamStreamBank","Param"),o3d.ParamString=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamString","Param"),o3d.ParamTexture=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamTexture","Param"),o3d.ParamTransform=function(){o3d.Param.call(this),this.value=null},o3d.inherit("ParamTransform","Param"),o3d.ParamVertexBufferStream=function(){o3d.Param.call(this),this.stream=null},o3d.inherit("ParamVertexBufferStream","Param"),o3d.CompositionParamMatrix4=function(){o3d.ParamMatrix4.call(this),this.matrix_names_=[]},o3d.inherit("CompositionParamMatrix4","ParamMatrix4"),o3d.CompositionParamMatrix4.prototype.matrix_names_=[],o3d.CompositionParamMatrix4.prototype.inverse_=!1,o3d.CompositionParamMatrix4.prototype.transpose_=!1,o3d.CompositionParamMatrix4.prototype.__defineGetter__("value",function(){var a=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];for(var b=0;b<this.matrix_names_.length;++b)o3d.Transform.compose(a,o3d.Param.SAS[this.matrix_names_[b]]);this.inverse_&&o3d.Transform.inverse(a),this.transpose_&&o3d.Transform.transpose(a);return a}),o3d.CompositionParamMatrix4.prototype.__defineSetter__("value",function(a){}),o3d.ProjectionParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["projection"]},o3d.inherit("ProjectionParamMatrix4","CompositionParamMatrix4"),o3d.ProjectionInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["projection"],this.inverse_=!0},o3d.inherit("ProjectionInverseParamMatrix4","CompositionParamMatrix4"),o3d.ProjectionTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["projection"],this.transpose_=!0},o3d.inherit("ProjectionTransposeParamMatrix4","CompositionParamMatrix4"),o3d.ProjectionInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["projection"],this.inverse_=!0,this.transpose_=!0},o3d.inherit("ProjectionInverseTransposeParamMatrix4","CompositionParamMatrix4"),o3d.ViewParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view"]},o3d.inherit("ViewParamMatrix4","CompositionParamMatrix4"),o3d.ViewInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view"],this.inverse_=!0},o3d.inherit("ViewInverseParamMatrix4","CompositionParamMatrix4"),o3d.ViewTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view"],this.transpose_=!0},o3d.inherit("ViewTransposeParamMatrix4","CompositionParamMatrix4"),o3d.ViewInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view"],this.inverse_=!0,this.transpose_=!0},o3d.inherit("ViewInverseTransposeParamMatrix4","CompositionParamMatrix4"),o3d.ViewProjectionParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["viewProjection"]},o3d.inherit("ViewProjectionParamMatrix4","CompositionParamMatrix4"),o3d.ViewProjectionInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["viewProjection"],this.inverse_=!0},o3d.inherit("ViewProjectionInverseParamMatrix4","CompositionParamMatrix4"),o3d.ViewProjectionTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["viewProjection"],this.transpose_=!0},o3d.inherit("ViewProjectionTransposeParamMatrix4","CompositionParamMatrix4"),o3d.ViewProjectionInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["viewProjection"],this.inverse_=!0,this.transpose_=!0},o3d.inherit("ViewProjectionInverseTransposeParamMatrix4","CompositionParamMatrix4"),o3d.WorldParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["world"]},o3d.inherit("WorldParamMatrix4","CompositionParamMatrix4"),o3d.WorldInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["world"],this.inverse_=!0},o3d.inherit("WorldInverseParamMatrix4","CompositionParamMatrix4"),o3d.WorldTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["world"],this.transpose_=!0},o3d.inherit("WorldTransposeParamMatrix4","CompositionParamMatrix4"),o3d.WorldInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["world"],this.inverse_=!0,this.transpose_=!0},o3d.inherit("WorldInverseTransposeParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view","world"]},o3d.inherit("WorldViewParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view","world"],this.inverse_=!0},o3d.inherit("WorldViewInverseParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view","world"],this.transpose_=!0},o3d.inherit("WorldViewTransposeParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["view","world"],this.inverse_=!0,this.transpose_=!0},o3d.inherit("WorldViewInverseTransposeParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewProjectionParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["worldViewProjection"]},o3d.inherit("WorldViewProjectionParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewProjectionInverseParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["worldViewProjection"],this.inverse_=!0},o3d.inherit("WorldViewProjectionInverseParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewProjectionTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["worldViewProjection"],this.transpose_=!0},o3d.inherit("WorldViewProjectionTransposeParamMatrix4","CompositionParamMatrix4"),o3d.WorldViewProjectionInverseTransposeParamMatrix4=function(){o3d.CompositionParamMatrix4.call(this),this.matrix_names_=["worldViewProjection"],this.inverse_=!0,this.transpose_=!0},o3d.inherit("WorldViewProjectionInverseTransposeParamMatrix4","CompositionParamMatrix4"),o3d.ParamInteger.prototype.applyToLocation=function(a,b){a.uniform1i(b,this.value)},o3d.ParamBoolean.prototype.applyToLocation=function(a,b){a.uniform1i(b,this.value)},o3d.ParamFloat.prototype.applyToLocation=function(a,b){a.uniform1f(b,this.value)},o3d.ParamFloat2.prototype.applyToLocation=function(a,b){a.uniform2fv(b,this.value)},o3d.ParamFloat3.prototype.applyToLocation=function(a,b){a.uniform3fv(b,this.value)},o3d.ParamFloat4.prototype.applyToLocation=function(a,b){a.uniform4fv(b,this.value)},o3d.ParamMatrix4.prototype.applyToLocation=function(a,b){a.uniformMatrix4fv(b,!1,o3d.Transform.flattenMatrix4(this.value))},o3d.ParamParamArray.prototype.applyToLocations=function(a,b){var c=this.value;b.length!=c.length&&a.client.error_callback("Invalid uniform param array: incorrect number of elements.");for(var d=0;d<c.length;d++)c.getParam(d).applyToLocation(a,b[d])},o3d.Param.texture_index_=0,o3d.ParamSampler.prototype.applyToLocation=function(a,b,c){var d=o3d.Param.texture_index_;a.activeTexture(a.TEXTURE0+d);var e=null,f=0,g=null;this.value?g=this.value:(o3d.Sampler.defaultSampler_.gl=a,g=o3d.Sampler.defaultSampler_,a.client.reportErrors_()&&a.client.error_callback("Missing Sampler for ParamSampler "+this.name)),g.bindAndSetParameters_(c),a.uniform1i(b,d),o3d.Param.texture_index_++},o3d.ParamSampler.defaultParamSampler_=new o3d.ParamSampler,o3d.Param.SAS=new o3d.ParamObject,o3d.Param.sasTypes_={world:"WorldParamMatrix4",view:"ViewParamMatrix4",projection:"ProjectionParamMatrix4",worldView:"WorldViewParamMatrix4",viewProjection:"ViewProjectionParamMatrix4",worldViewProjection:"WorldViewProjectionParamMatrix4",worldInverse:"WorldInverseParamMatrix4",viewInverse:"ViewInverseParamMatrix4",projectionInverse:"ProjectionInverseParamMatrix4",worldViewInverse:"WorldViewInverseParamMatrix4",viewProjectionInverse:"ViewProjectionInverseParamMatrix4",worldViewProjectionInverse:"WorldViewProjectionInverseParamMatrix4",worldTranspose:"WorldTransposeParamMatrix4",viewTranspose:"ViewTransposeParamMatrix4",projectionTranspose:"ProjectionTransposeParamMatrix4",worldViewTranspose:"WorldViewTransposeParamMatrix4",viewProjectionTranspose:"ViewProjectionTransposeParamMatrix4",worldViewProjectionTranspose:"WorldViewProjectionTransposeParamMatrix4",worldInverseTranspose:"WorldInverseTransposeParamMatrix4",viewInverseTranspose:"ViewInverseTransposeParamMatrix4",projectionInverseTranspose:"ProjectionInverseTransposeParamMatrix4",worldViewInverseTranspose:"WorldViewInverseTransposeParamMatrix4",viewProjectionInverseTranspose:"ViewProjectionInverseTransposeParamMatrix4",worldViewProjectionInverseTranspose:"WorldViewProjectionInverseTransposeParamMatrix4"};for(name in o3d.Param.sasTypes_)o3d.Param.SAS.createParam(name,o3d.Param.sasTypes_[name]);o3d.Param.SAS.setWorld=function(a){this.world=a},o3d.Param.SAS.setView=function(a){this.view=a},o3d.Param.SAS.setProjection=function(a){this.projection=a},o3d.Param.SAS.setViewProjection=function(a){this.viewProjection=a},o3d.Param.SAS.setWorldViewProjection=function(a){this.worldViewProjection=a},o3d.Event=function(){o3d.ObjectBase.call(this)},o3d.inherit("Event","ObjectBase"),o3d.Event.Type=goog.typedef,o3d.Event.TYPE_INVALID=0,o3d.Event.TYPE_CLICK=1,o3d.Event.TYPE_DBLCLICK=2,o3d.Event.TYPE_MOUSEDOWN=3,o3d.Event.TYPE_MOUSEMOVE=4,o3d.Event.TYPE_MOUSEUP=5,o3d.Event.TYPE_WHEEL=6,o3d.Event.TYPE_KEYDOWN=7,o3d.Event.TYPE_KEYPRESS=8,o3d.Event.TYPE_KEYUP=9,o3d.Event.TYPE_RESIZE=10,o3d.Event.prototype.type=o3d.Event.TYPE_INVALID,o3d.Event.Button=goog.typedef,o3d.Event.BUTTON_LEFT=0,o3d.Event.BUTTON_MIDDLE=1,o3d.Event.BUTTON_RIGHT=2,o3d.Event.BUTTON_4=3,o3d.Event.BUTTON_5=4,o3d.Event.prototype.button=o3d.Event.BUTTON_LEFT,o3d.Event.prototype.ctrl_key=!1,o3d.Event.prototype.alt_key=!1,o3d.Event.prototype.shift_key=!1,o3d.Event.prototype.meta_key=!1,o3d.Event.prototype.key_code=0,o3d.Event.prototype.char_code=0,o3d.Event.prototype.x=0,o3d.Event.prototype.y=0,o3d.Event.prototype.screenX=0,o3d.Event.prototype.screenY=0,o3d.Event.prototype.deltaX=0,o3d.Event.prototype.deltaY=0,o3d.Event.prototype.width=0,o3d.Event.prototype.height=0,o3d.Event.prototype.fullscreen=!1,o3d.RenderEvent=function(){o3d.Event.call(this)},o3d.inherit("RenderEvent","Event"),o3d.RenderEvent.prototype.elapsedTime=0,o3d.TickEvent=function(){o3d.Event.call(this)},o3d.inherit("RenderEvent","Event"),o3d.TickEvent.prototype.elapsedTime=0,o3d.RawData=function(){o3d.NamedObject.call(this)},o3d.inherit("RawData","NamedObject"),o3d.RawData.prototype.stringValue="",o3d.RawData.prototype.image_=null,o3d.RawData.prototype.uri="",o3d.RawData.prototype.length=0,o3d.RawData.prototype.discard=function(){o3d.notImplemented()},o3d.RawData.prototype.flush=function(){o3d.notImplemented()},o3d.Texture=function(){o3d.ParamObject.call(this),this.format=o3d.Texture.UNKNOWN_FORMAT,this.levels=1,this.alphaIsOne=!0,this.texture_=null,this.texture_target_=0,this.texture_width_=0,this.texture_height_=0,this.parameter_cache_={}},o3d.inherit("Texture","ParamObject"),o3d.Texture.Format=goog.typedef,o3d.Texture.UNKNOWN_FORMAT=0,o3d.Texture.XRGB8=1,o3d.Texture.ARGB8=2,o3d.Texture.ABGR16F=3,o3d.Texture.R32F=4,o3d.Texture.ABGR32F=5,o3d.Texture.DXT1=6,o3d.Texture.DXT3=7,o3d.Texture.DXT5=8,o3d.Texture.prototype.generateMips=function(a,b){this.gl.bindTexture(this.texture_target_,this.texture_),this.gl.generateMipmap(this.texture_target_),this.levels=b},o3d.Texture.isPowerOfTwo_=function(a){return(a&a-1)==0},o3d.Texture.nextHighestPowerOfTwo_=function(a){var b=1;while(b<a)b*=2;return b},o3d.Texture.prototype.getGLTextureFormat_=function(){switch(this.format){case o3d.Texture.XRGB8:return this.gl.RGB;case o3d.Texture.ARGB8:case o3d.Texture.ABGR16F:case o3d.Texture.ABGR32F:return this.gl.RGBA;case o3d.Texture.R32F:case o3d.Texture.DXT1:case o3d.Texture.DXT3:case o3d.Texture.DXT5:default:o3d.notImplemented();return 0}},o3d.Texture.prototype.getTexImage2DTarget_=function(a){return this.texture_target_==this.gl.TEXTURE_CUBE_MAP?this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+a:this.gl.TEXTURE_2D},o3d.Texture.maxLevels_=function(a,b){if(a==0||b==0)return 0;var c=Math.max(a,b),d=0;while(c>0)++d,c=c>>1;return d};var g_counter=0;o3d.Texture.prototype.setFromCanvas_=function(a,b,c,d,e){var f=this.gl;if(b&&(!o3d.Texture.isPowerOfTwo_(a.width)||!o3d.Texture.isPowerOfTwo_(a.height))){var g=o3d.Bitmap.getScratchCanvas_();g.width=o3d.Texture.nextHighestPowerOfTwo_(a.width),g.height=o3d.Texture.nextHighestPowerOfTwo_(a.height),g.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,c),f.bindTexture(this.texture_target_,this.texture_),f.texImage2D(this.getTexImage2DTarget_(e),0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,a),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,0),this.texture_width_=a.width,this.texture_height_=a.height,d&&(this.gl.generateMipmap(this.texture_target_),this.levels=o3d.Texture.maxLevels_(this.texture_width_,this.texture_height_)),g_counter++},o3d.Texture.prototype.drawImageFromCanvas_=function(a,b,c,d,e,f,g,h,i,j,k){var l=o3d.Bitmap.getScratchCanvas_();l.width=i,l.height=j;var m=l.getContext("2d");m.save(),m.translate(-b,-c),m.scale(i/d,j/e),m.drawImage(a,0,0,a.width,a.height);var n=this.gl;n.bindTexture(this.texture_target_,this.texture_);var o=this.getGLTextureFormat_();n.texImage2D(this.getTexImage2DTarget_(k),f,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,l),this.texture_width_=l.width,this.texture_height_=l.height,m.restore()},o3d.Texture.prototype.setValues_=function(a,b,c){var d=new Uint8Array(b.length);for(var e=0;e<b.length;++e)d[e]=Math.min(255,Math.max(0,b[e]*256));var f=this.getGLTextureFormat_();this.gl.bindTexture(this.texture_target_,this.texture_),this.gl.texSubImage2D(this.getTexImage2DTarget_(c),a,0,0,this.texture_width_,this.texture_height_,f,this.gl.UNSIGNED_BYTE,d)},o3d.Texture.prototype.initWithTarget_=function(a,b,c,d,e,f,g){this.width=b,this.height=c,this.format=d,this.levels=e,this.texture_=this.gl.createTexture(),this.texture_target_=a;if(b!=undefined&&c!=undefined){this.gl.bindTexture(this.texture_target_,this.texture_);var d=this.getGLTextureFormat_(),h=new Uint8Array(b*c*4),i=o3d.Bitmap.getScratchCanvas_();i.width=b,i.height=c;var j=1;this.texture_target_==this.gl.TEXTURE_CUBE_MAP&&(j=6);for(var k=0;k<j;++k)this.gl.texImage2D(this.getTexImage2DTarget_(k),0,d,b,c,0,d,this.gl.UNSIGNED_BYTE,h);this.texture_width_=b,this.texture_height_=c}},o3d.Texture2D=function(a,b){o3d.Texture.call(this),this.width=a||0,this.height=b||0,this.renderSurfaces_=[]},o3d.inherit("Texture2D","Texture"),o3d.ParamObject.setUpO3DParam_(o3d.Texture2D,"width","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Texture2D,"height","ParamInteger"),o3d.Texture2D.prototype.init_=function(a,b,c,d,e){this.initWithTarget_(this.gl.TEXTURE_2D,a,b,c,d,e)},o3d.Texture2D.prototype.getRenderSurface=function(a){if(!this.renderSurfaces_[a]){var b=new o3d.RenderSurface;b.gl=this.gl,b.initWithTexture(this,a),this.renderSurfaces_[a]=b}return this.renderSurfaces_[a]},o3d.Texture2D.prototype.set=function(a,b){this.setValues_(a,b)},o3d.Texture2D.prototype.setRect=function(a,b,c,d,e){var f=this.getGLTextureFormat_(),g=f==this.gl.RGB?3:4,h=e.length/g/d;if(!(b>this.width||c>this.height||b+d<0||c+h<0)){var i=d;b<0&&(i+=b),b+d>this.width&&(i-=b+d-this.width);var j=h;c<0&&(j+=c),c+h>this.height&&(j-=c+h-this.height);var k=b<0?Math.abs(b):0,l=c<0?Math.abs(c):0,m=new Uint8Array(i*j*g),n=0;for(var o=0;o<j;++o)for(var p=0;p<i;++p){var q=((l+o)*d+(k+p))*g;m[n++]=Math.min(255,Math.max(0,e[q]*256)),m[n++]=Math.min(255,Math.max(0,e[q+1]*256)),m[n++]=Math.min(255,Math.max(0,e[q+2]*256)),m[n++]=Math.min(255,Math.max(0,e[q+3]*256))}var r=Math.max(b,0),s=this.height-(Math.max(c,0)+j);this.gl.bindTexture(this.texture_target_,this.texture_),this.gl.texSubImage2D(this.gl.TEXTURE_2D,a,r,s,i,j,f,this.gl.UNSIGNED_BYTE,m)}},o3d.Texture2D.prototype.getRect=function(a,b,c,d,e){o3d.notImplemented()},o3d.Texture2D.prototype.setFromBitmap=function(a){var b=a.defer_mipmaps_to_texture_;this.setFromCanvas_(a.canvas_,b,a.defer_flip_vertically_to_texture_,a.defer_mipmaps_to_texture_)},o3d.Texture2D.prototype.drawImage=function(a,b,c,d,e,f,g,h,i,j,k){this.drawImageFromCanvas_(a.canvas_,c,d,e,f,g,h,i,j,k)},o3d.TextureCUBE=function(){o3d.Texture.call(this),this.edgeLength=0,this.faces_set_={0:!1,1:!1,2:!1,3:!1,4:!1,5:!1}},o3d.inherit("TextureCUBE","Texture"),o3d.TextureCUBE.CubeFace=goog.typedef,o3d.TextureCUBE.FACE_POSITIVE_X=0,o3d.TextureCUBE.FACE_NEGATIVE_X=1,o3d.TextureCUBE.FACE_POSITIVE_Y=2,o3d.TextureCUBE.FACE_NEGATIVE_Y=3,o3d.TextureCUBE.FACE_POSITIVE_Z=4,o3d.TextureCUBE.FACE_NEGATIVE_Z=5,o3d.ParamObject.setUpO3DParam_(o3d.TextureCUBE,"edgeLength","ParamInteger"),o3d.TextureCUBE.prototype.init_=function(a,b,c,d,e){this.initWithTarget_(this.gl.TEXTURE_CUBE_MAP,a,a,b,c,d,e)},o3d.TextureCUBE.prototype.getRenderSurface=function(a,b,c){o3d.notImplemented()},o3d.TextureCUBE.prototype.set=function(a,b,c){this.setValues_(b,c,a),this.faces_set_[a]=!0},o3d.TextureCUBE.prototype.setRect=function(a,b,c,d,e,f){o3d.notImplemented()},o3d.TextureCUBE.prototype.getRect=function(a,b,c,d,e,f){o3d.notImplemented()},o3d.TextureCUBE.prototype.setFromBitmap=function(a,b){var c=b.defer_mipmaps_to_texture_;for(var d in this.faces_set_)c=c&&(this.faces_set_[d]||d==a);var e=b.defer_mipmaps_to_texture_;this.setFromCanvas_(b.canvas_,e,!1,c,a),this.faces_set_[a]=!0},o3d.TextureCUBE.prototype.drawImage=function(a,b,c,d,e,f,g,h,i,j,k,l){this.drawImageFromCanvas_(a.canvas_,c,d,e,f,h,i,j,k,l,g)},o3d.Texture.prototype.bindAndSetParameters_=function(a,b,c,d){var e=this.texture_target_;this.gl.bindTexture(e,this.texture_);if(!o3d.Texture.isPowerOfTwo_(this.texture_width_)||!o3d.Texture.isPowerOfTwo_(this.texture_height_)||this.texture_target_==this.gl.TEXTURE_CUBE_MAP)a=b=this.gl.CLAMP_TO_EDGE;this.parameter_cache_.addressModeU!=a&&(this.gl.texParameteri(e,this.gl.TEXTURE_WRAP_S,a),this.parameter_cache_.addressModeU=a),this.parameter_cache_.addressModeV!=b&&(this.gl.texParameteri(e,this.gl.TEXTURE_WRAP_T,b),this.parameter_cache_.addressModeV=b),this.parameter_cache_.minFilter!=c&&(this.gl.texParameteri(e,this.gl.TEXTURE_MIN_FILTER,c),this.parameter_cache_.minFilter=c),this.parameter_cache_.magFilter!=d&&(this.gl.texParameteri(e,this.gl.TEXTURE_MAG_FILTER,d),this.parameter_cache_.magFilter=d)},o3d.Bitmap=function(){o3d.ParamObject.call(this)},o3d.inherit("Bitmap","ParamObject"),o3d.Bitmap.Semantic=goog.typedef,o3d.Bitmap.FACE_POSITIVE_X=0,o3d.Bitmap.FACE_NEGATIVE_X=1,o3d.Bitmap.FACE_POSITIVE_Y=2,o3d.Bitmap.FACE_NEGATIVE_Y=3,o3d.Bitmap.FACE_POSITIVE_Z=4,o3d.Bitmap.FACE_NEGATIVE_Z=5,o3d.Bitmap.IMAGE=6,o3d.Bitmap.SLICE=7,o3d.Bitmap.scratch_canvas_=null,o3d.Bitmap.getScratchCanvas_=function(){o3d.Bitmap.scratch_canvas_||(o3d.Bitmap.scratch_canvas_=document.createElement("CANVAS"));return o3d.Bitmap.scratch_canvas_},o3d.Bitmap.prototype.canvas_=null,o3d.Bitmap.prototype.flipVertically=function(){var a=document.createElement("CANVAS");a.width=this.width,a.height=this.height;var b=a.getContext("2d");b.translate(0,this.height),b.scale(1,-1),b.drawImage(this.canvas_,0,0,this.width,this.height),this.canvas_=a},o3d.Bitmap.prototype.flipVerticallyLazily_=function(){this.defer_flip_vertically_to_texture_=!0},o3d.Bitmap.prototype.generateMips=function(a,b){this.defer_mipmaps_to_texture_=!0},o3d.Bitmap.prototype.width=0,o3d.Bitmap.prototype.height=0,o3d.Bitmap.prototype.defer_mipmaps_to_texture_=!1,o3d.Bitmap.prototype.defer_flip_vertically_to_texture_=!1,o3d.Bitmap.prototype.format=o3d.Texture.UNKNOWN_FORMAT,o3d.Bitmap.prototype.numMipmaps=1,o3d.Bitmap.prototype.semantic=o3d.Bitmap.UNKNOWN_SEMANTIC,o3d.FileRequest=function(){this.method_="",this.listeners=[],this.async_=!0,this.request_=new XMLHttpRequest;var a=this;this.request_.onreadystatechange=function(){a.readyState=this.readyState,a.done=a.done||this.done,this.readyState==4&&(this.responseText&&(a.success=!0),a.done=!0),a.data=this.responseText,a.onreadystatechange&&a.onreadystatechange.apply(a,arguments)},this.request_.onprogress=function(b){var c=a.listeners;for(var d=0,e=c.length;d<e;d++)c[d].onProgressUpdate?c[d].onProgressUpdate(b):c[d](b)}},o3d.inherit("FileRequest","NamedObject"),o3d.FileRequest.prototype.onreadystatechange=null,o3d.FileRequest.prototype.addProgressListener=function(a){this.listeners.push(a)},o3d.FileRequest.prototype.uri="",o3d.FileRequest.prototype.data=null,o3d.FileRequest.prototype.readyState=0,o3d.FileRequest.prototype.done=!1,o3d.FileRequest.prototype.success=!1,o3d.FileRequest.prototype.image_=null,o3d.FileRequest.prototype.error="",o3d.FileRequest.prototype.isImageUrl_=function(a){var b=a.substring(a.length-4);return b==".png"||b==".jpg"},o3d.FileRequest.prototype.imageLoaded_=function(){this.image_.complete&&(this.success=!0,this.done=!0,this.readyState=4,this.data=new o3d.RawData,this.data.image_=this.image_),this.onreadystatechange.apply(this,arguments)},o3d.FileRequest.prototype.open=function(a,b,c){this.uri=b,this.method_=a,this.async_=c},o3d.FileRequest.prototype.send=function(){if(this.isImageUrl_(this.uri)){this.image_=new Image;var a=this;this.image_.onload=function(){a.imageLoaded_.call(a)},this.image_.src=this.uri}else this.request_.open(this.method_,this.uri,this.async_)},o3d.Renderer={},o3d.Renderer.InitStatus=goog.typedef,o3d.Renderer.UNINITIALIZED=0,o3d.Renderer.SUCCESS=1,o3d.Renderer.GPU_NOT_UP_TO_SPEC=2,o3d.Renderer.OUT_OF_RESOURCES=3,o3d.Renderer.INITIALIZATION_ERROR=4,o3d.Renderer.DisplayMode=goog.typedef,o3d.Renderer.DISPLAY_MODE_DEFAULT=0,o3d.Renderer.render_callback_interval_=null,o3d.Renderer.clients_=[],o3d.Renderer.installRequestAnimationFrame=function(){window.requestAnimationFrame=function(){return window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){setTimeout(a,1e3/60)}}()},window.requestAnimationFrame||o3d.Renderer.installRequestAnimationFrame(),o3d.Renderer.renderClients=function(a){for(var b=0;b<o3d.Renderer.clients_.length;++b){var c=o3d.Renderer.clients_[b];c.counter_manager_.tick(),c.renderMode==o3d.Client.RENDERMODE_CONTINUOUS&&c.render(a)}window.requestAnimationFrame(o3d.Renderer.renderClients)},o3d.Renderer.installRenderInterval=function(){o3d.Renderer.render_callback_interval_=setInterval("o3d.Renderer.renderClients()",1e3/60),window.requestAnimationFrame=function(){}},o3d.ClientInfo=function(){o3d.NamedObject.call(this)},o3d.inherit("ClientInfo","NamedObject"),o3d.ClientInfo.prototype.num_objects=0,o3d.ClientInfo.prototype.texture_memory_used=0,o3d.ClientInfo.prototype.buffer_memory_used=0,o3d.ClientInfo.prototype.software_renderer=!1,o3d.ClientInfo.prototype.non_power_of_two_textures=!0,o3d.ClientInfo.prototype.glsl=!0,o3d.Client=function(){o3d.NamedObject.call(this);var a=this.createPack();this.root=a.createObject("Transform"),this.renderGraphRoot=a.createObject("RenderNode"),this.clientId=o3d.Client.nextId++,this.packs_=[a],this.clientInfo=a.createObject("ClientInfo"),this.counter_manager_=new o3d.CounterManager,o3d.Renderer.clients_.length==0&&window.requestAnimationFrame(o3d.Renderer.renderClients),o3d.Renderer.clients_.push(this),this.stateMapStack_=[],this.stateVariableStacks_={}},o3d.inherit("Client","NamedObject"),o3d.Client.RenderCallback=goog.typedef,o3d.Client.TickCallback=goog.typedef,o3d.Client.ErrorCallback=goog.typedef,o3d.Client.prototype.renderGraphRoot=null,o3d.Client.nextId=0,o3d.Client.prototype.then_=0,o3d.Client.prototype.root=null,o3d.Client.prototype.packs_=[],o3d.Client.prototype.counter_manager_=null,o3d.Client.prototype.normalizeClearColorAlpha=!0,o3d.Client.prototype.error_callback=function(a){alert(a)},o3d.Client.prototype.render_callback=function(a){},o3d.Client.prototype.tick_callback=function(a){},o3d.Client.prototype.cleanup=function(){this.clearRenderCallback(),this.clearTickCallback(),this.clearErrorCallback()},o3d.Client.prototype.createPack=function(){var a=new o3d.Pack;a.client=this,a.gl=this.gl,this.packs_.push(a);return a},o3d.Client.prototype.destroyPack=function(a){o3d.removeFromArray(this.packs_,a)},o3d.Client.prototype.getObjectById=function(a){o3d.notImplemented()},o3d.Client.prototype.getObjects=function(a,b){var c=[];for(var d=0;d<this.packs_.length;++d){var e=this.packs_[d];c=c.concat(e.getObjects(a,b))}return c},o3d.Client.prototype.getObjectsByClassName=function(a){var b=[];for(var c=0;c<this.packs_.length;++c){var d=this.packs_[c];b=b.concat(d.getObjectsByClassName(a))}return b},o3d.Client.RenderMode=goog.typedef,o3d.Client.RENDERMODE_CONTINUOUS=0,o3d.Client.RENDERMODE_ON_DEMAND=1,o3d.Client.prototype.renderMode=o3d.Client.RENDERMODE_CONTINUOUS,o3d.Client.prototype.render=function(a){if(!!this.gl){var b=new o3d.RenderEvent;this.counter_manager_.advanceRenderFrameCounters(),this.clearStateStack_(),a||(a=(new Date).getTime()),a*=.001,this.then_==0?b.elapsedTime=0:b.elapsedTime=a-this.then_;if(this.render_callback){for(var c in this.render_stats_)b[c]=this.render_stats_[c];this.render_callback(b)}this.then_=a,this.gl.colorMask(!0,!0,!0,!0),this.renderTree(this.renderGraphRoot),this.normalizeClearColorAlpha&&(this.gl.colorMask(!1,!1,!1,!0),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT))}},o3d.Client.prototype.render_stats={},o3d.Client.prototype.renderTree=function(a){this.render_stats_={drawElementsCulled:0,drawElementsProcessed:0,drawElementsRendered:0,primitivesRendered:0,transformsCulled:0,transformsProcessed:0},a.render()},o3d.Client.prototype.getDisplayModes=[],o3d.Client.prototype.setFullscreenClickRegion=function(a,b,c,d,e){o3d.notImplemented()},o3d.Client.prototype.clearFullscreenClickRegion=function(){o3d.notImplemented()},o3d.Client.prototype.cancelFullscreenDisplay=function(){render_node.render()},o3d.Client.prototype.client_info=null,o3d.Client.prototype.fullscreen=!1,o3d.Client.prototype.__defineGetter__("width",function(){return this.gl.canvas.width}),o3d.Client.prototype.__defineSetter__("width",function(a){this.gl.canvas.width=a}),o3d.Client.prototype.__defineGetter__("height",function(){return this.gl.canvas.height}),o3d.Client.prototype.__defineSetter__("height",function(a){this.gl.canvas.height=a}),o3d.Client.prototype.initWithCanvas=function(a){var b,c={alpha:!0,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!0};if(!a||!a.getContext)return!1;var d=["webgl","experimental-webgl","moz-webgl"];for(var e=0;e<d.length;++e){try{b=a.getContext(d[e],c)}catch(f){}if(b)break}if(!b)return!1;this.gl=b,this.root.gl=b,this.renderGraphRoot.gl=b,b.client=this,b.displayInfo={width:a.width,height:a.height},o3d.State.createDefaultState_(b).push_(),this.initErrorTextures_();return!0},o3d.Client.prototype.initErrorTextures_=function(){var a=[1,0,0,1],b=[1,1,0,1],c=[a,a,a,a,a,a,a,a,a,a,b,b,b,b,a,a,a,b,a,a,a,b,b,a,a,b,a,a,b,a,b,a,a,b,a,b,a,a,b,a,a,b,b,a,a,a,b,a,a,a,b,b,b,b,a,a,a,a,a,a,a,a,a,a],d=[];for(var e=0;e<c.length;e++)for(var f=0;f<4;f++)d[e*4+f]=c[e][f];var g=new o3d.TextureCUBE;g.gl=this.gl,g.init_(8,o3d.Texture.ARGB8,1,!1,!0);for(var e=0;e<6;++e)g.set(e,0,d);g.name="DefaultTextureCube",this.error_texture_cube_=g,this.fallback_error_texture_cube_=g;var h=new o3d.Texture2D;h.gl=this.gl,h.init_(8,8,o3d.Texture.ARGB8,1,!1),h.set(0,d),h.name="DefaultTexture",this.error_texture_=h,this.fallback_error_texture_=h},o3d.Client.prototype.setRenderCallback=function(a){this.render_callback=a},o3d.Client.prototype.clearRenderCallback=function(){this.render_callback=null},o3d.Client.prototype.setPostRenderCallback=function(a){this.postRenderCallback=a},o3d.Client.prototype.clearPostRenderCallback=function(){this.postRenderCallback=null},o3d.Client.prototype.setLostResourcesCallback=function(a){this.lostResourcesCallback=a},o3d.Client.prototype.clearLostResourcesCallback=function(){this.lostResourcesCallback=null},o3d.Client.getEvent_=function(a){return a?a:window.event},o3d.Client.getEventInfo_=function(a){var b=a.target?a.target:a.srcElement,c=b.id?b.id:"->"+b.toString(),d=a.detail?a.detail:-a.wheelDelta;return{event:a,element:b,name:c,wheel:d}},o3d.Client.getAbsolutePosition_=function(a){var b={x:0,y:0};for(var c=a;c;c=c.offsetParent)b.x+=c.offsetLeft,b.y+=c.offsetTop;return b},o3d.Client.getLocalXY_=function(a){var b=a.event,c=o3d.Client.getAbsolutePosition_(a.element);return{x:b.pageX-c.x,y:b.pageY-c.y}},o3d.Client.wrapEventCallback_=function(a,b){return function(c){c=o3d.Client.getEvent_(c);var d=c,e=o3d.Client.getEventInfo_(c),f=o3d.Client.getLocalXY_(e);c=o3d.clone(c),c.x=f.x,c.y=f.y,c.deltaY=-e.wheel,a(c),b&&o3djs.event.cancel(d)}},o3d.Client.prototype.setEventCallback=function(a,b){var c=this.gl.canvas,d=a=="wheel",e=a.substr(0,3)=="key";e?c=document:b=o3d.Client.wrapEventCallback_(b,d),d?(c.addEventListener("DOMMouseScroll",b,!0),c.addEventListener("mousewheel",b,!0)):c.addEventListener(a,b,!0)},o3d.Client.prototype.clearEventCallback=function(a){var b=this.gl.canvas,c=a=="wheel",d=a.substr(0,3)=="key";d&&(b=document),c?(b.removeEventListener("DOMMouseScroll"),b.removeEventListener("mousewheel")):b.removeEventListener(a)},o3d.Client.prototype.setErrorTexture=function(a){this.error_texture_=a},o3d.Client.prototype.setErrorTextureCube=function(a){this.error_texture_cube_map_=a},o3d.Client.prototype.setTickCallback=function(a){this.tickCallback=a},o3d.Client.prototype.clearTickCallback=function(){this.tickCallback=null},o3d.Client.prototype.setErrorCallback=function(a){a?this.error_callback=this.wrapErrorCallback_(a):this.error_callback=function(a){this.last_error_=a}},o3d.Client.prototype.wrapErrorCallback_=function(a){return function(b){this.last_error_=b,a(b)}},o3d.Client.prototype.clearErrorCallback=function(){this.setErrorCallback(null)},o3d.Client.prototype.invalidateAllParameters=function(){o3d.notImplemented()},o3d.Client.prototype.toDataURL=function(a){o3d.notImplemented()},o3d.Client.prototype.clearStateStack_=function(){this.stateMapStack_=[];for(var a in this.stateVariableStacks_){var b=this.stateVariableStacks_[a];b.length!=1&&(this.stateVariableStacks_[a]=b.slice(0,1))}},o3d.Client.prototype.pushState_=function(a){this.stateMapStack_.push(a);for(var b in a){var c=a[b];this.stateVariableStacks_[b]==undefined&&(this.stateVariableStacks_[b]=[]),this.stateVariableStacks_[b].push(c)}o3d.State.setVariables_(this.gl,a)},o3d.Client.prototype.popState_=function(){var a=this.stateMapStack_.pop();for(var b in a){var c=this.stateVariableStacks_[b];c.pop(),a[b]=c.length?c[c.length-1]:o3d.State.stateVariableInfos_[b].defaultValue}o3d.State.setVariables_(this.gl,a)},o3d.Client.prototype.getState_=function(a){var b=this.stateVariableStacks_[a];return b.length?b[b.length-1]:o3d.State.stateVariableInfos_[a].defaultValue},o3d.Client.prototype.renderer_init_status=0,o3d.Client.prototype.cursor=null,o3d.Client.prototype.error_texture_=null,o3d.Client.prototype.error_texture_cube_=null,o3d.Client.prototype.fallback_error_texture_=null,o3d.Client.prototype.fallback_error_texture_cube_=null,o3d.Client.prototype.last_error_="",o3d.Client.prototype.__defineGetter__("lastError",function(){return this.last_error_}),o3d.Client.prototype.reportErrors_=function(){return this.error_texture_==null},o3d.Client.prototype.objects=[],o3d.Client.prototype.clearLastError=function(){this.last_error_=""},o3d.Client.prototype.profileReset=function(){o3d.notImplemented()},o3d.Client.prototype.profileToString=function(){o3d.notImplemented()},o3d.Client.prototype.clientId=0,o3d.Client.prototype.clientInfo=null,o3d.Client.prototype.canvas=null,o3d.RenderNode=function(a,b){o3d.ParamObject.call(this),this.priority=a||0,this.children=[],this.active=b||!0,this.parent=null},o3d.inherit("RenderNode","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.RenderNode,"priority","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.RenderNode,"active","ParamBoolean"),o3d.RenderNode.prototype.__defineSetter__("parent",function(a){this.parent_&&this.parent_.removeChild(this),this.parent_=a;if(this.parent_){if(!this.parent_.addChild)throw"Parent of render node must be render node or null.";this.parent_.addChild(this)}}),o3d.RenderNode.prototype.__defineGetter__("parent",function(a){return this.parent_}),o3d.RenderNode.prototype.addChild=function(a){this.children.push(a)},o3d.RenderNode.prototype.removeChild=function(a){o3d.removeFromArray(this.children,a)},o3d.RenderNode.prototype.getRenderNodesInTree=function(){o3d.notImplemented()},o3d.RenderNode.prototype.getRenderNodesByNameInTree=function(a){o3d.notImplemented()},o3d.RenderNode.prototype.getRenderNodesByClassNameInTree=function(a){o3d.notImplemented()},o3d.RenderNode.prototype.render=function(){function a(a,b){return a.priority-b.priority}this.children.sort(a);var b=this.children;this.before();for(var c=0;c<b.length;++c)b[c].render();this.after()},o3d.RenderNode.prototype.before=function(){},o3d.RenderNode.prototype.after=function(){},o3d.ClearBuffer=function(){o3d.RenderNode.call(this),this.clearColor=[0,0,0,1],this.clearColorFlag=!0,this.clearDepth=1,this.clearDepthFlag=!0,this.clearStencil=0,this.clearStencilFlag=!0},o3d.inherit("ClearBuffer","RenderNode"),o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearColor","ParamFloat4"),o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearColorFlag","ParamBoolean"),o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearDepth","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearDepthFlag","ParamBoolean"),o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearStencil","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.ClearBuffer,"clearStencilFlag","ParamBoolean"),o3d.ClearBuffer.prototype.before=function(){var a=0;this.gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),this.gl.clearDepth(this.clearDepth),this.gl.clearStencil(this.clearStencil),this.clearColorFlag&&(a=a|this.gl.COLOR_BUFFER_BIT),this.clearDepthFlag&&(a=a|this.gl.DEPTH_BUFFER_BIT),this.clearStencilFlag&&(a=a|this.gl.STENCIL_BUFFER_BIT),this.gl.clear(a)},o3d.StateSet=function(a){o3d.RenderNode.call(this),this.state=a||null},o3d.inherit("StateSet","RenderNode"),o3d.ParamObject.setUpO3DParam_(o3d.StateSet,"state","ParamState"),o3d.StateSet.prototype.before=function(){this.state&&this.state.push_()},o3d.StateSet.prototype.after=function(){this.state&&this.state.pop_()},o3d.Viewport=function(a,b){o3d.RenderNode.call(this),this.viewport=a||[0,0,1,1],this.depthRange=b||[0,1]},o3d.inherit("Viewport","RenderNode"),o3d.ParamObject.setUpO3DParam_(o3d.Viewport,"viewport","ParamFloat4"),o3d.ParamObject.setUpO3DParam_(o3d.Viewport,"depthRange","ParamFloat2"),o3d.Viewport.prototype.before=function(){var a=this.viewport[0]*this.gl.displayInfo.width,b=(1-this.viewport[1]-this.viewport[3])*this.gl.displayInfo.height,c=this.viewport[2]*this.gl.displayInfo.width,d=this.viewport[3]*this.gl.displayInfo.height;this.gl.viewport(a,b,c,d),a!=0||b!=0||this.viewport[2]!=1||this.viewport[3]!=1?(this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(a,b,c,d)):this.gl.disable(this.gl.SCISSOR_TEST)},o3d.TreeTraversal=function(a){o3d.RenderNode.call(this),this.transform=a||null,this.drawLists_=[],this.drawListsToReset_=[]},o3d.inherit("TreeTraversal","RenderNode"),o3d.ParamObject.setUpO3DParam_(o3d.TreeTraversal,"transform","ParamTransform"),o3d.TreeTraversal.prototype.registerDrawList=function(a,b,c){(c==undefined||c)&&this.drawListsToReset_.push(a),this.drawLists_.push({list:a,context:b})},o3d.TreeTraversal.prototype.unregisterDrawList=function(a){o3d.notImplemented()},o3d.TreeTraversal.prototype.before=function(){for(var a=0;a<this.drawListsToReset_.length;++a)this.drawListsToReset_[a].list_=[];this.transform.traverse(this.drawLists_)},o3d.DrawList=function(){o3d.NamedObject.call(this),this.list_=[]},o3d.inherit("DrawList","NamedObject"),this.list_=[],o3d.DrawList.SortMethod=goog.typedef,o3d.DrawList.BY_PERFORMANCE=0,o3d.DrawList.BY_Z_ORDER=1,o3d.DrawList.BY_PRIORITY=2,o3d.DrawList.comparePriority_=function(a,b){return a.drawElement.owner.priority-b.drawElement.owner.priority},o3d.DrawList.compareZ_=function(a,b){return o3d.Transform.transformPointZOnly(b.worldViewProjection,b.drawElement.owner.zSortPoint)-o3d.Transform.transformPointZOnly(a.worldViewProjection,a.drawElement.owner.zSortPoint)},o3d.DrawList.prototype.sort_=function(a){switch(a){case o3d.DrawList.BY_PRIORITY:this.list_.sort(o3d.DrawList.comparePriority_);break;case o3d.DrawList.BY_Z_ORDER:this.list_.sort(o3d.DrawList.compareZ_);break;case o3d.DrawList.BY_PERFORMANCE:default:}},o3d.DrawList.prototype.render=function(){for(var a=0;a<this.list_.length;++a){var b=this.list_[a],c=b.world,d=b.view,e=b.viewProjection,f=b.worldViewProjection,g=b.projection,h=b.transform,i=b.drawElement,j=i.owner,k=i.material||j.material,l=k.effect;o3d.Param.SAS.setWorld(c),o3d.Param.SAS.setView(d),o3d.Param.SAS.setProjection(g),o3d.Param.SAS.setViewProjection(e),o3d.Param.SAS.setWorldViewProjection(f);var m=[h,i,j];j.streamBank&&m.push(j.streamBank),m.push(k,l,o3d.Param.SAS),l.searchForParams_(m);var n=k.state!=undefined;n&&k.state.push_(),j.render(),n&&k.state.pop_()}},o3d.DrawPass=function(a,b){o3d.RenderNode.call(this),this.drawList=a||null,this.sortMethod=b||o3d.DrawList.BY_PERFORMANCE},o3d.inherit("DrawPass","RenderNode"),o3d.DrawPass.SortMethod=goog.typedef,o3d.ParamObject.setUpO3DParam_(o3d.DrawPass,"drawList","ParamDrawList"),o3d.ParamObject.setUpO3DParam_(o3d.DrawPass,"sortMethod","ParamInteger"),o3d.DrawPass.prototype.before=function(){this.drawList&&(this.drawList.sort_(this.sortMethod),this.drawList.render())},o3d.RenderSurfaceSet=function(a,b){o3d.RenderNode.call(this),this.renderSurface=a||null,this.renderDepthStencilSurface=b||null},o3d.inherit("RenderSurfaceSet","RenderNode"),o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceSet,"renderSurface","ParamRenderSurface"),o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceSet,"renderDepthStencilSurface","ParamRenderDepthStencilSurface"),o3d.RenderSurfaceSet.prototype.clearFramebufferObjects_=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderSurface.framebuffer_),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,null),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},o3d.RenderSurfaceSet.prototype.installFramebufferObjects_=function(){this.clearFramebufferObjects_(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderSurface.framebuffer_);if(this.renderSurface){var a=this.renderSurface.texture.texture_,b=this.renderSurface.level;this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,a,b)}if(this.renderDepthStencilSurface){var c=this.renderDepthStencilSurface.depth_stencil_buffer_;this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,c),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,c)}},o3d.RenderSurfaceSet.prototype.before=function(){this.installFramebufferObjects_(),this.previousHeight=this.gl.displayInfo.height,this.previousWidth=this.gl.displayInfo.width,this.previousRenderSurfaceSet=this.gl.currentRenderSurfaceSet,this.gl.displayInfo.height=this.renderSurface.height,this.gl.displayInfo.width=this.renderSurface.width,this.gl.currentRenderSurfaceSet=this},o3d.RenderSurfaceSet.prototype.after=function(){this.clearFramebufferObjects_(),this.gl.displayInfo.height=this.previousHeight,this.gl.displayInfo.width=this.previousWidth,this.gl.currentRenderSurfaceSet=this.previousRenderSurfaceSet},o3d.RenderSurfaceBase=function(a,b,c){o3d.ParamObject.call(this),this.width=a||0,this.height=b||0,this.texture=c||null,this.level=0,this.framebuffer_=null},o3d.inherit("RenderSurfaceBase","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceBase,"width","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.RenderSurfaceBase,"height","ParamInteger"),o3d.RenderSurface=function(){o3d.RenderSurfaceBase.call(this)},o3d.inherit("RenderSurface","RenderSurfaceBase"),o3d.RenderSurface.prototype.initWithTexture=function(a,b){this.framebuffer_=this.gl.createFramebuffer(),this.texture=a,this.level=b,this.width=a.width,this.height=a.height},o3d.RenderDepthStencilSurface=function(){o3d.RenderSurfaceBase.call(this),this.depth_stencil_buffer_=null},o3d.inherit("RenderDepthStencilSurface","RenderSurfaceBase"),o3d.RenderDepthStencilSurface.prototype.initWithSize_=function(a,b){this.depth_stencil_buffer_=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depth_stencil_buffer_),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.width=a,this.height=b},o3d.State=function(){o3d.ParamObject.call(this),this.state_params_={},o3d.State.stateVariableInfos_=o3d.State.stateVariableInfos_||{AlphaBlendEnable:{paramType:"ParamBoolean",defaultValue:!1},AlphaComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_ALWAYS},AlphaReference:{paramType:"ParamFloat",defaultValue:0},AlphaTestEnable:{paramType:"ParamBoolean",defaultValue:!1},BlendAlphaEquation:{paramType:"ParamInteger",defaultValue:o3d.State.BLEND_ADD},BlendEquation:{paramType:"ParamInteger",defaultValue:o3d.State.BLEND_ADD},CCWStencilComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_ALWAYS},CCWStencilFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},CCWStencilPassOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},CCWStencilZFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},ColorWriteEnable:{paramType:"ParamInteger",defaultValue:15},CullMode:{paramType:"ParamInteger",defaultValue:o3d.State.CULL_CW},DestinationBlendAlphaFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ZERO},DestinationBlendFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ZERO},DitherEnable:{paramType:"ParamBoolean",defaultValue:!1},FillMode:{paramType:"ParamInteger",defaultValue:o3d.State.SOLID},LineSmoothEnable:{paramType:"ParamBoolean",defaultValue:!1},PointSize:{paramType:"ParamFloat",defaultValue:0},PointSpriteEnable:{paramType:"ParamBoolean",defaultValue:!1},PolygonOffset1:{paramType:"ParamFloat",defaultValue:0},PolygonOffset2:{paramType:"ParamFloat",defaultValue:0},SeparateAlphaBlendEnable:{paramType:"ParamBoolean",defaultValue:!1},SourceBlendAlphaFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ONE},SourceBlendFunction:{paramType:"ParamInteger",defaultValue:o3d.State.BLENDFUNC_ONE},StencilComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_ALWAYS},StencilEnable:{paramType:"ParamBoolean",defaultValue:!1},StencilFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},StencilMask:{paramType:"ParamInteger",defaultValue:255},StencilPassOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},StencilReference:{paramType:"ParamInteger",defaultValue:0},StencilWriteMask:{paramType:"ParamInteger",defaultValue:255},StencilZFailOperation:{paramType:"ParamInteger",defaultValue:o3d.State.STENCIL_KEEP},TwoSidedStencilEnable:{paramType:"ParamBoolean",defaultValue:!1},ZComparisonFunction:{paramType:"ParamInteger",defaultValue:o3d.State.CMP_LESS},ZEnable:{paramType:"ParamBoolean",defaultValue:!0},ZWriteEnable:{paramType:"ParamBoolean",defaultValue:!0}}},o3d.inherit("State","ParamObject"),o3d.State.prototype.state_params_={},o3d.State.CMP_NEVER=0,o3d.State.CMP_LESS=1,o3d.State.CMP_EQUAL=2,o3d.State.CMP_LEQUAL=3,o3d.State.CMP_GREATER=4,o3d.State.CMP_NOTEQUAL=5,o3d.State.CMP_GEQUAL=6,o3d.State.CMP_ALWAYS=7,o3d.Cull=goog.typedef,o3d.State.CULL_NONE=0,o3d.State.CULL_CW=1,o3d.State.CULL_CCW=2,o3d.State.POINT=0,o3d.State.WIREFRAME=1,o3d.State.SOLID=2,o3d.State.BLENDFUNC_ZERO=0,o3d.State.BLENDFUNC_ONE=1,o3d.State.BLENDFUNC_SOURCE_COLOR=2,o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR=3,o3d.State.BLENDFUNC_SOURCE_ALPHA=4,o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA=5,o3d.State.BLENDFUNC_DESTINATION_ALPHA=6,o3d.State.BLENDFUNC_INVERSE_DESTINATION_ALPHA=7,o3d.State.BLENDFUNC_DESTINATION_COLOR=8,o3d.State.BLENDFUNC_INVERSE_DESTINATION_COLOR=9,o3d.State.BLENDFUNC_SOURCE_ALPHA_SATUTRATE=10,o3d.State.BLEND_ADD=0,o3d.State.BLEND_SUBTRACT=1,o3d.State.BLEND_REVERSE_SUBTRACT=2,o3d.State.BLEND_MIN=3,o3d.State.BLEND_MAX=4,o3d.State.STENCIL_KEEP=0,o3d.State.STENCIL_ZERO=1,o3d.State.STENCIL_REPLACE=2,o3d.State.STENCIL_INCREMENT_SATURATE=3,o3d.State.STENCIL_DECREMENT_SATURATE=4,o3d.State.STENCIL_INVERT=5,o3d.State.STENCIL_INCREMENT=6,o3d.State.STENCIL_DECREMENT=7,o3d.State.prototype.getStateParam=function(a){if(!this.state_params_[a]){var b=o3d.State.stateVariableInfos_[a],c=new o3d.global.o3d[b.paramType];c.value=b.defaultValue,this.state_params_[a]=c}return this.state_params_[a]},o3d.State.createDefaultState_=function(a){var b=new o3d.State;b.gl=a;var c=o3d.State.stateVariableInfos_;for(name in c){var d=c[name];b.getStateParam(name).value=d.defaultValue}return b},o3d.State.convertCmpFunc_=function(a,b){switch(b){case o3d.State.CMP_ALWAYS:return a.ALWAYS;case o3d.State.CMP_NEVER:return a.NEVER;case o3d.State.CMP_LESS:return a.LESS;case o3d.State.CMP_GREATER:return a.GREATER;case o3d.State.CMP_LEQUAL:return a.LEQUAL;case o3d.State.CMP_GEQUAL:return a.GEQUAL;case o3d.State.CMP_EQUAL:return a.EQUAL;case o3d.State.CMP_NOTEQUAL:return a.NOTEQUAL;default:}return a.ALWAYS},o3d.State.convertBlendFunc_=function(a,b){switch(b){case o3d.State.BLENDFUNC_ZERO:return a.ZERO;case o3d.State.BLENDFUNC_ONE:return a.ONE;case o3d.State.BLENDFUNC_SOURCE_COLOR:return a.SRC_COLOR;case o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR:return a.ONE_MINUS_SRC_COLOR;case o3d.State.BLENDFUNC_SOURCE_ALPHA:return a.SRC_ALPHA;case o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA:return a.ONE_MINUS_SRC_ALPHA;case o3d.State.BLENDFUNC_DESTINATION_ALPHA:return a.DST_ALPHA;case o3d.State.BLENDFUNC_INVERSE_DESTINATION_ALPHA:return a.ONE_MINUS_DST_ALPHA;case o3d.State.BLENDFUNC_DESTINATION_COLOR:return a.DST_COLOR;case o3d.State.BLENDFUNC_INVERSE_DESTINATION_COLOR:return a.ONE_MINUS_DST_COLOR;case o3d.State.BLENDFUNC_SOURCE_ALPHA_SATUTRATE:return a.SRC_ALPHA_SATURATE;default:}return a.ONE},o3d.State.convertBlendEquation_=function(a,b){switch(b){case o3d.State.BLEND_ADD:return a.FUNC_ADD;case o3d.State.BLEND_SUBTRACT:return a.FUNC_SUBTRACT;case o3d.State.BLEND_REVERSE_SUBTRACT:return a.FUNC_REVERSE_SUBTRACT;case o3d.State.BLEND_MIN:return a.MIN;case o3d.State.BLEND_MAX:return a.MAX;default:}return a.FUNC_ADD},o3d.State.prototype.push_=function(){this.gl.client.pushState_(this.getVariableMap_())},o3d.State.prototype.pop_=function(){this.gl.client.popState_()},o3d.State.prototype.getVariableMap_=function(){var a={},b=this.state_params_;for(var c in b)a[c]=b[c].value;return a},o3d.State.relevantValues_=function(a,b,c,d){var e=!1;for(var f=0;f<b.length;++f){var g=b[f];if(c[g]!==undefined){e=!0;break}}if(e)for(var f=0;f<b.length;++f){var g=b[f],h=c[g];h===undefined&&(h=a.client.getState_(g)),d[g]=h}return e},o3d.State.setVariables_=function(a,b){var c={};this.relevantValues_(a,["AlphaBlendEnable"],b,c)&&(c.AlphaBlendEnable?a.enable(a.BLEND):a.disable(a.BLEND)),this.relevantValues_(a,["SeparateAlphaBlendEnable","SourceBlendFunction","SourceBlendAlphaFunction","DestinationBlendAlphaFunction","BlendEquation","BlendAlphaEquation"],b,c)&&c.SeparateAlphaBlendEnable&&(a.blendFuncSeparate(o3d.State.convertBlendFunc_(a,c.SourceBlendFunction),o3d.State.convertBlendFunc_(a,c.DestinationBlendFunction),o3d.State.convertBlendFunc_(a,c.SourceBlendAlphaFunction),o3d.State.convertBlendFunc_(a,c.DestinationBlendAlphaFunction)),a.blendEquationSeparate(o3d.State.convertBlendEquation_(a,c.BlendEquation),o3d.State.convertBlendEquation_(a,c.BlendAlphaEquation))),this.relevantValues_(a,["SourceBlendFunction","DestinationBlendFunction"],b,c)&&a.blendFunc(o3d.State.convertBlendFunc_(a,c.SourceBlendFunction),o3d.State.convertBlendFunc_(a,c.DestinationBlendFunction)),this.relevantValues_(a,["BlendEquation"],b,c)&&a.blendEquation(o3d.State.convertBlendEquation_(a,c.BlendEquation));if(this.relevantValues_(a,["CullMode"],b,c))switch(c.CullMode){case o3d.State.CULL_CW:a.enable(a.CULL_FACE),a.cullFace(a.BACK);break;case o3d.State.CULL_CCW:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;default:a.disable(a.CULL_FACE)}this.relevantValues_(a,["DitherEnable"],b,c)&&(c.DitherEnable?a.enable(a.DITHER):a.disable(a.DITHER)),this.relevantValues_(a,["ZEnable","ZComparisonFunction"],b,c)&&(c.ZEnable?(a.enable(a.DEPTH_TEST),a.depthFunc(this.convertCmpFunc_(a,c.ZComparisonFunction))):a.disable(a.DEPTH_TEST)),this.relevantValues_(a,["ZWriteEnable"],b,c)&&a.depthMask(c.ZWriteEnable),this.relevantValues_(a,["StencilEnable","StencilComparisonFunction"],b,c)&&(c.StencilEnable?(a.enable(a.STENCIL_TEST),a.stencilFunc(this.convertCmpFunc_(a,c.StencilComparisonFunction))):a.disable(a.STENCIL_TEST));if(this.relevantValues_(a,["PolygonOffset1","PolygonOffset2"],b,c)){var d=c.PolygonOffset1||0,e=c.PolygonOffset2||0;d||e?(a.enable(a.POLYGON_OFFSET_FILL),a.polygonOffset(d,e)):a.disable(a.POLYGON_OFFSET_FILL)}this.relevantValues_(a,["FillMode"],b,c)&&(a.fillMode_=c.FillMode)},o3d.DrawContext=function(a,b){o3d.ParamObject.call(this),this.view=a||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.projection=b||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("DrawContext","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.DrawContext,"view","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.DrawContext,"projection","ParamMatrix4"),o3d.RayIntersectionInfo=function(){o3d.NamedObject.call(this),o3d.RayIntersectionInfo.prototype.position=[0,0,0]},o3d.inherit("RayIntersectionInfo","NamedObject"),o3d.RayIntersectionInfo.prototype.valid=!1,o3d.RayIntersectionInfo.prototype.inside=!1,o3d.RayIntersectionInfo.prototype.intersected=!1,o3d.RayIntersectionInfo.prototype.position=[0,0,0],o3d.RayIntersectionInfo.prototype.primitiveIndex=-1,o3d.Sampler=function(){o3d.ParamObject.call(this),this.addressModeU=o3d.Sampler.WRAP,this.addressModeV=o3d.Sampler.WRAP,this.addressModeW=o3d.Sampler.WRAP,this.magFilter=o3d.Sampler.LINEAR,this.minFilter=o3d.Sampler.LINEAR,this.mipFilter=o3d.Sampler.LINEAR,this.borderColor=[0,0,0,0],this.maxAnisotropy=1,this.texture=null},o3d.inherit("Sampler","ParamObject"),o3d.Sampler.AddressMode=goog.typedef,o3d.Sampler.WRAP=0,o3d.Sampler.MIRROR=1,o3d.Sampler.CLAMP=2,o3d.Sampler.BORDER=3,o3d.Sampler.FilterType=goog.typedef,o3d.Sampler.NONE=0,o3d.Sampler.POINT=1,o3d.Sampler.LINEAR=2,o3d.Sampler.ANISOTROPIC=3,o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"addressModeU","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"addressModeV","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"addressModeW","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"magFilter","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"minFilter","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"mipFilter","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"borderColor","ParamFloat4"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"maxAnisotropy","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Sampler,"texture","ParamTexture"),o3d.Sampler.prototype.convertAddressMode_=function(a){var b=this.gl.REPEAT;switch(a){case o3d.Sampler.WRAP:b=this.gl.REPEAT;break;case o3d.Sampler.MIRROR:b=this.gl.MIRRORED_REPEAT;break;case o3d.Sampler.CLAMP:b=this.gl.CLAMP_TO_EDGE;break;case o3d.Sampler.BORDER:default:this.gl.client.error_callback("Unknown/Unavailable Address mode")}return b},o3d.Sampler.prototype.convertMinFilter_=function(a,b){switch(a){case o3d.Sampler.NONE:return this.gl.NEAREST;case o3d.Sampler.POINT:if(b==o3d.Sampler.NONE)return this.gl.NEAREST;if(b==o3d.Sampler.POINT)return this.gl.NEAREST_MIPMAP_NEAREST;if(b==o3d.Sampler.LINEAR)return this.gl.NEAREST_MIPMAP_LINEAR;if(b==o3d.Sampler.ANISOTROPIC)return this.gl.NEAREST_MIPMAP_LINEAR;case o3d.Sampler.ANISOTROPIC:case o3d.Sampler.LINEAR:if(b==o3d.Sampler.NONE)return this.gl.LINEAR;if(b==o3d.Sampler.POINT)return this.gl.LINEAR_MIPMAP_NEAREST;if(b==o3d.Sampler.LINEAR)return this.gl.LINEAR_MIPMAP_LINEAR;if(b==o3d.Sampler.ANISOTROPIC)return this.gl.LINEAR_MIPMAP_LINEAR}this.gl.client.error_callback("Unknown filter.");return this.gl.NONE},o3d.Sampler.prototype.convertMagFilter_=function(a){switch(a){case o3d.Sampler.NONE:case o3d.Sampler.POINT:return this.gl.NEAREST;case o3d.Sampler.LINEAR:case o3d.Sampler.ANISOTROPIC:return this.gl.LINEAR}this.gl.client.error_callback("Unknown filter.");return this.gl.LINEAR},o3d.Sampler.defaultSampler_=new o3d.Sampler,o3d.Sampler.defaultSampler_.magFilter=o3d.Sampler.POINT,o3d.Sampler.prototype.bindAndSetParameters_=function(a){var b=null;this.texture?b=this.texture:this.gl.client.reportErrors_()?(b=this.gl.client.fallback_error_texture_,this.gl.client.error_callback("Missing texture for sampler "+this.name)):a?b=this.gl.client.error_texture_cube_:b=this.gl.client.error_texture_;var c=this.mipFilter;b.levels==1&&(c=o3d.Sampler.NONE),b.bindAndSetParameters_(this.convertAddressMode_(this.addressModeU),this.convertAddressMode_(this.addressModeV),this.convertMinFilter_(this.minFilter,c),this.convertMagFilter_(this.magFilter))},o3d.Transform=function(a,b,c,d,e){o3d.ParamObject.call(this),this.boundingBoxLocal=d||new o3d.BoundingBox,this.boundingBox=null,this.localMatrix=a||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.worldMatrix=b||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.parent=null,this.visible=c||!0,this.cull=e||!1,this.children=[],this.shapes=[]},o3d.inherit("Transform","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Transform,"visible","ParamBoolean"),o3d.ParamObject.setUpO3DParam_(o3d.Transform,"worldMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Transform,"localMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Transform,"cull","ParamBoolean"),o3d.ParamObject.setUpO3DParam_(o3d.Transform,"boundingBox","ParamBoundingBox"),o3d.Transform.prototype.__defineSetter__("parent",function(a){this.parent_!=null&&(o3d.removeFromArray(this.parent_.children,this),this.parent_.recalculateBoundingBox()),this.parent_=a,a&&a.addChild(this)}),o3d.Transform.prototype.__defineGetter__("parent",function(a){return this.parent_}),o3d.Transform.prototype.__defineSetter__("localMatrix",function(a){var b=this.getParam("localMatrix");b.value=a,this._transformBoundingBox()}),o3d.Transform.prototype.__defineGetter__("localMatrix",function(a){var b=this.getParam("localMatrix");return b.value}),o3d.Transform.prototype.__defineSetter__("shapes",function(a){this.shapes_=a,this.recalculateBoundingBox()}),o3d.Transform.prototype.__defineGetter__("shapes",function(a){return this.shapes_}),o3d.Transform.prototype.addChild=function(a){this.children.push(a),this.recalculateBoundingBox()},o3d.Transform.prototype.getTransformsInTree=function(){var a=[];o3d.Transform.getTransformInTreeRecursive_(this,a);return a},o3d.Transform.getTransformInTreeRecursive_=function(a,b){b.push(a);var c=a.children;for(var d=0;d<c.length;++d)o3d.Transform.getTransformInTreeRecursive_(c[d],b)},o3d.Transform.prototype.getTransformsByNameInTree=function(a){o3d.notImplemented()},o3d.Transform.prototype.getUpdatedWorldMatrix=function(){var a;this.parent?a=this.parent.getUpdatedWorldMatrix():a=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],o3d.Transform.compose(a,this.localMatrix,this.worldMatrix);return this.worldMatrix},o3d.Transform.prototype.recalculateBoundingBox=function(a,b){var c=this.boundingBox,d=this.children,e=this.shapes;c.valid=!1;for(var f=0;f<d.length;++f){var g=d[f],h=g.boundingBox;if(a||!h.valid)g.recalculateBoundingBox(a,b),h=g.boundingBox;h.valid&&(c.valid?c=c.add(h):c=h)}for(var f=0;f<e.length;++f){var i=e[f],j=i.getBoundingBox(b);j.valid&&(c.valid?c=c.add(j):c=j)}this.boundingBoxLocal=c,this._transformBoundingBox()},o3d.Transform.prototype._transformBoundingBox=function(){var a=this.boundingBoxLocal.mul(this.localMatrix);this.boundingBox=a,this.parent&&a.valid&&this.parent._trickleUp(this.boundingBox)},o3d.Transform.prototype._trickleUp=function(a){this.boundingBox.valid&&(this.boundingBoxLocal=this.boundingBoxLocal.add(a),this._transformBoundingBox())},o3d.Transform.prototype.addShape=function(a){this.shapes.push(a),this.recalculateBoundingBox()},o3d.Transform.prototype.removeShape=function(a){o3d.removeFromArray(this.shapes,a),this.recalculateBoundingBox()},o3d.Transform.prototype.createDrawElements=function(a,b){var c=this.children,d=this.shapes;for(var e=0;e<d.length;++e)d[e].createDrawElements(a,b);for(var e=0;e<c.length;++e)c[e].createDrawElements(a,b)},o3d.Transform.prototype.identity=function(){var a=this.localMatrix;for(var b=0;b<4;++b)for(var c=0;c<4;++c)a[b][c]=b==c?1:0;this._transformBoundingBox()},o3d.Transform.compose=function(a,b,c){var d=c||a,e=a[0],f=a[1],g=a[2],h=a[3],i=b[0],j=b[1],k=b[2],l=b[3],m=e[0],n=e[1],o=e[2],p=e[3],q=f[0],r=f[1],s=f[2],t=f[3],u=g[0],v=g[1],w=g[2],x=g[3],y=h[0],z=h[1],A=h[2],B=h[3],C=i[0],D=i[1],E=i[2],F=i[3],G=j[0],H=j[1],I=j[2],J=j[3],K=k[0],L=k[1],M=k[2],N=k[3],O=l[0],P=l[1],Q=l[2],R=l[3];d[0].splice(0,4,m*C+q*D+u*E+y*F,n*C+r*D+v*E+z*F,o*C+s*D+w*E+A*F,p*C+t*D+x*E+B*F),d[1].splice(0,4,m*G+q*H+u*I+y*J,n*G+r*H+v*I+z*J,o*G+s*H+w*I+A*J,p*G+t*H+x*I+B*J),d[2].splice(0,4,m*K+q*L+u*M+y*N,n*K+r*L+v*M+z*N,o*K+s*L+w*M+A*N,p*K+t*L+x*M+B*N),d[3].splice(0,4,m*O+q*P+u*Q+y*R,n*O+r*P+v*Q+z*R,o*O+s*P+w*Q+A*R,p*O+t*P+x*Q+B*R)},o3d.Transform.matricesEqual=function(a,b){if(a==b)return!0;for(var c=0;c<4;++c)for(var d=0;d<4;++d)if(a[c][d]!=b[c][d])return!1;return!0},o3d.Transform.transpose=function(a,b){var c=b||a,d=a[0],e=a[1],f=a[2],g=a[3],h=d[0],i=d[1],j=d[2],k=d[3],l=e[0],m=e[1],n=e[2],o=e[3],p=f[0],q=f[1],r=f[2],s=f[3],t=g[0],u=g[1],v=g[2],w=g[3];c[0].splice(0,4,h,l,p,t),c[1].splice(0,4,i,m,q,u),c[2].splice(0,4,j,n,r,v),c[3].splice(0,4,k,o,s,w)},o3d.Transform.inverse=function(a,b){var c=b||a,d=a[0],e=a[1],f=a[2],g=a[3],h=d[0],i=d[1],j=d[2],k=d[3],l=e[0],m=e[1],n=e[2],o=e[3],p=f[0],q=f[1],r=f[2],s=f[3],t=g[0],u=g[1],v=g[2],w=g[3],x=r*w,y=v*s,z=n*w,A=v*o,B=n*s,C=r*o,D=j*w,E=v*k,F=j*s,G=r*k,H=j*o,I=n*k,J=p*u,K=t*q,L=l*u,M=t*m,N=l*q,O=p*m,P=h*u,Q=t*i,R=h*q,S=p*i,T=h*m,U=l*i,V=x*m+A*q+B*u-(y*m+z*q+C*u),W=y*i+D*q+G*u-(x*i+E*q+F*u),X=z*i+E*m+H*u-(A*i+D*m+I*u),Y=C*i+F*m+I*q-(B*i+G*m+H*q),Z=1/(h*V+l*W+p*X+t*Y);c[0].splice(0,4,Z*V,Z*W,Z*X,Z*Y),c[1].splice(0,4,Z*(y*l+z*p+C*t-(x*l+A*p+B*t)),Z*(x*h+E*p+F*t-(y*h+D*p+G*t)),Z*(A*h+D*l+I*t-(z*h+E*l+H*t)),Z*(B*h+G*l+H*p-(C*h+F*l+I*p))),c[2].splice(0,4,Z*(J*o+M*s+N*w-(K*o+L*s+O*w)),Z*(K*k+P*s+S*w-(J*k+Q*s+R*w)),Z*(L*k+Q*o+T*w-(M*k+P*o+U*w)),Z*(O*k+R*o+U*s-(N*k+S*o+T*s))),c[3].splice(0,4,Z*(L*r+O*v+K*n-(N*v+J*n+M*r)),Z*(R*v+J*j+Q*r-(P*r+S*v+K*j)),Z*(P*n+U*v+M*j-(T*v+L*j+Q*n)),Z*(T*r+N*j+S*n-(R*n+U*r+O*j)))},o3d.Transform.prototype.translate=function(){var a=arguments.length!=3?arguments[0]:arguments,b=this.localMatrix,c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],i=b[3],j=f[0],k=f[1],l=f[2],m=f[3],n=g[0],o=g[1],p=g[2],q=g[3],r=h[0],s=h[1],t=h[2],u=h[3],v=i[0],w=i[1],x=i[2],y=i[3];i.splice(0,4,j*c+n*d+r*e+v,k*c+o*d+s*e+w,l*c+p*d+t*e+x,m*c+q*d+u*e+y),this._transformBoundingBox()},o3d.Transform.prototype.rotateX=function(a){var b=this.localMatrix,c=b[0],d=b[1],e=b[2],f=b[3],g=d[0],h=d[1],i=d[2],j=d[3],k=e[0],l=e[1],m=e[2],n=e[3],o=Math.cos(a),p=Math.sin(a);d.splice(0,4,o*g+p*k,o*h+p*l,o*i+p*m,o*j+p*n),e.splice(0,4,o*k-p*g,o*l-p*h,o*m-p*i,o*n-p*j),this._transformBoundingBox()},o3d.Transform.transformPoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3],j=c*f[3]+d*g[3]+e*h[3]+i[3];return[(c*f[0]+d*g[0]+e*h[0]+i[0])/j,(c*f[1]+d*g[1]+e*h[1]+i[1])/j,(c*f[2]+d*g[2]+e*h[2]+i[2])/j]},o3d.Transform.multiplyVector=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=a[0],h=a[1],i=a[2],j=a[3];return[c*g[0]+d*h[0]+e*i[0]+f*j[0],c*g[1]+d*h[1]+e*i[1]+f*j[1],c*g[2]+d*h[2]+e*i[2]+f*j[2],c*g[3]+d*h[3]+e*i[3]+f*j[3]]},o3d.Transform.transformPointZOnly=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3];return(c*f[2]+d*g[2]+e*h[2]+i[2])/(c*f[3]+d*g[3]+e*h[3]+i[3])},o3d.Transform.prototype.rotateY=function(a){var b=this.localMatrix,c=b[0],d=b[1],e=b[2],f=b[3],g=c[0],h=c[1],i=c[2],j=c[3],k=e[0],l=e[1],m=e[2],n=e[3],o=Math.cos(a),p=Math.sin(a);c.splice(0,4,o*g-p*k,o*h-p*l,o*i-p*m,o*j-p*n),e.splice(0,4,o*k+p*g,o*l+p*h,o*m+p*i,o*n+p*j),this._transformBoundingBox()},o3d.Transform.prototype.rotateZ=function(a){var b=this.localMatrix,c=b[0],d=b[1],e=b[2],f=b[3],g=c[0],h=c[1],i=c[2],j=c[3],k=d[0],l=d[1],m=d[2],n=d[3],o=Math.cos(a),p=Math.sin(a);c.splice(0,4,o*g+p*k,o*h+p*l,o*i+p*m,o*j+p*n),d.splice(0,4,o*k-p*g,o*l-p*h,o*m-p*i,o*n-p*j),this._transformBoundingBox()},o3d.Transform.prototype.rotateZYX=function(a){var b=this.localMatrix,c=Math.sin(a[0]),d=Math.cos(a[0]),e=Math.sin(a[1]),f=Math.cos(a[1]),g=Math.sin(a[2]),h=Math.cos(a[2]),i=h*e,j=g*e,k=h*f,l=g*f,m=-e,n=i*c-g*d,o=j*c+h*d,p=f*c,q=i*d+g*c,r=j*d-h*c,s=f*d,t=b[0],u=b[1],v=b[2],w=b[3],x=t[0],y=t[1],z=t[2],A=t[3],B=u[0],C=u[1],D=u[2],E=u[3],F=v[0],G=v[1],H=v[2],I=v[3],J=w[0],K=w[1],L=w[2],M=w[3];t.splice(0,4,k*x+l*B+m*F,k*y+l*C+m*G,k*z+l*D+m*H,k*A+l*E+m*I),u.splice(0,4,n*x+o*B+p*F,n*y+o*C+p*G,n*z+o*D+p*H,n*A+o*E+p*I),v.splice(0,4,q*x+r*B+s*F,q*y+r*C+s*G,q*z+r*D+s*H,q*A+r*E+s*I),this._transformBoundingBox()},o3d.Transform.prototype.axisRotate=function(a,b){o3d.Transform.axisRotateMatrix(this.localMatrix,a,b)},o3d.Transform.axisRotateMatrix=function(a,b,c,d){d=d||a;var e=b[0],f=b[1],g=b[2],h=Math.sqrt(e*e+f*f+g*g);e/=h,f/=h,g/=h;var i=e*e,j=f*f,k=g*g,l=Math.cos(c),m=Math.sin(c),n=1-l,o=i+(1-i)*l,p=e*f*n+g*m,q=e*g*n-f*m,r=e*f*n-g*m,s=j+(1-j)*l,t=f*g*n+e*m,u=e*g*n+f*m,v=f*g*n-e*m,w=k+(1-k)*l,x=a[0],y=a[1],z=a[2],A=a[3],B=x[0],C=x[1],D=x[2],E=x[3],F=y[0],G=y[1],H=y[2],I=y[3],J=z[0],K=z[1],L=z[2],M=z[3],N=A[0],O=A[1],P=A[2],Q=A[3];d[0].splice(0,4,o*B+p*F+q*J,o*C+p*G+q*K,o*D+p*H+q*L,o*E+p*I+q*M),d[1].splice(0,4,r*B+s*F+t*J,r*C+s*G+t*K,r*D+s*H+t*L,r*E+s*I+t*M),d[2].splice(0,4,u*B+v*F+w*J,u*C+v*G+w*K,u*D+v*H+w*L,u*E+v*I+w*M),d[3].splice(0,4,N,O,P,Q)},o3d.Transform.prototype.quaternionRotate=function(a){var b=this.localMatrix,c=a[0],d=a[1],e=a[2],f=a[3],g=f*f,h=f*c,i=f*d,j=f*e,k=c*f,l=c*c,m=c*d,n=c*e,o=d*f,p=d*c,q=d*d,r=d*e,s=e*f,t=e*c,u=e*d,v=e*e,w=g+l+q+v;o3d.Transform.compose(this.localMatrix,[[(g+l-q-v)/w,2*(j+m)/w,2*(n-i)/w,0],[2*(m-j)/w,(g-l+q-v)/w,2*(h+r)/w,0],[2*(i+n)/w,2*(r-h)/w,(g-l-q+v)/w,0],[0,0,0,1]]),this._transformBoundingBox()},o3d.Transform.prototype.scale=function(){var a;arguments.length==3?a=arguments:a=arguments[0];var b=this.localMatrix,c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],i=b[3];f.splice(0,4,c*f[0],c*f[1],c*f[2],c*f[3]),g.splice(0,4,d*g[0],d*g[1],d*g[2],d*g[3]),h.splice(0,4,e*h[0],e*h[1],e*h[2],e*h[3]),this._transformBoundingBox()},o3d.Transform.flattenMatrix4=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return[b[0],b[1],b[2],b[3],c[0],c[1],c[2],c[3],d[0],d[1],d[2],d[3],e[0],e[1],e[2],e[3]]},o3d.Transform.prototype.traverse=function(a,b){this.gl.client.render_stats_.transformsProcessed++;if(a.length!=0&&!!this.visible){b=b||[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],o3d.Transform.compose(b,this.localMatrix,this.worldMatrix);var c=[];if(this.cull){if(this.boundingBox)for(var d=0;d<a.length;++d){var e=a[d],f=[[],[],[],[]];o3d.Transform.compose(e.context.view,this.worldMatrix,f),o3d.Transform.compose(e.context.projection,f,f),this.boundingBox.inFrustum(f)&&c.push(e)}}else c=a;if(c.length==0){this.gl.client.render_stats_.transformsCulled++;return}var g=this.children,h=this.shapes;for(var d=0;d<h.length;++d)h[d].writeToDrawLists(c,this.worldMatrix,this);for(var d=0;d<g.length;++d)g[d].traverse(c,this.worldMatrix)}},o3d.Pack=function(){o3d.NamedObject.call(this),this.objects_=[]},o3d.inherit("Pack","NamedObject"),o3d.Pack.prototype.destroy=function(){this.objects_=[],this.client.destroyPack(this)},o3d.Pack.prototype.removeObject=function(a){o3d.removeFromArray(this.objects_,a)},o3d.Pack.prototype.createObject=function(a){var b=o3d.global.o3d[o3d.filterTypeName_(a)];if(typeof b!="function")throw"cannot find type in o3d namespace: "+a;var c=new b;c.gl=this.gl,c.clientId=o3d.Client.nextId++,this.objects_.push(c);return c},o3d.Pack.prototype.createTexture2D=function(a,b,c,d,e){var f=this.createObject("Texture2D");f.init_(a,b,c,d,e);return f},o3d.Pack.prototype.createTextureCUBE=function(a,b,c,d){var e=this.createObject("TextureCUBE");e.init_(a,b,c,d);return e},o3d.Pack.prototype.createDepthStencilSurface=function(a,b){var c=this.createObject("RenderDepthStencilSurface");c.initWithSize_(a,b);return c},o3d.Pack.prototype.getObjects=function(a,b){b=o3d.filterTypeName_(b);var c=[];for(var d=0;d<this.objects_.length;++d){var e=this.objects_[d];e.isAClassName(b)&&e.name==a&&c.push(e)}return c},o3d.Pack.prototype.getObjectsByClassName=function(a){a=o3d.filterTypeName_(a);var b=[];for(var c=0;c<this.objects_.length;++c){var d=this.objects_[c];d.isAClassName(a)&&b.push(d)}return b},o3d.Pack.prototype.objects_=[],o3d.Pack.prototype.createFileRequest=function(a){return this.createObject("FileRequest")},o3d.Pack.prototype.createArchiveRequest=function(){return this.createObject("ArchiveRequest")},o3d.Pack.prototype.createBitmapsFromRawData=function(a){var b=this.createObject("Bitmap");if(!a.image_)throw"Cannot create bitmap from non-image data.";b.height=a.image_.height,b.width=a.image_.width;var c=document.createElement("CANVAS");c.width=b.width,c.height=b.height;var d=c.getContext("2d");d.drawImage(a.image_,0,0,b.width,b.height),b.canvas_=c,b.flipVerticallyLazily_(),b.format=o3d.Texture.ARGB8,b.numMipmaps=1;return[b]},o3d.Pack.prototype.createRawDataFromDataURL=function(a){o3d.notImplemented()},o3d.BoundingBox=function(a,b){o3d.ParamObject.call(this);var c=a||[0,0,0],d=b||[0,0,0];this.minExtent=[c[0],c[1],c[2]],this.maxExtent=[d[0],d[1],d[2]],a&&b&&(this.valid=!0)},o3d.inherit("BoundingBox","ParamObject"),o3d.BoundingBox.prototype.corners_=function(){var a=[],b=[this.minExtent,this.maxExtent];for(var c=0;c<2;++c)for(var d=0;d<2;++d)for(var e=0;e<2;++e)a.push([b[c][0],b[d][1],b[e][2]]);return a},o3d.BoundingBox.fitBoxToPoints_=function(a,b){var c=b||new o3d.BoundingBox;for(var d=0;d<3;++d){c.maxExtent[d]=c.minExtent[d]=a[0][d];for(var e=1;e<a.length;++e){var f=a[e];c.minExtent[d]=Math.min(c.minExtent[d],f[d]),c.maxExtent[d]=Math.max(c.maxExtent[d],f[d])}}c.valid=!0;return c},o3d.BoundingBox.prototype.valid=!1,o3d.BoundingBox.prototype.minExtent=[0,0,0],o3d.BoundingBox.prototype.maxExtent=[0,0,0],o3d.BoundingBox.prototype.mul=function(a){var b=this.corners_(),c=[];for(var d=0;d<b.length;++d)c.push(o3d.Transform.transformPoint(a,b[d]));var e=o3d.BoundingBox.fitBoxToPoints_(c);e.valid=this.valid;return e},o3d.BoundingBox.prototype.add=function(a){var b=new o3d.BoundingBox([Math.min(a.minExtent[0],this.minExtent[0]),Math.min(a.minExtent[1],this.minExtent[1]),Math.min(a.minExtent[2],this.minExtent[2])],[Math.max(a.maxExtent[0],this.maxExtent[0]),Math.max(a.maxExtent[1],this.maxExtent[1]),Math.max(a.maxExtent[2],this.maxExtent[2])]);b.valid=this.valid&&a.valid;return b},o3d.BoundingBox.prototype.intersectRay=function(a,b){arguments.length==6&&(a=[arguments[0],arguments[1],arguments[2]],b=[arguments[3],arguments[4],arguments[5]]);var c=new o3d.RayIntersectionInfo;if(this.valid){c.valid=!0,c.intersected=!0;var d=3,e=0,f=1,g=2,h=[b[0]-a[0],b[1]-a[1],b[2]-a[2]],i=[0,0,0],j=!0,k=[],l=[],m=[];for(var n=0;n<d;++n)k.push(0),l.push(0),m.push(0,0);var o;for(var n=0;n<d;++n)a[n]<this.minExtent[n]?(k[n]=f,m[n]=this.minExtent[n],j=!1):a[n]>this.maxExtent[n]?(k[n]=e,m[n]=this.maxExtent[n],j=!1):k[n]=g;if(j)c.position=a,c.inside=!0;else{for(var n=0;n<d;++n)k[n]!=g&&h[n]!=0?l[n]=(m[n]-a[n])/h[n]:l[n]=-1;o=0;for(var n=1;n<d;++n)l[o]<l[n]&&(o=n);if(l[o]<0)c.intersected=!1;else{for(var n=0;n<d;++n)if(o!=n){i[n]=a[n]+l[o]*h[n];if(i[n]<this.minExtent[n]||i[n]>this.maxExtent[n]){c.intersected=!1;break}}else i[n]=m[n];c.position=i}}}return c},o3d.BoundingBox.prototype.inFrustum=function(a){var b=this.corners_(),c=63;for(var d=0;d<b.length;++d){var e=b[d],f=o3d.Transform.transformPoint(a,e);c&=(f[0]>1)<<0|(f[0]<-1)<<1|(f[1]>1)<<2|(f[1]<-1)<<3|(f[2]>1)<<4|(f[2]<0)<<5;if(c==0)return!0}return c==0},o3d.BoundingBox.prototype.getCenterOfGeometry=function(){var a=(this.minExtent[0]+this.maxExtent[0])/2,b=(this.minExtent[1]+this.maxExtent[1])/2,c=(this.minExtent[2]+this.maxExtent[2])/2;return[a,b,c]},o3d.DrawElement=function(a){o3d.ParamObject.call(this),this.material=a||null,this.owner_=null},o3d.inherit("DrawElement","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.DrawElement,"material","ParamMaterial"),o3d.Element=function(a,b,c,d){o3d.ParamObject.call(this),this.material=a,this.boundingBox=b||new o3d.BoundingBox,this.zSortPoint=c||[0,0,0],this.priority=0,this.cull=d||!1,this.owner_=null,this.drawElements=[]},o3d.inherit("Element","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Element,"material","ParamMaterial"),o3d.ParamObject.setUpO3DParam_(o3d.Element,"boundingBox","ParamBoundingBox"),o3d.ParamObject.setUpO3DParam_(o3d.Element,"zSortPoint","ParamFloat3"),o3d.ParamObject.setUpO3DParam_(o3d.Element,"priority","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.Element,"cull","ParamBoolean"),o3d.Element.prototype.__defineSetter__("owner",function(a){this.owner_=a,a.addElement(this)}),o3d.Element.prototype.__defineGetter__("owner",function(){return this.owner_}),o3d.Element.prototype.createDrawElement=function(a,b){drawElement=a.createObject("DrawElement"),drawElement.owner=this,drawElement.material=b,this.drawElements.push(drawElement);return drawElement},o3d.Element.prototype.intersectRay=function(a,b,c,d){o3d.notImplemented()},o3d.Element.prototype.getBoundingBox=function(a){return this.boundingBox},o3d.Element.prototype.render=function(){},o3d.Field=function(){o3d.NamedObject.call(this)},o3d.inherit("Field","NamedObject"),o3d.Field.prototype.numComponents=0,o3d.Field.prototype.buffer=null,o3d.Field.prototype.offset_=0,o3d.Field.prototype.size=0,o3d.Field.prototype.setAt=function(a,b){this.buffer.lock();var c=b.length/this.numComponents;for(var d=0;d<c;++d)for(var e=0;e<this.numComponents;++e)this.buffer.array_[(a+d)*this.buffer.totalComponents+this.offset_+e]=b[this.numComponents*d+e];this.buffer.unlock();return!0},o3d.Field.prototype.getAt=function(a,b){return this.buffer.getAtHelper_(a,b,this.offset_,this.numComponents)},o3d.FloatField=function(){o3d.Field.call(this)},o3d.inherit("FloatField","Field"),o3d.UInt32Field=function(){o3d.Field.call(this)},o3d.inherit("UInt32Field","Field"),o3d.UByteNField=function(){o3d.Field.call(this)},o3d.inherit("UByteNField","Field"),o3d.Buffer=function(){this.fields=[],this.array_=null},o3d.inherit("Buffer","NamedObject"),o3d.Buffer.prototype.fields=[],o3d.Buffer.prototype.totalComponents=0,o3d.Buffer.prototype.gl_buffer_=0,o3d.Buffer.prototype.createArray=function(a){return new Float32Array(a)},o3d.Buffer.prototype.__defineGetter__("numElements",function(){return this.array_?this.array_.length/this.totalComponents:0}),o3d.Buffer.prototype.updateTotalComponents_=function(){var a=0;for(var b=0;b<this.fields.length;++b)this.fields[b].offset_=a,a+=this.fields[b].numComponents;this.totalComponents=a},o3d.Buffer.prototype.allocateElements=function(a){this.updateTotalComponents_(),this.resize(a*this.totalComponents)},o3d.Buffer.prototype.resize=function(a){this.gl_buffer_=this.gl.createBuffer(),this.array_=this.createArray(Math.floor(a))},o3d.Buffer.prototype.createField=function(a,b){var c=this.array_&&this.array_.length>0,d=[],e=this.numElements;if(c)for(var f=0;f<this.fields.length;f++)d[f]=this.fields[f].getAt(0,e);var g=new o3d.Field;g.buffer=this,g.numComponents=b,g.size=b*(a=="UByteNField"?1:4),this.fields.push(g),this.updateTotalComponents_();if(c){this.allocateElements(e);for(var f=0;f<this.fields.length;f++){var h=d[f];h&&this.fields[f].setAt(0,h)}}return g},o3d.Buffer.prototype.removeField=function(a){o3d.removeFromArray(this.fields,a),this.updateTotalComponents_()},o3d.Buffer.prototype.getAtHelper_=function(a,b,c,d){var e=[];for(var f=0;f<b;++f)for(var g=0;g<d;++g)e.push(this.array_[(a+f)*this.totalComponents+c+g]);return e},o3d.Buffer.prototype.lock=function(){},o3d.Buffer.prototype.unlock=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl_buffer_),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.array_,this.gl.STATIC_DRAW)},o3d.Buffer.prototype.set=function(a){a.length||o3d.notImplemented(),(this.array_==null||this.array_.length!=a.length)&&this.resize(a.length),this.lock();for(var b=0;b<a.length;++b)this.array_[b]=a[b];this.unlock()},o3d.VertexBufferBase=function(){o3d.Buffer.call(this)},o3d.inherit("VertexBufferBase","Buffer"),o3d.VertexBufferBase.prototype.get=function(){return this.getAtHelper_(0,this.numElements,0,this.totalComponents)},o3d.VertexBufferBase.prototype.getAt=function(a,b){return this.getAtHelper_(a,b,0,this.totalComponents)},o3d.VertexBuffer=function(){o3d.Buffer.call(this)},o3d.inherit("VertexBuffer","Buffer"),o3d.VertexBuffer.prototype.className="o3d.VertexBuffer",o3d.SourceBuffer=function(){o3d.Buffer.call(this)},o3d.inherit("SourceBuffer","Buffer"),o3d.IndexBuffer=function(){o3d.Buffer.call(this)},o3d.inherit("IndexBuffer","Buffer"),o3d.IndexBuffer.prototype.createArray=function(a){return new Uint16Array(a)},o3d.IndexBuffer.prototype.unlock=function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.gl_buffer_),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.array_,this.gl.STATIC_DRAW)},o3d.Stream=function(a,b,c,d){o3d.NamedObject.call(this),this.semantic=a,this.semanticIndex=b,this.field=c,this.startIndex=d},o3d.inherit("Stream","NamedObject"),o3d.Stream.Semantic=goog.typedef,o3d.Stream.UNKNOWN_SEMANTIC=0,o3d.Stream.POSITION=1,o3d.Stream.NORMAL=2,o3d.Stream.TANGENT=3,o3d.Stream.BINORMAL=4,o3d.Stream.COLOR=5,o3d.Stream.TEXCOORD=6,o3d.Stream.INFLUENCE_WEIGHTS=7,o3d.Stream.INFLUENCE_INDICES=8,o3d.Stream.prototype.field=null,o3d.Stream.prototype.semantic=o3d.Stream.UNKNOWN_SEMANTIC,o3d.Stream.prototype.semanticIndex=0,o3d.Stream.prototype.startIndex=0,o3d.Stream.prototype.getMaxVertices_=function(){var a=this.field.buffer;if(!a)return 0;var b=a.numElements;return this.startIndex>b?0:b-this.startIndex},o3d.VertexSource=function(){o3d.ParamObject.call(this)},o3d.inherit("VertexSource","ParamObject"),o3d.VertexSource.prototype.bindStream=function(a,b,c){if(a){var d=a.getVertexStreamParam(b,c),e=this.getVertexStreamParam(b,c);if(d&&e&&d.stream.field.className==e.stream.field.className&&d.stream.field.numComponents==e.stream.field.numComponents){e.bind(d),a.streamWasBound_(this,b,c);return!0}}return!1},o3d.VertexSource.prototype.unbindStream=function(a,b){var c=this.getVertexStreamParam(a,b);if(c&&c.inputConnection!=null){c.unbindInput();return!0}return!1},o3d.VertexSource.prototype.getVertexStreamParam=function(a,b){o3d.notImplemented()},o3d.VertexSource.prototype.streamWasBound_=function(a,b,c){},o3d.StreamBank=function(){o3d.VertexSource.call(this),this.vertex_streams_=[]},o3d.inherit("StreamBank","VertexSource"),o3d.StreamBank.prototype.vertex_streams_=[],o3d.StreamBank.prototype.__defineGetter__("vertexStreams",function(){var a=[];for(var b=0;b<this.vertex_streams_.length;++b){var c=this.vertex_streams_[b];if(c&&c.length)for(var d=0;d<c.length;++d){var e=c[d];e&&a.push(e.stream)}}return a}),o3d.StreamBank.prototype.setVertexStream=function(a,b,c,d){this.vertex_streams_[a]==undefined&&(this.vertex_streams_[a]=[]);var e=new o3d.Stream(a,b,c,d),f=new o3d.ParamVertexBufferStream;f.stream=e,f.owner_=this,this.vertex_streams_[a][b]=f},o3d.StreamBank.prototype.getVertexStream=function(a,b){return this.vertex_streams_[a]==undefined?null:this.vertex_streams_[a][b]?this.vertex_streams_[a][b].stream:null},o3d.StreamBank.prototype.getVertexStreamParam=function(a,b){return this.vertex_streams_[a]==undefined?null:this.vertex_streams_[a][b]},o3d.StreamBank.prototype.removeVertexStream=function(a,b){if(this.vertex_streams_[a]==undefined)return!1;delete this.vertex_streams_[a][b];return!0},o3d.Primitive=function(a){o3d.Element.call(this),this.indexBuffer=null,this.streamBank=a||null,this.primitiveType=o3d.Primitive.TRIANGLELIST,this.numberVertices=0,this.numberPrimitives=0,this.startIndex=0,this.wireframeIndexBuffer_=null},o3d.inherit("Primitive","Element"),o3d.Primitive.Type=goog.typedef,o3d.Primitive.POINTLIST=1,o3d.Primitive.LINELIST=2,o3d.Primitive.LINESTRIP=3,o3d.Primitive.TRIANGLELIST=4,o3d.Primitive.TRIANGLESTRIP=5,o3d.Primitive.TRIANGLEFAN=6,o3d.ParamObject.setUpO3DParam_(o3d.Primitive,"streamBank","ParamStreamBank"),o3d.Primitive.prototype.render=function(){var a=this.streamBank,b=this.indexBuffer,c=[];for(var d=0;d<a.vertex_streams_.length;++d){var e=a.vertex_streams_[d];if(e&&e.length)for(var f=0;f<e.length;++f){var g=o3d.Effect.reverseSemanticMap_[d][f],h=e[f].stream,i=h.field,j=i.buffer;g==undefined&&this.gl.client.error_callback("uknown semantic");var k=e[f];while(!k.owner_.updateStreams&&k.inputConnection)k=k.inputConnection;k.owner_.updateStreams&&k.owner_.updateStreams(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,j.gl_buffer_),this.gl.enableVertexAttribArray(g),c.push(g);var l=Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(g,i.numComponents,this.gl.FLOAT,!1,j.totalComponents*l,i.offset_*l)}}this.gl.client.render_stats_.primitivesRendered+=this.numberPrimitives;var m,n;switch(this.primitiveType){case o3d.Primitive.POINTLIST:m=this.gl.POINTS,n=this.numberPrimitives;break;case o3d.Primitive.LINELIST:m=this.gl.LINES,n=this.numberPrimitives*2;break;case o3d.Primitive.LINESTRIP:m=this.gl.LINE_STRIP,n=this.numberPrimitives+1;break;case o3d.Primitive.TRIANGLELIST:m=this.gl.TRIANGLES,n=this.numberPrimitives*3;break;case o3d.Primitive.TRIANGLESTRIP:m=this.gl.TRIANGLE_STRIP,n=this.numberPrimitives+2;break;case o3d.Primitive.TRIANGLEFAN:m=this.gl.TRIANGLE_FAN,n=this.numberPrimitives+2;break;case o3d.Primitive.TRIANGLELIST:default:m=this.gl.TRIANGLES,n=this.numberPrimitives*3}var o=!1;this.gl.fillMode_==o3d.State.POINT?m=this.gl.POINTS:this.gl.fillMode_==o3d.State.WIREFRAME&&(this.primitiveType==o3d.Primitive.TRIANGLELIST||this.primitiveType==o3d.Primitive.TRIANGLEFAN||this.primitiveType==o3d.Primitive.TRIANGLESTRIP)&&(o=!0,m=this.gl.LINES,this.computeWireframeIndices_());if(o){b=this.wireframeIndexBuffer_;switch(this.primitiveType){default:case o3d.Primitive.TRIANGLELIST:n=this.numberPrimitives*6;break;case o3d.Primitive.TRIANGLESTRIP:case o3d.Primitive.TRIANGLEFAN:n=this.numberPrimitives==0?0:this.numberPrimitives*4+2}}b?(this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,b.gl_buffer_),this.gl.drawElements(m,n,this.gl.UNSIGNED_SHORT,0)):this.gl.drawArrays(m,0,n);for(var p=0;p<c.length;++p)this.gl.disableVertexAttribArray(c[p])},o3d.Primitive.prototype.getIndex_=function(a){return this.indexBuffer?this.indexBuffer.array_[a]:a},o3d.Primitive.prototype.computeWireframeIndices_=function(){this.wireframeIndexBuffer_=new o3d.IndexBuffer,this.wireframeIndexBuffer_.gl=this.gl;var a=this.numberPrimitives,b=this.primitiveType==o3d.Primitive.TRIANGLELIST?3*a:2*a+1;this.wireframeIndexBuffer_.resize(2*b);var c=0;switch(this.primitiveType){default:case o3d.Primitive.TRIANGLELIST:var d=this.wireframeIndexBuffer_.array_;this.wireframeIndexBuffer_.lock();for(var e=0;e<a;++e){var f=this.getIndex_(3*e),g=this.getIndex_(3*e+1),h=this.getIndex_(3*e+2);d[c++]=f,d[c++]=g,d[c++]=g,d[c++]=h,d[c++]=h,d[c++]=f}this.wireframeIndexBuffer_.unlock();break;case o3d.Primitive.TRIANGLEFAN:var d=this.wireframeIndexBuffer_.array_;this.wireframeIndexBuffer_.lock();var i;a>0&&(i=this.getIndex_(0),d[c++]=i,d[c++]=this.getIndex_(1));for(var e=2;e<a+2;++e){var f=this.getIndex_(e);d[c++]=i,d[c++]=f,d[c++]=f,d[c++]=this.getIndex_(e-1)}this.wireframeIndexBuffer_.unlock();break;case o3d.Primitive.TRIANGLESTRIP:var d=this.wireframeIndexBuffer_.array_;this.wireframeIndexBuffer_.lock();var f,g;a>0&&(f=this.getIndex_(0),g=this.getIndex_(1),d[c++]=f,d[c++]=g);for(var e=2;e<a+2;++e){var h=this.getIndex_(e);d[c++]=g,d[c++]=h,d[c++]=h,d[c++]=f,f=g,g=h}this.wireframeIndexBuffer_.unlock()}},o3d.Primitive.prototype.computeTriangleIndices_=function(a){var b;switch(this.primitiveType){case o3d.Primitive.TRIANGLESTRIP:a%2==0?b=[a,a+1,a+2]:b=[a+1,a,a+2];break;case o3d.Primitive.TRIANGLEFAN:b=[0,a+1,a+2];break;case o3d.Primitive.TRIANGLELIST:default:b=[3*a,3*a+1,3*a+2]}if(this.indexBuffer){var c=this.indexBuffer.array_;return[c[b[0]],c[b[1]],c[b[2]]]}return b},o3d.Primitive.prototype.intersectRay=function(a,b,c,d){var e=new o3d.RayIntersectionInfo;e.valid=!0;var f=this.streamBank,g=this.indexBuffer,h=this.streamBank.vertex_streams_[o3d.Stream.POSITION],i=h[a].stream,j=i.field,k=j.buffer,l=k.array_.length/k.totalComponents,m=j.getAt(0,l),n=d[0]-c[0],o=d[1]-c[1],p=d[2]-c[2],q=[n,o,p],r=-o,s=n,t=0;n*n+o*o<p*p&&(r=-p,s=0,t=n);var u=o*t-p*s,v=p*r-n*t,w=n*s-o*r,x=r*c[0]+s*c[1]+t*c[2],y=u*c[0]+v*c[1]+w*c[2],z=0,A=g?g.array_.length:l;switch(this.primitiveType){case o3d.Primitive.TRIANGLESTRIP:numTriangles=A-2;break;case o3d.Primitive.TRIANGLEFAN:numTriangles=A-2;break;case o3d.Primitive.TRIANGLELIST:default:numTriangles=A/3}for(var B=0;B<numTriangles;++B){var C=this.computeTriangleIndices_(B),D=[!1,!1,!1],E=[!1,!1,!1];for(var F=0;F<3;++F){var G=3*C[F],H=m.slice(G,G+3);D[F]=r*H[0]+s*H[1]+t*H[2]-x>0,E[F]=u*H[0]+v*H[1]+w*H[2]-y>0}if(D[0]==D[1]&&D[0]==D[2]||E[0]==E[1]&&E[0]==E[2])continue;var G;G=3*C[0];var I=m[G]-c[0],J=m[G+1]-c[1],K=m[G+2]-c[2];G=3*C[1];var L=m[G]-c[0],M=m[G+1]-c[1],N=m[G+2]-c[2];G=3*C[2];var O=m[G]-c[0],P=m[G+1]-c[1],Q=m[G+2]-c[2],R=M*Q-N*P,S=J*Q-K*P,T=J*N-K*M,U=I*R-L*S+O*T;if(b==o3d.State.CULL_CW&&U<0||b==o3d.State.CULL_CCW&&U>0)continue;var V=(R*n-(L*Q-N*O)*o+(L*P-M*O)*p)/U,W=(-S*n+(I*Q-K*O)*o-(I*P-J*O)*p)/U,X=(T*n-(I*N-K*L)*o+(I*M-J*L)*p)/U;if(V>=0&&W>=0&&X>=0&&V+W+X>0){var Y=V+W+X;V/=Y,W/=Y,X/=Y;var Z=I*V+L*W+O*X,$=J*V+M*W+P*X,_=K*V+N*W+Q*X,ba=Z*Z+$*$+_*_;if(!e.intersected||ba<z)z=ba,e.position[0]=Z+c[0],e.position[1]=$+c[1],e.position[2]=_+c[2],e.primitiveIndex=B;e.intersected=!0}}return e},o3d.Primitive.prototype.getBoundingBox=function(a){var b=this.streamBank,c=this.indexBuffer,d=this.streamBank.getVertexStream(o3d.Stream.POSITION,a),e=[],f=d.field,g=f.buffer,h=g.array_.length/g.totalComponents,i=f.getAt(0,h);for(var j=0;j<h;++j){var k=[0,0,0];for(var l=0;l<f.numComponents;++l)k[l]=i[f.numComponents*j+l];e.push(k)}o3d.BoundingBox.fitBoxToPoints_(e,this.boundingBox);return this.boundingBox},o3d.Shape=function(){o3d.ParamObject.call(this),this.elements=[]},o3d.inherit("Shape","ParamObject"),o3d.Shape.prototype.elements=[],o3d.Shape.findDrawElementWithMaterial_=function(a,b){for(var c=0;c<a.length;++c)if(a[c].material==b)return a[c];return null},o3d.Shape.prototype.createDrawElements=function(a,b){var c=this.elements;for(var d=0;d<c.length;++d){var e=c[d];o3d.Shape.findDrawElementWithMaterial_(e.drawElements,b)||e.createDrawElement(a,b)}},o3d.Shape.prototype.addElement=function(a){this.elements.push(a)},o3d.Shape.prototype.removeElement=function(a){o3d.removeFromArray(this.elements,a)},o3d.Shape.prototype.writeToDrawLists=function(a,b,c){var d=this.elements;for(var e=0;e<d.length;++e){var f=d[e];for(var g=0;g<f.drawElements.length;++g){this.gl.client.render_stats_.drawElementsProcessed++;var h=f.drawElements[g],i=h.material||h.owner.material,j=i.drawList,k=!1;for(var l=0;l<a.length;++l){var m=a[l],n=m.list;if(j==n){var o=m.context,p=o.view,q=o.projection,r=[[],[],[],[]],s=[[],[],[],[]];o3d.Transform.compose(q,p,s),o3d.Transform.compose(s,b,r);if(f.cull&&f.boundingBox&&!f.boundingBox.inFrustum(r))continue;k=!0,n.list_.push({view:p,projection:q,world:b,viewProjection:s,worldViewProjection:r,transform:c,drawElement:h})}}k?this.gl.client.render_stats_.drawElementsRendered++:this.gl.client.render_stats_.drawElementsCulled++}}},o3d.Shape.prototype.getBoundingBox=function(a){var b=this.elements,c=new o3d.BoundingBox;for(var d=0,e=b.length;d<e;++d){var f=b[d],g=f.boundingBox;if(a||!g.valid)g=f.getBoundingBox(0);c.valid?c=c.add(g):c=g}return c},o3d.EffectParameterInfo=function(a,b,c,d,e){this.name=a||"",this.className=b||"",this.numElements=c||0,this.semantic=d||"",this.sasClassName=e||""},o3d.inherit("EffectParameterInfo","NamedObject"),o3d.EffectStreamInfo=function(a,b){o3d.NamedObject.call(this),a||(a=o3d.Stream.UNKNOWN_SEMANTIC),b||(b=0),this.semantic=a,this.opt_semantic_index=b},o3d.inherit("EffectStreamInfo","NamedObject"),o3d.EffectStreamInfo.prototype.semantic=o3d.Stream.UNKNOWN_SEMANTIC,o3d.EffectStreamInfo.prototype.semanticIndex=0,o3d.Effect=function(){o3d.ParamObject.call(this),this.program_=null,this.uniforms_={},this.attributes_={}},o3d.inherit("Effect","ParamObject"),o3d.Effect.HELPER_CONSTANT_NAME="dx_clipping",o3d.Effect.prototype.uniforms_={},o3d.Effect.prototype.attributes_={},o3d.Effect.prototype.vertexShaderLoaded_=!1,o3d.Effect.prototype.fragmentShaderLoaded_=!1,o3d.Effect.prototype.bindAttributesAndLinkIfReady=function(){if(this.vertexShaderLoaded_&&this.fragmentShaderLoaded_){var a=o3d.Effect.semanticMap_;for(var b in a)this.gl.bindAttribLocation(this.program_,a[b].gl_index,b);this.gl.linkProgram(this.program_);if(!this.gl.getProgramParameter(this.program_,this.gl.LINK_STATUS)){var c=this.gl.getShaderInfoLog(this.program_);this.gl.client.error_callback("Program link failed with error log:\n"+c)}this.getUniforms_(),this.getAttributes_()}},o3d.Effect.prototype.loadShaderFromString=function(a,b){this.program_||(this.program_=this.gl.createProgram());var c=!0,d=this.gl.createShader(b);this.gl.shaderSource(d,"#ifdef GL_ES\nprecision highp float;\n#endif\n"+a),this.gl.compileShader(d);if(!this.gl.getShaderParameter(d,this.gl.COMPILE_STATUS)){c=!1;var e=this.gl.getShaderInfoLog(d);this.gl.client.error_callback("Shader compile failed with error log:\n"+e)}this.gl.attachShader(this.program_,d);return c},o3d.Effect.prototype.loadVertexShaderFromString=function(a){var b=this.loadShaderFromString(a,this.gl.VERTEX_SHADER);this.vertexShaderLoaded_=b,this.bindAttributesAndLinkIfReady();return b},o3d.Effect.prototype.loadPixelShaderFromString=function(a){var b=this.loadShaderFromString(a,this.gl.FRAGMENT_SHADER);this.fragmentShaderLoaded_=b,this.bindAttributesAndLinkIfReady();return b},o3d.Effect.prototype.loadFromFXString=function(a){var b=a.indexOf("// #o3d SplitMarker");return this.loadVertexShaderFromString(a.substr(0,b))&&this.loadPixelShaderFromString(a.substr(b))},o3d.Effect.prototype.getParamArrayNames_=function(a,b){var c=[];for(var d=0;d<b;d++)c[d]=a+"["+d+"]";return c},o3d.Effect.prototype.getUniforms_=function(){this.uniforms_={};var a=this.gl.getProgramParameter(this.program_,this.gl.ACTIVE_UNIFORMS);for(var b=0;b<a;++b){var c=this.gl.getActiveUniform(this.program_,b),d=c.name;if(d.indexOf("[")!=-1){var e=c.name.substring(0,c.name.indexOf("[")),f=this.getParamArrayNames_(e,c.size),g=[];for(var h=0;h<f.length;h++)g[h]=this.gl.getUniformLocation(this.program_,f[h]);this.uniforms_[e]={info:{name:e,size:c.size,type:c.type},kind:o3d.Effect.ARRAY,locations:g}}else this.uniforms_[d]={info:c,kind:o3d.Effect.ELEMENT,location:this.gl.getUniformLocation(this.program_,d)}}},o3d.Effect.prototype.getAttributes_=function(){this.attributes_={};var a=this.gl.getProgramParameter(this.program_,this.gl.ACTIVE_ATTRIBUTES);for(var b=0;b<a;++b){var c=this.gl.getActiveAttrib(this.program_,b);this.attributes_[c.name]={info:c,location:this.gl.getAttribLocation(this.program_,c.name)}}},o3d.Effect.paramTypes_=null,o3d.Effect.getParamTypes_=function(a){o3d.Effect.paramTypes_||(o3d.Effect.paramTypes_={},o3d.Effect.paramTypes_[a.FLOAT]="ParamFloat",o3d.Effect.paramTypes_[a.FLOAT_VEC2]="ParamFloat2",o3d.Effect.paramTypes_[a.FLOAT_VEC3]="ParamFloat3",o3d.Effect.paramTypes_[a.FLOAT_VEC4]="ParamFloat4",o3d.Effect.paramTypes_[a.INT]="ParamInteger",o3d.Effect.paramTypes_[a.BOOL]="ParamBoolean",o3d.Effect.paramTypes_[a.FLOAT_MAT4]="ParamMatrix4",o3d.Effect.paramTypes_[a.SAMPLER_2D]="ParamSampler",o3d.Effect.paramTypes_[a.SAMPLER_CUBE]="ParamSampler");return o3d.Effect.paramTypes_},o3d.Effect.semanticMap_={position:{semantic:o3d.Stream.POSITION,index:0,gl_index:0},normal:{semantic:o3d.Stream.NORMAL,index:0,gl_index:1},tangent:{semantic:o3d.Stream.TANGENT,index:0,gl_index:2},binormal:{semantic:o3d.Stream.BINORMAL,index:0,gl_index:3},color:{semantic:o3d.Stream.COLOR,index:0,gl_index:4},texCoord0:{semantic:o3d.Stream.TEXCOORD,index:0,gl_index:5},texCoord1:{semantic:o3d.Stream.TEXCOORD,index:1,gl_index:6},texCoord2:{semantic:o3d.Stream.TEXCOORD,index:2,gl_index:7},texCoord3:{semantic:o3d.Stream.TEXCOORD,index:3,gl_index:8},texCoord4:{semantic:o3d.Stream.TEXCOORD,index:4,gl_index:9},texCoord5:{semantic:o3d.Stream.TEXCOORD,index:5,gl_index:10},texCoord6:{semantic:o3d.Stream.TEXCOORD,index:6,gl_index:11},texCoord7:{semantic:o3d.Stream.TEXCOORD,index:7,gl_index:12},influenceWeights:{semantic:o3d.Stream.INFLUENCE_WEIGHTS,index:0,gl_index:13},influenceIndices:{semantic:o3d.Stream.INFLUENCE_INDICES,index:0,gl_index:14}},o3d.Effect.reverseSemanticMap_=[],function(){var a=o3d.Effect.reverseSemanticMap_;for(var b in o3d.Effect.semanticMap_){var c=o3d.Effect.semanticMap_[b];a[c.semantic]=a[c.semantic]||[],a[c.semantic][c.index]=c.gl_index}}(),o3d.Effect.prototype.createUniformParameters=function(a){var b=o3d.Param.sasTypes_,c=o3d.Effect.getParamTypes_(this.gl);for(var d in this.uniforms_){var e=this.uniforms_[d];if(!b[d])switch(e.kind){case o3d.Effect.ARRAY:var f=a.createParam(d,"ParamParamArray"),g=new o3d.ParamArray;g.gl=this.gl,g.resize(e.info.size,c[e.info.type]),f.value=g;break;case o3d.Effect.STRUCT:o3d.notImplemented();break;case o3d.Effect.ELEMENT:default:a.createParam(d,c[e.info.type])}}},o3d.Effect.prototype.createSASParameters=function(a){var b=o3d.Param.sasTypes_;for(var c in this.uniforms_){var d=this.uniforms_[c].info,e=b[c];e&&a.createParam(d.name,e)}},o3d.Effect.prototype.getParameterInfo=function(){var a=[],b=o3d.Param.sasTypes_,c=o3d.Effect.semanticMap_,d=o3d.Effect.getParamTypes_(this.gl);for(var e in this.uniforms_){var f=this.uniforms_[e],g=b[e]||"",h=d[f.info.type]||"",i=f.kind==o3d.Effect.ARRAY?f.info.size:0,j=c[e]?e:"";a.push(new o3d.EffectParameterInfo(e,h,i,j.toUpperCase(),g))}return a},o3d.Effect.prototype.getStreamInfo=function(){var a=[];for(var b in this.attributes_){var c=o3d.Effect.semanticMap_[b];a.push(new o3d.EffectStreamInfo(c.semantic,c.index))}return a},o3d.Effect.prototype.searchForParams_=function(a){var b={};for(var c in this.uniforms_)b[c]=!0;this.gl.useProgram(this.program_),o3d.Param.texture_index_=0;var d=a.length;for(var e=0;e<d;++e){var f=a[e];for(var g in this.uniforms_)if(b[g]){var h=this.uniforms_[g],i=f.getParam(g);i&&(h.kind==o3d.Effect.ARRAY?i.applyToLocations(this.gl,h.locations):i.applyToLocation(this.gl,h.location),delete b[g])}}this.updateHelperConstants_(this.gl.displayInfo.width,this.gl.displayInfo.height),delete b[o3d.Effect.HELPER_CONSTANT_NAME];for(var g in b){if(this.uniforms_[g].info.type!=this.gl.SAMPLER_2D)throw'Uniform param not filled: "'+g+'"';this.gl.client.reportErrors_()&&this.gl.client.error_callback("Missing ParamSampler");var j=o3d.ParamSampler.defaultParamSampler_;j.gl=this.gl,j.applyToLocation(this.gl,this.uniforms_[g].location)}},o3d.Effect.prototype.updateHelperConstants_=function(a,b){var c=this.uniforms_[o3d.Effect.HELPER_CONSTANT_NAME],d=[0,0,0,0];c&&(d[0]=1/a,d[1]=-1/b,d[2]=2,this.gl.currentRenderSurfaceSet?d[3]=-1:d[3]=1,this.gl.uniform4f(c.location,d[0],d[1],d[2],d[3]))},o3d.Effect.MatrixLoadOrder=goog.typedef,o3d.Effect.ROW_MAJOR=0,o3d.Effect.COLUMN_MAJOR=1,o3d.Effect.ELEMENT=0,o3d.Effect.ARRAY=1,o3d.Effect.STRUCT=2,o3d.Effect.prototype.matrix_load_order_=o3d.Effect.ROW_MAJOR,o3d.Effect.prototype.source_="",o3d.Material=function(a,b,c){o3d.ParamObject.call(this),this.state=a||null,this.effect=b||null,this.drawList=c||null},o3d.inherit("Material","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Material,"effect","ParamEffect"),o3d.ParamObject.setUpO3DParam_(o3d.Material,"state","ParamState"),o3d.ParamObject.setUpO3DParam_(o3d.Material,"drawList","ParamDrawList"),this.JSON||(this.JSON={}),function(){function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(a)),typeof rep=="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g;return e}if(rep&&typeof rep=="object"){f=rep.length;for(c=0;c<f;c+=1)d=rep[c],typeof d=="string"&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g;return e}}function quote(a){escapable.lastIndex=0;return escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function f(a){return a<10?"0"+a:a}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c=="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c=="string"&&(indent=c);rep=b;if(!b||typeof b=="function"||typeof b=="object"&&typeof b.length=="number")return str("",{"":a});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver=="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")})}(),o3d.ArchiveRequest=function(){o3d.ObjectBase.call(this),this.method_=null,this.listeners=[]},o3d.inherit("ArchiveRequest","ObjectBase"),o3d.ArchiveRequest.prototype.uri="",o3d.ArchiveRequest.prototype.open=function(a,b){this.uri=b;var c=b,d=b.lastIndexOf("/");d!=-1&&(c=c.substring(0,d+1)),this.parentURI_=c},o3d.ArchiveRequest.prototype.send=function(){var a=this;this.done=!1,this.success=!0,this.error=null;var b=function(b){var c=a.listeners;for(var d=0,e=c.length;d<e;d++)c.onProgressUpdate?c[d].onProgressUpdate(b):c[d](b)},c=function(c,d){if(d!=null)a.pendingRequests_=1,a.resolvePendingRequest_(null,d);else{var e=JSON.stringify(JSON.parse(c)),f=new o3d.RawData;f.uri="scene.json",f.stringValue=e;var g=/\"([^\"]*\.(fx|png|jpg))\"/g,h,i=[];while((h=g.exec(c))!=null)i.push(h[1]);a.pendingRequests_=i.length+1;var j=function(c){var d=function(b,d){var e=null;d==null&&(e=new o3d.RawData,e.uri=c,e.stringValue=b),a.resolvePendingRequest_(e,d)};o3djs.io.loadTextFile(a.relativeToAbsoluteURI_(c),d,b)},k=function(b){var c=new Image;c.onload=function(){var e=new o3d.RawData;e.uri=b,e.image_=c,a.resolvePendingRequest_(e,d)},c.onerror=function(){a.resolvePendingRequest_(null,d)},c.src=a.relativeToAbsoluteURI_(b)};for(var l=0;l<i.length;++l)a.stringEndsWith_(i[l],".fx")?j(i[l]):(a.stringEndsWith_(i[l],".png")||a.stringEndsWith_(i[l],".jpg"))&&k(i[l]);a.resolvePendingRequest_(f)}};o3djs.io.loadTextFile(this.uri,c,b)},o3d.ArchiveRequest.prototype.onreadystatechange=null,o3d.ArchiveRequest.prototype.addProgressListener=function(a){this.listeners.push(a)},o3d.ArchiveRequest.prototype.onfileavailable=null,o3d.ArchiveRequest.prototype.relativeToAbsoluteURI_=function(a){return this.parentURI_+a},o3d.ArchiveRequest.prototype.stringEndsWith_=function(a,b){return a.substring(a.length-b.length)==b},o3d.ArchiveRequest.prototype.resolvePendingRequest_=function(a,b){this.success=this.success&&a&&!b,b!=null&&(this.error=""+b),a&&this.onfileavailable&&this.onfileavailable(a),--this.pendingRequests_==0&&(this.done=!0,this.onreadystatechange&&this.onreadystatechange())},o3d.ParamFloatOutput=function(){o3d.ParamFloat.call(this)},o3d.inherit("ParamFloatOutput","ParamFloat"),o3d.ParamFloatOutput.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()}),o3d.ParamFloatOutput.prototype.__defineSetter__("value",function(a){}),o3d.ParamFloat2Output=function(){o3d.ParamFloat2.call(this)},o3d.inherit("ParamFloat2Output","ParamFloat2"),o3d.ParamFloat2Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()}),o3d.ParamFloat2Output.prototype.__defineSetter__("value",function(a){}),o3d.ParamFloat3Output=function(){o3d.ParamFloat3.call(this)},o3d.inherit("ParamFloat3Output","ParamFloat3"),o3d.ParamFloat3Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()}),o3d.ParamFloat3Output.prototype.__defineSetter__("value",function(a){}),o3d.ParamFloat4Output=function(){o3d.ParamFloat4.call(this)},o3d.inherit("ParamFloat4Output","ParamFloat4"),o3d.ParamFloat4Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()}),o3d.ParamFloat4Output.prototype.__defineSetter__("value",function(a){}),o3d.ParamMatrix4Output=function(){o3d.ParamMatrix4.call(this)},o3d.inherit("ParamMatrix4Output","ParamMatrix4"),o3d.ParamMatrix4Output.prototype.__defineGetter__("value",function(){return this.owner_.updateOutputs()}),o3d.ParamMatrix4Output.prototype.__defineSetter__("value",function(a){}),o3d.ParamOp2FloatsToFloat2=function(){o3d.ParamObject.call(this),this.last_output_value_=[0,0]},o3d.inherit("ParamOp2FloatsToFloat2","ParamObject"),function(){for(var a=0;a<2;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp2FloatsToFloat2,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp2FloatsToFloat2,"output","ParamMatrix4Output")}(),o3d.ParamOp2FloatsToFloat2.prototype.updateOutputs=function(){this.last_output_value_[0]=this.getParam("input0").value,this.last_output_value_[1]=this.getParam("input1").value;return this.last_output_value_},o3d.ParamOp3FloatsToFloat3=function(){o3d.ParamObject.call(this),this.last_output_value_=[0,0,0]},o3d.inherit("ParamOp3FloatsToFloat3","ParamObject"),function(){for(var a=0;a<3;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp3FloatsToFloat3,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp3FloatsToFloat3,"output","ParamMatrix4Output")}(),o3d.ParamOp3FloatsToFloat3.prototype.updateOutputs=function(){this.last_output_value_[0]=this.getParam("input0").value,this.last_output_value_[1]=this.getParam("input1").value,this.last_output_value_[2]=this.getParam("input2").value;return this.last_output_value_},o3d.ParamOp4FloatsToFloat4=function(){o3d.ParamObject.call(this),this.last_output_value_=[0,0,0,0]},o3d.inherit("ParamOp4FloatsToFloat4","ParamObject"),function(){for(var a=0;a<4;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp4FloatsToFloat4,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp4FloatsToFloat4,"output","ParamMatrix4Output")}(),o3d.ParamOp4FloatsToFloat4.prototype.updateOutputs=function(){this.last_output_value_[0]=this.getParam("input0").value,this.last_output_value_[1]=this.getParam("input1").value,this.last_output_value_[2]=this.getParam("input2").value,this.last_output_value_[3]=this.getParam("input3").value;return this.last_output_value_},o3d.ParamOp16FloatsToMatrix4=function(){o3d.ParamObject.call(this),this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("ParamOp16FloatsToMatrix4","ParamObject"),function(){for(var a=0;a<16;a++)o3d.ParamObject.setUpO3DParam_(o3d.ParamOp16FloatsToMatrix4,"input"+a,"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.ParamOp16FloatsToMatrix4,"output","ParamMatrix4Output")}(),o3d.ParamOp16FloatsToMatrix4.prototype.updateOutputs=function(){for(var a=0;a<16;a++)this.last_output_value_[Math.floor(a/4)][a%4]=this.getParam("input"+a).value;return this.last_output_value_},o3d.TRSToMatrix4=function(){o3d.ParamObject.call(this),this.rotateX=0,this.rotateY=0,this.rotateZ=0,this.translateX=0,this.translateY=0,this.translateZ=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("TRSToMatrix4","ParamObject"),function(){var a=["rotateX","rotateY","rotateZ","translateX","translateY","translateZ","scaleX","scaleY","scaleZ"];for(var b=0;b<a.length;b++)o3d.ParamObject.setUpO3DParam_(o3d.TRSToMatrix4,a[b],"ParamFloat");o3d.ParamObject.setUpO3DParam_(o3d.TRSToMatrix4,"output","ParamMatrix4Output")}(),o3d.TRSToMatrix4.prototype.updateOutputs=function(){var a=this.last_output_value_,b=this.rotateX,c=this.rotateY,d=this.rotateZ,e=this.scaleX,f=this.scaleY,g=this.scaleZ,h=Math.sin(b),i=Math.cos(b),j=Math.sin(c),k=Math.cos(c),l=Math.sin(d),m=Math.cos(d),n=m*j,o=l*j;a[0].splice(0,4,m*k*e,l*k*e,-j*e,0),a[1].splice(0,4,(n*h-l*i)*f,(o*h+m*i)*f,k*h*f,0),a[2].splice(0,4,(n*i+l*h)*g,(o*i-m*h)*g,k*i*g,0),a[3].splice(0,4,this.translateX,this.translateY,this.translateZ,1);return a},o3d.Matrix4Composition=function(){o3d.ParamObject.call(this),this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("Matrix4Composition","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Composition,"inputMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Composition,"localMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Composition,"outputMatrix","ParamMatrix4Output"),o3d.Matrix4Composition.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.getParam("localMatrix").value;o3d.Transform.compose(a,b,this.last_output_value_);return this.last_output_value_},o3d.Matrix4AxisRotation=function(){o3d.ParamObject.call(this),this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("Matrix4AxisRotation","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"inputMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"axis","ParamFloat3"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"angle","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4AxisRotation,"outputMatrix","ParamMatrix4Output"),o3d.Matrix4AxisRotation.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.getParam("axis").value,c=this.getParam("angle").value;o3d.Transform.axisRotateMatrix(a,b,c,this.last_output_value_);return this.last_output_value_},o3d.Matrix4Scale=function(){o3d.ParamObject.call(this),this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("Matrix4Scale","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Scale,"inputMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Scale,"scale","ParamFloat3"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Scale,"outputMatrix","ParamMatrix4Output"),o3d.Matrix4Scale.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.last_output_value_,c=this.getParam("scale").value,d=c[0],e=c[1],f=c[2],g=a[0],h=a[1],i=a[2],j=a[3];b[0].splice(0,4,d*g[0],d*g[1],d*g[2],d*g[3]),b[1].splice(0,4,e*h[0],e*h[1],e*h[2],e*h[3]),b[2].splice(0,4,f*i[0],f*i[1],f*i[2],f*i[3]),b[3]=j.slice(0);return b},o3d.Matrix4Translation=function(){o3d.ParamObject.call(this),this.last_output_value_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3d.inherit("Matrix4Translation","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Translation,"inputMatrix","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Translation,"translation","ParamFloat3"),o3d.ParamObject.setUpO3DParam_(o3d.Matrix4Translation,"outputMatrix","ParamMatrix4Output"),o3d.Matrix4Translation.prototype.updateOutputs=function(){var a=this.getParam("inputMatrix").value,b=this.last_output_value_,c=this.getParam("translation").value,d=c[0],e=c[1],f=c[2],g=a[0],h=a[1],i=a[2],j=a[3];b[0]=g.slice(0),b[1]=h.slice(0),b[2]=i.slice(0),b[3].splice(0,4,g[0]*d+h[0]*e+i[0]*f+j[0],g[1]*d+h[1]*e+i[1]*f+j[1],g[2]*d+h[2]*e+i[2]*f+j[2],g[3]*d+h[3]*e+i[3]*f+j[3]);return b},o3d.Function=function(a){o3d.NamedObject.call(this),this.func_=a},o3d.inherit("Function","NamedObject"),o3d.Function.prototype.evaluate=function(a,b){this.func_.call(this,a,b)},o3d.FunctionEval=function(){o3d.ParamObject.call(this),this.input_param_=this.getParam("input"),this.func_param_=this.getParam("functionObject"),this.output_param_=this.getParam("output"),this.func_context_={},this.last_input_value_=null,this.last_output_value_=null},o3d.inherit("FunctionEval","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.FunctionEval,"output","ParamFloatOutput"),o3d.ParamObject.setUpO3DParam_(o3d.FunctionEval,"input","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.FunctionEval,"functionObject","ParamFunction"),o3d.FunctionEval.prototype.updateOutputs=function(){var a=this.input_param_.value;this.last_input_value_!=a&&(this.last_output_value_=this.func_param_.value.evaluate(this.last_input_value_,this.func_context_),this.last_input_value_=a);return this.last_output_value_},o3d.CounterManager=function(){this.counterMap_={}},o3d.CounterManager.prototype.lastUpdated=null,o3d.CounterManager.prototype.advanceCounters=function(a,b){var c=this.counterMap_[a];if(!!c){var d=c.length,e=[];for(var f=0;f<d;f++)e[f]=c[f];for(var f=0;f<d;++f)e[f].running&&e[f].advance(b)}},o3d.CounterManager.prototype.tick=function(){this.advanceCounters("TickCounter",1);var a=new Date,b=0;this.lastUpdated!=null&&(b=(a-this.lastUpdated)/1e3),this.lastUpdated=a,this.advanceCounters("SecondCounter",b)},o3d.CounterManager.prototype.advanceRenderFrameCounters=function(){this.advanceCounters("RenderFrameCounter",1)},o3d.CounterManager.prototype.registerCounter=function(a){var b=a.counter_type_,c=this.counterMap_[b];c||(c=this.counterMap_[b]=[]),c.push(a)},o3d.CounterManager.prototype.unregisterCounter=function(a){var b=a.counter_type_,c=this.counterMap_[b];c&&o3d.removeFromArray(c,a)},o3d.Counter=function(){o3d.ParamObject.call(this),this.next_callback_=-1,this.prev_callback_=-1,this.old_count_=0,this.last_call_callbacks_end_count_=0,this.callbacks_=[],this.counter_manager_=null,this.running_param_=this.createParam("running","ParamBoolean"),this.count_param_=this.createParam("count","ParamFloat"),this.multiplier=1,this.forward=!0,this.countMode=o3d.Counter.CONTINUOUS},o3d.inherit("Counter","ParamObject"),o3d.ParamObject.setUpO3DParam_(o3d.Counter,"forward","ParamBoolean"),o3d.ParamObject.setUpO3DParam_(o3d.Counter,"start","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.Counter,"end","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.Counter,"countMode","ParamInteger"),o3d.ParamObject.setUpO3DParam_(o3d.Counter,"multiplier","ParamFloat"),o3d.Counter.prototype.__defineSetter__("running",function(a){var b=this.running_param_.value;this.counter_manager_&&b!=a&&(a==!1?this.counter_manager_.unregisterCounter(this):this.counter_manager_.registerCounter(this)),this.running_param_.value=a}),o3d.Counter.prototype.__defineGetter__("running",function(){return this.running_param_.value}),o3d.Counter.prototype.__defineSetter__("count",function(a){this.setCount(a)}),o3d.Counter.prototype.__defineGetter__("count",function(){return this.count_param_.value}),o3d.Counter.prototype.__defineSetter__("gl",function(a){var b=this.running;this.running=!1,this.gl_=a,this.gl_&&this.gl_.client&&(this.counter_manager_=this.gl_.client.counter_manager_),this.running=b}),o3d.Counter.prototype.__defineGetter__("gl",function(){return this.gl_}),o3d.Counter.CountMode=goog.typedef,o3d.Counter.CONTINUOUS=0,o3d.Counter.ONCE=1,o3d.Counter.CYCLE=2,o3d.Counter.OSCILLATE=3,o3d.Counter.prototype.counter_type_="Counter",o3d.Counter.prototype.reset=function(){this.setCount(this.forward?this.start:this.end)},o3d.Counter.prototype.setCount=function(a){this.count_param_.value=a,this.old_count_=a,this.next_callback_=-1,this.prev_callback_=-1},o3d.Counter.prototype.advance=function(a){var b=[],c=this.count_param_.value;if(this.count_param_.inputConnection)this.callCallbacks_(this.old_count_,c,b);else{var d=this.forward,e=this.start,f=this.end,g=this.multiplier,h=(d?a:-a)*g,i=f-e,j=this.countMode;if(i>=0){var k=c+h;if(h>=0){switch(j){case o3d.Counter.ONCE:k>=f&&(k=f,this.running=!1);break;case o3d.Counter.CYCLE:while(k>=f){this.callCallbacks_(c,f,b);if(i==0)break;c=e,k-=i}break;case o3d.Counter.OSCILLATE:while(h>0){k=c+h;if(k<f)break;this.callCallbacks_(c,f,b),d=!d;var l=f-c;h-=l,c=f,k=f;if(h<=0||i==0)break;k-=h;if(k>e)break;this.callCallbacks_(c,e,b),d=!d,l=c-e,h-=l,c=e,k=e}this.forward=d;break;case o3d.Counter.CONTINUOUS:default:}this.callCallbacks_(c,k,b),this.count_param_.value=k}else if(h<0){switch(j){case o3d.Counter.ONCE:k<=e&&(k=e,this.running=!1);break;case o3d.Counter.CYCLE:while(k<=e){this.callCallbacks_(c,e,b);if(i==0)break;c=f,k+=i}break;case o3d.Counter.OSCILLATE:while(h<0){k=c+h;if(k>e)break;this.callCallbacks_(c,e,b),d=!d;var l=c-e;h+=l,c=e,k=e;if(h>=0||i==0)break;k-=h;if(k<f)break;this.callCallbacks_(c,f,b),d=!d,l=f-c,h+=l,c=f,k=f}this.forward=d;break;case o3d.Counter.CONTINUOUS:default:}this.callCallbacks_(c,k,b),this.count_param_.value=k}}else if(i<0){i=-i;var k=c-h;if(h>0){switch(j){case o3d.Counter.ONCE:k<=f&&(k=f,this.running=!1);break;case o3d.Counter.CYCLE:while(k<=f)this.callCallbacks_(c,f,b),c=e,k+=i;break;case o3d.Counter.OSCILLATE:while(h>0){k=c-h;if(k>f)break;this.callCallbacks_(c,f,b),d=!d;var l=c-f;h-=l,c=f,k=f;if(h<=0)break;k+=h;if(k<e)break;this.callCallbacks_(c,e,b),d=!d,l=e-c,h-=l,c=e,k=e}this.forward=d;break;case o3d.Counter.CONTINUOUS:default:}this.callCallbacks_(c,k,b),this.count_param_.value=k}else if(h<0){switch(j){case o3d.Counter.ONCE:k>=e&&(k=e,this.running=!1);break;case o3d.Counter.CYCLE:while(k>=e)this.callCallbacks_(c,e,b),c=f,k-=i;break;case o3d.Counter.OSCILLATE:while(h<0){k=c-h;if(k<e)break;this.callCallbacks_(c,e,b),d=!d;var l=e-c;h+=l,c=e,k=e;if(h>=0)break;k+=h;if(k>f)break;this.callCallbacks_(c,f,b),d=!d,l=c-f,h+=l,c=f,k=f}this.forward=d;break;case o3d.Counter.CONTINUOUS:default:}this.callCallbacks_(c,k,b),this.count_param_.value=k}}}this.old_count_=c;for(var m=0;m<b.length;m++)b[m]()},o3d.Counter.prototype.callCallbacks_=function(a,b,c){if(b>a){if(this.next_callback_<0||a!=this.last_call_callbacks_end_count_){this.next_callback_=0;while(this.next_callback_!=this.callbacks_.length&&this.callbacks_[this.next_callback_].count<a)++this.next_callback_}while(this.next_callback_<this.callbacks_.length){if(this.callbacks_[this.next_callback_].count>b)break;c.push(this.callbacks_[this.next_callback_].callback),++this.next_callback_}this.prev_callback_=-1,this.last_call_callbacks_end_count_=b}else if(b<a){if(this.prev_callback_<0||a!=this.last_call_callbacks_end_count_){this.prev_callback_=this.callbacks_.length-1;while(this.prev_callback_>=0&&this.callbacks_[this.prev_callback_].count>a)--this.prev_callback_}while(this.prev_callback_>=0){if(this.callbacks_[this.prev_callback_].count<b)break;c.push(this.callbacks_[this.prev_callback_].callback),--this.prev_callback_}this.next_callback_=-1,this.last_call_callbacks_end_count_=b}},o3d.Counter.prototype.addCallback=function(a,b){this.next_callback_=-1,this.prev_callback_=-1;var c=this.callbacks_.length,d=0;while(d!=c){var e=this.callbacks_[d];if(e.count==a){e.callback=b;return}if(e.count>a)break;++d}var f=this.callbacks_.splice(d,this.callbacks_.length-d);this.callbacks_.push(new o3d.Counter.CallbackInfo(a,b)),this.callbacks_.push.apply(this.callbacks_,f)},o3d.Counter.prototype.removeCallback=function(a){var b=this.callbacks_.length;for(var c=0;c!=b;++c)if(this.callbacks_[c].count==a){this.next_callback_=-1,this.prev_callback_=-1,this.callbacks_.splice(c,1);return!0}return!1},o3d.Counter.prototype.removeAllCallbacks=function(){this.callbacks_=[],this.next_callback_=-1,this.prev_callback_=-1},o3d.Counter.CallbackInfo=function(a,b){this.count=a,this.callback=b,this.called_=!1},o3d.Counter.CallbackInfo.prototype.run=function(){this.called_||(this.called_=!0,this.callback(),this.called_=!1)},o3d.SecondCounter=function(){o3d.Counter.call(this),this.running=!0},o3d.inherit("SecondCounter","Counter"),o3d.SecondCounter.prototype.counter_type_="SecondCounter",o3d.RenderFrameCounter=function(){o3d.Counter.call(this),this.running=!0},o3d.inherit("RenderFrameCounter","Counter"),o3d.RenderFrameCounter.prototype.counter_type_="RenderFrameCounter",o3d.TickCounter=function(){o3d.Counter.call(this),this.running=!0},o3d.inherit("TickCounter","Counter"),o3d.TickCounter.prototype.counter_type_="TickCounter",o3d.CurveKey=function(a){o3d.ObjectBase.call(this),this.owner_=a,this.input_=0,this.output_=0},o3d.inherit("CurveKey","ObjectBase"),o3d.CurveKey.prototype.destroy=function(){o3d.removeFromArray(this.owner_.keys,this),this.owner_.invalidateCache_()},o3d.CurveKey.prototype.getOutputAtOffset=function(a,b){var c=b.input-this.input,d=b.output-this.output;return this.output+a/c*d},o3d.CurveKey.prototype.__defineGetter__("input",function(){return this.input_}),o3d.CurveKey.prototype.__defineSetter__("input",function(a){a!=this.input_&&(this.input_=a,this.owner_.invalidateCache_())}),o3d.CurveKey.prototype.__defineGetter__("output",function(){return this.output_}),o3d.CurveKey.prototype.__defineSetter__("output",function(a){a!=this.output_&&(this.output_=a,this.owner_.invalidateCache_())}),o3d.StepCurveKey=function(a){o3d.CurveKey.call(this,a),a.num_step_keys_++},o3d.inherit("StepCurveKey","CurveKey"),o3d.StepCurveKey.prototype.getOutputAtOffset=function(a,b){return this.output},o3d.StepCurveKey.prototype.destroy=function(){o3d.CurveKey.prototype.destroy.call(this),this.owner_.num_step_keys_--},o3d.LinearCurveKey=function(a){o3d.CurveKey.call(this,a)},o3d.inherit("LinearCurveKey","CurveKey"),o3d.BezierCurveKey=function(a){o3d.CurveKey.call(this,a),this.in_tangent_=[0,0],this.out_tangent_=[0,0]},o3d.inherit("BezierCurveKey","CurveKey"),o3d.BezierCurveKey.prototype.__defineGetter__("inTangent",function(){return this.in_tangent_}),o3d.BezierCurveKey.prototype.__defineSetter__("inTangent",function(a){a!=this.in_tangent_&&(this.in_tangent_=a,this.owner_.invalidateCache_())}),o3d.BezierCurveKey.prototype.__defineGetter__("outTangent",function(){return this.out_tangent_}),o3d.BezierCurveKey.prototype.__defineSetter__("outTangent",function(a){a!=this.out_tangent_&&(this.out_tangent_=a,this.owner_.invalidateCache_())}),o3d.BezierCurveKey.findT_=function(a,b,c,d,e,f){var g=.001,h=1,i=0,j=.5;f<=.1?j=.1:f>=.9?j=.9:j=f;var k=!0;while(h-i>g){k?k=!1:j=(h-i)/2+i;var l=1-j,m=a*l*l*l+3*b*j*l*l+3*c*j*j*l+d*j*j*j;if(Math.abs(m-e)<=g)break;m>e?h=j:i=j}return j},o3d.BezierCurveKey.prototype.getOutputAtOffset=function(a,b){var c=b.input-this.input,d=b.output-this.output,e;b.inTangent?e=b.inTangent:e=[b.input-c/3,b.output-d/3];var f=a/c;f=o3d.BezierCurveKey.findT_(this.input,this.outTangent[0],e[0],b.input,this.input+a,f);var g=this.outTangent[1],h=e[1],i=1-f,j=3,k=3;return this.output*i*i*i+j*g*i*i*f+k*h*i*f*f+b.output*f*f*f},o3d.Curve=function(){o3d.Function.call(this,this.evaluate),this.preInfinity=o3d.Curve.CONSTANT,this.postInfinity=o3d.Curve.CONSTANT,this.useCache=!0,this.sample_rate_=o3d.Curve.kDefaultSampleRate,this.keys=[],this.sorted_=!0,this.check_discontinuity_=!1,this.discontinuous_=!1,this.num_step_keys_=0},o3d.inherit("Curve","Function"),o3d.Curve.kMinimumSampleRate=1/240,o3d.Curve.kDefaultSampleRate=1/30,o3d.Curve.prototype.__defineGetter__("sampleRate",function(){return this.sample_rate_}),o3d.Curve.prototype.__defineSetter__("sampleRate",function(a){a<o3d.Curve.kMinimumSampleRate?(a=o3d.Curve.kMinimumSampleRate,this.gl.client.error_callback("attempt to set sample rate to "+a+" which is lower than the minimum of "+o3d.Curve.kMinimumSampleRate)):a!=this.sample_rate_&&(this.sample_rate_=a,this.invalidateCache_())}),o3d.Curve.Infinity=goog.typedef,o3d.Curve.CONSTANT=0,o3d.Curve.LINEAR=1,o3d.Curve.CYCLE=2,o3d.Curve.CYCLE_RELATIVE=3,o3d.Curve.OSCILLATE=4,o3d.Curve.prototype.set=function(a,b,c){o3d.notImplemented()},o3d.Curve.prototype.createKey=function(a){var b=new o3d[a](this);this.keys.push(b);return b},o3d.Curve.prototype.addLinearKeys=function(a){var b=2;if(a.length%b!=0)this.gl.client.error_callback("addLinearKeys: expected multiple of 2 values got "+a.size());else{for(var c=0;c<a.length;c+=b){var d=this.createKey("LinearCurveKey");d.input=a[c],d.output=a[c+1]}this.sorted_=!1}},o3d.Curve.prototype.addStepKeys=function(a){var b=2;if(a.length%b!=0)this.gl.client.error_callback("addStepKeys: expected multiple of 2 values got "+a.size());else{for(var c=0;c<a.length;c+=b){var d=this.createKey("StepCurveKey");d.input=a[c],d.output=a[c+1]}this.sorted_=!1}},o3d.Curve.prototype.addBezierKeys=function(a){var b=6;if(a.length%b!=0)this.gl.client.error_callback("addBezierKeys: expected multiple of 6 values got "+a.size());else{for(var c=0;c<a.length;c+=b){var d=this.createKey("BezierCurveKey");d.input=a[c],d.output=a[c+1],d.inTangent[0]=a[c+2],d.inTangent[1]=a[c+3],d.outTangent[0]=a[c+4],d.outTangent[1]=a[c+5]}this.sorted_=!1}},o3d.Curve.prototype.invalidateCache_=function(){this.check_valid_=!1,this.check_discontinuity_=!0},o3d.Curve.prototype.isDiscontinuous=function(){this.updateCurveInfo_();return this.discontinuous_},o3d.Curve.compareInputs_=function(a,b){return a.input-b.input},o3d.Curve.prototype.updateCurveInfo_=function(){this.sorted_||(this.keys.sort(o3d.Curve.compareInputs_),this.sorted_=!0,this.invalidateCache_());if(this.check_discontinuity_){this.check_discontinuity_=!1;var a=this.keys.length;this.discontinuous_=this.num_step_keys_>0&&this.num_step_keys_!=a;if(!this.discontinuous_&&a>1)for(var b=0;b<a-1;++b)if(this.keys[b].input==this.keys[b+1].input&&this.keys[b].output!=this.keys[b+1].output){this.discontinuous_=!0;break}}},o3d.Curve.prototype.getOutputInSpan_=function(a,b){var c=this.keys,d=c.length;if(a<c[0].input){this.gl.client.error_callback("Curve.getOutputInSpan_: input is lower than any key");return 0}if(a>=c[d-1].input)return c[d-1].output;var e=0,f=d,g,h=!1,i=3;if(b){g=b.curve_last_key_index_;if(g<f-1)if(c[g].input<=a&&c[g+1].input>a)h=!0;else if(a>c[g].input){var j=g+i;j>f&&(j=f);for(++g;g<j;++g)if(c[g].input<=a&&c[g+1].input>a){h=!0;break}}else if(g>0){var j=g-i;j<0&&(j=0);for(--g;g>=j;--g)if(c[g].input<=a&&c[g+1].input>a){h=!0;break}}}if(!h){while(e<=f){var k=Math.floor((e+f)/2);if(a>c[k].input)e=k+1;else{if(k==0)break;f=k-1}}f=d;while(e<f){if(c[e].input>a)break;++e}(e<=0||e>=f)&&this.gl.client.error_callback("Curve.getOutputInSpan_: start is outside range."),g=e-1}var l=c[g];b&&(b.curve_last_key_index_=g);if(g+1>=d||!c[g+1]){this.gl.client.error_callback("Curve.getOutputInSpan_: next key is null: index is "+g+"; size is "+d);return l.output}return l.getOutputAtOffset(a-l.input,c[g+1])},o3d.Curve.prototype.evaluate=function(a,b){var c=this.keys,d=c.length;if(d==0)return 0;if(d==1)return c[0].output;this.updateCurveInfo_();var e=c[0].input,f=c[d-1].input,g=f-e,h=c[0].output,i=c[d-1].output,j=i-h,k=1e-5,l=0;if(a<e){if(g<=0)return h;var m=e-a;switch(this.preInfinity){case o3d.Curve.CONSTANT:return h;case o3d.Curve.LINEAR:var n=c[1],o=n.input-e;return o>k?h-m*(n.output-h)/o:h;case o3d.Curve.CYCLE:var p=Math.ceil(m/g);a+=p*g,a=e+(a-e)%g;break;case o3d.Curve.CYCLE_RELATIVE:var p=Math.ceil(m/g);a+=p*g,a=e+(a-e)%g,l-=p*j;break;case o3d.Curve.OSCILLATE:var p=Math.ceil(m/(2*g));a+=p*2*g,a=f-Math.abs(a-f);break;default:this.gl.client.error_callback("Curve: invalid value "+this.preInfinity+"for pre-infinity");return h}}else if(a>=f){if(g<=0)return i;var q=a-f;switch(this.postInfinity){case o3d.Curve.CONSTANT:return i;case o3d.Curve.LINEAR:var r=c[d-2],o=f-r.input;return o>k?i+q*(i-r.output)/o:i;case o3d.Curve.CYCLE:var p=Math.ceil(q/g);a-=p*g,a=e+(a-e)%g;break;case o3d.Curve.CYCLE_RELATIVE:var p=Math.floor((a-e)/g);a-=p*g,a=e+(a-e)%g,l+=p*j;break;case o3d.Curve.OSCILLATE:var p=Math.ceil(q/(2*g));a-=p*2*g,a=e+Math.abs(a-e);break;default:this.gl.client.error_callback("Curve.invalid value "+this.postInfinity+"for post-infinity");return i}}return a>=f?i+l:this.getOutputInSpan_(a,b)+l},o3d.Skin=function(){o3d.NamedObject.call(this),this.influences=[],this.inverseBindPoseMatrices=[],this.info_valid_=!1,this.highest_matrix_index_=0,this.highest_influences_=0,this.supports_vertex_shader_=!1,this.buffers_valid_=!1,this.vertex_buffer_=null,this.weights_field_=null,this.matrix_indices_field_=null},o3d.inherit("Skin","NamedObject"),o3d.Skin.prototype.updateVertexShader=function(){if(!this.buffers_valid_){var a=4,b=this.influences.length;if(!this.weights_field_&&!this.matrix_indices_field_){var c=new o3d.VertexBuffer;c.gl=this.gl,this.weights_field_=c.createField("FloatField",a),this.matrix_indices_field_=c.createField("FloatField",a),c.allocateElements(b)}var d,e,f=this.weights_field_,g=this.matrix_indices_field_,h=this.getHighestInfluences();this.buffers_valid_=!0,f.buffer.lock(),g.buffer.lock();var i=o3d.SkinEval.getMaxNumBones(this);this.supports_vertex_shader_=h<=a&&this.inverseBindPoseMatrices.length<=i;if(this.supports_vertex_shader_){var j=new Float32Array(b*a),k=new Float32Array(b*a);for(d=0;d<b;++d){var l=this.influences[d];for(e=0;e<l.length&&e<a*2;e+=2)k[d*a+e/2]=l[e],j[d*a+e/2]=l[e+1]}f.setAt(0,j),g.setAt(0,k)}f.buffer.unlock(),g.buffer.unlock()}return this.supports_vertex_shader_},o3d.Skin.prototype.setVertexInfluences=function(a,b){b.length%2!=0?this.gl.client.error_callback("odd number of values passed intoSetVertexInfluence. Even number required as they are pairs."):(this.influences[a]=b,this.info_valid_=!1,this.buffers_valid_=!1)},o3d.Skin.prototype.getVertexInfluences=function(a){return this.influences[a]||[]},o3d.Skin.prototype.updateInfo_=function(){if(!this.info_valid_){this.info_valid_=!0,this.highest_matrix_index_=0,this.highest_influences_=0;for(var a=0;a<this.influences.length;++a){var b=this.influences[a],c=b.length;c>this.highest_influences_&&(this.highest_influences_=c);for(var d=0;d<b.length;d+=2)b[d]>this.highest_matrix_index_&&(this.highest_matrix_index_=b[d])}this.highest_influences_%2&&this.gl.client.error_callback("Skin.updateInfo: Influences should not have odd length "),this.highest_influences_=Math.floor(this.highest_influences_/2)}},o3d.Skin.prototype.getHighestMatrixIndex=function(){this.updateInfo_();return this.highest_matrix_index_},o3d.Skin.prototype.getHighestInfluences=function(){this.updateInfo_();return this.highest_influences_},o3d.Skin.prototype.setInverseBindPoseMatrix=function(a,b){this.inverseBindPoseMatrices[a]=b},o3d.Skin.prototype.set=function(a,b,c){o3d.notImplemented()},o3d.SkinEval=function(){o3d.StreamBank.call(this),this.base=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.temp_matrix_=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.bones_=[],this.bone_array_=null,this.input_stream_infos_=[],this.output_stream_infos_=[],this.createParam("boneToWorld3x4","ParamParamArrayOutput"),this.usingSkinShader=0},o3d.inherit("SkinEval","StreamBank"),o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"base","ParamMatrix4"),o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"usingSkinShader","ParamFloat"),o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"disableShader","ParamBoolean"),o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"skin","ParamSkin"),o3d.ParamObject.setUpO3DParam_(o3d.SkinEval,"matrices","ParamArray"),o3d.SkinEval.getMaxNumBones=function(a){var b=a.gl,c=b.getParameter(b.MAX_VERTEX_UNIFORM_VECTORS);return Math.floor((c-32)/3)},o3d.SkinEval.prototype.streamWasBound_=function(a,b,c){this.skin.updateVertexShader();if(this.skin.weights_field_&&this.skin.matrix_indices_field_){var d=a.getVertexStream(o3d.Stream.INFLUENCE_WEIGHTS,0),e=a.getVertexStream(o3d.Stream.INFLUENCE_INDICES,0);if(!d||!e||d.field!=this.skin.weights_field_||e.field!=this.skin.matrix_indices_field_)a.setVertexStream(o3d.Stream.INFLUENCE_WEIGHTS,0,this.skin.weights_field_,0),a.setVertexStream(o3d.Stream.INFLUENCE_INDICES,0,this.skin.matrix_indices_field_,0);var f=a.getParam("boneToWorld3x4");f||(f=a.createParam("boneToWorld3x4","ParamParamArray")),f.bind(this.getParam("boneToWorld3x4")),f=a.getParam("usingSkinShader"),f||(f=a.createParam("usingSkinShader","ParamFloat")),f.bind(this.getParam("usingSkinShader"))}},o3d.SkinEval.prototype.multiplyAdd_=function(a,b,c){var d=a[0],e=a[1],f=a[2],g=a[3],h=c[0],i=c[1],j=c[2],k=c[3];h[0]+=d[0]*b,h[1]+=d[1]*b,h[2]+=d[2]*b,h[3]+=d[3]*b,i[0]+=e[0]*b,i[1]+=e[1]*b,i[2]+=e[2]*b,i[3]+=e[3]*b,j[0]+=f[0]*b,j[1]+=f[1]*b,j[2]+=f[2]*b,j[3]+=f[3]*b,k[0]+=g[0]*b,k[1]+=g[1]*b,k[2]+=g[2]*b,k[3]+=g[3]*b},o3d.SkinEval.prototype.initStreams_=function(a){var b,c,d,e,f=this.skin.influences.length;for(b=0,e=0;b<this.vertex_streams_.length;++b){var g=this.vertex_streams_[b];if(g)for(c=0;c<g.length;++c,++e){var h=g[c],i=h.inputConnection;i&&i.isAClassName("ParamVertexBufferStream")&&i.owner_.updateStreams();var j=h.stream;if(j.getMaxVertices_()!=f){this.gl.client.error_callback("SkinEval.doSkinning_: stream "+j.semantic+" index "+j.semanticIndex+" in SkinEval '"+this.name+" does not have the same number of vertices as Skin '"+a.name+"'");return}this.input_stream_infos_[e]||(this.input_stream_infos_[e]=new o3d.SkinEval.StreamInfo);if(!this.input_stream_infos_[e].init(j,!1)){var k;j.field.buffer&&(k=j.field.buffer.name),this.gl.client.error_callback("SkinEval.doSkinning_: unable to lock buffer '"+k+" used by stream "+j.semantic+" index "+j.semanticIndex+" in SkinEval '"+this.name+"'");return}var l=h.outputConnections;this.output_stream_infos_[e]||(this.output_stream_infos_[e]=[]);var m=this.output_stream_infos_[e];m.length=l.length;for(d=0;d<l.length;++d){var n=l[d];n.isAClassName("ParamVertexBufferStream")||this.gl.client.error_callback("SkinEval.doSkinning: "+n.className+" not ParamVertexBufferStream");var o=n.stream;if(o.getMaxVertices_()!=f){this.gl.client.error_callback("SkinEval.doSkinning_: stream "+o.semantic+" index "+o.semanticIndex+" targeted by SkinEval '"+this.name+" does not have the same number of vertices as "+"Skin '"+a.name+"'");return}m[d]||(m[d]=new o3d.SkinEval.StreamInfo);if(!m[d].init(o,!0)){var k;o.field.buffer&&(k=o.field.buffer.name),this.gl.client.error_callback("SkinEval.doSkinning_: unable to lock buffer '"+k+" used by stream "+o.semantic+" index "+o.semanticIndex+" targeted by SkinEval '"+this.name+"'");return}}}}this.input_stream_infos_.length=e,this.output_stream_infos_.length=e},o3d.SkinEval.prototype.uninitStreams_=function(){for(ii=0;ii<this.input_stream_infos_.length;++ii)this.input_stream_infos_[ii].uninit();for(ii=0;ii<this.output_stream_infos_.length;++ii){var a=this.output_stream_infos_[ii];for(var b=0;b<a.length;++b)a[b].uninit()}},o3d.SkinEval.prototype.doSkinning_=function(){this.initStreams_();var a,b,c,d=this.skin.influences,e=d.length;for(a=0;a<e;++a){var f=d[a];if(f.length){var g=f[0],h=f[1],i=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];this.multiplyAdd_(this.bones_[g],h,i);var j=f.length;for(b=2;b<j;b+=2){var k=f[b],l=f[b+1];this.multiplyAdd_(this.bones_[k],l,i)}for(b=0;b<this.input_stream_infos_.length;++b){var m=this.input_stream_infos_[b];m.compute_function_(i);var n=this.output_stream_infos_[b],o=n.length;for(c=0;c<o;++c)n[c].copy_function_(m)}}}this.uninitStreams_()},o3d.SkinEval.prototype.updateBones_=function(){var a=this.matrices;if(!a)this.gl.client.error_callback("SkinEval.updateBones_: no matrices for SkinEval '"+this.name+"'");else{var b=this.skin;if(!b){this.gl.client.error_callback("SkinEval.updateBones_: no skin specified in SkinEval '"+this.name+"'");return}if(b.getHighestMatrixIndex()>=a.length){this.gl.client.error_callback("SkinEval.updateBones_: skin '"+b.name+" specified in SkinEval '"+this.name+"' references matrices outside the valid range in ParamArray '"+a.name+"'");return}var c=b.inverseBindPoseMatrices;if(c.length!=a.length){this.gl.client.error_callback("SkinEval.updateBones_: skin '"+b.name+" specified in SkinEval '"+this.name+"' and the ParamArray '"+a.name+"' do not have the same number of matrices.");return}var d=this.temp_matrix_;o3d.Transform.inverse(this.base,d);for(var e=0;e<a.length;++e){var f=a.getParam(e);if(!f){this.gl.client.error_callback("SkinEval.updateBones_: In SkinEval '"+this.name+"' param at index "+e+" in ParamArray '"+a.name+" is not a ParamMatrix4");return}this.bones_[e]=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],o3d.Transform.compose(f.value,c[e],this.bones_[e]),o3d.Transform.compose(d,this.bones_[e],this.bones_[e])}}},o3d.SkinEval.prototype.updateStreams=function(){if(this.disableShader||!this.usingSkinShader||!this.skin.updateVertexShader())this.updateBones_(),this.doSkinning_(this.skin),this.usingSkinShader=0},o3d.SkinEval.prototype.updateOutputs=function(a){this.updateBones_();if(!this.bone_array_){this.bone_array_=new o3d.ParamArray,this.bone_array_.gl=this.gl;var b=o3d.SkinEval.getMaxNumBones(this);this.bone_array_.resize(b*3,"ParamFloat4"),a.value=this.bone_array_}var c=this.bone_array_,d,e;if(!this.disableShader&&this.skin.updateVertexShader()){if(!this.usingSkinShader){this.usingSkinShader=1,this.initStreams_();var f=this.skin.influences.length;for(d=0;d<this.input_stream_infos_.length;++d){var g=this.input_stream_infos_[d],h=this.output_stream_infos_[d];for(e=0;e<h.length;++e){var i=g.field_.getAt(0,f);h[e].field_.setAt(0,i)}}this.uninitStreams_()}var j;for(d=0;d<this.bones_.length;++d){var k=this.bones_[d];j=c.getParam(d*3),j.value[0]=k[0][0],j.value[1]=k[1][0],j.value[2]=k[2][0],j.value[3]=k[3][0],j=c.getParam(d*3+1),j.value[0]=k[0][1],j.value[1]=k[1][1],j.value[2]=k[2][1],j.value[3]=k[3][1],j=c.getParam(d*3+2),j.value[0]=k[0][2],j.value[1]=k[1][2],j.value[2]=k[2][2],j.value[3]=k[3][2]}}return c},o3d.SkinEval.StreamInfo=function(){this.compute_function_=null,this.copy_function_=null,this.result_=null,this.field_=null,this.values_=null,this.buffer_=null,this.index_=0,this.writable_=!1},o3d.SkinEval.StreamInfo.prototype.init=function(a,b){if(this.values_||this.buffer_)return!1;var c=a.field,d=c.buffer;if(!d)return!1;switch(c.numComponents){case 3:this.copy_function_=this.copyFloat3,this.compute_function_=a.semantic==o3d.Stream.POSITION?this.computeFloat3AsPoint3:this.computeFloat3AsVector3;break;case 4:this.compute_function_=this.computeFloat4AsVector4,this.copy_function_=this.copyFloat4;break;default:return!1}d.lock(),this.field_=c,this.buffer_=d,this.values_=d.array_,this.index_=this.field_.offset_,this.writable_=b,this.stride_=d.totalComponents;return!0},o3d.SkinEval.StreamInfo.prototype.uninit=function(){this.buffer_&&(this.writable_&&this.buffer_.unlock(),this.buffer_=null,this.field_=null,this.values_=null)},o3d.SkinEval.StreamInfo.prototype.computeFloat3AsVector3=function(a){var b=this.index_,c=[this.values_[b],this.values_[b+1],this.values_[b+2],0];this.result_=o3d.Transform.multiplyVector(a,c),this.index_=b+this.stride_},o3d.SkinEval.StreamInfo.prototype.computeFloat3AsPoint3=function(a){var b=this.index_,c=[this.values_[b],this.values_[b+1],this.values_[b+2],1];this.result_=o3d.Transform.multiplyVector(a,c),this.index_=b+this.stride_},o3d.SkinEval.StreamInfo.prototype.computeFloat4AsVector4=function(a){var b=this.index_,c=[this.values_[b],this.values_[b+1],this.values_[b+2],this.values_[b+3]];this.result_=o3d.Transform.multiplyVector(a,c),this.index_=b+this.stride_},o3d.SkinEval.StreamInfo.prototype.copyFloat3=function(a){var b=this.index_;this.values_[b]=a.result_[0],this.values_[b+1]=a.result_[1],this.values_[b+2]=a.result_[2],this.index_=b+this.stride_},o3d.SkinEval.StreamInfo.prototype.copyFloat4=function(a){var b=this.index_;this.values_[b]=a.result_[0],this.values_[b+1]=a.result_[1],this.values_[b+2]=a.result_[2],this.values_[b+3]=a.result_[3],this.index_=b+this.stride_};var o3djs=o3djs||{},goog=goog||{};goog.typedef=!0,o3djs.global=this,o3djs.BROWSER_ONLY=!0,o3djs.provided_=[],o3djs.provide=function(a){if(o3djs.getObjectByName(a)&&!o3djs.implicitNamespaces_[a])throw'Namespace "'+a+'" already declared.';var b=a;while(b=b.substring(0,b.lastIndexOf(".")))o3djs.implicitNamespaces_[b]=!0;o3djs.exportPath_(a),o3djs.provided_.push(a)},o3djs.implicitNamespaces_={},o3djs.exportPath_=function(a,b,c){var d=a.split("."),e=c||o3djs.global,f;!(d[0]in e)&&e.execScript&&e.execScript("var "+d[0]);while(d.length&&(f=d.shift()))!d.length&&o3djs.isDef(b)?e[f]=b:e[f]?e=e[f]:e=e[f]={}},o3djs.getObjectByName=function(a,b){var c=a.split("."),d=b||o3djs.global;for(var e=0;e<c.length;++e){var f=c[e];if(d[f])d=d[f];else return null}return d},o3djs.require=function(a){var b=document.getElementsByTagName("script").length;if(!o3djs.getObjectByName(a)){var c=o3djs.getPathFromRule_(a);if(c)o3djs.included_[c]=!0,o3djs.writeScripts_();else throw new Error("o3djs.require could not find: "+a)}},o3djs.basePath="",o3djs.included_={},o3djs.dependencies_={visited:{},written:{}},o3djs.findBasePath_=function(){var a=o3djs.global.document;if(typeof a!="undefined"){if(o3djs.global.BASE_PATH){o3djs.basePath=o3djs.global.BASE_PATH;return}o3djs.global.BASE_PATH=null;var b=a.getElementsByTagName("script");for(var c,d=0;c=b[d];d++){var e=c.src,f=e.length,g=e.match(/(.*?)(o3djs\/base.js|o3d\.min\.js|o3d\.src\.js)/);if(g){o3djs.basePath=g[1];return}}}},o3djs.writeScriptTag_=function(a){var b=o3djs.global.document;typeof b!="undefined"&&!o3djs.dependencies_.written[a]&&(o3djs.dependencies_.written[a]=!0,b.write('<script type="text/javascript" src="'+a+'"></'+"script>"))},o3djs.writeScripts_=function(){function d(d){if(!(d in c.written)){if(d in c.visited){d in b||(b[d]=!0,a.push(d));return}c.visited[d]=!0,d in b||(b[d]=!0,a.push(d))}}var a=[],b={},c=o3djs.dependencies_;for(var e in o3djs.included_)c.written[e]||d(e);for(var f=0;f<a.length;f++)if(a[f])o3djs.writeScriptTag_(o3djs.basePath+a[f]);else throw Error("Undefined script input")},o3djs.getPathFromRule_=function(a){var b=a.split(".");return b.join("/")+".js"},o3djs.findBasePath_(),o3djs.isDef=function(a){return typeof a!="undefined"},o3djs.exportSymbol=function(a,b,c){o3djs.exportPath_(a,b,c)},o3djs.v8Initializer_="",o3djs.v8InitializerArgs_=[],o3djs.valueToString_=function(a){switch(typeof a){case"undefined":return"undefined";case"string":var b=escape(a);return b===a?'"'+a+'"':'unescape("'+b+'")';case"object":if(a===null)return"null";if(a instanceof RegExp){var c="new RegExp("+o3djs.valueToString_(a.source)+', "';a.global&&(c+="g"),a.ignoreCase&&(c+="i"),a.multiline&&(c+="m"),c+='")';return c}if(o3djs.base.isArray(a)){var d=a,c="[",e="";for(var f=0;f<d.length;++f)c+=e+o3djs.valueToString_(d[f]),e=",";c+="]\n";return c}var g=a,c="{\n",e="";for(var h in g)c+=e+'"'+h+'": '+o3djs.valueToString_(g[h]),e=",";c+="}\n";return c;default:return a.toString()}},o3djs.namespaceInitializer_=function(a,b,c){var d=b+" = {};\n";for(var e in a){var f=b+"."+e,g=a[e];if(typeof g!="object"||g===null||!!o3djs.base.isArray(g)||g instanceof RegExp){var h=o3djs.valueToString_(g);typeof g=="function"&&h.indexOf("o3djs.BROWSER_ONLY")!=-1&&(h="args_["+c.length+"]",c.push(g)),d+=f+" = "+h+";\n",typeof g=="function"&&g.prototype&&(d+=o3djs.namespaceInitializer_(g.prototype,f+".prototype"))}else d+=o3djs.namespaceInitializer_(g,f)}return d},o3djs.provide("o3djs.base"),o3djs.base=o3djs.base||{},o3djs.base.o3d=null,o3djs.base.glsl=!1,o3djs.base.snapshotProvidedNamespaces=function(){o3djs.v8Initializer_="function(args_) {\n",o3djs.v8InitializerArgs_=[];for(var a=0;a<o3djs.provided_.length;++a){var b=o3djs.getObjectByName(o3djs.provided_[a]);o3djs.v8Initializer_+=o3djs.namespaceInitializer_(b,o3djs.provided_[a],o3djs.v8InitializerArgs_)}o3djs.v8Initializer_+="}\n"},o3djs.base.initV8=function(clientObject){var v8Init=function(initializer,args){var o3djsBrowser=o3djs;o3djs={},o3djs.browser=o3djsBrowser,o3djs.global=function(){return this}(),o3djs.require=function(a){},o3djs.provide=function(a){},eval("("+initializer+")")(args),o3djs.base.o3d=plugin.o3d,o3djs.base.glsl=plugin.client.clientInfo.glsl};clientObject.eval(v8Init.toString())(o3djs.v8Initializer_,o3djs.v8InitializerArgs_)},o3djs.base.init=function(a){function b(a){var c={},d=!1;for(var e in a){var f=a[e];if(typeof f=="object"||typeof f=="function")f=b(f);typeof f!="undefined"&&(c[e]=f,d=!0)}return d?c:undefined}try{o3djs.base.o3d=b(a.o3d)}catch(c){o3djs.base.o3d=a.o3d}o3djs.base.o3d=o3djs.base.o3d||a.o3d,o3djs.base.glsl=a.client.clientInfo.glsl},o3djs.base.isArray=function(a){var b=a;return typeof a=="object"&&a!==null&&"length"in b&&"splice"in b},o3djs.base.ready=function(){return o3djs.base.o3d!=null},o3djs.base.maybeDeobfuscateFunctionName_=function(a){return a},o3djs.base.inherit=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c},o3djs.base.parseErrorStack=function(a){var b=[],c,d;if(!a||!a.stack)return b;var e=a.stack.split("\n");for(var f=0;f<e.length-1;f++){var g=e[f];c=g.match(/^([a-zA-Z0-9_$]*)/)[1],c?c=o3djs.base.maybeDeobfuscateFunctionName_(c):c="anonymous";var h=g.match(/(.*:[0-9]+)$/);d=h&&h[1],d||(d="(unknown)"),b[b.length]=c+" : "+d}var i=/^anonymous :/;while(b.length&&i.exec(b[b.length-1]))b.length=b.length-1;return b},o3djs.base.getFunctionName=function(a){var b=a.toString().match(/function(\s*)(\w*)/);return b&&b.length>=2&&b[2]?o3djs.base.maybeDeobfuscateFunctionName_(b[2]):"anonymous"},o3djs.base.formatErrorStack=function(a){var b="";for(var c=0;c<a.length;c++)b+="> "+a[c]+"\n";return b},o3djs.base.getStackTrace=function(stripCount){var result="";if(typeof arguments.caller!="undefined")for(var a=arguments.caller;a!=null;a=a.caller){result+="> "+o3djs.base.getFunctionName(a.callee)+"\n";if(a.caller==a){result+="*";break}}else{var testExcp;try{eval("var var;")}catch(testExcp){var stack=o3djs.base.parseErrorStack(testExcp);result+=o3djs.base.formatErrorStack(stack.slice(3+stripCount,stack.length))}}return result},o3djs.base.setErrorHandler=function(a){a.setErrorCallback(function(b){a.clearErrorCallback(),alert("ERROR: "+b+"\n"+o3djs.base.getStackTrace(1))})},o3djs.base.IsMSIE=function(){var a=navigator.userAgent.toLowerCase(),b=/msie/.test(a)&&!/opera/.test(a);return b},o3djs.provide("o3djs.effect"),o3djs.effect=o3djs.effect||{},o3djs.effect.TWO_COLOR_CHECKER_EFFECT_NAME="o3djs.effect.twoColorCheckerEffect",o3djs.effect.o3d={LANGUAGE:"o3d",FLOAT2:"float2",FLOAT3:"float3",FLOAT4:"float4",MATRIX4:"float4x4",MATRIX3:"float3x3",MOD:"fmod",ATTRIBUTE:"  ",ATTRIBUTE_PREFIX:"input.",VARYING:"  ",VARYING_DECLARATION_PREFIX:"",VERTEX_VARYING_PREFIX:"output.",PIXEL_VARYING_PREFIX:"input.",TEXTURE:"tex",SAMPLER:"sampler",BEGIN_IN_STRUCT:"struct InVertex {\n",BEGIN_OUT_STRUCT:"struct OutVertex {\n",END_STRUCT:"};\n"},o3djs.effect.glsl={LANGUAGE:"glsl",FLOAT2:"vec2",FLOAT3:"vec3",FLOAT4:"vec4",MATRIX4:"mat4",MATRIX3:"mat3",MOD:"mod",ATTRIBUTE:"attribute ",ATTRIBUTE_PREFIX:"",VARYING:"varying ",VARYING_DECLARATION_PREFIX:"v_",VERTEX_VARYING_PREFIX:"v_",PIXEL_VARYING_PREFIX:"v_",TEXTURE:"texture",SAMPLER:"sampler2D",BEGIN_IN_STRUCT:"",BEGIN_OUT_STRUCT:"",END_STRUCT:"",semanticNameMap:{POSITION:"position",NORMAL:"normal",TANGENT:"tangent",BINORMAL:"binormal",COLOR:"color",TEXCOORD0:"texCoord0",TEXCOORD1:"texCoord1",TEXCOORD2:"texCoord2",TEXCOORD3:"texCoord3",TEXCOORD4:"texCoord4",TEXCOORD5:"texCoord5",TEXCOORD6:"texCoord6",TEXCOORD7:"texCoord7"}},o3djs.effect.glsl.semanticSuffix=function(a){return""},o3djs.effect.o3d.semanticSuffix=function(a){return" : "+a},o3djs.effect.glsl.getAttributeName_=function(a,b){var c=o3djs.effect;return c.semanticNameMap[b]},o3djs.effect.o3d.getAttributeName_=function(a,b){return a},o3djs.effect.glsl.mul=function(a,b){return"("+b+" * "+a+")"},o3djs.effect.o3d.mul=function(a,b){return"mul("+a+", "+b+")"},o3djs.effect.glsl.utilityFunctions=function(){return"vec4 lit(float l ,float h, float m) {\n  return vec4(1.0,\n              max(l, 0.0),\n              (l > 0.0) ? pow(max(0.0, h), m) : 0.0,\n              1.0);\n}\n"},o3djs.effect.o3d.utilityFunctions=function(){return""},o3djs.effect.glsl.beginVertexShaderMain=function(){return"void main() {\n"},o3djs.effect.o3d.beginVertexShaderMain=function(){return"OutVertex vertexShaderFunction(InVertex input) {\n  OutVertex output;\n"},o3djs.effect.glsl.endVertexShaderMain=function(){return"  gl_Position = "+o3djs.effect.VERTEX_VARYING_PREFIX+"position;\n}\n"},o3djs.effect.o3d.endVertexShaderMain=function(){return"  return output;\n}\n"},o3djs.effect.glsl.pixelShaderHeader=function(a,b,c,d){return"\n// #o3d SplitMarker\n"},o3djs.effect.o3d.pixelShaderHeader=function(a,b,c,d){return""},o3djs.effect.glsl.repeatVaryingDecls=function(a){return(a||o3djs.effect.varying_decls_||o3djs.buildVaryingDecls())+"\n"},o3djs.effect.o3d.repeatVaryingDecls=function(a){return""},o3djs.effect.glsl.beginPixelShaderMain=function(){return"void main() {\n"},o3djs.effect.o3d.beginPixelShaderMain=function(){return"float4 pixelShaderFunction(OutVertex input) : COLOR {\n"},o3djs.effect.o3d.endPixelShaderMain=function(a){return"  return "+a+";\n}\n"},o3djs.effect.glsl.endPixelShaderMain=function(a){return"  gl_FragColor = "+a+";\n}\n"},o3djs.effect.o3d.entryPoints=function(){return"// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n"},o3djs.effect.glsl.entryPoints=function(){return""},o3djs.effect.glsl.matrixLoadOrder=o3djs.effect.o3d.matrixLoadOrder=function(){return"// #o3d MatrixLoadOrder RowMajor\n"},o3djs.effect.setLanguage=function(a){var b=o3djs.effect.o3d;a=="glsl"&&(b=o3djs.effect.glsl);for(var c in o3djs.effect.glsl)o3djs.effect[c]=b[c];o3djs.effect.TWO_COLOR_CHECKER_FXSTRING=o3djs.effect.buildCheckerShaderString()},o3djs.effect.getLanguage=function(){return language_namespace==o3djs.effect.glsl?"glsl":"o3d"},o3djs.effect.buildAttributeDecls=function(a,b,c,d){var e=o3djs.effect.BEGIN_IN_STRUCT+o3djs.effect.ATTRIBUTE+o3djs.effect.FLOAT4+" "+"position"+o3djs.effect.semanticSuffix("POSITION")+";\n";if(b||c)e+=o3djs.effect.ATTRIBUTE+o3djs.effect.FLOAT3+" "+"normal"+o3djs.effect.semanticSuffix("NORMAL")+";\n";e+=o3djs.effect.buildTexCoords(a,!1)+o3djs.effect.buildBumpInputCoords(d)+o3djs.effect.END_STRUCT;return e},o3djs.effect.varying_decls_="",o3djs.effect.buildVaryingDecls=function(a,b,c,d){var e=o3djs.effect,f=e.BEGIN_OUT_STRUCT+e.VARYING+e.FLOAT4+" "+e.VARYING_DECLARATION_PREFIX+"position"+e.semanticSuffix("POSITION")+";\n"+e.buildTexCoords(a,!0)+e.buildBumpOutputCoords(d);if(b||c)f+=e.VARYING+e.FLOAT3+" "+e.VARYING_DECLARATION_PREFIX+"normal"+e.semanticSuffix("TEXCOORD"+e.interpolant_++ +"")+";\n"+e.VARYING+e.FLOAT3+" "+e.VARYING_DECLARATION_PREFIX+"surfaceToLight"+e.semanticSuffix("TEXCOORD"+e.interpolant_++ +"")+";\n";c&&(f+=e.VARYING+e.FLOAT3+" "+e.VARYING_DECLARATION_PREFIX+"surfaceToView"+e.semanticSuffix("TEXCOORD"+e.interpolant_++ +"")+";\n"),f+=e.END_STRUCT,e.varying_decls_=f;return f},o3djs.effect.interpolant_=0,o3djs.effect.buildTexCoord=function(a,b,c){var d=o3djs.effect;if(a.getParam(c+"Sampler")){if(b)return"  "+d.VARYING+d.FLOAT2+" "+d.VARYING_DECLARATION_PREFIX+c+"UV"+d.semanticSuffix("TEXCOORD"+d.interpolant_++ +"")+";\n";var e=c+"UV",f="TEXCOORD"+d.interpolant_++,g=d.getAttributeName_(e,f);d.semanticNameMap&&(d.nameToSemanticMap_[e]=f);return"  "+d.ATTRIBUTE+d.FLOAT2+" "+g+d.semanticSuffix(f)+";\n"}return""},o3djs.effect.buildTexCoords=function(a,b){var c=o3djs.effect;c.interpolant_=0,b||(c.nameToSemanticMap_={});return c.buildTexCoord(a,b,"emissive")+c.buildTexCoord(a,b,"ambient")+c.buildTexCoord(a,b,"diffuse")+c.buildTexCoord(a,b,"specular")},o3djs.effect.buildUVPassthrough=function(a,b){var c=o3djs.effect;if(a.getParam(b+"Sampler")){var d=b+"UV",e=d,f=c.nameToSemanticMap_[d];f&&(d=c.getAttributeName_(d,f));return"  "+c.VERTEX_VARYING_PREFIX+e+" = "+c.ATTRIBUTE_PREFIX+d+";\n"}return""},o3djs.effect.buildUVPassthroughs=function(a){var b=o3djs.effect;return b.buildUVPassthrough(a,"emissive")+b.buildUVPassthrough(a,"ambient")+b.buildUVPassthrough(a,"diffuse")+b.buildUVPassthrough(a,"specular")+b.buildUVPassthrough(a,"bump")},o3djs.effect.buildBumpInputCoords=function(a){var b=o3djs.effect;return a?"  "+b.FLOAT3+" tangent"+b.semanticSuffix("TANGENT")+";\n"+"  "+b.FLOAT3+" binormal"+b.semanticSuffix("BINORMAL")+";\n"+"  "+b.FLOAT2+" bumpUV"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n":""},o3djs.effect.buildBumpOutputCoords=function(a){var b=o3djs.effect;return a?b.VARYING+b.FLOAT3+" "+b.VARYING_DECLARATION_PREFIX+"tangent"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n"+b.VARYING+b.FLOAT3+" "+b.VARYING_DECLARATION_PREFIX+"binormal"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n"+b.VARYING+b.FLOAT2+" "+b.VARYING_DECLARATION_PREFIX+"bumpUV"+b.semanticSuffix("TEXCOORD"+b.interpolant_++)+";\n":""},o3djs.effect.buildCheckerShaderString=function(){var a=o3djs.effect,b=a.BEGIN_OUT_STRUCT+a.VARYING+a.FLOAT4+" "+a.VARYING_DECLARATION_PREFIX+"position"+a.semanticSuffix("POSITION")+";\n"+a.VARYING+a.FLOAT2+" "+a.VARYING_DECLARATION_PREFIX+"texCoord"+a.semanticSuffix("TEXCOORD0")+";\n"+a.VARYING+a.FLOAT3+" "+a.VARYING_DECLARATION_PREFIX+"normal"+a.semanticSuffix("TEXCOORD1")+";\n"+a.VARYING+a.FLOAT3+" "+a.VARYING_DECLARATION_PREFIX+"worldPosition"+a.semanticSuffix("TEXCOORD2")+";\n"+a.END_STRUCT;return"uniform "+a.MATRIX4+" worldViewProjection"+a.semanticSuffix("WORLDVIEWPROJECTION")+";\n"+"uniform "+a.MATRIX4+" worldInverseTranspose"+a.semanticSuffix("WORLDINVERSETRANSPOSE")+";\n"+"uniform "+a.MATRIX4+" world"+a.semanticSuffix("WORLD")+";\n"+"\n"+a.BEGIN_IN_STRUCT+a.ATTRIBUTE+a.FLOAT4+" position"+a.semanticSuffix("POSITION")+";\n"+a.ATTRIBUTE+a.FLOAT3+" normal"+a.semanticSuffix("NORMAL")+";\n"+a.ATTRIBUTE+a.FLOAT2+" texCoord0"+a.semanticSuffix("TEXCOORD0")+";\n"+a.END_STRUCT+"\n"+b+"\n"+a.beginVertexShaderMain()+"  "+a.VERTEX_VARYING_PREFIX+"position = "+a.mul(a.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n"+"  "+a.VERTEX_VARYING_PREFIX+"normal = "+a.mul(a.FLOAT4+"("+a.ATTRIBUTE_PREFIX+"normal, 0.0)","worldInverseTranspose")+".xyz;\n"+"  "+a.VERTEX_VARYING_PREFIX+"worldPosition = "+a.mul(a.ATTRIBUTE_PREFIX+"position","world")+".xyz;\n"+"  "+a.VERTEX_VARYING_PREFIX+"texCoord = "+a.ATTRIBUTE_PREFIX+"texCoord0;\n"+a.endVertexShaderMain()+"\n"+a.pixelShaderHeader()+"uniform "+a.FLOAT4+" color1;\n"+"uniform "+a.FLOAT4+" color2;\n"+"uniform float checkSize;\n"+"uniform "+a.FLOAT3+" lightWorldPos;\n"+"uniform "+a.FLOAT3+" lightColor;\n"+"\n"+a.repeatVaryingDecls(b)+a.FLOAT4+" checker("+a.FLOAT2+" uv) {\n"+"  float fmodResult = "+a.MOD+"("+"    floor(checkSize * uv.x) + \n"+"    floor(checkSize * uv.y), 2.0);\n"+"  return (fmodResult < 1.0) ? color1 : color2;\n"+"}\n\n"+a.beginPixelShaderMain()+"  "+a.FLOAT3+" surfaceToLight = \n"+"      normalize(lightWorldPos - "+a.PIXEL_VARYING_PREFIX+"worldPosition);\n"+"  "+a.FLOAT3+" worldNormal = normalize("+a.PIXEL_VARYING_PREFIX+"normal);\n"+"  "+a.FLOAT4+" check = checker("+a.PIXEL_VARYING_PREFIX+"texCoord);\n"+"  float directionalIntensity = \n"+"      clamp(dot(worldNormal, surfaceToLight), 0.0, 1.0);\n"+"  "+a.FLOAT4+" outColor = directionalIntensity * check;\n"+a.endPixelShaderMain(a.FLOAT4+"(outColor.rgb, check.a)")+"\n"+a.entryPoints()+a.matrixLoadOrder()},o3djs.effect.COLLADA_LIGHTING_TYPE_PARAM_NAME="collada.lightingType",o3djs.effect.COLLADA_LIGHTING_TYPES={phong:1,lambert:1,blinn:1,constant:1},o3djs.effect.COLLADA_SAMPLER_PARAMETER_PREFIXES=["emissive","ambient","diffuse","specular","bump"],o3djs.effect.isColladaLightingType=function(a){return o3djs.effect.COLLADA_LIGHTING_TYPES[a.toLowerCase()]==1},o3djs.effect.getColladaLightingType=function(a){var b=a.getParam(o3djs.effect.COLLADA_LIGHTING_TYPE_PARAM_NAME);if(b){var c=b.value.toLowerCase();if(o3djs.effect.isColladaLightingType(c))return c}return""},o3djs.effect.getNumTexCoordStreamsNeeded=function(a){var b=o3djs.effect,c=b.getColladaLightingType(a);if(!b.isColladaLightingType(c))throw"not a collada standard material";var d=b.COLLADA_SAMPLER_PARAMETER_PREFIXES,e=0;for(var f=0;f<d.length;++f){var g=d[f],h=a.getParam(g+"Sampler");h&&++e}return e},o3djs.effect.loadEffect=function(a,b){var c=o3djs.io.loadTextFileSynchronous(b);a.loadFromFXString(c)},o3djs.effect.createEffectFromFile=function(a,b){var c=o3djs.effect,d=a.getObjects(b,"o3d.Effect")[0];d||(d=a.createObject("Effect"),c.loadEffect(d,b),d.name=b);return d},o3djs.effect.buildStandardShaderString=function(a,b){var c=o3djs.effect,d=a.getParam("bumpSampler"),e,f=function(a){var b=a.value;if(!b)return"2D";switch(b.className){case"o3d.Texture1D":return"1D";case"o3d.Texture2D":return"2D";case"o3d.Texture3D":return"3D";case"o3d.TextureCUBE":return"CUBE";default:return"2D"}},g=function(a){var b=a.value;if(!b)return"2D";var c=b.getParam("Texture");return c?f(c):"2D"},h=function(){return"uniform "+c.MATRIX4+" worldViewProjection"+c.semanticSuffix("WORLDVIEWPROJECTION")+";\n"+"uniform "+c.FLOAT3+" lightWorldPos;\n"},i=function(){return"uniform "+c.FLOAT4+" lightColor;\n"},j=function(){return"uniform "+c.MATRIX4+" world"+c.semanticSuffix("WORLD")+";\n"+"uniform "+c.MATRIX4+" viewInverse"+c.semanticSuffix("VIEWINVERSE")+";\n"+"uniform "+c.MATRIX4+" worldInverseTranspose"+c.semanticSuffix("WORLDINVERSETRANSPOSE")+";\n"},k=function(a,b,d,e){e===undefined&&(e=!0);var f=a.getParam(d+"Sampler");if(f){var h=g(f);b.push(d+h+"Texture");return"uniform sampler"+h+" "+d+"Sampler;\n"}if(e){b.push(d+"Color");return"uniform "+c.FLOAT4+" "+d+";\n"}return""},l=function(a,b){var d=a.getParam(b+"Sampler");if(d){var e=g(d);return"  "+c.FLOAT4+" "+b+" = "+c.TEXTURE+e+"("+b+"Sampler, "+c.PIXEL_VARYING_PREFIX+b+"UV);\n"}return""},m=function(a,b){b.push("constant");return h()+w(a,!1,!1)+c.beginVertexShaderMain()+q()+c.buildUVPassthroughs(a)+c.endVertexShaderMain()+c.pixelShaderHeader(a,!1,!1,d)+i()+c.repeatVaryingDecls()+k(a,b,"emissive")+c.beginPixelShaderMain()+l(a,"emissive")+c.endPixelShaderMain("emissive")+c.entryPoints()+c.matrixLoadOrder()},n=function(a,b){b.push("lambert");return h()+j()+w(a,!0,!1)+c.beginVertexShaderMain()+c.buildUVPassthroughs(a)+q()+r()+s()+u()+c.endVertexShaderMain()+c.pixelShaderHeader(a,!0,!1)+i()+c.repeatVaryingDecls()+k(a,b,"emissive")+k(a,b,"ambient")+k(a,b,"diffuse")+k(a,b,"bump",!1)+c.utilityFunctions()+c.beginPixelShaderMain()+l(a,"emissive")+l(a,"ambient")+l(a,"diffuse")+v()+"  "+c.FLOAT3+" surfaceToLight = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToLight);\n"+"  "+c.FLOAT4+" litR = lit(dot(normal, surfaceToLight), 0.0, 0.0);\n"+c.endPixelShaderMain(c.FLOAT4+"((emissive +\n"+"      lightColor *"+" (ambient * diffuse + diffuse * litR.y)).rgb,\n"+"          diffuse.a)")+c.entryPoints()+c.matrixLoadOrder()},o=function(a,b){b.push("phong");return h()+j()+w(a,!0,!0)+c.beginVertexShaderMain()+c.buildUVPassthroughs(a)+q()+r()+s()+t()+u()+c.endVertexShaderMain()+c.pixelShaderHeader(a,!0,!0)+i()+c.repeatVaryingDecls()+k(a,b,"emissive")+k(a,b,"ambient")+k(a,b,"diffuse")+k(a,b,"specular")+k(a,b,"bump",!1)+"uniform float shininess;\n"+"uniform float specularFactor;\n"+c.utilityFunctions()+c.beginPixelShaderMain()+l(a,"emissive")+l(a,"ambient")+l(a,"diffuse")+l(a,"specular")+v()+"  "+c.FLOAT3+" surfaceToLight = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToLight);\n"+"  "+c.FLOAT3+" surfaceToView = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToView);\n"+"  "+c.FLOAT3+" halfVector = normalize(surfaceToLight + "+c.PIXEL_VARYING_PREFIX+"surfaceToView);\n"+"  "+c.FLOAT4+" litR = lit(dot(normal, surfaceToLight), \n"+"                    dot(normal, halfVector), shininess);\n"+c.endPixelShaderMain(c.FLOAT4+"((emissive +\n"+"  lightColor *"+" (ambient * diffuse + diffuse * litR.y +\n"+"                        specular * litR.z *"+" specularFactor)).rgb,\n"+"      diffuse.a)")+c.entryPoints()+c.matrixLoadOrder()},p=function(a,b){b.push("phong");return h()+j()+w(a,!0,!0)+c.beginVertexShaderMain()+c.buildUVPassthroughs(a)+q()+r()+s()+t()+u()+c.endVertexShaderMain()+c.pixelShaderHeader(a,!0,!0)+i()+c.repeatVaryingDecls()+k(a,b,"emissive")+k(a,b,"ambient")+k(a,b,"diffuse")+k(a,b,"specular")+k(a,b,"bump",!1)+"uniform float shininess;\n"+"uniform float specularFactor;\n"+c.utilityFunctions()+c.beginPixelShaderMain()+l(a,"emissive")+l(a,"ambient")+l(a,"diffuse")+l(a,"specular")+v()+"  "+c.FLOAT3+" surfaceToLight = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToLight);\n"+"  "+c.FLOAT3+" surfaceToView = normalize("+c.PIXEL_VARYING_PREFIX+"surfaceToView);\n"+"  "+c.FLOAT3+" halfVector = normalize(surfaceToLight + surfaceToView);\n"+"  "+c.FLOAT4+" litR = lit(dot(normal, surfaceToLight), \n"+"                    dot(normal, halfVector), shininess);\n"+c.endPixelShaderMain(c.FLOAT4+"((emissive +\n"+"  lightColor * (ambient * diffuse + diffuse * litR.y +\n"+"                        specular * litR.z *"+" specularFactor)).rgb,\n"+"      diffuse.a)")+c.entryPoints()+c.matrixLoadOrder()},q=function(){return"  "+c.VERTEX_VARYING_PREFIX+"position = "+c.mul(c.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n"},r=function(){return"  "+c.VERTEX_VARYING_PREFIX+"normal = "+c.mul(c.FLOAT4+"("+c.ATTRIBUTE_PREFIX+"normal, 0)","worldInverseTranspose")+".xyz;\n"},s=function(){return"  "+c.VERTEX_VARYING_PREFIX+"surfaceToLight = lightWorldPos - \n"+"                          "+c.mul(c.ATTRIBUTE_PREFIX+"position","world")+".xyz;\n"},t=function(){return"  "+c.VERTEX_VARYING_PREFIX+"surfaceToView = (viewInverse[3] - "+c.mul(c.ATTRIBUTE_PREFIX+"position","world")+").xyz;\n"},u=function(a){return d?"  "+c.VERTEX_VARYING_PREFIX+"binormal = "+c.mul(c.FLOAT4+"("+c.ATTRIBUTE_PREFIX+"binormal, 0)","worldInverseTranspose")+".xyz;\n"+"  "+c.VERTEX_VARYING_PREFIX+"tangent = "+c.mul(c.FLOAT4+"("+c.ATTRIBUTE_PREFIX+"tangent, 0)","worldInverseTranspose")+".xyz;\n":""},v=function(){return d?"  "+c.MATRIX3+" tangentToWorld = "+c.MATRIX3+"("+c.PIXEL_VARYING_PREFIX+"tangent,\n"+"                                   "+c.PIXEL_VARYING_PREFIX+"binormal,\n"+"                                   "+c.PIXEL_VARYING_PREFIX+"normal);\n"+"  "+c.FLOAT3+" tangentNormal = "+c.TEXTURE+"2D"+"(bumpSampler, "+c.PIXEL_VARYING_PREFIX+"bumpUV.xy).xyz -\n"+"                       "+c.FLOAT3+"(0.5, 0.5, 0.5);\n"+"  "+c.FLOAT3+" normal = "+c.mul("tangentNormal","tangentToWorld")+";\n"+"normal = normalize(normal);\n":"  "+c.FLOAT3+" normal = normalize("+c.PIXEL_VARYING_PREFIX+"normal);\n"},w=function(a,b,e){return c.buildAttributeDecls(a,b,e,d)+c.buildVaryingDecls(a,b,e,d)},x,y=[];if(b=="phong")x=p(a,y);else if(b=="lambert")x=n(a,y);else if(b=="blinn")x=o(a,y);else if(b=="constant")x=m(a,y);else throw'unknown effect type "'+b+'"';return{description:y.join("_"),shader:x}},o3djs.effect.getStandardShader=function(a,b,c){var d=o3djs.effect.buildStandardShaderString(b,c),e=a.getObjectsByClassName("o3d.Effect");for(var f=0;f<e.length;++f)if(e[f].name==d.description&&e[f].source==d.shader)return e[f];var g=a.createObject("Effect");if(g){g.name=d.description;if(g.loadFromFXString(d.shader))return g;a.removeObject(g)}return null},o3djs.effect.attachStandardShader=function(a,b,c,d){var e=o3djs.effect.getStandardShader(a,b,d);if(e){b.effect=e,e.createUniformParameters(b);var f=b.getParam("lightWorldPos");f&&!f.inputConnection&&(f.value=c);var f=b.getParam("lightColor");f&&!f.inputConnection&&(f.value=[1,1,1,1]);return!0}return!1},o3djs.effect.createUniformParameters=function(a,b,c){b.createUniformParameters(c);var d=b.getParameterInfo();for(var e=0;e<d.length;++e){var f=d[e];if(f.sasClassName.length==0)if(f.numElements>0){var g=a.createObject("ParamArray"),h=c.getParam(f.name);h.value=g,g.resize(f.numElements,f.className);if(f.className=="o3d.ParamSampler")for(var i=0;i<f.numElements;++i){var j=a.createObject("Sampler");g.getParam(i).value=j}}else if(f.className=="o3d.ParamSampler"){var j=a.createObject("Sampler"),h=c.getParam(f.name);h.value=j}}},o3djs.effect.createCheckerEffect=function(a){var b=a.getObjects(o3djs.effect.TWO_COLOR_CHECKER_EFFECT_NAME,"o3d.Effect");if(b.length>0)return b[0];var c=a.createObject("Effect");c.loadFromFXString(o3djs.effect.TWO_COLOR_CHECKER_FXSTRING),c.name=o3djs.effect.TWO_COLOR_CHECKER_EFFECT_NAME;return c},o3djs.effect.setLanguage("o3d"),o3djs.provide("o3djs.util"),o3djs.util=o3djs.util||{},o3djs.util.PLUGIN_NAME="O3D Plugin",o3djs.util.REQUIRED_VERSION="0.1.42.4",o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE=200,o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE=200,o3djs.util.PLUGIN_DOWNLOAD_URL="http://tools.google.com/dlpage/o3d",o3djs.util.rendererInitStatus={NO_PLUGIN:-1,UNINITIALIZED:0,SUCCESS:1,OUT_OF_RESOURCES:2,GPU_NOT_UP_TO_SPEC:3,INITIALIZATION_ERROR:4},o3djs.util.curry=function(a){var b=[];for(var c=1;c<arguments.length;++c)b.push(arguments[c]);return function(){var c=b.slice();for(var d=0;d<arguments.length;++d)c.push(arguments[d]);return a.apply(this,c)}},o3djs.util.getCurrentURI=function(){var a=window.location.href,b=a.lastIndexOf("/");return a.substring(0,b+1)},o3djs.util.getAbsoluteURI=function(a){return o3djs.util.getCurrentURI()+a},o3djs.util.arrayContains=function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1},o3djs.util.getTransformsInTreeByTags=function(a,b){var c=b.split(","),d=a.getTransformsInTree(),e=[];for(var f=0;f<d.length;f++){var g=d[f].getParam("collada.tags");if(g){var h=g.value.split(",");for(var i=0;i<h.length;i++)if(o3djs.util.arrayContains(c,h[i])){e[e.length]=d[f];break}}}return e},o3djs.util.getTransformsInTreeByPrefix=function(a,b){var c=[],d=a.getTransformsInTree();for(var e=0;e<d.length;e++){var f=d[e];f.name.indexOf(b)==0&&(c[c.length]=f)}return c},o3djs.util.getBoundingBoxOfTree=function(a){var b=a.boundingBox;if(b.valid)return b;var c=o3djs.base.o3d,d=a.children;for(var e=0;e<d.length;++e){var f=d[e],g=o3djs.util.getBoundingBoxOfTree(f);g.valid&&(b.valid?b=b.add(g):b=g)}var h=a.shapes;for(var e=0;e<h.length;++e){var i=h[e].elements;for(var j=0;j<i.length;++j){var k=i[j].boundingBox;k.valid||(k=i[j].getBoundingBox(0)),b.valid?b=b.add(k):b=k}}return b},o3djs.util.getPowerOfTwoSize=function(a){var b=1;a=a-1;while(a)a=a>>1,b=b<<1;return b},o3djs.util.getPluginVersion=function(){var a=null,b=null;if(navigator.plugins!=null&&navigator.plugins.length>0){var c=navigator.plugins[o3djs.util.PLUGIN_NAME];c&&(b=c.description)}else if(o3djs.base.IsMSIE())try{var d=new ActiveXObject("o3d_host.O3DHostControl");b=d.description}catch(e){}if(b){var f=/.*version:\s*(\d+)\.(\d+)\.(\d+)\.(\d+).*/,g=f.exec(b);g&&g.length==5&&(a=""+parseInt(g[1],10)+"."+parseInt(g[2],10)+"."+parseInt(g[3],10)+"."+parseInt(g[4],10))}return a},o3djs.util.requiredVersionAvailable=function(a){var b=o3djs.util.getPluginVersion();if(!b)return!1;var c=b.split("."),d=a.split(".");if(d.length>4)throw Error("requiredVersion has more than 4 parts!");for(var e=0;e<d.length;++e){var f=parseInt(c[e],10),g=parseInt(d[e],10);if(f<g)return!1;if(f>g)return!0}return!0},o3djs.util.getElementsByTagAndId=function(a,b){var c=[],d=document.getElementsByTagName(a);for(var e=0;e<d.length;++e){var f=d[e];f.id&&f.id.match(b)&&c.push(f)}return c},o3djs.util.getO3DContainerElements=function(a,b){var c=b||"div",d=a||"^o3d";return o3djs.util.getElementsByTagAndId(c,d)},o3djs.util.offerPlugin=function(a,b){var c=o3djs.util.requiredVersionAvailable(""),d=o3djs.util.getO3DContainerElements(a,b),e=!1,f=c?"This page requires a newer version of the O3D plugin.":"This page requires the O3D plugin to be installed.",g='<div style="background: lightblue; width: 100%; height: 100%; text-align:center;"><br/><br/>'+f+"<br/>"+'<a href="'+o3djs.util.PLUGIN_DOWNLOAD_URL+'">Click here to download.</a>'+"</div>";for(var h=0;h<d.length;++h){var i=d[h];i.clientWidth>=o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE&&i.clientHeight>=o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE&&i.style.display.toLowerCase()!="none"&&i.style.visibility.toLowerCase()!="hidden"&&(e=!0,i.innerHTML=g)}e||confirm(f+"\n\nClick OK to download.")&&(window.location=o3djs.util.PLUGIN_DOWNLOAD_URL)},o3djs.util.informNoGraphics=function(a,b,c,d){var e=o3djs.util.getO3DContainerElements(c,d),f=!1,g,h,i="",j=function(){},k=function(a){var b="";a.length>0&&(b="<br/><br/><div>More Info:<br/>"+a+"</div>");return b};a==o3djs.util.rendererInitStatus.GPU_NOT_UP_TO_SPEC?(g="We are terribly sorry but it appears your graphics card is not able to run o3d. We are working on a solution.",h='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+g+'<br/><br/><a href="'+o3djs.util.PLUGIN_DOWNLOAD_URL+'">Click Here to go the O3D website</a>'+k(b)+"</div>",i="\n\nClick OK to go to the o3d website.",j=function(){window.location=o3djs.util.PLUGIN_DOWNLOAD_URL}):a==o3djs.util.rendererInitStatus.OUT_OF_RESOURCES?(g="Your graphics system appears to be out of resources. Try closing some applications and then refreshing this page.",h='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+g+k(b)+"</div>"):(g="A unknown error has prevented O3D from starting. Try downloading new drivers or checking for OS updates.",h='<div style="background: lightgray; width: 100%; height: 100%; text-align: center;"><br/><br/>'+g+k(b)+"</div>");for(var l=0;l<e.length;++l){var m=e[l];m.clientWidth>=o3djs.util.MINIMUM_WIDTH_FOR_MESSAGE&&m.clientHeight>=o3djs.util.MINIMUM_HEIGHT_FOR_MESSAGE&&m.style.display.toLowerCase()!="none"&&m.style.visibility.toLowerCase()!="hidden"&&(f=!0,m.innerHTML=h)}f||confirm(g+i)&&j()},o3djs.util.informPluginFailure=function(a,b,c,d){a==o3djs.util.rendererInitStatus.NO_PLUGIN?o3djs.util.offerPlugin(c,d):o3djs.util.informNoGraphics(a,b,c,d)},o3djs.util.getElementContentById=function(a){o3djs.BROWSER_ONLY=!0;var b=document.getElementById(a);if(!b)throw"getElementContentById could not find node with id "+a;switch(b.tagName){case"TEXTAREA":return b.value;case"SCRIPT":return b.text;default:throw"getElementContentById does not no how to get content from a "+b.tagName+" element"}},o3djs.util.getElementById=function(a){o3djs.BROWSER_ONLY=!0;return document.getElementById(a)},o3djs.util.Engine={BROWSER:0,V8:1},o3djs.util.mainEngine_=o3djs.util.Engine.BROWSER,o3djs.util.setMainEngine=function(a){a==o3djs.util.Engine.V8&&!o3djs_isV8Supported()&&(a=o3djs.util.Engine.BROWSER),o3djs.util.mainEngine_=a},o3djs.util.fixFunctionString_=/^\s*function\s+[^\s]+\s*\(([^)]*)\)/,o3djs.util.callV8=function(a,b,c,d){var e=b.toString();e=e.replace(o3djs.util.fixFunctionString_,"function($1)");var f="function(thisArg, args) {\n  var localArgs = [];\n  var numArgs = args.length;\n  for (var i = 0; i < numArgs; ++i) {\n    localArgs.push(args[i]);\n  }\n  var func = "+e+";\n"+"  return func.apply(thisArg, localArgs);\n"+"}\n",g=a.eval(f);return g(c,d)},o3djs.util.stripDotDot_=/\/[^\/]+\/\.\./,o3djs.util.toAbsoluteUri=function(a){if(a.indexOf("://")==-1){var b=document.location.toString(),c=b.lastIndexOf("/");c!=-1&&(b=b.substring(0,c)),a=b+"/"+a}do{var d=a;a=a.replace(o3djs.util.stripDotDot_,"")}while(d!==a);return a},o3djs.util.scriptUris_=[],o3djs.util.addScriptUri=function(a){o3djs.util.scriptUris_.push(o3djs.util.toAbsoluteUri(a))},o3djs.util.isScriptUri=function(a){a=o3djs.util.toAbsoluteUri(a);for(var b=0;b<o3djs.util.scriptUris_.length;++b){var c=o3djs.util.scriptUris_[b];if(a.substring(0,c.length)===c)return!0}return!1},o3djs.util.isWantedScriptTag_=function(a){return a.id&&a.id.match(/^o3dscript/)},o3djs.util.getScriptTagText_=function(){var a="",b=document.getElementsByTagName("script");for(var c=0;c<b.length;++c){var d=b[c];if(d.type===""||d.type==="text/javascript")"text"in d&&d.text&&o3djs.util.isWantedScriptTag_(d)&&(a+=d.text),"src"in d&&d.src&&o3djs.util.isScriptUri(d.src)&&(a+=o3djs.io.loadTextFileSynchronous(d.src))}return a},o3djs.util.createClient=function(a,b,c){b=b||"",c=c||o3djs.util.REQUIRED_VERSION;if(!o3djs.util.requiredVersionAvailable(c))return null;b+=(b?",":"")+"APIVersion="+c;var d;o3djs.base.IsMSIE()?(a.innerHTML='<OBJECT WIDTH="100%" HEIGHT="100%"CLASSID="CLSID:9666A772-407E-4F90-BC37-982E8160EB2D"><PARAM name="o3d_features" value="'+b+'"/>'+"</OBJECT>",d=a.childNodes[0]):(d=document.createElement("object"),d.type="application/vnd.o3d.auto",d.style.width="100%",d.style.height="100%",d.setAttribute("o3d_features",b),a.appendChild(d)),d.client.clientInfo.glsl&&o3djs.effect.setLanguage("glsl");return d},o3djs.util.makeClients=function(a,b,c,d,e,f){d=d||o3djs.util.informPluginFailure,c=c||o3djs.util.REQUIRED_VERSION;if(!o3djs.util.requiredVersionAvailable(c))d(o3djs.util.rendererInitStatus.NO_PLUGIN,"",e,f);else{var g=[],h=o3djs.util.getO3DContainerElements(e,f),i=null;for(var j=0;j<h.length;++j){var k=h[j],l=b;if(!l){var m=k.getAttribute("o3d_features");m?l=m:l=""}var n=o3djs.util.createClient(k,l);g.push(n),k.id==="o3d"&&(i=n)}var o=window.setInterval(function(){var b=0,c="",h;for(var j=0;j<g.length;++j){var k=g[j];h=k.o3d;var l=h&&k.client&&k.client.rendererInitStatus>o3djs.util.rendererInitStatus.UNINITIALIZED;if(!l)return;var m=g[j].client.rendererInitStatus;m>b&&(b=m,c=g[j].client.lastError)}window.clearInterval(o);if(b>0&&b!=h.Renderer.SUCCESS){for(var j=0;j<g.length;++j){var n=g[j];n.parentNode.removeChild(n)}d(b,c,e,f)}else{o3djs.base.snapshotProvidedNamespaces();for(var j=0;j<g.length;++j)o3djs_isV8Supported()&&o3djs.base.initV8(g[j]),o3djs.event.startKeyboardEventSynthesis(g[j]),o3djs.error.setDefaultErrorHandler(g[j].client);o3djs.base.init(g[0]);switch(o3djs.util.mainEngine_){case o3djs.util.Engine.BROWSER:a(g);break;case o3djs.util.Engine.V8:if(!i)throw'V8 engine was requested but there is no element with the id "o3d"';var p=o3djs.util.getScriptTagText_();i.eval(p),o3djs.util.callV8(i,a,o3djs.global,[g]);break;default:throw"Unknown engine "+o3djs.util.mainEngine_}}},10)}},o3djs.provide("o3djs.webgl"),o3djs.webgl=o3djs.webgl||{},o3djs.webgl.makeClients=function(a,b,c,d,e,f,g){d=d||o3djs.webgl.informPluginFailure;var h=[],i=o3djs.util.getO3DContainerElements(e,f);for(var j=0;j<i.length;++j){var k=i[j],l=b;if(!l){var m=k.getAttribute("o3d_features");m?l=m:l=""}var n=o3djs.webgl.createClient(k,l,g);if(!n)return;h.push(n)}var o=window.setInterval(function(){for(var b=0;b<h.length;++b){var c=h[b];if(!c.sizeInitialized_)return}window.clearInterval(o),a(h)})},o3djs.webgl.createGLErrorWrapper=function(a,b){return function(){var c=a[b].apply(a,arguments),d=a.getError();if(d!=0)throw"GL error "+d+" in "+b;return c}},o3djs.webgl.addDebuggingWrapper=function(a){var b={};for(var c in a)typeof a[c]=="function"?b[c]=o3djs.webgl.createGLErrorWrapper(a,c):b[c]=a[c];b.getError=function(){return a.getError()};return b},o3djs.webgl.webGlCanvasError=function(a,b){var c=document.createElement("div");c.style.backgroundColor="#ccffff",c.style.textAlign="center",c.style.margin="10px",c.style.width="100%",c.style.height="100%";var d='<br/><br/><a href="http://code.google.com/p/kuda/wiki/TroubleshootWebGL">Please check that WebGL is enabled or click here to troubleshoot</a><br/>';c.innerHTML=d,a.appendChild(c)},o3djs.webgl.createClient=function(a,b,c){b=b||"",c=c||!1,o3djs.effect.setLanguage("glsl");var d;d=document.createElement("canvas");if(!d||!d.getContext){o3djs.webgl.webGlCanvasError(a,"HTMLCanvas");return null}d.style.width="100%",d.style.height="100%";var e=new o3d.Client,f=function(){var a=Math.max(1,d.clientWidth),b=Math.max(1,d.clientHeight);d.width=a,d.height=b,d.sizeInitialized_=!0,e.gl&&(e.gl.displayInfo={width:d.width,height:d.height})};window.addEventListener("resize",f,!1),setTimeout(f,0);if(!e.initWithCanvas(d)){o3djs.webgl.webGlCanvasError(a,"WebGL context");return null}d.client=e,d.o3d=o3d,c&&(e.gl=o3djs.webgl.addDebuggingWrapper(e.gl)),a.appendChild(d);return d},o3djs.provide("o3djs.debug");var O3D_DEBUG_PREFIX="o3dDebug_",O3D_DEBUG_PREFIX_LENGTH=O3D_DEBUG_PREFIX.length,O3D_DEBUG_COLOR_PARAM_NAME=O3D_DEBUG_PREFIX+"Color",O3D_DEBUG_VECTOR_SCALE_PARAM_NAME=O3D_DEBUG_PREFIX+"VectorScale",O3D_DEBUG_AXIS_SHAPE_NAME=O3D_DEBUG_PREFIX+"AxisShape",O3D_DEBUG_LINE_SHAPE_NAME=O3D_DEBUG_PREFIX+"LineShape",O3D_DEBUG_SPHERE_SHAPE_NAME=O3D_DEBUG_PREFIX+"SphereShape",O3D_DEBUG_CUBE_SHAPE_NAME=O3D_DEBUG_PREFIX+"CubeShape",O3D_DEBUG_AXIS_INFO_=[{offset:[1,0,0],color:[1,0,0,1]},{offset:[0,1,0],color:[0,1,0,1]},{offset:[0,0,1],color:[0,0,1,1]}];o3djs.debug.isDebugTransform=function(a){var b=a.name,c=b.length>=O3D_DEBUG_PREFIX_LENGTH&&b.substr(0,O3D_DEBUG_PREFIX_LENGTH)==O3D_DEBUG_PREFIX;return c},o3djs.debug.getDebugTransform_=function(a,b){if(a.name==b)return a;var c=a.children;for(var d=0;d<c.length;++d)if(c[d].name==b)return c[d];return null},o3djs.debug.createColorShaders_=function(a){var b=o3djs.effect,c="uniform "+b.MATRIX4+" worldViewProjection"+b.semanticSuffix("WORLDVIEWPROJECTION")+";\n"+b.BEGIN_IN_STRUCT+b.ATTRIBUTE+b.FLOAT4+" position"+b.semanticSuffix("POSITION")+";\n"+b.END_STRUCT+b.BEGIN_OUT_STRUCT+b.VARYING+b.FLOAT4+" "+b.VARYING_DECLARATION_PREFIX+"position"+b.semanticSuffix("POSITION")+";\n"+b.END_STRUCT+b.beginVertexShaderMain()+"  "+b.VERTEX_VARYING_PREFIX+"position = "+b.mul(b.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n"+b.endVertexShaderMain()+b.pixelShaderHeader()+"uniform "+b.FLOAT4+" "+a+";\n"+b.beginPixelShaderMain()+b.endPixelShaderMain(a)+b.entryPoints()+b.matrixLoadOrder();return c},o3djs.debug.createScaleShaders_=function(a,b){var c=o3djs.effect,d="uniform "+c.FLOAT3+" "+b+";\n"+"uniform "+c.MATRIX4+" worldViewProjection"+c.semanticSuffix("WORLDVIEWPROJECTION")+";\n"+c.BEGIN_IN_STRUCT+c.ATTRIBUTE+c.FLOAT4+" position"+c.semanticSuffix("POSITION")+";\n"+c.END_STRUCT+c.BEGIN_OUT_STRUCT+c.VARYING+c.FLOAT4+" "+c.VARYING_DECLARATION_PREFIX+"position"+c.semanticSuffix("POSITION")+";\n"+c.END_STRUCT+c.beginVertexShaderMain()+"  "+c.FLOAT4+" position = "+c.FLOAT4+"(\n"+"    "+c.ATTRIBUTE_PREFIX+"position.x * "+b+".x,\n"+"    "+c.ATTRIBUTE_PREFIX+"position.y * "+b+".y,\n"+"    "+c.ATTRIBUTE_PREFIX+"position.z * "+b+".z,\n"+"    1);\n"+"  "+c.VERTEX_VARYING_PREFIX+"position = "+c.mul("position","worldViewProjection")+";\n"+c.endVertexShaderMain()+c.pixelShaderHeader()+"uniform "+c.FLOAT4+" "+a+";\n"+c.beginPixelShaderMain()+c.endPixelShaderMain(a)+c.entryPoints()+c.matrixLoadOrder();return d},o3djs.debug=o3djs.debug||{},o3djs.debug.DebugLine=function(a){this.debugLineGroup_=a;var b=a.getPack();this.transform_=b.createObject("Transform"),this.transform_.name=O3D_DEBUG_LINE_SHAPE_NAME,this.transform_.addShape(a.getLineShape()),this.start_=[0,0,0],this.end_=[0,0,0],this.colorParam_=this.transform_.createParam(O3D_DEBUG_COLOR_PARAM_NAME,"ParamFloat4"),this.colorParam_.value=a.getColor()},o3djs.debug.DebugLine.prototype.destroy=function(){this.transform_.parent=null,this.debugLineGroup_.getPack().removeObject(this.transform_)},o3djs.debug.DebugLine.prototype.getId=function(){return this.transform_.clientId},o3djs.debug.DebugLine.prototype.update_=function(){var a=o3djs.math,b=a.subVector(this.end_,this.start_),c=a.normalize(b),d=a.dot(c,[0,1,0]),e,f;d>.99?(f=a.cross([1,0,0],c),e=a.cross(f,c)):(e=a.cross([0,1,0],c),f=a.cross(e,c)),this.transform_.localMatrix=[f.concat(0),c.concat(0),e.concat(0),this.start_.concat(1)],this.transform_.scale(1,a.length(b),1)},o3djs.debug.DebugLine.prototype.setEndPoints=function(a,b){this.start_=a,this.end_=b,this.update_()},o3djs.debug.DebugLine.prototype.setStart=function(a){this.start_=a,this.update_()},o3djs.debug.DebugLine.prototype.setEnd=function(a){this.end_=a,this.update_()},o3djs.debug.DebugLine.prototype.setColor=function(a){this.colorParam_.value=a},o3djs.debug.DebugLine.prototype.setVisible=function(a){this.transform_.parent=a?this.debugLineGroup_.getRoot():null},o3djs.debug.DebugLine.prototype.remove=function(){this.transform_.parent=null,this.debugLineGroup_.remove(this)},o3djs.debug.DebugLineGroup=function(a,b){this.currentColor_=[1,1,1,1],this.lineTransforms_={},this.freeLineTransforms_={},this.debugHelper_=a,this.root_=b},o3djs.debug.DebugLineGroup.prototype.getRoot=function(){return this.root_},o3djs.debug.DebugLineGroup.prototype.getPack=function(){return this.debugHelper_.getPack()},o3djs.debug.DebugLineGroup.prototype.getLineShape=function(){return this.debugHelper_.getLineShape()},o3djs.debug.DebugLineGroup.prototype.getColor=function(){return this.currentColor_},o3djs.debug.DebugLineGroup.prototype.setColor=function(a){this.currentColor_=a},o3djs.debug.DebugLineGroup.prototype.getLine_=function(){for(var a in this.freeLineTransforms_){var b=a,c=this.freeLineTransforms_[b];delete this.freeLineTransforms_[b];return c}return new o3djs.debug.DebugLine(this)},o3djs.debug.DebugLineGroup.prototype.addLine=function(a,b,c){var d=this.getLine_();d.setEndPoints(a||[0,0,0],b||[0,0,0]),d.setColor(c||this.currentColor_),d.setVisible(!0),this.lineTransforms_[d.getId()]=d;return d},o3djs.debug.DebugLineGroup.prototype.clear=function(){for(var a in this.lineTransforms_){var b=a,c=this.lineTransforms_[b];c.setVisible(!1),this.freeLineTransforms_[b]=c}this.lineTransforms_={}},o3djs.debug.DebugLineGroup.prototype.destroy=function(){this.clear();for(var a in this.freeLineTransforms_){var b=a;this.freeLineTransforms_[b].destroy()}this.freeLineTransforms_={}},o3djs.debug.DebugLineGroup.prototype.remove=function(a){var b=a.getId();delete this.lineTransforms_[b],this.freeLineTransforms_[b]=a},o3djs.debug.DebugHelper=function(a,b){this.pack_=a,this.viewInfo_=b,this.axisPrimitives_=[],this.axisShape_=a.createObject("Shape"),this.axisShape_.name=O3D_DEBUG_AXIS_SHAPE_NAME,this.lineShape_=a.createObject("Shape"),this.lineShape_.name=O3D_DEBUG_LINE_SHAPE_NAME;var c=a.createObject("Effect"),d=o3djs.debug.createScaleShaders_(O3D_DEBUG_COLOR_PARAM_NAME,O3D_DEBUG_VECTOR_SCALE_PARAM_NAME);c.loadFromFXString(d);var e=a.createObject("Material");e.effect=c,e.drawList=b.performanceDrawList,c.createUniformParameters(e),e.getParam(O3D_DEBUG_COLOR_PARAM_NAME).value=[1,1,1,1],e.getParam(O3D_DEBUG_VECTOR_SCALE_PARAM_NAME).value=[1,1,1];for(var f=0;f<O3D_DEBUG_AXIS_INFO_.length;++f){var g=O3D_DEBUG_AXIS_INFO_[f],h=o3djs.primitives.createCube(a,e,1,[[1,0,0,0],[0,1,0,0],[0,0,1,0],[g.offset[0]*.5,g.offset[1]*.5,g.offset[2]*.5,1]]),i=h.elements[0];i.owner=this.axisShape_,a.removeObject(h),i.createParam(O3D_DEBUG_COLOR_PARAM_NAME,"ParamFloat4").value=g.color,i.createParam(O3D_DEBUG_VECTOR_SCALE_PARAM_NAME,"ParamFloat3"),this.axisPrimitives_[f]=i}this.axisMaterial_=e,this.setAxisScale(10,1);var c=a.createObject("Effect"),d=o3djs.debug.createColorShaders_(O3D_DEBUG_COLOR_PARAM_NAME);c.loadFromFXString(d);var e=a.createObject("Material");e.effect=c,e.drawList=b.performanceDrawList,c.createUniformParameters(e),e.getParam(O3D_DEBUG_COLOR_PARAM_NAME).value=[1,1,1,1];var j=[0,0,0,0,1,0],k=a.createObject("StreamBank"),l=a.createObject("Primitive"),m=a.createObject("Shape"),n=a.createObject("VertexBuffer"),o=n.createField("FloatField",3);n.set(j),l.owner=m,l.createDrawElement(a,null),l.streamBank=k,l.material=e,l.numberVertices=2,l.numberPrimitives=1,l.primitiveType=o3djs.base.o3d.Primitive.LINELIST,k.setVertexStream(o3djs.base.o3d.Stream.POSITION,0,o,0),this.lineShape_=m,this.lineShape_.name=O3D_DEBUG_LINE_SHAPE_NAME,this.lineMaterial_=e,this.sphereShape_=o3djs.lineprimitives.createLineSphere(a,this.axisMaterial_,.5,8,8),this.sphereShape_.name=O3D_DEBUG_SPHERE_SHAPE_NAME;var l=this.sphereShape_.elements[0];this.sphereScaleParam_=l.createParam(O3D_DEBUG_VECTOR_SCALE_PARAM_NAME,"ParamFloat3").value=[1,1,1],this.cubeShape_=o3djs.lineprimitives.createLineCube(a,this.axisMaterial_,1),this.cubeShape_.name=O3D_DEBUG_CUBE_SHAPE_NAME;var l=this.cubeShape_.elements[0];this.cubeScaleParam_=l.createParam(O3D_DEBUG_VECTOR_SCALE_PARAM_NAME,"ParamFloat3").value=[1,1,1]},o3djs.debug.DebugHelper.prototype.getPack=function(){return this.pack_},o3djs.debug.DebugHelper.prototype.getLineShape=function(){return this.lineShape_},o3djs.debug.DebugHelper.prototype.setAxisScale=function(a,b){for(var c=0;c<O3D_DEBUG_AXIS_INFO_.length;++c){var d=O3D_DEBUG_AXIS_INFO_[c];this.axisPrimitives_[c].getParam(O3D_DEBUG_VECTOR_SCALE_PARAM_NAME).value=[d.offset[0]?a:b,d.offset[1]?a:b,d.offset[2]?a:b]}},o3djs.debug.DebugHelper.prototype.createShape_=function(a,b){var c=this.getPack().createObject("Transform");c.name=b.name,c.addShape(b),c.parent=this.viewInfo_.treeRoot,c.translate(a);return c},o3djs.debug.DebugHelper.prototype.addShape_=function(a,b){var c=o3djs.debug.getDebugTransform_(a,b.name);if(!c){var c=this.getPack().createObject("Transform");c.name=b.name,c.addShape(b),c.parent=a}},o3djs.debug.DebugHelper.prototype.removeShape_=function(a,b){var c=b.name,d=o3djs.debug.getDebugTransform_(a,b.name);d&&(d.parent=null,this.getPack().removeObject(d))},o3djs.debug.DebugHelper.prototype.addShapes_=function(a,b){this.addShape_(a,b);var c=a.children;for(var d=0;d<c.length;++d){var e=c[d];o3djs.debug.isDebugTransform(e)||this.addShapes_(e,b)}},o3djs.debug.DebugHelper.prototype.removeShapes_=function(a,b){this.removeShape_(a,b);var c=a.children;for(var d=0;d<c.length;++d){var e=c[d];o3djs.debug.isDebugTransform(e)||this.removeShapes_(e,b)}},o3djs.debug.DebugHelper.prototype.addSetDebugTransformParam_=function(a,b,c,d,e){var f=o3djs.debug.getDebugTransform_(a,b);if(f){var g=f.getParam(c);g||(g=f.createParam(c,d)),g.value=e}},o3djs.debug.DebugHelper.prototype.addAxis=function(a){this.addShape_(a,this.axisShape_)},o3djs.debug.DebugHelper.prototype.removeAxis=function(a){this.removeShape_(a,this.axisShape_)},o3djs.debug.DebugHelper.prototype.addAxes=function(a){this.addShapes_(a,this.axisShape_)},o3djs.debug.DebugHelper.prototype.removeAxes=function(a){this.removeShapes_(a,this.axisShape_)},o3djs.debug.DebugHelper.prototype.setAxisColor=function(a,b){this.addSetDebugTransformParam_(a,O3D_DEBUG_AXIS_SHAPE_NAME,O3D_DEBUG_COLOR_PARAM_NAME,"ParamFloat4",b)},o3djs.debug.DebugHelper.prototype.clearAxisColor=function(a){var b=o3djs.debug.getDebugTransform_(a,O3D_DEBUG_AXIS_SHAPE_NAME);if(b){var c=b.getParam(O3D_DEBUG_COLOR_PARAM_NAME);c&&b.removeParam(c)}},o3djs.debug.DebugHelper.prototype.createSphere=function(a,b,c){var d=this.createShape_(a,this.sphereShape_);b&&this.setSphereColor(d,b),c&&this.setSphereScale(d,c);return d},o3djs.debug.DebugHelper.prototype.addSphere=function(a,b,c){this.addShape_(a,this.sphereShape_),b&&this.setSphereColor(a,b),c&&this.setSphereScale(a,c)},o3djs.debug.DebugHelper.prototype.removeSphere=function(a){this.removeShape_(a,this.sphereShape_)},o3djs.debug.DebugHelper.prototype.addSpheres=function(a){this.addShapes_(a,this.sphereShape_)},o3djs.debug.DebugHelper.prototype.removeSpheres=function(a){this.removeShapes_(a,this.sphereShape_)},o3djs.debug.DebugHelper.prototype.setSphereColor=function(a,b){this.addSetDebugTransformParam_(a,O3D_DEBUG_SPHERE_SHAPE_NAME,O3D_DEBUG_COLOR_PARAM_NAME,"ParamFloat4",b)},o3djs.debug.DebugHelper.prototype.setSphereScale=function(a,b){this.addSetDebugTransformParam_(a,O3D_DEBUG_SPHERE_SHAPE_NAME,O3D_DEBUG_VECTOR_SCALE_PARAM_NAME,"ParamFloat3",[b,b,b])},o3djs.debug.DebugHelper.prototype.createCube=function(a,b,c){var d=this.createShape_(a,this.cubeShape_);b&&this.setCubeColor(d,b),c&&this.setCubeScale(d,c);return d},o3djs.debug.DebugHelper.prototype.addCube=function(a,b,c){this.addShape_(a,this.cubeShape_),b&&this.setCubeColor(a,b),c&&this.setCubeScale(a,c)},o3djs.debug.DebugHelper.prototype.removeCube=function(a){this.removeShape_(a,this.cubeShape_)},o3djs.debug.DebugHelper.prototype.addCubes=function(a){this.addShapes_(a,this.cubeShape_)},o3djs.debug.DebugHelper.prototype.removeCubes=function(a){this.removeShapes_(a,this.cubeShape_)},o3djs.debug.DebugHelper.prototype.setCubeColor=function(a,b){this.addSetDebugTransformParam_(a,O3D_DEBUG_CUBE_SHAPE_NAME,O3D_DEBUG_COLOR_PARAM_NAME,"ParamFloat4",b)},o3djs.debug.DebugHelper.prototype.setCubeScale=function(a,b){this.addSetDebugTransformParam_(a,O3D_DEBUG_CUBE_SHAPE_NAME,O3D_DEBUG_VECTOR_SCALE_PARAM_NAME,"ParamFloat3",[b,b,b])},o3djs.debug.DebugHelper.prototype.createDebugLineGroup=function(a){return new o3djs.debug.DebugLineGroup(this,a)},o3djs.debug.createDebugHelper=function(a,b){return new o3djs.debug.DebugHelper(a,b)},o3djs.provide("o3djs.element"),o3djs.element=o3djs.element||{},o3djs.element.setBoundingBoxAndZSortPoint=function(a){var b=a.getBoundingBox(0),c=b.minExtent,d=b.maxExtent;a.boundingBox=b,a.cull=!0,a.zSortPoint=o3djs.math.divVectorScalar(o3djs.math.addVector(c,d),2)},o3djs.element.addMissingTexCoordStreams=function(a){if(a.isAClassName("o3d.Primitive")){var b=a.material,c=a.streamBank,d=o3djs.effect.getColladaLightingType(b);if(d){var e=o3djs.effect.getNumTexCoordStreamsNeeded(b),f=c.vertexStreams,g=null,h=0;for(var i=0;i<f.length;++i){var j=f[i];j.semantic==o3djs.base.o3d.Stream.TEXCOORD&&(g=j,++h)}for(var i=h;i<e;++i)c.setVertexStream(g.semantic,g.semanticIndex+i-h+1,g.field,g.startIndex)}}},o3djs.element.duplicateElement=function(a,b){var c=a.createObject(b.className);c.copyParams(b),b.isAClassName("o3d.Primitive")&&(c.indexBuffer=b.indexBuffer,c.startIndex=b.startIndex,c.primitiveType=b.primitiveType,c.numberVertices=b.numberVertices,c.numberPrimitives=b.numberPrimitives);return c},o3djs.element.getNormalForTriangle=function(a,b,c){var d=a.primitiveType;if(d!=o3djs.base.o3d.Primitive.TRIANGLELIST&&d!=o3djs.base.o3d.Primitive.TRIANGLESTRIP)throw"primitive is not a TRIANGLELIST or TRIANGLESTRIP";var e=a.indexBuffer,f=d==o3djs.base.o3d.Primitive.TRIANGLELIST?b*3:b+2,g;if(e){var h=e.fields[0];g=h.getAt(f,3)}else g=[f,f+1,f+2];var i=a.streamBank.getVertexStream(o3djs.base.o3d.Stream.NORMAL,0);if(i){var j=i.field,k=[0,0,0];for(var l=0;l<3;++l){var m=j.getAt(g[l],1);k=o3djs.math.addVector(k,m)}return o3djs.math.normalize(k)}var n=a.streamBank.getVertexStream(o3djs.base.o3d.Stream.POSITION,0);if(!n)throw"no POSITION,0 stream in primitive";var o=n.field,p=[];for(var l=0;l<3;++l)p[l]=o.getAt(g[l],1);var q=o3djs.math.normalize(o3djs.math.subVector(p[1],p[0])),r=o3djs.math.normalize(o3djs.math.subVector(p[2],p[1]));return c?o3djs.math.cross(r,q):o3djs.math.cross(q,r)},o3djs.provide("o3djs.event"),o3djs.event=o3djs.event||{},o3djs.event.appendWithSpace=function(a,b){return a.length==0?b:a+" "+b},o3djs.event.appendWithSpaceIf=function(a,b,c){return a?o3djs.event.appendWithSpace(b,c):b},o3djs.event.getModifierString=function(a,b,c,d){var e=o3djs.event.appendWithSpaceIf(a,"","Control");e=o3djs.event.appendWithSpaceIf(b,e,"Alt"),e=o3djs.event.appendWithSpaceIf(c,e,"Shift");return o3djs.event.appendWithSpaceIf(d,e,"Meta")},o3djs.event.padWithLeadingZeroes=function(a,b){while(a.length<b)a="0"+a;return a},o3djs.event.getKeyIdentifier=function(a,b){a||(a=b);switch(a){case 3:case 13:return"Enter";case 37:return"Left";case 39:return"Right";case 38:return"Up";case 40:return"Down"}a=a>=97&&a<=122?a-32:a;var c=a.toString(16).toUpperCase();return"U+"+o3djs.event.padWithLeadingZeroes(c,4)},o3djs.event.keyIdentifierToChar=function(a){if(a&&typeof a=="string"){switch(a){case"Enter":return 13;case"Left":return 37;case"Right":return 39;case"Up":return 38;case"Down":return 40}if(a.indexOf("U+")==0)return parseInt(a.substr(2).toUpperCase(),16)}return 0},o3djs.event.getEventKeyChar=function(a){a||(a=window.event);var b=0;a.keyIdentifier&&(b=o3djs.event.keyIdentifierToChar(a.keyIdentifier)),b||(b=window.event?window.event.keyCode:a.charCode),b||(b=a.keyCode);return b},o3djs.event.cancel=function(a){a||(a=window.event),a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()},o3djs.event.startKeyboardEventSynthesis=function(a){var b=function(b){o3djs.event.onKey(b,a)};o3djs.event.addEventListener(a,"keypress",b),o3djs.event.addEventListener(a,"keydown",b),o3djs.event.addEventListener(a,"keyup",b)},o3djs.event.onKey=function(a,b){var c=o3djs.event.createKeyEvent(a.type,a.charCode,a.keyCode,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey);c&&(b.parentNode.dispatchEvent?b.parentNode.dispatchEvent(c):b.fireEvent&&b.fireEvent("on"+a.type,c))},o3djs.event.createKeyEvent=function(a,b,c,d,e,f,g){var h,i=o3djs.event.getKeyIdentifier(b,c);document.createEvent?(h=document.createEvent("KeyboardEvent"),h.initKeyboardEvent?(h.initKeyboardEvent(a,!0,!0,window,i,0,d,e,f,g),h.charCode=b,a=="keypress"?h.keyCode=b:h.keyCode=c):h.initKeyEvent&&(h.initKeyEvent(a,!0,!0,window,d,e,f,g,c,b),h.keyIdentifier=i)):document.createEventObject&&(h=document.createEventObject(),h.ctrlKey=d,h.altKey=e,h.shiftKey=f,h.metaKey=g,h.keyCode=b,h.keyIdentifier=i),h.synthetic=!0;return h},o3djs.event.createEventHandler=function(a){return function(b){var c=a.length;for(var d=0;d<c;++d){var e=a[d];typeof e.handleEvent=="function"?e.handleEvent(b):e(b)}}},o3djs.event.addEventListener=function(a,b,c){if(!c||typeof b!="string"||typeof c!="function"&&typeof c.handleEvent!="function")throw new Error("Invalid argument.");a.o3d_eventRegistry=a.o3d_eventRegistry||[];var d=a.o3d_eventRegistry,e=d[b];if(!e||e.length==0)e=d[b]=[],a.client.setEventCallback(b,o3djs.event.createEventHandler(e));else for(var f in e)if(e[f]==c)return;e.push(c)},o3djs.event.removeEventListener=function(a,b,c){var d=a.o3d_eventRegistry;if(!!d){var e=d[b];if(!e)return;for(var f in e)if(e[f]==c){e.length==1&&a.client.clearEventCallback(b),e.splice(f,1);break}}},o3djs.provide("o3djs.loader"),o3djs.loader=o3djs.loader||{},o3djs.loader.Loader=function(a){this.count_=1,this.onFinished_=a,this.loadInfo=o3djs.io.createLoadInfo()},o3djs.loader.createLoader=function(a){return new o3djs.loader.Loader(a)},o3djs.loader.Loader.prototype.loadTexture=function(a,b,c){var d=this;++this.count_;var e=o3djs.io.loadTexture(a,b,function(a,b){c&&c(a,b),d.countDown_()});this.loadInfo.addChild(e)},o3djs.loader.Loader.prototype.loadRawData=function(a,b,c){var d=this;++this.count_;var e=o3djs.io.loadRawData(a,b,function(a,b,e){c(a,b,e),d.countDown_()});this.loadInfo.addChild(e)},o3djs.loader.Loader.prototype.loadBitmaps=function(a,b,c){var d=this;++this.count_;var e=o3djs.io.loadBitmaps(a,b,function(a,b){c(a,b),d.countDown_()});this.loadInfo.addChild(e)},o3djs.loader.Loader.prototype.loadScene=function(a,b,c,d,e,f){var g=this;++this.count_;var h=o3djs.scene.loadScene(a,b,c,d,function(a,b,c){e&&e(a,b,c),g.countDown_()},f);this.loadInfo.addChild(h)},o3djs.loader.Loader.prototype.loadTextFile=function(a,b){var c=this;++this.count_;var d=o3djs.io.loadTextFile(a,function(a,d){b(a,d),c.countDown_()});this.loadInfo.addChild(d)},o3djs.loader.Loader.prototype.createLoader=function(a){var b=this;++this.count_;var c=o3djs.loader.createLoader(function(){a(),b.countDown_()});this.loadInfo.addChild(c.loadInfo);return c},o3djs.loader.Loader.prototype.countDown_=function(){--this.count_,this.count_===0&&this.onFinished_()},o3djs.loader.Loader.prototype.finish=function(){this.countDown_()},o3djs.provide("o3djs.math"),o3djs.math=o3djs.math||{},o3djs.math.randomSeed_=0,o3djs.math.RANDOM_RANGE_=Math.pow(2,32),o3djs.math.matrix4=o3djs.math.matrix4||{},o3djs.math.rowMajor=o3djs.math.rowMajor||{},o3djs.math.columnMajor=o3djs.math.columnMajor||{},o3djs.math.errorCheck=o3djs.math.errorCheck||{},o3djs.math.errorCheckFree=o3djs.math.errorCheckFree||{},o3djs.math.Vector2=goog.typedef,o3djs.math.Vector3=goog.typedef,o3djs.math.Vector4=goog.typedef,o3djs.math.Vector=goog.typedef,o3djs.math.Matrix1=goog.typedef,o3djs.math.Matrix2=goog.typedef,o3djs.math.Matrix3=goog.typedef,o3djs.math.Matrix4=goog.typedef,o3djs.math.Matrix=goog.typedef,o3djs.math.pseudoRandom=function(){var a=o3djs.math;return(a.randomSeed_=(134775813*a.randomSeed_+1)%a.RANDOM_RANGE_)/a.RANDOM_RANGE_},o3djs.math.resetPseudoRandom=function(){o3djs.math.randomSeed_=0},o3djs.math.degToRad=function(a){return a*Math.PI/180},o3djs.math.radToDeg=function(a){return a*180/Math.PI},o3djs.math.lerpScalar=function(a,b,c){return(1-c)*a+c*b},o3djs.math.addVector=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e]+b[e];return c},o3djs.math.subVector=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e]-b[e];return c},o3djs.math.lerpVector=function(a,b,c){var d=[],e=a.length;for(var f=0;f<e;++f)d[f]=(1-c)*a[f]+c*b[f];return d},o3djs.math.modClamp=function(a,b,c){var d=c||0;if(b<1e-5)return d;a-=d,a<0?a-=Math.floor(a/b)*b:a=a%b;return a+d},o3djs.math.lerpCircular=function(a,b,c,d){a=o3djs.math.modClamp(a,d),b=o3djs.math.modClamp(b,d);var e=b-a;Math.abs(e)>d*.5&&(e>0?b-=d:b+=d);return o3djs.math.modClamp(o3djs.math.lerpScalar(a,b,c),d)},o3djs.math.lerpRadian=function(a,b,c){return o3djs.math.lerpCircular(a,b,c,Math.PI*2)},o3djs.math.divVectorScalar=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e]/b;return c},o3djs.math.dot=function(a,b){var c=0,d=a.length;for(var e=0;e<d;++e)c+=a[e]*b[e];return c},o3djs.math.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},o3djs.math.length=function(a){var b=0,c=a.length;for(var d=0;d<c;++d)b+=a[d]*a[d];return Math.sqrt(b)},o3djs.math.lengthSquared=function(a){var b=0,c=a.length;for(var d=0;d<c;++d)b+=a[d]*a[d];return b},o3djs.math.distance=function(a,b){var c=0,d=a.length;for(var e=0;e<d;++e){var f=a[e]-b[e];c+=f*f}return Math.sqrt(c)},o3djs.math.distanceSquared=function(a,b){var c=0,d=a.length;for(var e=0;e<d;++e){var f=a[e]-b[e];c+=f*f}return c},o3djs.math.normalize=function(a){var b=[],c=0,d=a.length;for(var e=0;e<d;++e)c+=a[e]*a[e];c=Math.sqrt(c);for(var e=0;e<d;++e)b[e]=a[e]/c;return b},o3djs.math.addMatrix=function(a,b){var c=[],d=a.length,e=a[0].length;for(var f=0;f<d;++f){var g=[],h=a[f],i=b[f];for(var j=0;j<e;++j)g[j]=h[j]+i[j];c[f]=g}return c},o3djs.math.subMatrix=function(a,b){var c=[],d=a.length,e=a[0].length;for(var f=0;f<d;++f){var g=[],h=a[f],i=b[f];for(var j=0;j<e;++j)g[j]=h[j]-i[j];c[f]=g}return c},o3djs.math.lerpMatrix=function(a,b,c){var d=[],e=a.length,f=a[0].length;for(var g=0;g<e;++g){var h=[],i=a[g],j=b[g];for(var k=0;k<f;++k)h[k]=(1-c)*i[k]+c*j[k];d[g]=h}return d},o3djs.math.divMatrixScalar=function(a,b){var c=[],d=a.length,e=a[0].length;for(var f=0;f<d;++f){c[f]=[];for(var g=0;g<e;++g)c[f][g]=a[f][g]/b}return c},o3djs.math.negativeScalar=function(a){return-a},o3djs.math.negativeVector=function(a){var b=[],c=a.length;for(var d=0;d<c;++d)b[d]=-a[d];return b},o3djs.math.negativeMatrix=function(a){var b=[],c=a.length,d=a[0].length;for(var e=0;e<c;++e){b[e]=[];for(var f=0;f<d;++f)b[e][f]=-a[e][f]}return b},o3djs.math.copyScalar=function(a){return a},o3djs.math.copyVector=function(a){var b=[];for(var c=0;c<a.length;c++)b[c]=a[c];return b},o3djs.math.copyMatrix=function(a){var b=[],c=a.length;for(var d=0;d<c;++d){b[d]=[];for(var e=0;e<a[d].length;e++)b[d][e]=a[d][e]}return b},o3djs.math.getMatrixElements=function(a){var b=[],c=a.length,d=0;for(var e=0;e<c;e++)for(var f=0;f<a[e].length;f++)b[d++]=a[e][f];return b},o3djs.math.mulScalarScalar=function(a,b){return a*b},o3djs.math.mulScalarVector=function(a,b){var c=[],d=b.length;for(var e=0;e<d;++e)c[e]=a*b[e];return c},o3djs.math.mulVectorScalar=function(a,b){return o3djs.math.mulScalarVector(b,a)},o3djs.math.mulScalarMatrix=function(a,b){var c=[],d=b.length,e=b[0].length;for(var f=0;f<d;++f){c[f]=[];for(var g=0;g<e;++g)c[f][g]=a*b[f][g]}return c},o3djs.math.mulMatrixScalar=function(a,b){return o3djs.math.mulScalarMatrix(b,a)},o3djs.math.mulVectorVector=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e]*b[e];return c},o3djs.math.divVectorVector=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e]/b[e];return c},o3djs.math.rowMajor.mulVectorMatrix=function(a,b){var c=[],d=b[0].length,e=a.length;for(var f=0;f<d;++f){c[f]=0;for(var g=0;g<e;++g)c[f]+=a[g]*b[g][f]}return c},o3djs.math.columnMajor.mulVectorMatrix=function(a,b){var c=[],d=b.length,e=a.length;for(var f=0;f<d;++f){c[f]=0;var g=b[f];for(var h=0;h<e;++h)c[f]+=a[h]*g[h]}return c},o3djs.math.mulVectorMatrix=null,o3djs.math.rowMajor.mulMatrixVector=function(a,b){var c=[],d=a.length,e=a[0].length;for(var f=0;f<d;++f){c[f]=0;var g=a[f];for(var h=0;h<e;++h)c[f]+=g[h]*b[h]}return c},o3djs.math.columnMajor.mulMatrixVector=function(a,b){var c=[],d=a[0].length,e=b.length;for(var f=0;f<d;++f){c[f]=0;for(var g=0;g<e;++g)c[f]+=b[g]*a[g][f]}return c},o3djs.math.mulMatrixVector=null,o3djs.math.rowMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=c[0],h=c[1],i=d[0],j=d[1],k=e[0],l=e[1],m=f[0],n=f[1];return[[g*k+h*m,g*l+h*n],[i*k+j*m,i*l+j*n]]},o3djs.math.columnMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=c[0],h=c[1],i=d[0],j=d[1],k=e[0],l=e[1],m=f[0],n=f[1];return[[g*k+i*l,h*k+j*l],[g*m+i*n,h*m+j*n]]},o3djs.math.mulMatrixMatrix2=null,o3djs.math.rowMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],i=c[0],j=c[1],k=c[2],l=d[0],m=d[1],n=d[2],o=e[0],p=e[1],q=e[2],r=f[0],s=f[1],t=f[2],u=g[0],v=g[1],w=g[2],x=h[0],y=h[1],z=h[2];return[[i*r+j*u+k*x,i*s+j*v+k*y,i*t+j*w+k*z],[l*r+m*u+n*x,l*s+m*v+n*y,l*t+m*w+n*z],[o*r+p*u+q*x,o*s+p*v+q*y,o*t+p*w+q*z]]},o3djs.math.columnMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],i=c[0],j=c[1],k=c[2],l=d[0],m=d[1],n=d[2],o=e[0],p=e[1],q=e[2],r=f[0],s=f[1],t=f[2],u=g[0],v=g[1],w=g[2],x=h[0],y=h[1],z=h[2];return[[i*r+l*s+o*t,j*r+m*s+p*t,k*r+n*s+q*t],[i*u+l*v+o*w,j*u+m*v+p*w,k*u+n*v+q*w],[i*x+l*y+o*z,j*x+m*y+p*z,k*x+n*y+q*z]]},o3djs.math.mulMatrixMatrix3=null,o3djs.math.rowMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=c[0],l=c[1],m=c[2],n=c[3],o=d[0],p=d[1],q=d[2],r=d[3],s=e[0],t=e[1],u=e[2],v=e[3],w=f[0],x=f[1],y=f[2],z=f[3],A=g[0],B=g[1],C=g[2],D=g[3],E=h[0],F=h[1],G=h[2],H=h[3],I=i[0],J=i[1],K=i[2],L=i[3],M=j[0],N=j[1],O=j[2],P=j[3];return[[k*A+l*E+m*I+n*M,k*B+l*F+m*J+n*N,k*C+l*G+m*K+n*O,k*D+l*H+m*L+n*P],[o*A+p*E+q*I+r*M,o*B+p*F+q*J+r*N,o*C+p*G+q*K+r*O,o*D+p*H+q*L+r*P],[s*A+t*E+u*I+v*M,s*B+t*F+u*J+v*N,s*C+t*G+u*K+v*O,s*D+t*H+u*L+v*P],[w*A+x*E+y*I+z*M,w*B+x*F+y*J+z*N,w*C+x*G+y*K+z*O,w*D+x*H+y*L+z*P]]},o3djs.math.columnMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=c[0],l=c[1],m=c[2],n=c[3],o=d[0],p=d[1],q=d[2],r=d[3],s=e[0],t=e[1],u=e[2],v=e[3],w=f[0],x=f[1],y=f[2],z=f[3],A=g[0],B=g[1],C=g[2],D=g[3],E=h[0],F=h[1],G=h[2],H=h[3],I=i[0],J=i[1],K=i[2],L=i[3],M=j[0],N=j[1],O=j[2],P=j[3];return[[k*A+o*B+s*C+w*D,l*A+p*B+t*C+x*D,m*A+q*B+u*C+y*D,n*A+r*B+v*C+z*D],[k*E+o*F+s*G+w*H,l*E+p*F+t*G+x*H,m*E+q*F+u*G+y*H,n*E+r*F+v*G+z*H],[k*I+o*J+s*K+w*L,l*I+p*J+t*K+x*L,m*I+q*J+u*K+y*L,n*I+r*J+v*K+z*L],[k*M+o*N+s*O+w*P,l*M+p*N+t*O+x*P,m*M+q*N+u*O+y*P,n*M+r*N+v*O+z*P]]},o3djs.math.mulMatrixMatrix4=null,o3djs.math.rowMajor.mulMatrixMatrix=function(a,b){var c=[],d=a.length,e=b[0].length,f=b.length;for(var g=0;g<d;++g){var h=[],i=a[g];for(var j=0;j<e;++j){h[j]=0;for(var k=0;k<f;++k)h[j]+=i[k]*b[k][j]}c[g]=h}return c},o3djs.math.columnMajor.mulMatrixMatrix=function(a,b){var c=[],d=b.length,e=a[0].length,f=a.length;for(var g=0;g<d;++g){var h=[],i=b[g];for(var j=0;j<e;++j){h[j]=0;for(var k=0;k<f;++k)h[j]+=i[k]*a[k][j]}c[g]=h}return c},o3djs.math.mulMatrixMatrix=null,o3djs.math.rowMajor.column=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e][b];return c},o3djs.math.columnMajor.column=function(a,b){return a[b].slice()},o3djs.math.column=null,o3djs.math.rowMajor.row=function(a,b){return a[b].slice()},o3djs.math.columnMajor.row=function(a,b){var c=[],d=a.length;for(var e=0;e<d;++e)c[e]=a[e][b];return c},o3djs.math.row=null,o3djs.math.identity=function(a){var b=[];for(var c=0;c<a;++c){b[c]=[];for(var d=0;d<a;++d)b[c][d]=d==c?1:0}return b},o3djs.math.transpose=function(a){var b=[],c=a[0].length,d=a.length;for(var e=0;e<c;++e){b[e]=[];for(var f=0;f<d;++f)b[e][f]=a[f][e]}return b},o3djs.math.trace=function(a){var b=0,c=a.length;for(var d=0;d<c;++d)b+=a[d][d];return b},o3djs.math.det1=function(a){return a[0][0]},o3djs.math.det2=function(a){return a[0][0]*a[1][1]-a[0][1]*a[1][0]},o3djs.math.det3=function(a){return a[2][2]*(a[0][0]*a[1][1]-a[0][1]*a[1][0])-a[2][1]*(a[0][0]*a[1][2]-a[0][2]*a[1][0])+a[2][0]*(a[0][1]*a[1][2]-a[0][2]*a[1][1])},o3djs.math.det4=function(a){var b=a[0][0]*a[1][1]-a[0][1]*a[1][0],c=a[0][0]*a[1][2]-a[0][2]*a[1][0],d=a[0][0]*a[1][3]-a[0][3]*a[1][0],e=a[0][1]*a[1][2]-a[0][2]*a[1][1],f=a[0][1]*a[1][3]-a[0][3]*a[1][1],g=a[0][2]*a[1][3]-a[0][3]*a[1][2];return a[3][3]*(a[2][2]*b-a[2][1]*c+a[2][0]*e)-a[3][2]*(a[2][3]*b-a[2][1]*d+a[2][0]*f)+a[3][1]*(a[2][3]*c-a[2][2]*d+a[2][0]*g)-a[3][0]*(a[2][3]*e-a[2][2]*f+a[2][1]*g)},o3djs.math.inverse1=function(a){return[[1/a[0][0]]]},o3djs.math.inverse2=function(a){var b=1/(a[0][0]*a[1][1]-a[0][1]*a[1][0]);return[[b*a[1][1],-b*a[0][1]],[-b*a[1][0],b*a[0][0]]]},o3djs.math.inverse3=function(a){var b=a[1][1]*a[2][2]-a[1][2]*a[2][1],c=a[0][1]*a[2][2]-a[0][2]*a[2][1],d=a[0][1]*a[1][2]-a[0][2]*a[1][1],e=1/(a[0][0]*b-a[1][0]*c+a[2][0]*d);return[[e*b,-e*c,e*d],[-e*(a[1][0]*a[2][2]-a[1][2]*a[2][0]),e*(a[0][0]*a[2][2]-a[0][2]*a[2][0]),-e*(a[0][0]*a[1][2]-a[0][2]*a[1][0])],[e*(a[1][0]*a[2][1]-a[1][1]*a[2][0]),-e*(a[0][0]*a[2][1]-a[0][1]*a[2][0]),e*(a[0][0]*a[1][1]-a[0][1]*a[1][0])]]},o3djs.math.inverse4=function(a){var b=a[2][2]*a[3][3],c=a[3][2]*a[2][3],d=a[1][2]*a[3][3],e=a[3][2]*a[1][3],f=a[1][2]*a[2][3],g=a[2][2]*a[1][3],h=a[0][2]*a[3][3],i=a[3][2]*a[0][3],j=a[0][2]*a[2][3],k=a[2][2]*a[0][3],l=a[0][2]*a[1][3],m=a[1][2]*a[0][3],n=a[2][0]*a[3][1],o=a[3][0]*a[2][1],p=a[1][0]*a[3][1],q=a[3][0]*a[1][1],r=a[1][0]*a[2][1],s=a[2][0]*a[1][1],t=a[0][0]*a[3][1],u=a[3][0]*a[0][1],v=a[0][0]*a[2][1],w=a[2][0]*a[0][1],x=a[0][0]*a[1][1],y=a[1][0]*a[0][1],z=b*a[1][1]+e*a[2][1]+f*a[3][1]-(c*a[1][1]+d*a[2][1]+g*a[3][1]),A=c*a[0][1]+h*a[2][1]+k*a[3][1]-(b*a[0][1]+i*a[2][1]+j*a[3][1]),B=d*a[0][1]+i*a[1][1]+l*a[3][1]-(e*a[0][1]+h*a[1][1]+m*a[3][1]),C=g*a[0][1]+j*a[1][1]+m*a[2][1]-(f*a[0][1]+k*a[1][1]+l*a[2][1]),D=1/(a[0][0]*z+a[1][0]*A+a[2][0]*B+a[3][0]*C),E=[D*z,D*A,D*B,D*C],F=[D*(c*a[1][0]+d*a[2][0]+g*a[3][0]-(b*a[1][0]+e*a[2][0]+f*a[3][0])),D*(b*a[0][0]+i*a[2][0]+j*a[3][0]-(c*a[0][0]+h*a[2][0]+k*a[3][0])),D*(e*a[0][0]+h*a[1][0]+m*a[3][0]-(d*a[0][0]+i*a[1][0]+l*a[3][0])),D*(f*a[0][0]+k*a[1][0]+l*a[2][0]-(g*a[0][0]+j*a[1][0]+m*a[2][0]))],G=[D*(n*a[1][3]+q*a[2][3]+r*a[3][3]-(o*a[1][3]+p*a[2][3]+s*a[3][3])),D*(o*a[0][3]+t*a[2][3]+w*a[3][3]-(n*a[0][3]+u*a[2][3]+v*a[3][3])),D*(p*a[0][3]+u*a[1][3]+x*a[3][3]-(q*a[0][3]+t*a[1][3]+y*a[3][3])),D*(s*a[0][3]+v*a[1][3]+y*a[2][3]-(r*a[0][3]+w*a[1][3]+x*a[2][3]))],H=[D*(p*a[2][2]+s*a[3][2]+o*a[1][2]-(r*a[3][2]+n*a[1][2]+q*a[2][2])),D*(v*a[3][2]+n*a[0][2]+u*a[2][2]-(t*a[2][2]+w*a[3][2]+o*a[0][2])),D*(t*a[1][2]+y*a[3][2]+q*a[0][2]-(x*a[3][2]+p*a[0][2]+u*a[1][2])),D*(x*a[2][2]+r*a[0][2]+w*a[1][2]-(v*a[1][2]+y*a[2][2]+s*a[0][2]))];return[E,F,G,H]},o3djs.math.codet=function(a,b,c){var d=a.length,e=[],f=0;for(var g=0;g<d-1;++g){f==b&&f++,e[g]=[];var h=0;for(var i=0;i<d-1;++i)h==c&&h++,e[g][i]=a[f][h],h++;f++}return o3djs.math.det(e)},o3djs.math.det=function(a){var b=a.length;if(b<=4)return o3djs.math["det"+b](a);var c=0,d=1,e=a[0],f=a.length;for(var g=0;g<f;g++)c+=d*e[g]*o3djs.math.codet(a,0,g),d*=-1;return c},o3djs.math.inverse=function(a){var b=a.length;if(b<=4)return o3djs.math["inverse"+b](a);var c=[],d=a.length;for(var e=0;e<d;++e){c[e]=[];for(var f=0;f<d;++f)c[e][f]=((f+e)%2?-1:1)*o3djs.math.codet(a,f,e)}return o3djs.math.divMatrixScalar(c,o3djs.math.det(a))},o3djs.math.orthonormalize=function(a){var b=[],c=a.length;for(var d=0;d<c;++d){var e=a[d];for(var f=0;f<d;++f)e=o3djs.math.subVector(e,o3djs.math.mulScalarVector(o3djs.math.dot(b[f],a[d]),b[f]));b[d]=o3djs.math.normalize(e)}return b},o3djs.math.matrix4.inverse=function(a){return o3djs.math.inverse4(a)},o3djs.math.matrix4.mul=function(a,b){return o3djs.math.mulMatrixMatrix4(a,b)},o3djs.math.matrix4.det=function(a){return o3djs.math.det4(a)},o3djs.math.matrix4.copy=function(a){return o3djs.math.copyMatrix(a)},o3djs.math.matrix4.setUpper3x3=function(a,b){var c=b[0],d=b[1],e=b[2];a[0].splice(0,3,c[0],c[1],c[2]),a[1].splice(0,3,d[0],d[1],d[2]),a[2].splice(0,3,e[0],e[1],e[2]);return a},o3djs.math.matrix4.getUpper3x3=function(a){return[a[0].slice(0,3),a[1].slice(0,3),a[2].slice(0,3)]},o3djs.math.matrix4.setTranslation=function(a,b){a[3].splice(0,4,b[0],b[1],b[2],1);return a},o3djs.math.matrix4.getTranslation=function(a){return a[3].slice(0,3)},o3djs.math.matrix4.transformPoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3],j=c*f[3]+d*g[3]+e*h[3]+i[3];return[(c*f[0]+d*g[0]+e*h[0]+i[0])/j,(c*f[1]+d*g[1]+e*h[1]+i[1])/j,(c*f[2]+d*g[2]+e*h[2]+i[2])/j]},o3djs.math.matrix4.transformVector4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=a[0],h=a[1],i=a[2],j=a[3];return[c*g[0]+d*h[0]+e*i[0]+f*j[0],c*g[1]+d*h[1]+e*i[1]+f*j[1],c*g[2]+d*h[2]+e*i[2]+f*j[2],c*g[3]+d*h[3]+e*i[3]+f*j[3]]},o3djs.math.matrix4.transformDirection=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3];return[c*f[0]+d*g[0]+e*h[0],c*f[1]+d*g[1]+e*h[1],c*f[2]+d*g[2]+e*h[2]]},o3djs.math.matrix4.transformNormal=function(a,b){var c=o3djs.math.inverse4(a),d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3];return[d*g[0]+e*g[1]+f*g[2],d*h[0]+e*h[1]+f*h[2],d*i[0]+e*i[1]+f*i[2]]},o3djs.math.matrix4.identity=function(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},o3djs.math.matrix4.setIdentity=function(a){for(var b=0;b<4;b++)for(var c=0;c<4;c++)b==c?a[b][c]=1:a[b][c]=0;return a},o3djs.math.matrix4.perspective=function(a,b,c,d){var e=Math.tan(.5*(Math.PI-a)),f=c-d;return[[e/b,0,0,0],[0,e,0,0],[0,0,d/f,-1],[0,0,c*d/f,0]]},o3djs.math.matrix4.orthographic=function(a,b,c,d,e,f){return[[2/(b-a),0,0,0],[0,2/(d-c),0,0],[0,0,1/(e-f),0],[(a+b)/(a-b),(c+d)/(c-d),e/(e-f),1]]},o3djs.math.matrix4.frustum=function(a,b,c,d,e,f){var g=b-a,h=d-c,i=e-f;return[[2*e/g,0,0,0],[0,2*e/h,0,0],[(a+b)/g,(d+c)/h,f/i,-1],[0,0,e*f/i,0]]},o3djs.math.matrix4.lookAt=function(a,b,c){var d=o3djs.math.normalize(o3djs.math.subVector(a,b).slice(0,3)).concat(0),e=o3djs.math.normalize(o3djs.math.cross(c,d)).concat(0),f=o3djs.math.cross(d,e).concat(0);return o3djs.math.inverse([e,f,d,a.concat(1)])},o3djs.math.matrix4.composition=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=c[0],l=c[1],m=c[2],n=c[3],o=d[0],p=d[1],q=d[2],r=d[3],s=e[0],t=e[1],u=e[2],v=e[3],w=f[0],x=f[1],y=f[2],z=f[3],A=g[0],B=g[1],C=g[2],D=g[3],E=h[0],F=h[1],G=h[2],H=h[3],I=i[0],J=i[1],K=i[2],L=i[3],M=j[0],N=j[1],O=j[2],P=j[3];return[[k*A+o*B+s*C+w*D,l*A+p*B+t*C+x*D,m*A+q*B+u*C+y*D,n*A+r*B+v*C+z*D],[k*E+o*F+s*G+w*H,l*E+p*F+t*G+x*H,m*E+q*F+u*G+y*H,n*E+r*F+v*G+z*H],[k*I+o*J+s*K+w*L,l*I+p*J+t*K+x*L,m*I+q*J+u*K+y*L,n*I+r*J+v*K+z*L],[k*M+o*N+s*O+w*P,l*M+p*N+t*O+x*P,m*M+q*N+u*O+y*P,n*M+r*N+v*O+z*P]]},o3djs.math.matrix4.compose=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=c[0],l=c[1],m=c[2],n=c[3],o=d[0],p=d[1],q=d[2],r=d[3],s=e[0],t=e[1],u=e[2],v=e[3],w=f[0],x=f[1],y=f[2],z=f[3],A=g[0],B=g[1],C=g[2],D=g[3],E=h[0],F=h[1],G=h[2],H=h[3],I=i[0],J=i[1],K=i[2],L=i[3],M=j[0],N=j[1],O=j[2],P=j[3];a[0].splice(0,4,k*A+o*B+s*C+w*D,l*A+p*B+t*C+x*D,m*A+q*B+u*C+y*D,n*A+r*B+v*C+z*D),a[1].splice(0,4,k*E+o*F+s*G+w*H,l*E+p*F+t*G+x*H,m*E+q*F+u*G+y*H,n*E+r*F+v*G+z*H),a[2].splice(0,4,k*I+o*J+s*K+w*L,l*I+p*J+t*K+x*L,m*I+q*J+u*K+y*L,n*I+r*J+v*K+z*L),a[3].splice(0,4,k*M+o*N+s*O+w*P,l*M+p*N+t*O+x*P,m*M+q*N+u*O+y*P,n*M+r*N+v*O+z*P);return a},o3djs.math.matrix4.translation=function(a){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[a[0],a[1],a[2],1]]},o3djs.math.matrix4.translate=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3],j=f[0],k=f[1],l=f[2],m=f[3],n=g[0],o=g[1],p=g[2],q=g[3],r=h[0],s=h[1],t=h[2],u=h[3],v=i[0],w=i[1],x=i[2],y=i[3];i.splice(0,4,j*c+n*d+r*e+v,k*c+o*d+s*e+w,l*c+p*d+t*e+x,m*c+q*d+u*e+y);return a},o3djs.math.matrix4.scaling=function(a){return[[a[0],0,0,0],[0,a[1],0,0],[0,0,a[2],0],[0,0,0,1]]},o3djs.math.matrix4.scale=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[0],g=a[1],h=a[2],i=a[3];f.splice(0,4,c*f[0],c*f[1],c*f[2],c*f[3]),g.splice(0,4,d*g[0],d*g[1],d*g[2],d*g[3]),h.splice(0,4,e*h[0],e*h[1],e*h[2],e*h[3]);return a},o3djs.math.matrix4.rotationX=function(a){var b=Math.cos(a),c=Math.sin(a);return[[1,0,0,0],[0,b,c,0],[0,-c,b,0],[0,0,0,1]]},o3djs.math.matrix4.rotateX=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=d[0],h=d[1],i=d[2],j=d[3],k=e[0],l=e[1],m=e[2],n=e[3],o=Math.cos(b),p=Math.sin(b);d.splice(0,4,o*g+p*k,o*h+p*l,o*i+p*m,o*j+p*n),e.splice(0,4,o*k-p*g,o*l-p*h,o*m-p*i,o*n-p*j);return a},o3djs.math.matrix4.rotationY=function(a){var b=Math.cos(a),c=Math.sin(a);return[[b,0,-c,0],[0,1,0,0],[c,0,b,0],[0,0,0,1]]},o3djs.math.matrix4.rotateY=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c[0],h=c[1],i=c[2],j=c[3],k=e[0],l=e[1],m=e[2],n=e[3],o=Math.cos(b),p=Math.sin(b);c.splice(0,4,o*g-p*k,o*h-p*l,o*i-p*m,o*j-p*n),e.splice(0,4,o*k+p*g,o*l+p*h,o*m+p*i,o*n+p*j);return a},o3djs.math.matrix4.rotationZ=function(a){var b=Math.cos(a),c=Math.sin(a);return[[b,c,0,0],[-c,b,0,0],[0,0,1,0],[0,0,0,1]]},o3djs.math.matrix4.rotateZ=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c[0],h=c[1],i=c[2],j=c[3],k=d[0],l=d[1],m=d[2],n=d[3],o=Math.cos(b),p=Math.sin(b);c.splice(0,4,o*g+p*k,o*h+p*l,o*i+p*m,o*j+p*n),d.splice(0,4,o*k-p*g,o*l-p*h,o*m-p*i,o*n-p*j);return a},o3djs.math.matrix4.rotationZYX=function(a){var b=Math.sin(a[0]),c=Math.cos(a[0]),d=Math.sin(a[1]),e=Math.cos(a[1]),f=Math.sin(a[2]),g=Math.cos(a[2]),h=g*d,i=f*d;return[[g*e,f*e,-d,0],[h*b-f*c,i*b+g*c,e*b,0],[h*c+f*b,i*c-g*b,e*c,0],[0,0,0,1]]},o3djs.math.matrix4.rotateZYX=function(a,b){var c=Math.sin(b[0]),d=Math.cos(b[0]),e=Math.sin(b[1]),f=Math.cos(b[1]),g=Math.sin(b[2]),h=Math.cos(b[2]),i=h*e,j=g*e,k=h*f,l=g*f,m=-e,n=i*c-g*d,o=j*c+h*d,p=f*c,q=i*d+g*c,r=j*d-h*c,s=f*d,t=a[0],u=a[1],v=a[2],w=a[3],x=t[0],y=t[1],z=t[2],A=t[3],B=u[0],C=u[1],D=u[2],E=u[3],F=v[0],G=v[1],H=v[2],I=v[3],J=w[0],K=w[1],L=w[2],M=w[3];t.splice(0,4,k*x+l*B+m*F,k*y+l*C+m*G,k*z+l*D+m*H,k*A+l*E+m*I),u.splice(0,4,n*x+o*B+p*F,n*y+o*C+p*G,n*z+o*D+p*H,n*A+o*E+p*I),v.splice(0,4,q*x+r*B+s*F,q*y+r*C+s*G,q*z+r*D+s*H,q*A+r*E+s*I);return a},o3djs.math.matrix4.axisRotation=function(a,b){var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);c/=f,d/=f,e/=f;var g=c*c,h=d*d,i=e*e,j=Math.cos(b),k=Math.sin(b),l=1-j;return[[g+(1-g)*j,c*d*l+e*k,c*e*l-d*k,0],[c*d*l-e*k,h+(1-h)*j,d*e*l+c*k,0],[c*e*l+d*k,d*e*l-c*k,i+(1-i)*j,0],[0,0,0,1]]},o3djs.math.matrix4.axisRotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=Math.sqrt(d*d+e*e+f*f);d/=g,e/=g,f/=g;var h=d*d,i=e*e,j=f*f,k=Math.cos(c),l=Math.sin(c),m=1-k,n=h+(1-h)*k,o=d*e*m+f*l,p=d*f*m-e*l,q=d*e*m-f*l,r=i+(1-i)*k,s=e*f*m+d*l,t=d*f*m+e*l,u=e*f*m-d*l,v=j+(1-j)*k,w=a[0],x=a[1],y=a[2],z=a[3],A=w[0],B=w[1],C=w[2],D=w[3],E=x[0],F=x[1],G=x[2],H=x[3],I=y[0],J=y[1],K=y[2],L=y[3],M=z[0],N=z[1],O=z[2],P=z[3];w.splice(0,4,n*A+o*E+p*I,n*B+o*F+p*J,n*C+o*G+p*K,n*D+o*H+p*L),x.splice(0,4,q*A+r*E+s*I,q*B+r*F+s*J,q*C+r*G+s*K,q*D+r*H+s*L),y.splice(0,4,t*A+u*E+v*I,t*B+u*F+v*J,t*C+u*G+v*K,t*D+u*H+v*L);return a},o3djs.math.installRowMajorFunctions=function(){for(var a in o3djs.math.rowMajor)o3djs.math[a]=o3djs.math.rowMajor[a]},o3djs.math.installColumnMajorFunctions=function(){for(var a in o3djs.math.columnMajor)o3djs.math[a]=o3djs.math.columnMajor[a]},o3djs.math.installErrorCheckFunctions=function(){for(var a in o3djs.math.errorCheck)o3djs.math[a]=o3djs.math.errorCheck[a]},o3djs.math.installErrorCheckFreeFunctions=function(){for(var a in o3djs.math.errorCheckFree)o3djs.math[a]=o3djs.math.errorCheckFree[a]},o3djs.math.installRowMajorFunctions(),o3djs.math.installErrorCheckFunctions(),o3djs.provide("o3djs.pack"),o3djs.pack=o3djs.pack||{},o3djs.pack.preparePack=function(a,b,c){o3djs.material.prepareMaterials(a,b,c),o3djs.shape.prepareShapes(a)},o3djs.provide("o3djs.particles"),o3djs.particles=o3djs.particles||{},o3djs.particles.ParticleStateIds={BLEND:0,ADD:1,BLEND_PREMULTIPLY:2,BLEND_NO_ALPHA:3,SUBTRACT:4,INVERSE:5},o3djs.particles.FX_STRINGS_CG=[{name:"particle3d",fxString:"float4x4 worldViewProjection : WORLDVIEWPROJECTION;\nfloat4x4 world : WORLD;\nfloat3 worldVelocity;\nfloat3 worldAcceleration;\nfloat timeRange;\nfloat time;\nfloat timeOffset;\nfloat frameDuration;\nfloat numFrames;\n\n// We need to implement 1D!\nsampler rampSampler;\nsampler colorSampler;\n\nstruct VertexShaderInput {\n  float4 uvLifeTimeFrameStart : POSITION; // uv, lifeTime, frameStart\n  float4 positionStartTime : TEXCOORD0;    // position.xyz, startTime\n  float4 velocityStartSize : TEXCOORD1;   // velocity.xyz, startSize\n  float4 accelerationEndSize : TEXCOORD2; // acceleration.xyz, endSize\n  float4 spinStartSpinSpeed : TEXCOORD3;  // spinStart.x, spinSpeed.y\n  float4 orientation : TEXCOORD4;  // orientation\n  float4 colorMult : COLOR; //\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n  float2 texcoord : TEXCOORD0;\n  float1 percentLife : TEXCOORD1;\n  float4 colorMult: TEXCOORD2;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  float2 uv = input.uvLifeTimeFrameStart.xy;\n  float lifeTime = input.uvLifeTimeFrameStart.z;\n  float frameStart = input.uvLifeTimeFrameStart.w;\n  float3 position = input.positionStartTime.xyz;\n  float startTime = input.positionStartTime.w;\n  float3 velocity = mul(float4(input.velocityStartSize.xyz, 0),\n                        world).xyz + worldVelocity;\n  float startSize = input.velocityStartSize.w;\n  float3 acceleration = mul(float4(input.accelerationEndSize.xyz, 0),\n                            world).xyz + worldAcceleration;\n  float endSize = input.accelerationEndSize.w;\n  float spinStart = input.spinStartSpinSpeed.x;\n  float spinSpeed = input.spinStartSpinSpeed.y;\n\n  float localTime = fmod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = fmod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1 / numFrames);\n\n  output.texcoord = float2(u, uv.y + 0.5);\n  output.colorMult = input.colorMult;\n\n  float size = lerp(startSize, endSize, percentLife);\n  size = (percentLife < 0 || percentLife > 1) ? 0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  float4 rotatedPoint = float4((uv.x * c + uv.y * s) * size, 0,\n                               (uv.x * s - uv.y * c) * size, 1);\n  float3 center = velocity * localTime +\n                  acceleration * localTime * localTime + \n                  position;\n  \n      float4 q2 = input.orientation + input.orientation;\n      float4 qx = input.orientation.xxxw * q2.xyzx;\n      float4 qy = input.orientation.xyyw * q2.xyzy;\n      float4 qz = input.orientation.xxzw * q2.xxzz;\n  \n      float4x4 localMatrix = float4x4(\n        (1.0f - qy.y) - qz.z, \n        qx.y + qz.w, \n        qx.z - qy.w,\n        0,\n  \n        qx.y - qz.w, \n        (1.0f - qx.x) - qz.z, \n        qy.z + qx.w,\n        0,\n  \n        qx.z + qy.w, \n        qy.z - qx.w, \n        (1.0f - qx.x) - qy.y,\n        0,\n  \n        center.x, center.y, center.z, 1);\n  rotatedPoint = mul(rotatedPoint, localMatrix);\n  output.position = mul(rotatedPoint, worldViewProjection);\n  output.percentLife = percentLife;\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input): COLOR {\n  float4 colorMult = tex2D(rampSampler, \n                           float2(input.percentLife, 0.5)) *\n                     input.colorMult;\n  float4 color = tex2D(colorSampler, input.texcoord) * colorMult;\n  return color;\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"},{name:"particle2d",fxString:"float4x4 viewProjection : VIEWPROJECTION;\nfloat4x4 world : WORLD;\nfloat4x4 viewInverse : VIEWINVERSE;\nfloat3 worldVelocity;\nfloat3 worldAcceleration;\nfloat timeRange;\nfloat time;\nfloat timeOffset;\nfloat frameDuration;\nfloat numFrames;\n\n// We need to implement 1D!\nsampler rampSampler;\nsampler colorSampler;\n\nstruct VertexShaderInput {\n  float4 uvLifeTimeFrameStart : POSITION; // uv, lifeTime, frameStart\n  float4 positionStartTime : TEXCOORD0;    // position.xyz, startTime\n  float4 velocityStartSize : TEXCOORD1;   // velocity.xyz, startSize\n  float4 accelerationEndSize : TEXCOORD2; // acceleration.xyz, endSize\n  float4 spinStartSpinSpeed : TEXCOORD3;  // spinStart.x, spinSpeed.y\n  float4 colorMult : COLOR; //\n};\n\nstruct PixelShaderInput {\n  float4 position : POSITION;\n  float2 texcoord : TEXCOORD0;\n  float1 percentLife : TEXCOORD1;\n  float4 colorMult: TEXCOORD2;\n};\n\nPixelShaderInput vertexShaderFunction(VertexShaderInput input) {\n  PixelShaderInput output;\n\n  float2 uv = input.uvLifeTimeFrameStart.xy;\n  float lifeTime = input.uvLifeTimeFrameStart.z;\n  float frameStart = input.uvLifeTimeFrameStart.w;\n  float3 position = mul(float4(input.positionStartTime.xyz, 1),\n                        world).xyz;\n  float startTime = input.positionStartTime.w;\n  float3 velocity = mul(float4(input.velocityStartSize.xyz, 0),\n                        world).xyz + worldVelocity;\n  float startSize = input.velocityStartSize.w;\n  float3 acceleration = mul(float4(input.accelerationEndSize.xyz, 0),\n                            world).xyz + worldAcceleration;\n  float endSize = input.accelerationEndSize.w;\n  float spinStart = input.spinStartSpinSpeed.x;\n  float spinSpeed = input.spinStartSpinSpeed.y;\n\n  float localTime = fmod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = fmod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1 / numFrames);\n\n  output.texcoord = float2(u, uv.y + 0.5);\n  output.colorMult = input.colorMult;\n\n  float3 basisX = viewInverse[0].xyz;\n  float3 basisZ = viewInverse[1].xyz;\n\n  float size = lerp(startSize, endSize, percentLife);\n  size = (percentLife < 0 || percentLife > 1) ? 0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  float2 rotatedPoint = float2(uv.x * c + uv.y * s, \n                               -uv.x * s + uv.y * c);\n  float3 localPosition = float3(basisX * rotatedPoint.x +\n                                basisZ * rotatedPoint.y) * size +\n                         velocity * localTime +\n                         acceleration * localTime * localTime + \n                         position;\n\n  output.position = mul(float4(localPosition, 1), \n                        viewProjection);\n  output.percentLife = percentLife;\n  return output;\n}\n\nfloat4 pixelShaderFunction(PixelShaderInput input): COLOR {\n  float4 colorMult = tex2D(rampSampler, \n                           float2(input.percentLife, 0.5)) *\n                     input.colorMult;\n  float4 color = tex2D(colorSampler, input.texcoord) * colorMult;\n  return color;\n}\n\n// #o3d VertexShaderEntryPoint vertexShaderFunction\n// #o3d PixelShaderEntryPoint pixelShaderFunction\n// #o3d MatrixLoadOrder RowMajor\n"}],o3djs.particles.FX_STRINGS_GLSL=[{name:"particle3d",fxString:"uniform mat4 world;\nuniform mat4 worldViewProjection;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 position; // uv, lifeTime, frameStart\nattribute vec4 texCoord0; // position.xyz, startTime\nattribute vec4 texCoord1; // velocity.xyz, startSize\nattribute vec4 texCoord2; // acceleration.xyz, endSize\nattribute vec4 texCoord3; // spinStart.x, spinSpeed.y\nattribute vec4 texCoord4; // orientation\nattribute vec4 color; //\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\nvoid main() {\n  vec4 uvLifeTimeFrameStart = position;\n  vec4 positionStartTime = texCoord0;\n  vec4 velocityStartSize = texCoord1;\n  vec4 accelerationEndSize = texCoord2;\n  vec4 spinStartSpinSpeed = texCoord3;\n  vec4 orientation = texCoord4;\n  vec4 colorMult = color;\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz, 0)).xyz\n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime),\n      timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.0,\n                               (uv.x * s - uv.y * c) * size, 1.0);\n  vec3 center = velocity * localTime +\n                  acceleration * localTime * localTime + \n                  position;\n  \n      vec4 q2 = orientation + orientation;\n      vec4 qx = orientation.xxxw * q2.xyzx;\n      vec4 qy = orientation.xyyw * q2.xyzy;\n      vec4 qz = orientation.xxzw * q2.xxzz;\n  \n      mat4 localMatrix = mat4(\n        (1.0 - qy.y) - qz.z, \n        qx.y + qz.w, \n        qx.z - qy.w,\n        0,\n  \n        qx.y - qz.w, \n        (1.0 - qx.x) - qz.z, \n        qy.z + qx.w,\n        0,\n  \n        qx.z + qy.w, \n        qy.z - qx.w, \n        (1.0 - qx.x) - qy.y,\n        0,\n  \n        center.x, center.y, center.z, 1.0);\n  rotatedPoint = localMatrix * rotatedPoint;\n  gl_Position = worldViewProjection * rotatedPoint;\n  v_percentLife = percentLife;\n}\n\n// #o3d SplitMarker\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n\n// #o3d MatrixLoadOrder RowMajor\n"},{name:"particle2d",fxString:"uniform mat4 viewProjection;\nuniform mat4 world;\nuniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 position; // uv, lifeTime, frameStart\nattribute vec4 texCoord0; // position.xyz, startTime\nattribute vec4 texCoord1; // velocity.xyz, startSize\nattribute vec4 texCoord2; // acceleration.xyz, endSize\nattribute vec4 texCoord3; // spinStart.x, spinSpeed.y\nattribute vec4 color; //\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\nvoid main() {\n  vec4 uvLifeTimeFrameStart = position;\n  vec4 positionStartTime = texCoord0;\n  vec4 velocityStartSize = texCoord1;\n  vec4 accelerationEndSize = texCoord2;\n  vec4 spinStartSpinSpeed = texCoord3;\n  vec4 colorMult = color;\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = (world * vec4(positionStartTime.xyz, 1.0)).xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz, 0)).xyz \n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime),\n      timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  vec3 basisX = viewInverse[0].xyz;\n  vec3 basisZ = viewInverse[1].xyz;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n                               -uv.x * s + uv.y * c);\n  vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                                basisZ * rotatedPoint.y) * size +\n                         velocity * localTime +\n                         acceleration * localTime * localTime + \n                         position;\n\n  gl_Position = (viewProjection * vec4(localPosition, 1.0));\n  v_percentLife = percentLife;\n}\n\n// #o3d SplitMarker\n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n\n// #o3d MatrixLoadOrder RowMajor\n"}],o3djs.particles.useCorrectShaders_=function(){o3djs.particles.FX_STRINGS=o3djs.particles.FX_STRINGS_CG,o3djs.effect.LANGUAGE=="glsl"&&(o3djs.particles.FX_STRINGS=o3djs.particles.FX_STRINGS_GLSL)},o3djs.particles.CORNERS_=[[-0.5,-0.5],[.5,-0.5],[.5,.5],[-0.5,.5]],o3djs.particles.createParticleSystem=function(a,b,c,d){return new o3djs.particles.ParticleSystem(a,b,c,d)},o3djs.particles.ParticleSystem=function(a,b,c,d){var e=o3djs.base.o3d,f=[],g=[];o3djs.particles.useCorrectShaders_();for(var h=0;h<o3djs.particles.FX_STRINGS.length;++h){var i=o3djs.particles.FX_STRINGS[h],j=a.createObject("Effect");j.name=i.name,j.loadFromFXString(i.fxString),g.push(j)}var k={};k[o3djs.particles.ParticleStateIds.BLEND]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA},k[o3djs.particles.ParticleStateIds.ADD]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_ONE},k[o3djs.particles.ParticleStateIds.BLEND_PREMULTIPLY]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_ONE,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA},k[o3djs.particles.ParticleStateIds.BLEND_NO_ALPHA]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_COLOR,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR},k[o3djs.particles.ParticleStateIds.SUBTRACT]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA,BlendEquation:o3djs.base.o3d.State.BLEND_REVERSE_SUBTRACT},k[o3djs.particles.ParticleStateIds.INVERSE]={SourceBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_DESTINATION_COLOR,DestinationBlendFunction:o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_COLOR};for(var l in o3djs.particles.ParticleStateIds){var m=a.createObject("State"),n=o3djs.particles.ParticleStateIds[l];f[n]=m,m.getStateParam("ZWriteEnable").value=!1,m.getStateParam("CullMode").value=e.State.CULL_NONE;var i=k[n];for(var o in i)m.getStateParam(o).value=i[o]}var p=a.createTexture2D(8,8,e.Texture.ARGB8,1,!1),q=[0,.2,.7,1,.7,.2,0,0],r=[];for(var s=0;s<8;++s)for(var t=0;t<8;++t){var u=q[t]*q[s];r.push(u,u,u,u)}p.set(0,r);var v=a.createTexture2D(3,1,e.Texture.ARGB8,1,!1);v.set(0,[1,1,1,1,1,1,1,.5,1,1,1,0]),c||(this.counter_=a.createObject("SecondCounter"),c=this.counter_.getParam("count")),this.randomFunction_=d||function(){return Math.random()},this.particleStates=f,this.clockParam=c,this.pack=a,this.viewInfo=b,this.effects=g,this.defaultColorTexture=p,this.defaultRampTexture=v},o3djs.particles.ParticleSpec=function(){this.numParticles=1,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.lifeTimeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.position=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.worldAcceleration=[0,0,0],this.billboard=!0,this.orientation=[0,0,0,1]},o3djs.particles.ParticleSystem.prototype.createParticleEmitter=function(a,b){return new o3djs.particles.ParticleEmitter(this,a,b)},o3djs.particles.ParticleSystem.prototype.createTrail=function(a,b,c,d,e,f){return new o3djs.particles.Trail(this,a,b,c,d,e,f)},o3djs.particles.ParticleEmitter=function(a,b,c){c=c||a.clockParam;var d=o3djs.base.o3d,e=a.pack,f=a.viewInfo,g=e.createObject("Material");g.name="particles",g.drawList=f.zOrderedDrawList,g.effect=a.effects[1],a.effects[1].createUniformParameters(g),g.getParam("time").bind(c);var h=e.createObject("Sampler");h.texture=a.defaultRampTexture,h.addressModeU=d.Sampler.CLAMP;var i=e.createObject("Sampler");i.texture=b||a.defaultColorTexture,i.addressModeU=d.Sampler.CLAMP,i.addressModeV=d.Sampler.CLAMP,g.getParam("rampSampler").value=h,g.getParam("colorSampler").value=i;var j=e.createObject("VertexBuffer"),k=j.createField("FloatField",4),l=j.createField("FloatField",4),m=j.createField("FloatField",4),n=j.createField("FloatField",4),o=j.createField("FloatField",4),p=j.createField("FloatField",4),q=j.createField("FloatField",4),r=e.createObject("IndexBuffer"),s=e.createObject("StreamBank");s.setVertexStream(d.Stream.POSITION,0,k,0),s.setVertexStream(d.Stream.TEXCOORD,0,l,0),s.setVertexStream(d.Stream.TEXCOORD,1,m,0),s.setVertexStream(d.Stream.TEXCOORD,2,n,0),s.setVertexStream(d.Stream.TEXCOORD,3,o,0),s.setVertexStream(d.Stream.TEXCOORD,4,p,0),s.setVertexStream(d.Stream.COLOR,0,q,0);var t=e.createObject("Shape"),u=e.createObject("Primitive");u.material=g,u.owner=t,u.streamBank=s,u.indexBuffer=r,u.primitiveType=d.Primitive.TRIANGLELIST,u.createDrawElement(e,null),this.vertexBuffer_=j,this.uvLifeTimeFrameStartField_=k,this.positionStartTimeField_=l,this.velocityStartSizeField_=m,this.accelerationEndSizeField_=n,this.spinStartSpinSpeedField_=o,this.orientationField_=p,this.colorMultField_=q,this.indexBuffer_=r,this.streamBank_=s,this.primitive_=u,this.rampSampler_=h,this.rampTexture_=a.defaultRampTexture,this.colorSampler_=i,this.particleSystem=a,this.shape=t,this.material=g,this.clockParam=c},o3djs.particles.ParticleEmitter.prototype.setState=function(a){this.material.state=this.particleSystem.particleStates[a]},o3djs.particles.ParticleEmitter.prototype.setColorRamp=function(a){var b=a.length/4;if(b%1!=0)throw"colorRamp must have multiple of 4 entries";this.rampTexture_==this.particleSystem.defaultRampTexture&&(this.rampTexture_=null),this.rampTexture_&&this.rampTexture_.width!=b&&(this.particleSystem.pack.removeObject(this.rampTexture_),this.rampTexture_=null),this.rampTexture_||(this.rampTexture_=this.particleSystem.pack.createTexture2D(b,1,o3djs.base.o3d.Texture.ARGB8,1,!1)),this.rampTexture_.set(0,a),this.rampSampler_.texture=this.rampTexture_},o3djs.particles.ParticleEmitter.prototype.validateParameters=function(a){var b=new o3djs.particles.ParticleSpec;for(var c in a)if(typeof b[c]=="undefined")throw'unknown particle parameter "'+c+'"';for(var c in b)typeof a[c]=="undefined"&&(a[c]=b[c])},o3djs.particles.ParticleEmitter.prototype.createParticles_=function(a,b,c,d){var e=this.uvLifeTimeFrameStart_,f=this.positionStartTime_,g=this.velocityStartSize_,h=this.accelerationEndSize_,i=this.spinStartSpinSpeed_,j=this.orientation_,k=this.colorMults_;this.material.effect=this.particleSystem.effects[c.billboard?1:0],this.material.getParam("timeRange").value=c.timeRange,this.material.getParam("numFrames").value=c.numFrames,this.material.getParam("frameDuration").value=c.frameDuration,this.material.getParam("worldVelocity").value=c.worldVelocity,this.material.getParam("worldAcceleration").value=c.worldAcceleration;var l=this.particleSystem.randomFunction_,m=function(a){return(l()-.5)*a*2},n=function(a){var b=[];for(var c=0;c<a.length;++c)b.push(m(a[c]));return b};for(var o=0;o<b;++o){d&&d(o,c);var p=c.lifeTime,q=c.startTime===null?o*c.lifeTime/b:c.startTime,r=c.frameStart+m(c.frameStartRange),s=o3djs.math.addVector(c.position,n(c.positionRange)),t=o3djs.math.addVector(c.velocity,n(c.velocityRange)),u=o3djs.math.addVector(c.acceleration,n(c.accelerationRange)),v=o3djs.math.addVector(c.colorMult,n(c.colorMultRange)),w=c.spinStart+m(c.spinStartRange),x=c.spinSpeed+m(c.spinSpeedRange),y=c.startSize+m(c.startSizeRange),z=c.endSize+m(c.endSizeRange),A=c.orientation;for(var B=0;B<4;++B){var C=(o*4+B)*4,D=C+1,E=C+2,F=C+3;e[C]=o3djs.particles.CORNERS_[B][0],e[D]=o3djs.particles.CORNERS_[B][1],e[E]=p,e[F]=r,f[C]=s[0],f[D]=s[1],f[E]=s[2],f[F]=q,g[C]=t[0],g[D]=t[1],g[E]=t[2],g[F]=y,h[C]=u[0],h[D]=u[1],h[E]=u[2],h[F]=z,i[C]=w,i[D]=x,i[E]=0,i[F]=0,j[C]=A[0],j[D]=A[1],j[E]=A[2],j[F]=A[3],k[C]=v[0],k[D]=v[1],k[E]=v[2],k[F]=v[3]}}a*=4,this.uvLifeTimeFrameStartField_.setAt(a,e),this.positionStartTimeField_.setAt(a,f),this.velocityStartSizeField_.setAt(a,g),this.accelerationEndSizeField_.setAt(a,h),this.spinStartSpinSpeedField_.setAt(a,i),this.orientationField_.setAt(a,j),this.colorMultField_.setAt(a,k)},o3djs.particles.ParticleEmitter.prototype.allocateParticles_=function(a){if(this.vertexBuffer_.numElements!=a*4){this.vertexBuffer_.allocateElements(a*4);var b=[];for(var c=0;c<a;++c){var d=c*4;b.push(d+0,d+1,d+2),b.push(d+0,d+2,d+3)}this.indexBuffer_.set(b),this.uvLifeTimeFrameStart_=[],this.positionStartTime_=[],this.velocityStartSize_=[],this.accelerationEndSize_=[],this.spinStartSpinSpeed_=[],this.orientation_=[],this.colorMults_=[]}this.primitive_.numberPrimitives=a*2,this.primitive_.numberVertices=a*4},o3djs.particles.ParticleEmitter.prototype.setParameters=function(a,b){this.validateParameters(a);var c=a.numParticles;this.allocateParticles_(c),this.createParticles_(0,c,a,b)},o3djs.particles.ParticleEmitter.prototype.createOneShot=function(a){return new o3djs.particles.OneShot(this,a)},o3djs.particles.OneShot=function(a,b){var c=a.particleSystem.pack;this.emitter_=a,this.transform=c.createObject("Transform"),this.transform.visible=!1,this.transform.addShape(a.shape),this.timeOffsetParam_=this.transform.createParam("timeOffset","ParamFloat"),b&&this.setParent(b)},o3djs.particles.OneShot.prototype.setParent=function(a){this.transform.parent=a},o3djs.particles.OneShot.prototype.trigger=function(a,b){b&&this.setParent(b),a&&(this.transform.identity(),this.transform.translate(a)),this.transform.visible=!0,this.timeOffsetParam_.value=this.emitter_.clockParam.value},o3djs.particles.Trail=function(a,b,c,d,e,f,g){o3djs.particles.ParticleEmitter.call(this,a,e,g);var h=a.pack;this.allocateParticles_(c),this.validateParameters(d),this.parameters=d,this.perParticleParamSetter=f,this.birthIndex_=0,this.maxParticles_=c,this.transform=h.createObject("Transform"),this.transform.addShape(this.shape),this.transform.parent=b},o3djs.base.inherit(o3djs.particles.Trail,o3djs.particles.ParticleEmitter),o3djs.particles.Trail.prototype.birthParticles=function(a){var b=this.parameters.numParticles;this.parameters.startTime=this.clockParam.value,this.parameters.position=a;while(this.birthIndex_+b>=this.maxParticles_){var c=this.maxParticles_-this.birthIndex_;this.createParticles_(this.birthIndex_,c,this.parameters,this.perParticleParamSetter),b-=c,this.birthIndex_=0}this.createParticles_(this.birthIndex_,b,this.parameters,this.perParticleParamSetter),this.birthIndex_+=b},o3djs.provide("o3djs.picking"),o3djs.picking=o3djs.picking||{},o3djs.picking.Ray=goog.typedef,o3djs.picking.createPickInfo=function(a,b,c,d){return new o3djs.picking.PickInfo(a,b,c,d)},o3djs.picking.clientPositionToWorldRayEx=function(a,b,c,d,e,f){var g=o3djs.math.inverse(o3djs.math.matrix4.composition(d,c)),h=a/(e*.5)-1,i=-(b/(f*.5)-1);return{near:o3djs.math.matrix4.transformPoint(g,[h,i,0]),far:o3djs.math.matrix4.transformPoint(g,[h,i,1])}},o3djs.picking.clientPositionToWorldRay=function(a,b,c,d,e){return o3djs.picking.clientPositionToWorldRayEx(a,b,c.view,c.projection,d,e)},o3djs.picking.dprint=function(a){},o3djs.picking.dprintPoint3=function(a,b,c){},o3djs.picking.dprintBoundingBox=function(a,b,c){},o3djs.picking.dumpRayIntersectionInfo=function(a,b){o3djs.picking.dprint(a+" : valid = "+b.valid+" : intersected = "+b.intersected),b.intersected&&o3djs.picking.dprint(" : pos: "+b.position[0]+", "+b.position[1]+", "+b.position[2]+", "),o3djs.picking.dprint("\n")},o3djs.picking.PickInfo=function(a,b,c,d){this.element=a,this.shapeInfo=b,this.rayIntersectionInfo=c,this.worldIntersectionPosition=d},o3djs.picking.ShapeInfo=function(a,b,c){this.shape=a,this.parent=b,this.boundingBox=null,this.pickManager=c,this.update()},o3djs.picking.ShapeInfo.prototype.isPickable=function(){return!0},o3djs.picking.ShapeInfo.prototype.getBoundingBox=function(){return this.boundingBox},o3djs.picking.ShapeInfo.prototype.update=function(){var a=this.shape.elements;if(a.length>0){this.boundingBox=a[0].getBoundingBox(0);for(var b=1;b<a.length;b++)this.boundingBox=this.boundingBox.add(a[b].getBoundingBox(0))}},o3djs.picking.ShapeInfo.prototype.pick=function(a){if(this.isPickable()){var b=this.parent.transform.getUpdatedWorldMatrix(),c=o3djs.math.inverse(b),d=o3djs.math.matrix4.transformPoint(c,a.near),e=o3djs.math.matrix4.transformPoint(c,a.far),f=this.boundingBox.intersectRay(d,e);o3djs.picking.dumpRayIntersectionInfo("SHAPE(box): "+this.shape.name,f);if(f.intersected){var g=this.shape.elements;for(var h=0;h<g.length;h++){var i=g[h];f=i.intersectRay(0,o3djs.base.o3d.State.CULL_CCW,d,e),o3djs.picking.dumpRayIntersectionInfo("SHAPE(tris): "+this.shape.name+" : element "+i.name,f);if(f.intersected){var j=o3djs.math.matrix4.transformPoint(b,f.position);return o3djs.picking.createPickInfo(i,this,f,j)}}}}return null},o3djs.picking.ShapeInfo.prototype.dump=function(a){var b=a||"";o3djs.picking.dprint(b+"SHAPE: "+this.shape.name+"\n"),o3djs.picking.dprintPoint3("bb min",this.boundingBox.minExtent,b+"    "),o3djs.picking.dprintPoint3("bb max",this.boundingBox.maxExtent,b+"    ")},o3djs.picking.TransformInfo=function(a,b,c){this.childTransformInfos={},this.shapeInfos={},this.transform=a,this.parent=b,this.boundingBox=null,this.pickManager=c,this.pickableEvenIfInvisible=!1},o3djs.picking.TransformInfo.prototype.getBoundingBox=function(){return this.boundingBox},o3djs.picking.TransformInfo.prototype.isPickable=function(){return this.transform.visible||this.pickableEvenIfInvisible},o3djs.picking.TransformInfo.prototype.update=function(){var a={},b={},c=this.transform.children;for(var d=0;d<c.length;d++){var e=c[d],f=e.clientId,g=this.childTransformInfos[f];g||(g=this.pickManager.transformInfosByClientId[f],g?(delete g.parent.childTransformInfos[f],g.parent=this):g=this.pickManager.createTransformInfo(e,this)),g.boundingBox=null,g.update(),a[e.clientId]=g}var h=this.transform.shapes;for(var i=0;i<h.length;i++){var j=h[i],k=this.shapeInfos[j.clientId];k||(k=this.pickManager.createShapeInfo(j,this)),b[j.clientId]=k}for(var l in this.childTransformInfos){var m=l;if(!a[m]){var n=this.childTransformInfos[m];this.pickManager.onPickTree(n.transform)||this.pickManager.removeTransformInfo(n)}}this.childTransformInfos=a,this.shapeInfos=b;var o=null;for(var m in b){var k=b[m];if(k.isPickable()){var p=k.getBoundingBox().mul(this.transform.localMatrix);o?p&&(o=o.add(p)):o=p}}for(var m in a){var g=a[m];if(g.isPickable()){var p=g.getBoundingBox();p&&(o?o=o.add(p.mul(this.transform.localMatrix)):o=p.mul(this.transform.localMatrix))}}this.boundingBox=o},o3djs.picking.TransformInfo.prototype.pick=function(a){if(this.isPickable()&&this.boundingBox){var b=o3djs.math.matrix4.identity();this.parent&&(b=o3djs.math.inverse(this.parent.transform.getUpdatedWorldMatrix()));var c=o3djs.math.matrix4.transformPoint(b,a.near),d=o3djs.math.matrix4.transformPoint(b,a.far),e=this.boundingBox.intersectRay(c,d);o3djs.picking.dumpRayIntersectionInfo("TRANSFORM(box): "+this.transform.name,e);if(e.intersected){var f=null,g=-1;for(var h in this.childTransformInfos){var i=h,j=this.childTransformInfos[i],k=j.pick(a);if(k){var l=o3djs.math.lengthSquared(o3djs.math.subVector(a.near,k.worldIntersectionPosition));if(!f||l<g)g=l,f=k}}for(var h in this.shapeInfos){var i=h,m=this.shapeInfos[i],k=m.pick(a);if(k){var l=o3djs.math.lengthSquared(o3djs.math.subVector(a.near,k.worldIntersectionPosition));if(!f||l<g)g=l,f=k}}return f}}return null},o3djs.picking.TransformInfo.prototype.dump=function(a){var b=a||"";o3djs.picking.dprint(b+"TRANSFORM: "+this.transform.name+"\n"),this.boundingBox?(o3djs.picking.dprintPoint3("bb min",this.boundingBox.minExtent,b+"    "),o3djs.picking.dprintPoint3("bb max",this.boundingBox.maxExtent,b+"    ")):o3djs.picking.dprint(b+"    bb *NA*\n"),o3djs.picking.dprint(b+"--Shapes--\n");for(var c in this.shapeInfos){var d=c,e=this.shapeInfos[d];e.dump(b+"    ")}o3djs.picking.dprint(b+"--Children--\n");for(var c in this.childTransformInfos){var d=c,f=this.childTransformInfos[d];f.dump(b+"    ")}},o3djs.picking.PickManager=function(a){this.transformInfosByClientId={},this.rootTransformInfo=this.createTransformInfo(a,null)},o3djs.picking.PickManager.prototype.createShapeInfo=function(a,b){return new o3djs.picking.ShapeInfo(a,b,this)},o3djs.picking.PickManager.prototype.createTransformInfo=function(a,b){var c=new o3djs.picking.TransformInfo(a,b,this);this.addTransformInfo(c);return c},o3djs.picking.PickManager.prototype.addTransformInfo=function(a){this.transformInfosByClientId[a.transform.clientId]=a},o3djs.picking.PickManager.prototype.removeTransformInfo=function(a){delete this.transformInfosByClientId[a.transform.clientId]},o3djs.picking.PickManager.prototype.getTransformInfo=function(a){return this.transformInfosByClientId[a.clientId]},o3djs.picking.PickManager.prototype.update=function(){this.rootTransformInfo.update()},o3djs.picking.PickManager.prototype.dump=function(){this.rootTransformInfo.dump()},o3djs.picking.PickManager.prototype.pick=function(a){return this.rootTransformInfo.pick(a)},o3djs.picking.createPickManager=function(a){return new o3djs.picking.PickManager(a)},o3djs.picking.PickManager.prototype.onPickTree=function(a){var b=!1,c=a.parent;c===this.rootTransformInfo.transform?b=!0:c!=null&&(b=this.onPickTree(c));return b},o3djs.provide("o3djs.primitives"),o3djs.primitives=o3djs.primitives||{},o3djs.primitives.setCullingInfo=function(a){var b=a.getBoundingBox(0);a.boundingBox=b;var c=b.minExtent,d=b.maxExtent;a.zSortPoint=o3djs.math.divVectorScalar(o3djs.math.addVector(c,d),2)},o3djs.primitives.VertexStreamInfo=function(a,b,c){this.numComponents=a,this.semantic=b,this.semanticIndex=c||0,this.elements=[],this.addElement=function(a,b,c,d){},this.setElement=function(a,b,c,d,e){},this.addElementVector=function(a){},this.setElementVector=function(a,b){},this.getElementVector=function(a){return[]};switch(a){case 1:this.addElement=function(a){this.elements.push(a)},this.getElement=function(a){return this.elements[a]},this.setElement=function(a,b){this.elements[a]=b};break;case 2:this.addElement=function(a,b){this.elements.push(a,b)},this.addElementVector=function(a){this.elements.push(a[0],a[1])},this.getElementVector=function(b){return this.elements.slice(b*a,(b+1)*a)},this.setElement=function(b,c,d){this.elements[b*a+0]=c,this.elements[b*a+1]=d},this.setElementVector=function(b,c){this.elements[b*a+0]=c[0],this.elements[b*a+1]=c[1]};break;case 3:this.addElement=function(a,b,c){this.elements.push(a,b,c)},this.addElementVector=function(a){this.elements.push(a[0],a[1],a[2])},this.getElementVector=function(b){return this.elements.slice(b*a,(b+1)*a)},this.setElement=function(b,c,d,e){this.elements[b*a+0]=c,this.elements[b*a+1]=d,this.elements[b*a+2]=e},this.setElementVector=function(b,c){this.elements[b*a+0]=c[0],this.elements[b*a+1]=c[1],this.elements[b*a+2]=c[2]};break;case 4:this.addElement=function(a,b,c,d){this.elements.push(a,b,c,d)},this.addElementVector=function(a){this.elements.push(a[0],a[1],a[2],a[3])},this.getElementVector=function(b){return this.elements.slice(b*a,(b+1)*a)},this.setElement=function(b,c,d,e,f){this.elements[b*a+0]=c,this.elements[b*a+1]=d,this.elements[b*a+2]=e,this.elements[b*a+3]=f},this.setElementVector=function(b,c){this.elements[b*a+0]=c[0],this.elements[b*a+1]=c[1],this.elements[b*a+2]=c[2],this.elements[b*a+3]=c[3]};break;default:throw"A stream must contain between 1 and 4 components"}},o3djs.primitives.VertexStreamInfo.prototype.numElements=function(){return this.elements.length/this.numComponents},o3djs.primitives.createVertexStreamInfo=function(a,b,c){return new o3djs.primitives.VertexStreamInfo(a,b,c)},o3djs.primitives.VertexInfoBase=function(){this.streams=[],this.indices=[]},o3djs.primitives.VertexInfoBase.prototype.addStream=function(a,b,c){this.removeStream(b,c);var d=o3djs.primitives.createVertexStreamInfo(a,b,c);this.streams.push(d);return d},o3djs.primitives.VertexInfoBase.prototype.findStream=function(a,b){b=b||0;for(var c=0;c<this.streams.length;++c)if(this.streams[c].semantic===a&&this.streams[c].semanticIndex==b)return this.streams[c];return null},o3djs.primitives.VertexInfoBase.prototype.removeStream=function(a,b){b=b||0;for(var c=0;c<this.streams.length;++c)if(this.streams[c].semantic===a&&this.streams[c].semanticIndex==b){this.streams.splice(c,1);return}},o3djs.primitives.VertexInfoBase.prototype.append=function(a){if(this.streams.length==0&&a.streams.length!=0){for(var b=0;b<a.streams.length;b++){var c=a.streams[b],d=this.addStream(c.numComponents,c.semantic,c.semanticIndex);d.elements=d.elements.concat(c.elements)}this.indices=this.indices.concat(a.indices)}else{if(this.streams.length!=a.streams.length)throw"Number of VertexInfoStreams did not match";for(var b=0;b<this.streams.length;b++){var e=!1,f=this.streams[b].semantic,g=this.streams[b].numComponents,h=this.streams[b].semanticIndex;for(var i=0;i<a.streams.length;i++){var j=a.streams[i];if(j.semantic===f&&j.numComponents==g&&j.semanticIndex==h){e=!0;break}}if(!e)throw"Did not find stream with semantic="+f+", numComponents="+g+", and semantic index="+h+" in given VertexInfo"}var k=this.findStream(o3djs.base.o3d.Stream.POSITION);if(!k)throw"POSITION stream is missing";var l=k.numElements();for(var b=0;b<this.streams.length;b++){var d=this.streams[b],c=a.findStream(d.semantic,d.semanticIndex);d.elements=d.elements.concat(c.elements)}for(var b=0;b<a.indices.length;b++)this.indices.push(a.indices[b]+l)}},o3djs.primitives.VertexInfoBase.prototype.validate=function(){var a=this.findStream(o3djs.base.o3d.Stream.POSITION);if(!a)throw"POSITION stream is missing";var b=a.numElements();for(var c=0;c<this.streams.length;++c)if(this.streams[c].numElements()!==b)throw"Stream "+c+" contains "+this.streams[c].numElements()+" elements whereas the POSITION stream contains "+b;for(var d=0;d<this.indices.length;++d)if(this.indices[d]<0||this.indices[d]>=b)throw"The index "+this.indices[d]+" is out of range [0, "+b+"]"},o3djs.primitives.VertexInfoBase.prototype.reorient=function(a){var b=o3djs.math,c=b.inverse(b.matrix4.getUpper3x3(a));for(var d=0;d<this.streams.length;++d){var e=this.streams[d];if(e.numComponents==3){var f=e.numElements();switch(e.semantic){case o3djs.base.o3d.Stream.POSITION:for(var g=0;g<f;++g)e.setElementVector(g,b.matrix4.transformPoint(a,e.getElementVector(g)));break;case o3djs.base.o3d.Stream.NORMAL:for(var g=0;g<f;++g)e.setElementVector(g,b.matrix4.transformNormal(a,e.getElementVector(g)));break;case o3djs.base.o3d.Stream.TANGENT:case o3djs.base.o3d.Stream.BINORMAL:for(var g=0;g<f;++g)e.setElementVector(g,b.matrix4.transformDirection(a,e.getElementVector(g)))}}}},o3djs.primitives.VertexInfoBase.prototype.createShapeByType=function(a,b,c){this.validate();var d=this.indices.length,e;switch(c){case o3djs.base.o3d.Primitive.POINTLIST:e=d/1;break;case o3djs.base.o3d.Primitive.LINELIST:e=d/2;break;case o3djs.base.o3d.Primitive.LINESTRIP:e=d-1;break;case o3djs.base.o3d.Primitive.TRIANGLELIST:e=d/3;break;case o3djs.base.o3d.Primitive.TRIANGLESTRIP:case o3djs.base.o3d.Primitive.TRIANGLEFAN:e=d-2;break;default:throw"unknown primitive type"}var f=this.findStream(o3djs.base.o3d.Stream.POSITION),g=f.numElements(),h=a.createObject("Shape"),i=a.createObject("Primitive"),j=a.createObject("StreamBank");i.owner=h,i.streamBank=j,i.material=b,i.numberPrimitives=e,i.primitiveType=c,i.numberVertices=g,i.createDrawElement(a,null);var k=b.effect.getStreamInfo();for(var l=0;l<k.length;++l){var m=k[l].semantic,n=k[l].semanticIndex,o=this.findStream(m,n);if(!o)switch(m){case o3djs.base.o3d.Stream.TANGENT:case o3djs.base.o3d.Stream.BINORMAL:if(c==o3djs.base.o3d.Primitive.TRIANGLELIST)this.addTangentStreams(n);else throw"Can not create tangents and binormals for primitive type"+c;break;case o3djs.base.o3d.Stream.COLOR:o=this.addStream(4,m,n);for(var p=0;p<g;++p)o.addElement(1,1,1,1);break;case o3djs.base.o3d.Stream.INFLUENCE_WEIGHTS:case o3djs.base.o3d.Stream.INFLUENCE_INDICES:break;default:throw"Missing stream for semantic "+m+" with semantic index "+n}}var q=a.createObject("VertexBuffer"),r=[];for(var l=0;l<this.streams.length;++l){var s=this.streams[l],t=s.semantic==o3djs.base.o3d.Stream.COLOR&&s.numComponents==4?"UByteNField":"FloatField";r[l]=q.createField(t,s.numComponents),j.setVertexStream(s.semantic,s.semanticIndex,r[l],0)}q.allocateElements(g);for(var l=0;l<this.streams.length;++l)r[l].setAt(0,this.streams[l].elements);var u=a.createObject("IndexBuffer");u.set(this.indices),i.indexBuffer=u,o3djs.primitives.setCullingInfo(i);return h},o3djs.primitives.VertexInfo=function(){o3djs.primitives.VertexInfoBase.call(this)},o3djs.base.inherit(o3djs.primitives.VertexInfo,o3djs.primitives.VertexInfoBase),o3djs.primitives.VertexInfo.prototype.numTriangles=function(){return this.indices.length/3},o3djs.primitives.VertexInfo.prototype.addTriangle=function(a,b,c){this.indices.push(a,b,c)},o3djs.primitives.VertexInfo.prototype.getTriangle=function(a){var b=a*3;return[this.indices[b+0],this.indices[b+1],this.indices[b+2]]},o3djs.primitives.VertexInfo.prototype.setTriangle=function(a,b,c,d){var e=a*3;this.indices[e+0]=b,this.indices[e+1]=c,this.indices[e+2]=d},o3djs.primitives.VertexInfo.prototype.createShape=function(a,b){return this.createShapeByType(a,b,o3djs.base.o3d.Primitive.TRIANGLELIST)},o3djs.primitives.VertexInfo.prototype.addTangentStreams=function(a){function j(a,b){var c=h(a,b);return f[c]}function i(a,c,d,e){var g=h(a,c),i=f[g];i||(i=[[0,0,0],[0,0,0]]),i=b.addMatrix(i,[d,e]),f[g]=i}function h(a,c){return g(b.mulVectorScalar(a,100))+","+g(b.mulVectorScalar(c,100))}function g(a){return[Math.round(a[0]),Math.round(a[1]),Math.round(a[2])]}a=a||0;var b=o3djs.math;this.validate();var c=this.findStream(o3djs.base.o3d.Stream.POSITION);if(!c)throw"Cannot calculate tangent frame because POSITION stream is missing";if(c.numComponents!=3)throw"Cannot calculate tangent frame because POSITION stream is not 3D";var d=this.findStream(o3djs.base.o3d.Stream.NORMAL);if(!d)throw"Cannot calculate tangent frame because NORMAL stream is missing";if(d.numComponents!=3)throw"Cannot calculate tangent frame because NORMAL stream is not 3D";var e=this.findStream(o3djs.base.o3d.Stream.TEXCOORD,a);if(!e)throw"Cannot calculate tangent frame because TEXCOORD stream "+a+" is missing";var f={},k=this.numTriangles();for(var l=0;l<k;++l){var m=this.getTriangle(l),n=[],o=[],p=[];for(var q=0;q<3;++q){var r=m[q];n[q]=e.getElementVector(r),o[q]=c.getElementVector(r),p[q]=d.getElementVector(r)}var s=[0,0,0],t=[0,0,0];for(var u=0;u<3;++u){var v=[o[1][u]-o[0][u],n[1][0]-n[0][0],n[1][1]-n[0][1]],w=[o[2][u]-o[0][u],n[2][0]-n[0][0],n[2][1]-n[0][1]],x=b.normalize(b.cross(v,w));x[0]==0&&(x[0]=1),s[u]=-x[1]/x[0],t[u]=-x[2]/x[0]}var y=b.length(s);y>.001&&(s=b.mulVectorScalar(s,1/y));var z=b.length(t);z>.001&&(t=b.mulVectorScalar(t,1/z));for(var q=0;q<3;++q)i(o[q],p[q],s,t)}var A=this.addStream(3,o3djs.base.o3d.Stream.TANGENT,a),B=this.addStream(3,o3djs.base.o3d.Stream.BINORMAL,a),C=c.numElements();for(var r=0;r<C;++r){var D=c.getElementVector(r),E=d.getElementVector(r),F=j(D,E),s=F[0];s=b.subVector(s,b.mulVectorScalar(E,b.dot(E,s)));var y=b.length(s);y>.001&&(s=b.mulVectorScalar(s,1/y));var t=F[1];t=b.subVector(t,b.mulVectorScalar(s,b.dot(s,t))),t=b.subVector(t,b.mulVectorScalar(E,b.dot(E,t)));var z=b.length(t);z>.001&&(t=b.mulVectorScalar(t,1/z)),A.setElementVector(r,s),B.setElementVector(r,t)}},o3djs.primitives.createVertexInfo=function(){return new o3djs.primitives.VertexInfo},o3djs.primitives.createSphereVertices=function(a,b,c,d){if(b<=0||c<=0)throw Error("subdivisionAxis and subdivisionHeight must be > 0");var e=o3djs.primitives.createVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=e.addStream(3,o3djs.base.o3d.Stream.NORMAL),h=e.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0);for(var i=0;i<=c;i++)for(var j=0;j<=b;j++){var k=j/b,l=i/c,m=2*Math.PI*k,n=Math.PI*l,o=Math.sin(m),p=Math.cos(m),q=Math.sin(n),r=Math.cos(n),s=p*q,t=r,u=o*q;f.addElement(a*s,a*t,a*u),g.addElement(s,t,u),h.addElement(1-k,1-l)}var v=b+1;for(var j=0;j<b;j++)for(var i=0;i<c;i++)e.addTriangle((i+0)*v+j,(i+0)*v+j+1,(i+1)*v+j),e.addTriangle((i+1)*v+j,(i+0)*v+j+1,(i+1)*v+j+1);d&&e.reorient(d);return e},o3djs.primitives.createSphere=function(a,b,c,d,e,f){var g=o3djs.primitives.createSphereVertices(c,d,e,f);return g.createShape(a,b)},o3djs.primitives.CUBE_FACE_INDICES_=[[3,7,5,1],[0,4,6,2],[6,7,3,2],[0,1,5,4],[5,7,6,4],[2,3,1,0]],o3djs.primitives.createCubeVertices=function(a,b){var c=a/2,d=[[-c,-c,-c],[+c,-c,-c],[-c,+c,-c],[+c,+c,-c],[-c,-c,+c],[+c,-c,+c],[-c,+c,+c],[+c,+c,+c]],e=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],f=[[0,0],[1,0],[1,1],[0,1]],g=o3djs.primitives.createVertexInfo(),h=g.addStream(3,o3djs.base.o3d.Stream.POSITION),i=g.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=g.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0);for(var k=0;k<6;++k){var l=o3djs.primitives.CUBE_FACE_INDICES_[k];for(var m=0;m<4;++m){var n=d[l[m]],o=e[k],p=f[m];h.addElementVector(n),i.addElementVector(o),j.addElementVector(p);var q=4*k;g.addTriangle(q+0,q+1,q+2),g.addTriangle(q+0,q+2,q+3)}}b&&g.reorient(b);return g},o3djs.primitives.createCube=function(a,b,c,d){var e=o3djs.primitives.createCubeVertices(c,d);return e.createShape(a,b)},o3djs.primitives.createBox=function(a,b,c,d,e,f){var g=o3djs.primitives.createCubeVertices(1);g.reorient([[c,0,0,0],[0,d,0,0],[0,0,e,0],[0,0,0,1]]),f&&g.reorient(f);return g.createShape(a,b)},o3djs.primitives.createRainbowCube=function(a,b,c,d){var e=o3djs.primitives.createCubeVertices(c,d),f=e.addStream(4,o3djs.base.o3d.Stream.COLOR),g=[[1,0,0,1],[0,1,0,1],[0,0,1,1],[1,1,0,1],[0,1,1,1],[1,0,1,1],[0,.5,.3,1],[.3,0,.5,1]],h=e.vertices;for(var i=0;i<6;++i){var j=o3djs.primitives.CUBE_FACE_INDICES_[i];for(var k=0;k<4;++k){var l=g[j[k]];f.addElementVector(l)}}return e.createShape(a,b)},o3djs.primitives.createDiscVertices=function(a,b,c,d,e,f){if(b<3)throw Error("divisions must be at least 3");var g=c?c:1,h=d?d:0,i=e?e:1,j=o3djs.primitives.createVertexInfo(),k=j.addStream(3,o3djs.base.o3d.Stream.POSITION),l=j.addStream(3,o3djs.base.o3d.Stream.NORMAL),m=j.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),n=0;h==0&&(k.addElement(0,0,0),l.addElement(0,1,0),m.addElement(0,0),n++);for(var o=Math.max(h,1);o<=g;++o){var p=a*Math.pow(o/g,i);for(var q=0;q<b;++q){var r=2*Math.PI*q/b,s=p*Math.cos(r),t=p*Math.sin(r);k.addElement(s,0,t),l.addElement(0,1,0),m.addElement(s,t);if(o>h){var u=n+(q+1)%b,v=n+q;if(o>1){var w=n+q-b,x=n+(q+1)%b-b;j.addTriangle(u,v,w),j.addTriangle(u,w,x)}else j.addTriangle(0,u,v)}}n+=b}f&&j.reorient(f);return j},o3djs.primitives.createDisc=function(a,b,c,d,e,f,g,h){var i=o3djs.primitives.createDiscVertices(c,d,e,f,g,h);return i.createShape(a,b)},o3djs.primitives.createCylinderVertices=function(a,b,c,d,e){return o3djs.primitives.createTruncatedConeVertices(a,a,b,c,d,e)},o3djs.primitives.createCylinder=function(a,b,c,d,e,f,g){var h=o3djs.primitives.createCylinderVertices(c,d,e,f,g);return h.createShape(a,b)},o3djs.primitives.createTruncatedConeVertices=function(a,b,c,d,e,f){if(d<3)throw Error("radialSubdivisions must be 3 or greater");if(e<1)throw Error("verticalSubdivisions must be 1 or greater");var g=o3djs.primitives.createVertexInfo(),h=g.addStream(3,o3djs.base.o3d.Stream.POSITION),i=g.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=g.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),k=d+1,l=Math.atan2(a-b,c),m=Math.cos(l),n=Math.sin(l);for(var o=-2;o<=e+2;++o){var p=o/e,q=c*p,r;o<0?(q=0,p=1,r=a):o>e?(q=c,p=1,r=b):r=a+(b-a)*(o/e);if(o==-2||o==e+2)r=0,p=0;q-=c/2;for(var s=0;s<k;++s){var t=Math.sin(s*Math.PI*2/d),u=Math.cos(s*Math.PI*2/d);h.addElement(t*r,q,u*r),i.addElement(o<0||o>e?0:t*m,o<0?-1:o>e?1:n,o<0||o>e?0:u*m),j.addElement(s/d,p)}}for(var o=0;o<e+4;++o)for(var s=0;s<d;++s)g.addTriangle(k*(o+0)+0+s,k*(o+0)+1+s,k*(o+1)+1+s),g.addTriangle(k*(o+0)+0+s,k*(o+1)+1+s,k*(o+1)+0+s);f&&g.reorient(f);return g},o3djs.primitives.createTruncatedCone=function(a,b,c,d,e,f,g,h){var i=o3djs.primitives.createTruncatedConeVertices(c,d,e,f,g,h);return i.createShape(a,b)},o3djs.primitives.createTorusVertices=function(a,b,c,d,e){if(c<3)throw Error("tubeLengthSubdivisions must be 3 or greater");if(d<3)throw Error("circleSubdivisions must be 3 or greater");var f=o3djs.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),i=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0);for(var j=0;j<c;++j){var k=j/c*2*Math.PI;for(var l=0;l<d;++l){var m=l/d*2*Math.PI,n=Math.sin(k),o=Math.cos(k),p=Math.sin(m),q=Math.cos(m);g.addElement((a+b*q)*o,b*p,(a+b*q)*n),h.addElement(q*o,p,q*n),i.addElement(j/c,l/d)}}for(var j=0;j<c;++j)for(var l=0;l<d;++l){var r=(j+1)%c,s=(l+1)%d,t=d*j+l,u=d*r+l,v=d*j+s,w=d*r+s;f.addTriangle(t,w,u),f.addTriangle(t,v,w)}e&&f.reorient(e);return f},o3djs.primitives.createTorus=function(a,b,c,d,e,f,g){var h=o3djs.primitives.createTorusVertices(c,d,e,f,g);return h.createShape(a,b)},o3djs.primitives.createWedgeVertices=function(a,b,c){var d=o3djs.math,e=o3djs.primitives.createVertexInfo(),f=e.addStream(3,o3djs.base.o3d.Stream.POSITION),g=e.addStream(3,o3djs.base.o3d.Stream.NORMAL),h=e.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),i=-b*.5,j=b*.5,k=[],l=[[a[0][0],a[0][1]],[a[1][0],a[1][1]],[a[2][0],a[2][1]]];k[0]=d.cross(d.normalize([l[1][0]-l[0][0],l[1][1]-l[0][1],i-i]),d.normalize([l[1][0]-l[1][0],l[1][1]-l[1][1],j-i])),k[1]=d.cross(d.normalize([l[2][0]-l[1][0],l[2][1]-l[1][1],i-i]),d.normalize([l[2][0]-l[2][0],l[2][1]-l[2][1],j-i])),k[2]=d.cross([l[0][0]-l[2][0],l[0][1]-l[2][1],i-i],[l[0][0]-l[0][0],l[0][1]-l[0][1],j-i]),f.addElement(l[0][0],l[0][1],i),g.addElement(0,0,-1),h.addElement(0,1),f.addElement(l[1][0],l[1][1],i),g.addElement(0,0,-1),h.addElement(1,0),f.addElement(l[2][0],l[2][1],i),g.addElement(0,0,-1),h.addElement(0,0),f.addElement(l[0][0],l[0][1],j),g.addElement(0,0,1),h.addElement(0,1),f.addElement(l[1][0],l[1][1],j),g.addElement(0,0,1),h.addElement(1,0),f.addElement(l[2][0],l[2][1],j),g.addElement(0,0,1),h.addElement(0,0),f.addElement(l[0][0],l[0][1],i),g.addElement(k[0][0],k[0][1],k[0][2]),h.addElement(0,1),f.addElement(l[1][0],l[1][1],i),g.addElement(k[0][0],k[0][1],k[0][2]),h.addElement(0,0),f.addElement(l[1][0],l[1][1],j),g.addElement(k[0][0],k[0][1],k[0][2]),h.addElement(1,0),f.addElement(l[0][0],l[0][1],j),g.addElement(k[0][0],k[0][1],k[0][2]),h.addElement(1,1),f.addElement(l[1][0],l[1][1],i),g.addElement(k[1][0],k[1][1],k[1][2]),h.addElement(0,1),f.addElement(l[2][0],l[2][1],i),g.addElement(k[1][0],k[1][1],k[1][2]),h.addElement(0,0),f.addElement(l[2][0],l[2][1],j),g.addElement(k[1][0],k[1][1],k[1][2]),h.addElement(1,0),f.addElement(l[1][0],l[1][1],j),g.addElement(k[1][0],k[1][1],k[1][2]),h.addElement(1,1),f.addElement(l[2][0],l[2][1],i),g.addElement(k[2][0],k[2][1],k[2][2]),h.addElement(0,1),f.addElement(l[0][0],l[0][1],i),g.addElement(k[2][0],k[2][1],k[2][2]),h.addElement(0,0),f.addElement(l[0][0],l[0][1],j),g.addElement(k[2][0],k[2][1],k[2][2]),h.addElement(1,0),f.addElement(l[2][0],l[2][1],j),g.addElement(k[2][0],k[2][1],k[2][2]),h.addElement(1,1),e.addTriangle(0,2,1),e.addTriangle(3,4,5),e.addTriangle(6,7,8),e.addTriangle(6,8,9),e.addTriangle(10,11,12),e.addTriangle(10,12,13),e.addTriangle(14,15,16),e.addTriangle(14,16,17),c&&e.reorient(c);return e},o3djs.primitives.createWedge=function(a,b,c,d,e){var f=o3djs.primitives.createWedgeVertices(c,d,e);return f.createShape(a,b)},o3djs.primitives.createPrismVertices=function(a,b,c){if(a.length<3)throw Error("there must be 3 or more points");var d=-0.5*b,e=.5*b,f=[],g=o3djs.primitives.createVertexInfo(),h=g.addStream(3,o3djs.base.o3d.Stream.POSITION),i=g.addStream(3,o3djs.base.o3d.Stream.NORMAL),j=g.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0),k=a.length;for(var l=0;l<k;++l){var m=(l+1)%k,n=a[m][0]-a[l][0],o=a[m][1]-a[l][1],p=Math.sqrt(n*n+o*o);f[l]=[o/p,-n/p,0]}var q=a[0][0],r=a[0][1],s=a[0][0],t=a[0][1];for(var l=1;l<k;++l){var n=a[l][0],o=a[l][1];q=Math.min(q,n),r=Math.min(r,o),s=Math.max(s,n),t=Math.max(t,o)}var u=[],v=[],w=s-q,x=t-r;for(var l=0;l<k;++l)u[l]=[(a[l][0]-q)/w,(a[l][1]-r)/x],v[l]=[(s-a[l][0])/w,(a[l][1]-r)/x];for(var l=0;l<k;++l){var m=(l+1)%k;h.addElement(a[l][0],a[l][1],d),i.addElement(0,0,-1),j.addElement(v[l][0],v[l][1]),h.addElement(a[l][0],a[l][1],e),i.addElement(0,0,1),j.addElement(u[l][0],u[l][1]),h.addElement(a[l][0],a[l][1],d),i.addElement(f[l][0],f[l][1],f[l][2]),j.addElement(0,1),h.addElement(a[m][0],a[m][1],d),i.addElement(f[l][0],f[l][1],f[l][2]),j.addElement(0,0),h.addElement(a[m][0],a[m][1],e),i.addElement(f[l][0],f[l][1],f[l][2]),j.addElement(1,0),h.addElement(a[l][0],a[l][1],e),i.addElement(f[l][0],f[l][1],f[l][2]),j.addElement(1,1),l>0&&l<k-1&&(g.addTriangle(0,6*(l+1),6*l),g.addTriangle(1,6*l+1,6*(l+1)+1)),g.addTriangle(6*l+2,6*l+3,6*l+4),g.addTriangle(6*l+2,6*l+4,6*l+5)}c&&g.reorient(c);return g},o3djs.primitives.createPrism=function(a,b,c,d,e){var f=o3djs.primitives.createPrismVertices(c,d,e);return f.createShape(a,b)},o3djs.primitives.createPlaneVertices=function(a,b,c,d,e){if(c<=0||d<=0)throw Error("subdivisionWidth and subdivisionDepth must be > 0");var f=o3djs.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),i=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0);for(var j=0;j<=d;j++)for(var k=0;k<=c;k++){var l=k/c,m=j/d;g.addElement(a*l-a*.5,0,b*m-b*.5),h.addElement(0,1,0),i.addElement(l,1-m)}var n=c+1;for(var j=0;j<d;j++)for(var k=0;k<c;k++)f.addTriangle((j+0)*n+k,(j+1)*n+k,(j+0)*n+k+1),f.addTriangle((j+1)*n+k,(j+1)*n+k+1,(j+0)*n+k+1);e&&f.reorient(e);return f},o3djs.primitives.createPlane=function(a,b,c,d,e,f,g){var h=o3djs.primitives.createPlaneVertices(c,d,e,f,g);return h.createShape(a,b)},o3djs.primitives.createFadePlane=function(a,b,c,d,e,f,g){var h=o3djs.primitives.createPlaneVertices(c,d,e,f,g),i=h.addStream(4,o3djs.base.o3d.Stream.COLOR);for(var j=0;j<=f;j++){var k=j/f;for(var l=0;l<=e;l++)i.addElement(1,1,1,k)}return h.createShape(a,b)},o3djs.provide("o3djs.rendergraph"),o3djs.rendergraph=o3djs.rendergraph||{},o3djs.rendergraph.createView=function(a,b,c,d,e,f,g,h,i){return new o3djs.rendergraph.ViewInfo(a,b,c,d,e,f,g,h,i)},o3djs.rendergraph.createBasicView=function(a,b,c,d,e,f){return o3djs.rendergraph.createView(a,b,c,d,e,f)},o3djs.rendergraph.createExtraView=function(a,b,c,d){return o3djs.rendergraph.createView(a.pack,a.treeRoot,a.renderGraphRoot,c,d,b,a.performanceDrawList,a.zOrderedDrawList)},o3djs.rendergraph.ViewInfo=function(a,b,c,d,e,f,g,h,i){function r(a,b){return j.createDrawPass(a,undefined,undefined,undefined,b)}var j=this,k=d||[.5,.5,.5,1],l=e||0,m=0,n=a.createObject("Viewport");f&&(n.viewport=f),n.priority=l;var o=a.createObject("ClearBuffer");o.clearColor=k,o.priority=m++,o.parent=n;var p=a.createObject("TreeTraversal");p.priority=m++,p.parent=n,p.transform=b,this.drawPassInfos_=[],this.pack=a,this.renderGraphRoot=c,this.treeRoot=b,this.root=n,this.viewport=n,this.clearBuffer=o;var q=i||a.createObject("DrawContext");this.drawContext=q,this.treeTraversal=p,this.priority=m;var s=r(o3djs.base.o3d.DrawList.BY_PERFORMANCE,g),t=s.state,u=r(o3djs.base.o3d.DrawList.BY_Z_ORDER,h),v=u.state;v.getStateParam("AlphaBlendEnable").value=!0,v.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA,v.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA,v.getStateParam("AlphaTestEnable").value=!0,v.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER,c&&(this.root.parent=c),this.performanceDrawPassInfo=s,this.zOrderedDrawPassInfo=u,this.performanceStateSet=s.stateSet,this.performanceState=t,this.performanceDrawList=s.drawList,this.zOrderedStateSet=u.stateSet,this.zOrderedState=v,this.zOrderedDrawList=u.drawList,this.performanceDrawPass=s.drawPass,this.zOrderedDrawPass=u.drawPass,this.ownDrawContext_=i?!1:!0},o3djs.rendergraph.ViewInfo.prototype.destroy=function(a,b){a===undefined&&(a=!0);for(var c=0;c<this.drawPassInfos_.length;++c)this.drawPassInfos_[c].destroy();this.pack.removeObject(this.viewport),this.pack.removeObject(this.clearBuffer),a&&this.ownDrawContext_&&this.pack.removeObject(this.drawContext),this.pack.removeObject(this.treeTraversal),this.viewport.parent=null},o3djs.rendergraph.ViewInfo.prototype.createDrawPass=function(a,b,c,d,e){b=b||this.drawContext,d=d||this.viewport,c=typeof c!="undefined"?c:this.priority++;var f=o3djs.rendergraph.createDrawPassInfo(this.pack,b,a,d,e);f.root.priority=c,this.treeTraversal.registerDrawList(f.drawList,b,!0),this.drawPassInfos_.push(f);return f},o3djs.rendergraph.createDrawPassInfo=function(a,b,c,d,e){return new o3djs.rendergraph.DrawPassInfo(a,b,c,d,e)},o3djs.rendergraph.DrawPassInfo=function(a,b,c,d,e){var f=e?!1:!0;d=d||null,e=e||a.createObject("DrawList");var g=a.createObject("StateSet"),h=a.createObject("State");g.state=h,g.parent=d;var i=a.createObject("DrawPass");i.drawList=e,i.sortMethod=c,i.parent=g,this.pack=a,this.state=h,this.stateSet=g,this.drawPass=i,this.drawList=e,this.root=g,this.ownDrawList_=f},o3djs.rendergraph.DrawPassInfo.prototype.destroy=function(){this.ownDrawList_&&(this.drawPass.drawList=null,this.pack.removeObject(this.drawList)),this.drawPass.parent=null,this.stateSet.parent=null,this.pack.removeObject(this.drawPass),this.pack.removeObject(this.stateSet),this.pack.removeObject(this.state)},o3djs.provide("o3djs.canvas"),o3djs.canvas=o3djs.canvas||{},o3djs.canvas.create=function(a,b,c){return new o3djs.canvas.CanvasInfo(a,b,c)},o3djs.canvas.buildShaderString=function(){var a=o3djs.effect,b=a.BEGIN_OUT_STRUCT+a.VARYING+a.FLOAT4+" "+a.VARYING_DECLARATION_PREFIX+"position"+a.semanticSuffix("POSITION")+";\n"+a.VARYING+a.FLOAT2+" "+a.VARYING_DECLARATION_PREFIX+"texCoord"+a.semanticSuffix("TEXCOORD0")+";\n"+a.END_STRUCT;return"uniform "+a.MATRIX4+" worldViewProjection"+a.semanticSuffix("WORLDVIEWPROJECTION")+";\n\n"+a.BEGIN_IN_STRUCT+a.ATTRIBUTE+a.FLOAT4+" position"+a.semanticSuffix("POSITION")+";\n"+a.ATTRIBUTE+a.FLOAT2+" texCoord0"+a.semanticSuffix("TEXCOORD0")+";\n"+a.END_STRUCT+"\n"+b+"\n"+a.beginVertexShaderMain()+"  "+a.VERTEX_VARYING_PREFIX+"position = "+a.mul(a.ATTRIBUTE_PREFIX+"position","worldViewProjection")+";\n"+"  "+a.VERTEX_VARYING_PREFIX+"texCoord = "+a.ATTRIBUTE_PREFIX+"texCoord0;\n"+a.endVertexShaderMain()+"\n"+a.pixelShaderHeader()+"uniform "+a.SAMPLER+" texSampler0;\n"+a.repeatVaryingDecls(b)+a.beginPixelShaderMain()+a.endPixelShaderMain(a.TEXTURE+"2D"+"(texSampler0, "+a.PIXEL_VARYING_PREFIX+"texCoord)")+a.entryPoints()+a.matrixLoadOrder()},o3djs.canvas.CanvasInfo=function(a,b,c){this.pack=a,this.viewInfo=c,this.root=b,this.effect_=this.pack.createObject("Effect"),this.effect_.loadFromFXString(o3djs.canvas.buildShaderString()),this.transparentMaterial_=this.pack.createObject("Material"),this.opaqueMaterial_=this.pack.createObject("Material"),this.transparentMaterial_.effect=this.effect_,this.opaqueMaterial_.effect=this.effect_,this.transparentMaterial_.drawList=c.zOrderedDrawList,this.opaqueMaterial_.drawList=c.performanceDrawList,this.transparentState_=this.pack.createObject("State"),this.transparentState_.getStateParam("AlphaBlendEnable").value=!0,this.transparentState_.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_ONE,this.transparentState_.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA,this.transparentMaterial_.state=this.transparentState_,this.transparentQuadShape=o3djs.primitives.createPlane(this.pack,this.transparentMaterial_,1,1,1,1,[[1,0,0,0],[0,0,1,0],[0,-1,0,0],[0,0,0,1]]),this.opaqueQuadShape=o3djs.primitives.createPlane(this.pack,this.opaqueMaterial_,1,1,1,1,[[1,0,0,0],[0,0,1,0],[0,-1,0,0],[0,0,0,1]])},o3djs.canvas.CanvasQuad=function(a,b,c,d,e){this.canvasInfo=a;var f=e||a.root;this.transform=a.pack.createObject("Transform"),this.transform.parent=f,this.scaleTransform=a.pack.createObject("Transform"),this.scaleTransform.parent=this.transform,this.texture=a.pack.createTexture2D(b,c,o3djs.base.o3d.Texture.ARGB8,1,!1),this.canvas=a.pack.createObject("Canvas"),this.canvas.setSize(b,c),this.sampler=a.pack.createObject("Sampler"),this.sampler.addressModeU=o3djs.base.o3d.Sampler.CLAMP,this.sampler.addressModeV=o3djs.base.o3d.Sampler.CLAMP,this.paramSampler_=this.scaleTransform.createParam("texSampler0","ParamSampler"),this.paramSampler_.value=this.sampler,this.sampler.texture=this.texture,d?this.scaleTransform.addShape(a.transparentQuadShape):this.scaleTransform.addShape(a.opaqueQuadShape),this.scaleTransform.translate(b/2,c/2,0),this.scaleTransform.scale(b,-c,1)},o3djs.canvas.CanvasQuad.prototype.updateTexture=function(){var a=this.texture.width,b=this.texture.height;this.texture.drawImage(this.canvas,0,b-1,a,-b,0,0,0,a,b)},o3djs.canvas.CanvasInfo.prototype.createXYQuad=function(a,b,c,d,e,f,g){var h=new o3djs.canvas.CanvasQuad(this,d,e,f,g);h.transform.translate(a,b,c);return h},o3djs.canvas.CanvasInfo.prototype.createQuad=function(a,b,c,d){return new o3djs.canvas.CanvasQuad(this,a,b,c,d)},o3djs.provide("o3djs.material"),o3djs.material=o3djs.material||{},o3djs.material.hasNonOneAlpha_=function(a,b){var c=!1,d=!1,e=null,f=a.getParam(b+"Sampler");if(f&&f.isAClassName("o3d.ParamSampler")){c=!0;var g=f.value;g&&(e=g.texture)}else{var h=a.getParam(b+"Texture");h&&h.isAClassName("o3d.ParamTexture")&&(c=!0,e=h.value)}e&&!e.alphaIsOne&&(d=!0);if(!c){var i=a.getParam(b);i&&i.isAClassName("o3d.ParamFloat4")&&(c=!0)}return{found:c,nonOneAlpha:d}},o3djs.material.prepareMaterial=function(a,b,c,d){var e=b.performanceDrawList;if(!c.drawList){var f=c.getParam("collada.transparent");f&&f.className=="o3d.ParamBoolean"&&(c.drawList=f.value?b.zOrderedDrawList:b.performanceDrawList)}if(!c.effect){if(!d){var g=o3djs.effect.getColladaLightingType(c);g&&(d=g)}if(d){o3djs.material.attachStandardEffect(a,c,b,d);if(c.drawList==null){var h=o3djs.material.hasNonOneAlpha_(c,"diffuse");h.found||(h=o3djs.material.hasNonOneAlpha_(c,"emissive")),h.nonOneAlpha&&(e=b.zOrderedDrawList)}}}c.drawList||(c.drawList=e)},o3djs.material.prepareMaterials=function(a,b,c){var d=a.getObjectsByClassName("o3d.Material");for(var e=0;e<d.length;e++)o3djs.material.prepareMaterial(c||a,b,d[e])},o3djs.material.attachStandardEffectEx=function(a,b,c){if(!b.effect&&!o3djs.effect.attachStandardShader(a,b,[0,0,0],c))throw"Could not attach a standard effect"},o3djs.material.attachStandardEffect=function(a,b,c,d){if(!b.effect){var e=o3djs.math.matrix4.getTranslation(o3djs.math.inverse(c.drawContext.view));if(!o3djs.effect.attachStandardShader(a,b,e,d))throw"Could not attach a standard effect"}},o3djs.material.setDrawListOnMaterials=function(a,b){var c=a.getObjectsByClassName("o3d.Material");for(var d=0;d<c.length;d++){var e=c[d];e.drawList=b}},o3djs.material.createBasicMaterial=function(a,b,c,d){var e=a.createObject("Material");e.drawList=d?b.zOrderedDrawList:b.performanceDrawList;if(c.length)e.createParam("diffuse","ParamFloat4").value=c;else{var f=e.createParam("diffuseSampler","ParamSampler"),g=a.createObject("Sampler");f.value=g,g.texture=c}e.createParam("emissive","ParamFloat4").value=[0,0,0,1],e.createParam("ambient","ParamFloat4").value=[0,0,0,1],e.createParam("specular","ParamFloat4").value=[1,1,1,1],e.createParam("shininess","ParamFloat").value=50,e.createParam("specularFactor","ParamFloat").value=1,e.createParam("lightColor","ParamFloat4").value=[1,1,1,1];var h=e.createParam("lightWorldPos","ParamFloat3");o3djs.material.attachStandardEffect(a,e,b,"phong"),h.value=[1e3,2e3,3e3];return e},o3djs.material.createConstantMaterialEx=function(a,b,c){var d=a.createObject("Material");d.drawList=b;if(c.length)d.createParam("emissive","ParamFloat4").value=c;else{var e=d.createParam("emissiveSampler","ParamSampler"),f=a.createObject("Sampler");e.value=f,f.texture=c}o3djs.material.attachStandardEffectEx(a,d,"constant");return d},o3djs.material.createConstantMaterial=function(a,b,c,d){return o3djs.material.createConstantMaterialEx(a,d?b.zOrderedDrawList:b.performanceDrawList,c)},o3djs.material.createCheckerMaterial=function(a,b,c,d,e,f){c=c||[.4,.5,.5,1],d=d||[.6,.8,.8,1],f=f||10;var g=o3djs.effect.createCheckerEffect(a),h=a.createObject("Material");h.effect=g,h.drawList=e?b.zOrderedDrawList:b.performanceDrawList,o3djs.effect.createUniformParameters(a,g,h),h.getParam("color1").value=c,h.getParam("color2").value=d,h.getParam("checkSize").value=f;return h},o3djs.material.createMaterialFromFile=function(a,b,c){var d=o3djs.effect.createEffectFromFile(a,b),e=a.createObject("Material");e.effect=d,e.drawList=c,o3djs.effect.createUniformParameters(a,d,e);return e},o3djs.material.bindParamsOnMaterial=function(a,b){for(var c in b){var d=b[c],e=a.getParam(c);e&&d.isAClassName(e.className)&&e.bind(d)}},o3djs.material.bindParams=function(a,b){var c=a.getObjectsByClassName("o3d.Material");for(var d=0;d<c.length;++d)o3djs.material.bindParamsOnMaterial(c[d],b)},o3djs.material.createParams=function(a,b){var c=a.createObject("ParamObject"),d={};for(var e in b)d[e]=c.createParam(e,b[e]);return d},o3djs.material.createStandardParams=function(a){var b={lightColor:"ParamFloat4",lightWorldPos:"ParamFloat3"};return o3djs.material.createParams(a,b)},o3djs.material.createAndBindStandardParams=function(a){var b=o3djs.material.createStandardParams(a);o3djs.material.bindParams(a,b);return b},o3djs.provide("o3djs.io"),o3djs.io=o3djs.io||{},o3djs.io.createLoadInfo=function(a,b){return new o3djs.io.LoadInfo(a,b)},o3djs.io.LoadInfo=function(a,b){this.request_=a,this.hasStatus_=b,this.streamLength_=0,this.children_=[]},o3djs.io.LoadInfo.prototype.addChild=function(a){this.children_.push(a)},o3djs.io.LoadInfo.prototype.finish=function(){this.request_&&(this.hasStatus_&&(this.streamLength_=this.request_.streamLength),this.request_=null)},o3djs.io.LoadInfo.prototype.getTotalKnownBytesToStreamSoFar=function(){!this.streamLength_&&this.request_&&this.hasStatus_&&(this.streamLength_=this.request_.streamLength);var a=this.streamLength_;for(var b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownBytesToStreamSoFar();return a},o3djs.io.LoadInfo.prototype.getTotalBytesDownloaded=function(){var a=this.request_&&this.hasStatus_?this.request_.bytesReceived:this.streamLength_;for(var b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalBytesDownloaded();return a},o3djs.io.LoadInfo.prototype.getTotalKnownRequestsToStreamSoFar=function(){var a=1;for(var b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownRequestToStreamSoFar();return a},o3djs.io.LoadInfo.prototype.getTotalRequestsDownloaded=function(){var a=this.request_?0:1;for(var b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalRequestsDownloaded();return a},o3djs.io.LoadInfo.prototype.getKnownProgressInfoSoFar=function(){var a=0,b=this.getTotalKnownBytesToStreamSoFar(),c=this.getTotalBytesDownloaded();b>0&&(a=Math.floor(c/b*100));var d=b<1048576?1024:1048576;return{percent:a,downloaded:(c/d).toFixed(2),totalBytes:(b/d).toFixed(2),base:d,suffix:d==1024?"kb":"mb"}},o3djs.io.loadTextFileSynchronous=function(a){o3djs.BROWSER_ONLY=!0;var b='loadTextFileSynchronous failed to load url "'+a+'"',c;if(!o3djs.base.IsMSIE()&&window.XMLHttpRequest)c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("text/plain");else if(window.ActiveXObject)c=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";c.open("GET",a,!1),c.send(null);if(c.readyState!=4)throw b;return c.responseText},o3djs.io.loadTextFile=function(a,b,c){o3djs.BROWSER_ONLY=!0;var d='loadTextFile failed to load url "'+a+'"',e;if(!o3djs.base.IsMSIE()&&window.XMLHttpRequest)e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("text/plain");else if(window.ActiveXObject)e=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";var f=o3djs.io.createLoadInfo(e,!1);e.open("GET",a,!0);var g=function(){if(e.readyState==4){var c="",d=e.status==200||e.status==0;d&&(c=e.responseText),f.finish(),b(c,d?null:"could not load: "+a)}};e.onreadystatechange=g,e.onprogress=c,e.send(null);return f},o3djs.io.ArchiveInfo=function(a,b,c){function e(a){d.files[a.uri]=a}var d=this;this.files={},this.pack=a,this.destroyed=!1,this.request_=null,this.loadInfo=o3djs.io.loadArchiveAdvanced(a,b,e,function(a,b){d.request_=a,c(d,b)})},o3djs.io.ArchiveInfo.prototype.destroy=function(){this.destroyed||(this.pack.removeObject(this.request_),this.destroyed=!0,this.files={})},o3djs.io.ArchiveInfo.prototype.getFiles=function(a,b){a instanceof RegExp||(a=a.replace(/(\W)/g,"\\$&"),a=a.replace(/\\\*/g,".*"),a=a.replace(/\\\?/g,"."),a=new RegExp(a,b?"i":""));var c=[];for(var d in this.files)a.test(d)&&c.push(this.files[d]);return c},o3djs.io.ArchiveInfo.prototype.getFileByURI=function(a,b){if(b){a=a.toLowerCase();for(var c in this.files)if(c.toLowerCase()==a)return this.files[c];return undefined}return this.files[a]},o3djs.io.loadArchive=function(a,b,c){var d=new o3djs.io.ArchiveInfo(a,b,c);return d.loadInfo},o3djs.io.loadArchiveAdvanced=function(a,b,c,d){var e='loadArchive failed to load url "'+b+'"',f=a.createArchiveRequest(),g=o3djs.io.createLoadInfo(f,!0);f.open("GET",b),f.onfileavailable=c,f.onreadystatechange=function(){if(f.done){g.finish();var a=f.success,b=null;a||(b=f.error,b||(b="unknown error loading archive")),d(f,b)}},f.send();return g},o3djs.io.loadRawData=function(a,b,c){var d=a.createFileRequest("RAWDATA"),e=o3djs.io.createLoadInfo(d,!1);d.open("GET",b,!0),d.onreadystatechange=function(){if(d.done){var a=d.data,f=d.success,g=d.error;e.finish(),!f&&!g&&(g="unknown error loading RawData: "+b),c(d,a,f?null:g)}},d.send();return e},o3djs.io.loadBitmaps=function(a,b,c,d){typeof d=="undefined"&&(d=!0);return o3djs.io.loadRawData(a,b,function(b,d,e){var f=[];e||(f=a.createBitmapsFromRawData(d),a.removeObject(b)),c(f,e)})},o3djs.io.loadTexture=function(a,b,c,d,e){function f(b,f,g){var h=null;g||(h=o3djs.texture.createTextureFromRawData(a,f,d,e),a.removeObject(b)),c(h,g)}return o3djs.io.loadRawData(a,b,f)},o3djs.provide("o3djs.scene"),o3djs.scene=o3djs.scene||{},o3djs.scene.loadScene=function(a,b,c,d,e,f){function g(d,g){if(!g){var h=function(a,b,c){d.destroy(),e(a,b,c)};o3djs.serialization.deserializeArchive(d,"scene.json",a,b,c,h,f)}else d.destroy(),e(b,c,g)}return o3djs.io.loadArchive(b,d,g)},o3djs.provide("o3djs.serialization"),o3djs.serialization=o3djs.serialization||{},o3djs.serialization.supportedVersion=5,o3djs.serialization.CURVE_KEY_TYPES={step:1,linear:2,bezier:3},o3djs.serialization.Options=goog.typedef,o3djs.serialization.Deserializer=function(a,b){function c(a,b,c,d){var e=a.pack.createObject(c);if("custom"in b)if("fieldData"in b.custom){var f=b.custom.fieldData;if(f.length>0){var g=[];for(var h=0;h<f.length;++h){var i=f[h],j=e.createField(i.type,i.numComponents);g.push(j),a.addObject(i.id,j)}var k=f[0],l=k.data.length/k.numComponents;e.allocateElements(l);for(var h=0;h<f.length;++h){var i=f[h];g[h].setAt(0,i.data)}}}else{var m=a.archiveInfo.getFileByURI(d);e.set(m,b.custom.binaryRange[0],b.custom.binaryRange[1]-b.custom.binaryRange[0]);for(var n=0;n<b.custom.fields.length;++n)a.addObject(b.custom.fields[n],e.fields[n])}return e}this.pack=a,this.json=b,this.archiveInfo=null,this.createCallbacks={"o3djs.DestinationBuffer":function(a,b){var c=a.pack.createObject("o3d.VertexBuffer");if("custom"in b){for(var d=0;d<b.custom.fields.length;++d){var e=b.custom.fields[d],f=c.createField(e.type,e.numComponents);a.addObject(e.id,f)}c.allocateElements(b.custom.numElements)}return c},"o3d.VertexBuffer":function(a,b){return c(a,b,"o3d.VertexBuffer","vertex-buffers.bin")},"o3d.SourceBuffer":function(a,b){return c(a,b,"o3d.SourceBuffer","vertex-buffers.bin")},"o3d.IndexBuffer":function(a,b){return c(a,b,"o3d.IndexBuffer","index-buffers.bin")},"o3d.Texture2D":function(b,c){if("o3d.uri"in c.params){var d=c.params["o3d.uri"].value,e=b.archiveInfo.getFileByURI(d);if(!e)throw"Could not find texture "+d+" in the archive";return o3djs.texture.createTextureFromRawData(a,e,!0)}return b.pack.createTexture2D(c.custom.width,c.custom.height,c.custom.format,c.custom.levels,c.custom.renderSurfacesEnabled)},"o3d.TextureCUBE":function(b,c){if("o3d.negx_uri"in c.params){var d=["o3d.posx_uri","o3d.negx_uri","o3d.posy_uri","o3d.negy_uri","o3d.posz_uri","o3d.negz_uri"],e=[];for(var f=0;f<d.length;f++){var g=c.params[d[f]].value,h=b.archiveInfo.getFileByURI(g);if(!h)throw"Could not find texture "+g+" in the archive";e.push(h)}return o3djs.texture.createTextureFromRawDataArray(a,e,!0,!1)}if("o3d.uri"in c.params){var g=c.params["o3d.uri"].value,h=b.archiveInfo.getFileByURI(g);if(!h)throw"Could not find texture "+g+" in the archive";return o3djs.texture.createTextureFromRawData(a,h,!0)}return b.pack.createTextureCUBE(c.custom.edgeLength,c.custom.format,c.custom.levels,c.custom.renderSurfacesEnabled)}},this.initCallbacks={"o3d.Curve":function(a,b,c){if("custom"in c)if("keys"in c.custom){var d=c.custom.keys,e=o3djs.serialization.CURVE_KEY_TYPES.step,f=o3djs.serialization.CURVE_KEY_TYPES.linear,g=o3djs.serialization.CURVE_KEY_TYPES.bezier;for(var h=0;h<d.length;++h){var i=d[h];switch(i[0]){case e:b.addStepKeys(i.slice(1));break;case f:b.addLinearKeys(i.slice(1));break;case g:b.addBezierKeys(i.slice(1))}}}else{var j=a.archiveInfo.getFileByURI("curve-keys.bin");b.set(j,c.custom.binaryRange[0],c.custom.binaryRange[1]-c.custom.binaryRange[0])}},"o3d.Effect":function(a,b,c){var d=b.getParam("o3d.uri");if(d){var e=a.archiveInfo.getFileByURI(d.value);if(!e)throw"Cannot find shader "+d.value+" in archive.";if(!b.loadFromFXString(e.stringValue))throw"Cannot load shader "+d.value+" in archive."}},"o3d.Skin":function(a,b,c){if("custom"in c&&"binaryRange"in c.custom){var d=a.archiveInfo.getFileByURI("skins.bin");b.set(d,c.custom.binaryRange[0],c.custom.binaryRange[1]-c.custom.binaryRange[0])}},"o3d.SkinEval":function(a,b,c){if("custom"in c)for(var d=0;d<c.custom.vertexStreams.length;++d){var e=c.custom.vertexStreams[d],f=a.getObjectById(e.stream.field);b.setVertexStream(e.stream.semantic,e.stream.semanticIndex,f,e.stream.startIndex);if("bind"in e){var g=a.getObjectById(e.bind);b.bindStream(g,e.stream.semantic,e.stream.semanticIndex)}}},"o3d.StreamBank":function(a,b,c){if("custom"in c)for(var d=0;d<c.custom.vertexStreams.length;++d){var e=c.custom.vertexStreams[d],f=a.getObjectById(e.stream.field);b.setVertexStream(e.stream.semantic,e.stream.semanticIndex,f,e.stream.startIndex);if("bind"in e){var g=a.getObjectById(e.bind);b.bindStream(g,e.stream.semantic,e.stream.semanticIndex)}}}};if(!("version"in b))throw"Version in JSON file was missing.";if(b.version<o3djs.serialization.supportedVersion)throw"Version in JSON file was "+b.version+" but expected at least version "+o3djs.serialization.supportedVersion+".";if(!("objects"in b))throw"Objects array in JSON file was missing.";this.objectsById_=[null],this.objectsByIndex_=[],this.classNames_=[];for(var d in b.objects)this.classNames_.push(d);this.phase_=0,this.nextClassIndex_=0,this.nextObjectIndex_=0,this.globalObjectIndex_=0},o3djs.serialization.Deserializer.prototype.getObjectById=function(a){return this.objectsById_[a]},o3djs.serialization.Deserializer.prototype.addObject=function(a,b){this.objectsById_[a]=b},o3djs.serialization.Deserializer.prototype.deserializeValue=function(a){if(typeof a=="object"){if(a===null)return null;var b=a;if("length"in b){for(var c=0;c!=b.length;++c)b[c]=this.deserializeValue(b[c]);return b}var d=b.ref;if(d!==undefined){var e=this.objectsById_[d];if(e===undefined)throw"Could not find object with id "+d+".";return e}}return a},o3djs.serialization.Deserializer.prototype.setParamValue_=function(a,b,c){var d=a.getParam(b);if(d!==null){var e=c.value;e!==undefined&&(d.value=this.deserializeValue(e));var f=c.bind;if(f!==undefined){var g=this.objectsById_[f];if(g===undefined)throw"Could not find output param with id "+f+".";d.bind(g)}}},o3djs.serialization.Deserializer.prototype.createAndIdentifyParam_=function(a,b,c){var d=c["class"],e;d!==undefined?e=a.createParam(b,d):e=a.getParam(b);var f=c.id;f!==undefined&&e!==null&&(this.objectsById_[f]=e)},o3djs.serialization.Deserializer.prototype.createObjectsPhase_=function(a){for(;this.nextClassIndex_<this.classNames_.length;++this.nextClassIndex_){var b=this.classNames_[this.nextClassIndex_],c=this.json.objects[b],d=c.length;for(;this.nextObjectIndex_<d;++this.nextObjectIndex_){if(a--<=0)return;var e=c[this.nextObjectIndex_],f=undefined;"id"in e&&(f=this.objectsById_[e.id]),f===undefined&&(b in this.createCallbacks?f=this.createCallbacks[b](this,e):f=this.pack.createObject(b)),this.objectsByIndex_[this.globalObjectIndex_++]=f,"id"in e&&(this.objectsById_[e.id]=f);if("params"in e)if("length"in e.params)for(var g=0;g!=e.params.length;++g){var h=e.params[g];this.createAndIdentifyParam_(f,g,h)}else for(var i in e.params){var h=e.params[i];this.createAndIdentifyParam_(f,i,h)}}this.nextObjectIndex_=0}this.nextClassIndex_===this.classNames_.length&&(this.nextClassIndex_=0,this.nextObjectIndex_=0,this.globalObjectIndex_=0,++this.phase_)},o3djs.serialization.Deserializer.prototype.setPropertiesPhase_=function(a){for(;this.nextClassIndex_<this.classNames_.length;++this.nextClassIndex_){var b=this.classNames_[this.nextClassIndex_],c=this.json.objects[b],d=c.length;for(;this.nextObjectIndex_<d;++this.nextObjectIndex_){if(a--<=0)return;var e=c[this.nextObjectIndex_],f=this.objectsByIndex_[this.globalObjectIndex_++];if("properties"in e)for(var g in e.properties)if(g in f){var h=e.properties[g],i=this.deserializeValue(h);f[g]=i}if("params"in e)if("length"in e.params)for(var j=0;j!=e.params.length;++j){var k=e.params[j];this.setParamValue_(f,j,k)}else for(var l in e.params){var k=e.params[l];this.setParamValue_(f,l,k)}b in this.initCallbacks&&this.initCallbacks[b](this,f,e)}this.nextObjectIndex_=0}this.nextClassIndex_===this.classNames_.length&&(this.nextClassIndex_=0,this.nextObjectIndex_=0,this.globalObjectIndex_=0,++this.phase_)},o3djs.serialization.Deserializer.prototype.run=function(a){if(!a){while(this.run(1e4));return!1}switch(this.phase_){case 0:this.createObjectsPhase_(a);break;case 1:this.setPropertiesPhase_(a)}return this.phase_<2},o3djs.serialization.Deserializer.prototype.runBackground=function(a,b,c,d){function j(){var c=null,e=!1,f=!1,j=o3djs.error.createErrorCollector(a);try{e=!i.run(g)}catch(k){f=!0,e=!0,c=k}j.errors.length>0&&(e=!0,c=j.errors.join("\n")+(c?"\n"+c.toString():"")),j.finish(),e&&(window.clearInterval(h),d(b,c))}var e=this.json.objects.length*2,f=c*60,g=e/f,h,i=this;h=window.setInterval(j,1e3/60)},o3djs.serialization.createDeserializer=function(a,b){return new o3djs.serialization.Deserializer(a,b)},o3djs.serialization.deserialize=function(a,b){var c=o3djs.serialization.createDeserializer(a,b);c.run()},o3djs.serialization.deserializeArchive=function(archiveInfo,sceneJsonUri,client,pack,parent,callback,opt_options){opt_options=opt_options||{};var jsonFile=archiveInfo.getFileByURI(sceneJsonUri);if(!jsonFile)throw"Could not find "+sceneJsonUri+" in archive";var parsed=eval("("+jsonFile.stringValue+")"),deserializer=o3djs.serialization.createDeserializer(pack,parsed);deserializer.addObject(parsed.o3d_rootObject_root,parent),deserializer.archiveInfo=archiveInfo;var finishCallback=function(a,b){if(!b){var c=a.getObjects("o3d.animSourceOwner","o3d.ParamObject");if(c.length>0){if(opt_options.opt_animSource){var d=c[0].getParam("animSource"),e=d.outputConnections;for(var f=0;f<e.length;++f)e[f].bind(opt_options.opt_animSource)}for(var f=0;f<c.length;++f)a.removeObject(c[f])}}callback(a,parent,b)};if(opt_options.opt_async)deserializer.runBackground(client,pack,5,finishCallback);else{var exception=null,errorCollector=o3djs.error.createErrorCollector(client);try{deserializer.run()}catch(e){exception=e}errorCollector.errors.length>0&&(exception=errorCollector.errors.join("\n")+(exception?"\n"+exception.toString():"")),errorCollector.finish(),finishCallback(pack,exception)}},o3djs.provide("o3djs.error"),o3djs.error=o3djs.error||{},o3djs.error.callbacks_=[],o3djs.error.setErrorHandler=function(a,b){var c=a.clientId,d=o3djs.error.callbacks_[c];o3djs.error.callbacks_[c]=b,b?a.setErrorCallback(b):a.clearErrorCallback();return d},o3djs.error.setDefaultErrorHandler=function(a){o3djs.error.setErrorHandler(a,function(b){o3djs.error.setErrorHandler(a,null),alert("ERROR: "+b)})},o3djs.error.createErrorCollector=function(a){return new o3djs.error.ErrorCollector(a)},o3djs.error.ErrorCollector=function(a){var b=this;this.client_=a,this.errors=[],this.oldCallback_=o3djs.error.setErrorHandler(a,function(a){b.errors.push(a)})},o3djs.error.ErrorCollector.prototype.finish=function(){o3djs.error.setErrorHandler(this.client_,this.oldCallback_)},o3djs.provide("o3djs.texture"),o3djs.texture=o3djs.texture||{},o3djs.texture.MAX_TEXTURE_DIMENSION=2048,o3djs.texture.computeNumLevels=function(a,b){if(a==0||b==0)return 0;var c=Math.max(a,b),d=0;while(c>0)++d,c=c>>1;return d},o3djs.texture.createTextureFromRawData=function(a,b,c,d,e,f){var g=a.createBitmapsFromRawData(b);if(d||typeof d=="undefined")for(var h=0;h<g.length;++h){var i=g[h];i.semantic==o3djs.base.o3d.Bitmap.IMAGE&&g[h].flipVertically()}var j=o3djs.texture.createTextureFromBitmaps(a,g,c);for(var h=0;h<g.length;++h)a.removeObject(g[h]);return j},o3djs.texture.createTextureFromRawDataArray=function(a,b,c,d,e,f){var g=[];for(var h=0;h<b.length;++h)g=g.concat(a.createBitmapsFromRawData(b[h]));if(d||typeof d=="undefined")for(var h=0;h<g.length;++h){var i=g[h];i.semantic==o3djs.base.o3d.Bitmap.IMAGE&&g[h].flipVertically()}var j=o3djs.texture.createTextureFromBitmaps(a,g,c);for(var h=0;h<g.length;++h)a.removeObject(g[h]);return j},o3djs.texture.canMakeMipsAndScale=function(a){switch(a){case o3djs.base.o3d.Texture.XRGB8:case o3djs.base.o3d.Texture.ARGB8:case o3djs.base.o3d.Texture.ABGR16F:case o3djs.base.o3d.Texture.R32F:case o3djs.base.o3d.Texture.ABGR32F:return!0;case o3djs.base.o3d.Texture.DXT1:case o3djs.base.o3d.Texture.DXT3:case o3djs.base.o3d.Texture.DXT5:return!1}return!1},o3djs.texture.createTextureFromBitmaps=function(a,b,c){if(b.length==0)throw"no bitmaps";var d=b[0].width,e=b[0].height,f=b[0].format,g=b[0].numMipmaps,h=o3djs.texture.computeNumLevels(d,e),i=g,j=d,k=e;(typeof c=="undefined"||c)&&o3djs.texture.canMakeMipsAndScale(f)&&g==1&&h>1&&(i=h);for(var l=0;l<b.length;++l){var m=b[l];if(m.width!=d||m.height!=e||m.format!=f||m.numMipmaps!=g)throw"bitmaps must all be the same width, height, mips and format";i!=g&&m.generateMips(0,i-1)}var n=m.numMipmaps>1?m.numMipmaps:o3djs.texture.computeNumLevels(j,k),o;if(b.length==6&&b[0].semantic!=o3djs.base.o3d.Bitmap.SLICE){if(d!=e||d!=j||e!=k)throw"Cubemaps must be square";o=a.createTextureCUBE(j,f,i,!1);for(var l=0;l<6;++l)o.setFromBitmap(l,b[l])}else b.length==1&&(o=a.createTexture2D(j,k,f,i,!1),o.setFromBitmap(b[0]));return o},o3djs.texture.createCubeTextureFrom6Bitmaps=function(a,b,c){var d=o3djs.texture.computeNumLevels(b,b),e=a.createTextureCUBE(b,c[0].format,d,!1);for(var f=0;f<6;++f){var g=c[f];e.setFromBitmap(f,g)}e.generateMips(0,d-1);return e},o3djs.provide("o3djs.shape"),o3djs.shape=o3djs.shape||{},o3djs.shape.addMissingTexCoordStreams=function(a){var b=a.elements;for(var c=0;c<b.length;++c){var d=b[c];o3djs.element.addMissingTexCoordStreams(d)}},o3djs.shape.setBoundingBoxesAndZSortPoints=function(a){var b=a.elements;for(var c=0;c<b.length;++c){var d=b[c];o3djs.element.setBoundingBoxAndZSortPoint(d)}},o3djs.shape.prepareShape=function(a,b){b.createDrawElements(a,null),o3djs.shape.setBoundingBoxesAndZSortPoints(b),o3djs.shape.addMissingTexCoordStreams(b)},o3djs.shape.prepareShapes=function(a){var b=a.getObjectsByClassName("o3d.Shape");for(var c=0;c<b.length;++c)o3djs.shape.prepareShape(a,b[c])},o3djs.shape.deleteDuplicateShape=function(a,b){var c=a.elements;for(var d=0;d<c.length;d++){var e=c[d],f=e.drawElements;for(var g=0;g<f.length;g++){var h=f[g];b.removeObject(h)}b.removeObject(e)}b.removeObject(a)},o3djs.shape.duplicateShape=function(a,b){var c=a.createObject("Shape"),d=b.elements;for(var e=0;e<d.length;e++){var f=o3djs.element.duplicateElement(a,d[e]);f.owner=c}c.createDrawElements(a,null);return c}